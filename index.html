<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no">
<title>Polycam Web Scanner</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#000;
  font-family:sans-serif;
}

/* ğŸ”¥ Safariê°€ ì¹´ë©”ë¼ë¥¼ ëŠì§€ ì•Šë„ë¡ ë°˜ë“œì‹œ í™”ë©´ì— ì¡´ì¬í•´ì•¼ í•¨ */
#video{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  object-fit:cover;
  opacity:0;                 /* ì¹´ë©”ë¼ ë³´ì´ì§€ ì•Šê²Œ â€” í•˜ì§€ë§Œ â€œì¡´ì¬í•¨â€ */
  pointer-events:none;
  z-index:-1;
}

#scanCanvas,
#modelCanvas{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  pointer-events:none;
}

#modelCanvas{ display:none; }

#startBtn{
  position:fixed;
  bottom:40px;
  left:50%;
  transform:translateX(-50%);
  padding:18px 26px;
  border-radius:30px;
  border:none;
  font-size:17px;
  background:#ffffff;
  color:#000;
  z-index:10;
}

#confirmBtn{
  position:fixed;
  bottom:40px;
  right:40px;
  padding:18px 26px;
  border-radius:30px;
  border:none;
  font-size:17px;
  background:rgba(60,130,255,0.9);
  color:#fff;
  display:none;
  z-index:10;
}

#status{
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  padding:8px 18px;
  border-radius:20px;
  background:rgba(0,0,0,0.45);
  color:#fff;
  font-size:14px;
  z-index:10;
}
</style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>

<canvas id="scanCanvas"></canvas>
<canvas id="modelCanvas"></canvas>

<div id="status">ìŠ¤ìº” ì¤€ë¹„ ì¤‘...</div>
<button id="startBtn">ì „ì²´í™”ë©´ ì‹œì‘</button>
<button id="confirmBtn">í™•ì¸</button>

<script>
/* ======================================================
 * 1. ì „ì²´í™”ë©´ ì‹œì‘ ë²„íŠ¼
 * ====================================================== */
const startBtn   = document.getElementById("startBtn");
const confirmBtn = document.getElementById("confirmBtn");
const statusDiv  = document.getElementById("status");

startBtn.onclick = async () => {

  // iOSì—ì„œëŠ” fullscreen í—ˆìš©ëœ ì˜ì—­ ì œí•œ â†’ ì‹¤íŒ¨í•´ë„ ì§„í–‰
  try{
    await document.documentElement.requestFullscreen();
  }catch(e){}

  startBtn.style.display = "none";
  statusDiv.textContent = "ìŠ¤ìº” ì¤‘...";

  // ğŸ”¥ AudioContext í™œì„±í™”
  if(audioCtx.state === "suspended"){
    audioCtx.resume();
  }
};

/* ======================================================
 * 2. ì¹´ë©”ë¼(ë°˜ë“œì‹œ í™”ë©´ì— ë‚¨ê²¨ë‘¬ì•¼ í•œë‹¤!)
 * ====================================================== */
const video = document.getElementById("video");

navigator.mediaDevices.getUserMedia({
  video:{ facingMode:"environment" },
  audio:false
}).then(stream => {
  video.srcObject = stream;
}).catch(err => {
  console.error(err);
  statusDiv.textContent = "ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨";
});

/* ======================================================
 * 3. ìº”ë²„ìŠ¤ ì„¤ì •
 * ====================================================== */
const scanCanvas  = document.getElementById("scanCanvas");
const sCtx        = scanCanvas.getContext("2d");
const modelCanvas = document.getElementById("modelCanvas");
const mCtx        = modelCanvas.getContext("2d");

function resizeCanvas(){
  scanCanvas.width  = innerWidth;
  scanCanvas.height = innerHeight;
  modelCanvas.width  = innerWidth;
  modelCanvas.height = innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ======================================================
 * 4. ì°°ì¹µ ì†Œë¦¬ â€” Web Audio (mp3 ì—†ìŒ)
 * ====================================================== */
const AudioContextClass = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContextClass();

function playClick(){
  try{
    const osc  = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "square";
    osc.frequency.setValueAtTime(2000, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.005, audioCtx.currentTime + 0.06);

    osc.connect(gain).connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.06);
  }catch(e){}
}

/* ======================================================
 * 5. í¬ì¸íŠ¸ í´ë¼ìš°ë“œ ë°ì´í„°
 * ====================================================== */
let pointCloud = [];
let lastFeatureCount = 0;
let scanning = true;

/* ê°„ë‹¨ íŠ¹ì§•ì  ì¶”ì¶œ */
function extractFeatures(img){
  const pts = [];
  const d = img.data;
  const w = img.width;

  for(let i=0;i<d.length;i+=12){
    const sum = d[i] + d[i+1] + d[i+2];
    if(sum < 80 || sum > 680){
      const idx = i/4;
      pts.push({ x: idx % w, y: Math.floor(idx / w) });
    }
  }
  return pts;
}

function addPoints(features, imgW, imgH){
  for(let i=0;i<features.length;i+=2){
    const f = features[i];
    pointCloud.push({
      x:(f.x/imgW - 0.5)*2,
      y:(f.y/imgH - 0.5)*2,
      z:(Math.random()-0.5)*2
    });
    if(pointCloud.length>2500) pointCloud.shift();
  }
}

/* ======================================================
 * 6. ìŠ¤ìº” í™”ë©´ ê·¸ë¦¬ê¸°(ì +ì„ )
 * ====================================================== */
function drawScanView(){
  const w = scanCanvas.width;
  const h = scanCanvas.height;

  sCtx.clearRect(0,0,w,h);
  sCtx.fillStyle = "#000";
  sCtx.fillRect(0,0,w,h);

  // ì 
  sCtx.fillStyle = "rgba(0,255,255,0.95)";
  for(const p of pointCloud){
    const sx = (p.x*0.5+0.5)*w;
    const sy = (p.y*0.5+0.5)*h;
    sCtx.beginPath();
    sCtx.arc(sx, sy, 2, 0, Math.PI*2);
    sCtx.fill();
  }

  // ì„ 
  sCtx.strokeStyle = "rgba(0,180,255,0.5)";
  for(let i=0;i<pointCloud.length;i++){
    for(let j=i+1;j<i+6 && j<pointCloud.length;j++){
      const p1 = pointCloud[i], p2 = pointCloud[j];
      const dx = p1.x-p2.x, dy=p1.y-p2.y, dz=p1.z-p2.z;
      if(dx*dx+dy*dy+dz*dz < 0.25){
        const x1=(p1.x*0.5+0.5)*w;
        const y1=(p1.y*0.5+0.5)*h;
        const x2=(p2.x*0.5+0.5)*w;
        const y2=(p2.y*0.5+0.5)*h;
        sCtx.beginPath();
        sCtx.moveTo(x1,y1);
        sCtx.lineTo(x2,y2);
        sCtx.stroke();
      }
    }
  }
}

/* ======================================================
 * 7. ìŠ¤ìº” ë£¨í”„
 * ====================================================== */
function scanLoop(){
  if(!scanning) return;

  if(video.readyState >= 2){

    const tw = 200, th = 150;
    const temp = document.createElement("canvas");
    temp.width = tw;
    temp.height = th;
    const tctx = temp.getContext("2d");

    tctx.drawImage(video,0,0,tw,th);
    const frame = tctx.getImageData(0,0,tw,th);

    const features = extractFeatures(frame);
    const diff = Math.abs(features.length - lastFeatureCount);

    if(diff > 40){
      playClick();
      addPoints(features, tw, th);
    }

    lastFeatureCount = features.length;
    drawScanView();
    confirmBtn.style.display = "block";
  }

  requestAnimationFrame(scanLoop);
}

requestAnimationFrame(scanLoop);

/* ======================================================
 * 8. í™•ì¸ â†’ ê²°ê³¼ 3D ë·°ì–´
 * ====================================================== */
confirmBtn.onclick = () => {
  scanning = false;

  scanCanvas.style.display = "none";
  modelCanvas.style.display = "block";
  statusDiv.textContent = "ìŠ¤ìº” ê²°ê³¼";

  show3DModel();
};

/* ======================================================
 * 9. 3D ë·°ì–´
 * ====================================================== */
let angle = 0;

function show3DModel(){

  function loop(){
    const w = modelCanvas.width;
    const h = modelCanvas.height;
    const cx = w/2, cy = h/2;
    const scale = Math.min(w,h)*0.45;
    const fov = 1.8;

    mCtx.clearRect(0,0,w,h);
    mCtx.fillStyle = "#000";
    mCtx.fillRect(0,0,w,h);

    const cosA = Math.cos(angle);
    const sinA = Math.sin(angle);

    // ì 
    for(const p of pointCloud){
      const x = p.x*cosA - p.z*sinA;
      const z = p.x*sinA + p.z*cosA;
      const y = p.y;

      const depth = (z + 3)/fov;
      const sx = cx + x*scale/depth;
      const sy = cy + y*scale/depth;

      mCtx.fillStyle = `rgba(0,255,255,${0.3 + 0.7*(1-depth/4)})`;
      mCtx.beginPath();
      mCtx.arc(sx,sy,2.5/depth,0,Math.PI*2);
      mCtx.fill();
    }

    angle += 0.003;
    requestAnimationFrame(loop);
  }

  requestAnimationFrame(loop);
}
</script>

</body>
</html>