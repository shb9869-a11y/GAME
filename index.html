<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>SLEEEEP – White Room & Red Rock</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PWA 기본: 홈 화면 추가용 (완전 풀스크린 아님) -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
  *{box-sizing:border-box;margin:0;padding:0;}

  :root{
    --camX: 0px;
    --camY: 0px;
  }

  body{
    background:#000;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    color:#fff;
    overscroll-behavior:none;
  }

  /* 가로 모드 안내 (그래도 가로 위주로) */
  .rotate-warning{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:#000;
    color:#fff;
    font-size:18px;
    text-align:center;
    padding:20px;
    z-index:1000;
  }

  .game-root{
    position:relative;
    width: 800px;
    height: 450px;
    background:#111;
    overflow:hidden;
    border-radius:16px;
    box-shadow:0 0 40px rgba(0,0,0,0.8);
  }

  @media (orientation:portrait){
    .game-root{display:none;}
    .rotate-warning{display:flex;}
  }
  @media (orientation:landscape){
    .game-root{display:block;}
  }

  /* 월드: 카메라 무빙 */
  .world{
    position:absolute;
    left:50%;
    top:55%;
    width:520px;
    height:320px;
    transform:translate(calc(-50% + var(--camX)),
                        calc(-50% + var(--camY)));
    transition:transform .18s ease-out;
    pointer-events:none;
  }

  .scene-layer{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  /* ===== 정육면체 방 구조 ===== */

  /* 바닥: 정사각형을 약간 원근감 있게 눕힌 형태 */
  .room-floor{
    position:absolute;
    left:50%;
    top:62%;
    width:280px;
    height:160px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#ffffff;
    border:4px solid #000;
    box-shadow:0 18px 0 #000;
  }

  .scene-rock .room-floor{
    background:#fdf6f6;
  }

  /* 뒤 벽: 정사각형 면 */
  .room-wall-back{
    position:absolute;
    left:50%;
    top:20%;
    width:260px;
    height:110px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#f7f7f7;
    border:4px solid #000;
    box-shadow:0 12px 0 #000;
  }

  /* 왼쪽 벽 */
  .room-wall-left{
    position:absolute;
    left:16%;
    top:40%;
    width:120px;
    height:110px;
    transform:skewY(-26deg);
    background:#f3f3f3;
    border:4px solid #000;
    box-shadow:0 8px 0 #000;
  }

  /* 오른쪽 벽 */
  .room-wall-right{
    position:absolute;
    right:16%;
    top:40%;
    width:120px;
    height:110px;
    transform:skewY(-26deg);
    background:#f3f3f3;
    border:4px solid #000;
    box-shadow:0 8px 0 #000;
  }

  /* 정육면체 느낌을 주기 위한 모서리 라인 (선택) */
  .room-edge{
    position:absolute;
    background:#000;
  }
  .room-edge.e1{ /* 왼벽–바닥 모서리 */
    left:19%;
    top:58%;
    width:2px;
    height:90px;
  }
  .room-edge.e2{ /* 오른벽–바닥 모서리 */
    right:19%;
    top:58%;
    width:2px;
    height:90px;
  }

  /* EXIT 박스 (빨간 박스 + 흰 글자) – 뒷벽 중앙 */
  .exit-box{
    position:absolute;
    left:50%;
    top:16%;
    width:110px;
    height:48px;
    transform:translateX(-50%) skewY(-26deg);
    background:#c80000;
    border:4px solid #000;
    box-shadow:0 8px 0 #000;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .exit-box span{
    transform:skewY(26deg);
    color:#fff;
    font-size:15px;
    letter-spacing:0.25em;
    text-indent:0.25em;
    font-weight:700;
  }

  /* 붉은 바위 – 중앙에 큰 덩어리 */
  .red-rock{
    position:absolute;
    left:50%;
    top:58%;
    width:160px;
    height:100px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#a30000;
    border:5px solid #000;
    border-radius:12px;
    box-shadow:0 24px 0 #000;
  }

  /* 플레이어 (사람 형상) */
  .player{
    position:absolute;
    width:32px;
    height:48px;
    transform-origin:center bottom;
  }
  .player .shadow{
    position:absolute;
    left:50%;
    bottom:0;
    width:32px;
    height:12px;
    transform:translateX(-50%);
    background:radial-gradient(ellipse at center,
             rgba(0,0,0,0.45) 0, transparent 70%);
  }
  .player .body{
    position:absolute;
    left:50%;
    bottom:14px;
    transform:translateX(-50%);
    width:24px;
    height:22px;
    border-radius:4px;
    background:#fff;
    border:3px solid #000;
  }
  .player .head{
    position:absolute;
    left:50%;
    bottom:34px;
    transform:translateX(-50%);
    width:18px;
    height:18px;
    border-radius:50%;
    background:#fff;
    border:3px solid #000;
  }

  /* 동그라미 조이스틱 – 왼쪽 아래 */
  .joystick{
    position:absolute;
    left:40px;
    bottom:40px;
    width:120px;
    height:120px;
    z-index:30;
  }
  .joystick-base{
    position:absolute;
    left:50%;
    top:50%;
    width:100px;
    height:100px;
    transform:translate(-50%,-50%);
    border-radius:50%;
    border:3px solid #fff;
    background:rgba(255,255,255,0.05);
    box-shadow:0 4px 0 #000;
  }
  .joystick-knob{
    position:absolute;
    left:50%;
    top:50%;
    width:46px;
    height:46px;
    transform:translate(-50%,-50%);
    border-radius:50%;
    background:#ffffff;
    border:3px solid #000;
    box-shadow:0 3px 0 #000;
  }

  .log{
    position:absolute;
    left:10px;
    top:10px;
    font-size:12px;
    color:#ccc;
    z-index:40;
  }

  .info-panel{
    position:absolute;
    right:20px;
    top:20px;
    width:260px;
    padding:10px 14px;
    background:rgba(255,255,255,0.95);
    color:#000;
    border-radius:8px;
    border:3px solid #000;
    font-size:12px;
    line-height:1.4;
    z-index:35;
  }
  .info-panel h1{
    font-size:14px;
    margin-bottom:6px;
    text-transform:uppercase;
    letter-spacing:0.1em;
  }

  .fade-overlay{
    position:absolute;
    inset:0;
    background:#000;
    opacity:0;
    pointer-events:none;
    transition:opacity .6s ease;
    z-index:50;
  }
  .fade-overlay.active{
    opacity:1;
    pointer-events:auto;
  }
</style>
</head>
<body>

<div class="rotate-warning">
  이 체험은<br><strong>가로 모드</strong>에서 사용해 주세요.<br><br>
  기기를 가로로 돌려 주세요.
</div>

<div class="game-root">
  <div class="world" id="world">
    <div class="scene-layer" id="sceneLayer">
      <!-- 방/EXIT/바위는 JS에서 채움 -->
    </div>
    <div class="scene-layer">
      <div class="player" id="player">
        <div class="shadow"></div>
        <div class="body"></div>
        <div class="head"></div>
      </div>
    </div>
  </div>

  <!-- 동그라미 조이스틱 -->
  <div class="joystick" id="joystick">
    <div class="joystick-base"></div>
    <div class="joystick-knob" id="joystickKnob"></div>
  </div>

  <div class="log" id="log">
    하얀 방을 거닐다가, 뒷벽 중앙의 빨간 EXIT 박스로 다가가 보세요.
  </div>

  <div class="info-panel" id="infoPanel">
    <!-- 내용은 JS에서 채움 -->
  </div>

  <div class="fade-overlay" id="fade"></div>
</div>

<script>
  /***********************
   * 씬/좌표 설정
   ***********************/
  const worldEl   = document.getElementById('world');
  const sceneEl   = document.getElementById('sceneLayer');
  const playerEl  = document.getElementById('player');
  const logEl     = document.getElementById('log');
  const infoPanel = document.getElementById('infoPanel');
  const fadeEl    = document.getElementById('fade');

  const tileW = 64;
  const tileH = 32;
  const originX = 260;
  const originY = 60;

  // 방 안 월드 좌표: 정육면체의 바닥 중앙을 (0,0)으로 두고 ±roomLimit
  const roomLimitX = 3.6;
  const roomLimitY = 3.6;

  const scenes = {
    waiting: {
      key:'waiting',
      hasExit:true,
      hasRedRock:false,
      infoTitle:'WHITE ROOM',
      infoBody:[
        '이곳은 잠들기 직전, 아무것도 정해지지 않은 하얀 방입니다.',
        '방 안을 천천히 거닐다가, 뒷벽 중앙의 빨간 EXIT 박스로 다가가 보세요.',
        '왼쪽 아래 동그라미 조이스틱을 움직이면 인물이 따라 움직입니다.'
      ]
    },
    rock: {
      key:'rock',
      hasExit:false,
      hasRedRock:true,
      infoTitle:'RED ROCK ROOM',
      infoBody:[
        '당신은 붉은 바위가 놓인 하얀 방으로 들어왔습니다.',
        '정육면체 방 안에서, 바위를 중심으로 천천히 걸어보세요.',
        '이 방은 더 이상 어디로 이어지지 않습니다.'
      ]
    }
  };

  let currentSceneKey = 'waiting';

  function buildScene(){
    sceneEl.innerHTML = '';

    worldEl.className = 'world ' + (currentSceneKey === 'rock' ? 'scene-rock' : '');

    // 정육면체 방 구성
    const floor = document.createElement('div');
    floor.className = 'room-floor';
    sceneEl.appendChild(floor);

    const back = document.createElement('div');
    back.className = 'room-wall-back';
    sceneEl.appendChild(back);

    const leftWall = document.createElement('div');
    leftWall.className = 'room-wall-left';
    sceneEl.appendChild(leftWall);

    const rightWall = document.createElement('div');
    rightWall.className = 'room-wall-right';
    sceneEl.appendChild(rightWall);

    const edge1 = document.createElement('div');
    edge1.className = 'room-edge e1';
    sceneEl.appendChild(edge1);
    const edge2 = document.createElement('div');
    edge2.className = 'room-edge e2';
    sceneEl.appendChild(edge2);

    const scene = scenes[currentSceneKey];

    if(scene.hasExit){
      const exitBox = document.createElement('div');
      exitBox.className = 'exit-box';
      const span = document.createElement('span');
      span.textContent = 'EXIT';
      exitBox.appendChild(span);
      sceneEl.appendChild(exitBox);
    }

    if(scene.hasRedRock){
      const rock = document.createElement('div');
      rock.className = 'red-rock';
      sceneEl.appendChild(rock);
    }

    // 정보 패널
    infoPanel.innerHTML =
      `<h1>${scene.infoTitle}</h1>` +
      scene.infoBody.map(p=>`<p>${p}</p>`).join('');
  }

  /***********************
   * 플레이어 / 카메라
   ***********************/
  let playerX = 0;   // 방 바닥 좌표 (x,y)
  let playerY = 0;
  let velX = 0;
  let velY = 0;
  const speed = 1.8; // 조이스틱 최대 속도

  function worldToScreen(x, y){
    const isoX = (x - y) * (tileW/2);
    const isoY = (x + y) * (tileH/2);
    return {
      x: originX + isoX,
      y: originY + isoY + 60 // 바닥 중심을 화면에서 약간 아래로
    };
  }

  function updatePlayerVisual(){
    const pos = worldToScreen(playerX, playerY);
    playerEl.style.left = pos.x + 'px';
    playerEl.style.top  = pos.y + 'px';

    // 카메라: 플레이어 위치에 따른 약한 파라럭스
    const desiredX = 260;
    const desiredY = 150;
    const diffX = desiredX - pos.x;
    const diffY = desiredY - pos.y;
    const camX = diffX * 0.22;
    const camY = diffY * 0.22;
    document.documentElement.style.setProperty('--camX', camX + 'px');
    document.documentElement.style.setProperty('--camY', camY + 'px');
  }

  function clampRoom(){
    playerX = Math.max(-roomLimitX, Math.min(roomLimitX, playerX));
    playerY = Math.max(-roomLimitY, Math.min(roomLimitY, playerY));
  }

  function checkExitTrigger(){
    if(currentSceneKey !== 'waiting') return;
    // EXIT 박스 근처의 바닥 좌표 대략 위치 (뒷벽 중앙 앞쪽)
    const exitX = 0;
    const exitY = -roomLimitY + 0.6;
    const dx = playerX - exitX;
    const dy = playerY - exitY;
    const dist = Math.hypot(dx, dy);
    if(dist < 1.2){
      goToScene('rock');
    }
  }

  function goToScene(key){
    fadeEl.classList.add('active');
    setTimeout(()=>{
      currentSceneKey = key;
      buildScene();
      if(key === 'rock'){
        playerX = 0;
        playerY = roomLimitY - 1.0;
        logEl.textContent = '붉은 바위 방에 도착했습니다. 바위를 중심으로 천천히 걸어보세요.';
      }else{
        playerX = 0;
        playerY = 0;
        logEl.textContent = '하얀 방입니다. 빨간 EXIT 박스로 다가가 보세요.';
      }
      clampRoom();
      updatePlayerVisual();
      fadeEl.classList.remove('active');
    }, 600);
  }

  /***********************
   * 조이스틱 입력
   ***********************/
  const joystick     = document.getElementById('joystick');
  const joystickKnob = document.getElementById('joystickKnob');

  let joyActive = false;
  let joyCenter = {x:0,y:0};
  let joyVector = {x:0,y:0};
  const joyMaxRadius = 40;

  function setJoyVector(clientX, clientY){
    const dx = clientX - joyCenter.x;
    const dy = clientY - joyCenter.y;
    const angle = Math.atan2(dy, dx);
    const dist  = Math.min(joyMaxRadius, Math.hypot(dx,dy));
    const nx = Math.cos(angle) * (dist/joyMaxRadius);
    const ny = Math.sin(angle) * (dist/joyMaxRadius);
    joyVector.x = nx;
    joyVector.y = ny;

    joystickKnob.style.left = 50 + (nx * 40) + '%';
    joystickKnob.style.top  = 50 + (ny * 40) + '%';
  }

  function resetJoystick(){
    joyVector.x = 0;
    joyVector.y = 0;
    joystickKnob.style.left = '50%';
    joystickKnob.style.top  = '50%';
  }

  // 여기서는 joystick 영역에서만 pointer 취급 → 다른 곳(텍스트, 버튼)은
  // 꾹 눌렀을 때 복사/선택 메뉴가 뜰 수 있음 (전역 preventDefault 안함)
  joystick.addEventListener('pointerdown', e=>{
    e.preventDefault();
    joyActive = true;
    const rect = joystick.getBoundingClientRect();
    joyCenter.x = rect.left + rect.width/2;
    joyCenter.y = rect.top  + rect.height/2;
    setJoyVector(e.clientX, e.clientY);
  });

  window.addEventListener('pointermove', e=>{
    if(!joyActive) return;
    e.preventDefault();
    setJoyVector(e.clientX, e.clientY);
  });

  window.addEventListener('pointerup', ()=>{
    if(!joyActive) return;
    joyActive = false;
    resetJoystick();
  });
  window.addEventListener('pointercancel', ()=>{
    if(!joyActive) return;
    joyActive = false;
    resetJoystick();
  });

  /***********************
   * 키보드(테스트용)
   ***********************/
  window.addEventListener('keydown', e=>{
    const step = 0.4;
    if(e.key === 'ArrowUp')    joyVector.y = -1;
    if(e.key === 'ArrowDown')  joyVector.y =  1;
    if(e.key === 'ArrowLeft')  joyVector.x = -1;
    if(e.key === 'ArrowRight') joyVector.x =  1;
  });
  window.addEventListener('keyup', e=>{
    if(['ArrowUp','ArrowDown'].includes(e.key)) joyVector.y = 0;
    if(['ArrowLeft','ArrowRight'].includes(e.key)) joyVector.x = 0;
  });

  /***********************
   * 메인 루프
   ***********************/
  let lastTime = performance.now();

  function loop(now){
    const dt = Math.min(0.05, (now - lastTime) / 1000);
    lastTime = now;

    velX = joyVector.x * speed;
    velY = joyVector.y * speed;

    playerX += velX * dt;
    playerY += velY * dt;

    clampRoom();
    updatePlayerVisual();
    checkExitTrigger();

    requestAnimationFrame(loop);
  }

  /***********************
   * 초기화
   ***********************/
  buildScene();
  clampRoom();
  updatePlayerVisual();
  requestAnimationFrame(loop);

  // 서비스워커 등록 (있으면 홈화면 추가시 캐시용)
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('sw.js').catch(console.error);
    });
  }
</script>

</body>
</html>