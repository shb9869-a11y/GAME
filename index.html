<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

<title>Polycam Style Scanner</title>

<style>
    body {
        margin:0;
        background:#000;
        overflow:hidden;
        font-family:sans-serif;
    }

    #view {
        position:fixed;
        top:0; left:0;
        width:100vw;
        height:100vh;
        object-fit:cover;
        filter:brightness(1.1) contrast(1.1);
    }

    /* 상단에 SLAM 레이저 느낌 */
    .scan-line {
        position:fixed;
        top:0; left:0;
        width:100%; height:2px;
        background:rgba(0,200,255,0.3);
        animation:scan 3s linear infinite;
    }
    @keyframes scan {
        0% { top:0; }
        100% { top:100%; }
    }

    /* 점군 캔버스 */
    #points {
        position:fixed;
        top:0; left:0;
        width:100vw;
        height:100vh;
        pointer-events:none;
        mix-blend-mode:screen;
    }

</style>
</head>

<body>

<video id="view" autoplay playsinline muted></video>
<canvas id="points"></canvas>
<div class="scan-line"></div>

<audio id="scanSound" src="scanSound.mp3" preload="auto"></audio>

<script>
/* -------------------------
   1. 카메라 켜기
------------------------- */
const video = document.getElementById("view");

navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"environment" },
    audio:false
}).then(stream =>{
    video.srcObject = stream;
});

/* -------------------------
   2. 점군(3D-like) Canvas
------------------------- */
const canvas = document.getElementById("points");
const ctx = canvas.getContext("2d");
let w = canvas.width = window.innerWidth;
let h = canvas.height = window.innerHeight;

window.addEventListener("resize", ()=>{
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
});

/* 점군 데이터 */
let points = [];
const maxPoints = 600;

function addPoint(x, y){
    if(points.length > maxPoints) points.shift();
    points.push({
        x:x,
        y:y,
        z:Math.random()*2,   // 의사 3D 깊이
        a:1.0                // 투명도
    });
}

/* 점군 그리기 */
function drawPoints(){
    ctx.clearRect(0,0,w,h);

    for(let p of points){
        const size = 2 + p.z*3;
        ctx.fillStyle = `rgba(0,255,200,${p.a})`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, size, 0, Math.PI*2);
        ctx.fill();
        p.a *= 0.96;  // 점이 점점 사라지기
    }

    requestAnimationFrame(drawPoints);
}
drawPoints();

/* -------------------------
   3. 공간 이동 감지 (Polycam 느낌)
------------------------- */
let lastFrame = null;
let moving = false;
let moveTimer = null;

const scanSound = document.getElementById("scanSound");
scanSound.loop = true;
scanSound.volume = 0.6;

/* 카메라 프레임 분석 → 움직임 감지 */
function detectMotion(){
    const smallCanvas = document.createElement("canvas");
    const sctx = smallCanvas.getContext("2d");
    smallCanvas.width = 160;
    smallCanvas.height = 120;

    setInterval(()=>{
        if(video.videoWidth === 0) return;

        sctx.drawImage(video, 0, 0, 160, 120);
        let frame = sctx.getImageData(0, 0, 160, 120);

        if(lastFrame){
            let diff = 0;
            for(let i=0; i<frame.data.length; i+=4){
                diff += Math.abs(frame.data[i] - lastFrame.data[i]);
            }

            let movement = diff / 20000;

            if(movement > 2){
                // 움직임이 충분히 크다 → 스캔 시작
                if(!moving){
                    moving = true;
                    scanSound.play();
                }
                clearTimeout(moveTimer);
                moveTimer = setTimeout(()=>{
                    moving = false;
                    scanSound.pause();
                }, 600); // 멈추면 0.6초 후 스캔 정지

                // 점군 찍기
                addPoint(
                    Math.random()*w,
                    Math.random()*h
                );
            }
        }

        lastFrame = frame;

    }, 80); // 80ms 간격 = 12.5fps 분석
}
detectMotion();

</script>

</body>
</html>