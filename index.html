<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,interactive-widget=resizes-content">
<title>SLEEEEEEEP ‚Äì THE SECOND SLEEP</title>

<!-- ÌîΩÏÖÄ Í≤åÏûÑ Ìè∞Ìä∏ -->
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEP">
<meta name="theme-color" content="#000000">

<style>
:root{
  --appH: 100svh;
  --frame: clamp(16px, 4vmin, 40px);
  --ui-gap: 8px;

  --fs-body: clamp(12px, 2.2vmin, 16px);
  --fs-strong: clamp(14px, 2.8vmin, 20px);
  --fs-small: clamp(11px, 1.8vmin, 14px);

  --pad-btn-y: clamp(6px, 1.1vmin, 10px);
  --pad-btn-x: clamp(10px, 1.8vmin, 20px);

  --safe-t: env(safe-area-inset-top, 0px);
  --safe-b: env(safe-area-inset-bottom, 0px);
  --safe-l: env(safe-area-inset-left, 0px);
  --safe-r: env(safe-area-inset-right, 0px);

  --accent: #f5f5f5;
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  -webkit-user-select:none;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}

html,body{
  width:100%;
  height:100%;
  overflow:hidden;
  touch-action:manipulation;
  background:#000;
  color:var(--accent);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans KR",sans-serif;
}

.frameBox{
  position:fixed;
  left:calc(var(--frame) + var(--safe-l));
  right:calc(var(--frame) + var(--safe-r));
  top:calc(var(--frame) + var(--safe-t));
  bottom:calc(var(--frame) + var(--safe-b));
  border:2px solid rgba(255,255,255,0.8);
  pointer-events:none;
  z-index:5;
}

.hidden{ display:none !important; }

/* Î∞∞Í≤Ω Ï∫îÎ≤ÑÏä§(ÏßÄÍ∏àÏùÄ Ïïà Ïç®ÎèÑ Îê®) */
#blobCanvas{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  image-rendering:pixelated;
  z-index:0;
}

/* GAME LAYOUT */
#gameLayout{
  position:fixed;
  inset:0;
  padding:calc(var(--frame) + var(--safe-t))
           calc(var(--frame) + var(--safe-r))
           calc(var(--frame) + var(--safe-b))
           calc(var(--frame) + var(--safe-l));
  z-index:20;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}

#gameCard{
  width:100%;
  max-width:1120px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:16px;
}

/* Í≤åÏûÑ ÌôîÎ©¥ Î∞ïÏä§ */
#gameScreenWrap{
  width:100%;
  max-width:720px;
  aspect-ratio:16/9;
  background:#001307;
  border:1px solid rgba(255,255,255,0.4);
  box-shadow:0 0 0 2px #000, 0 0 30px #000;
  position:relative;
  overflow:hidden;
  pointer-events:auto;
}

#gameCanvas{
  width:100%;
  height:100%;
  position:relative;
  z-index:1;
  image-rendering:pixelated;
}

/* Îã§ÌÅê ÏòÅÏÉÅ */
#docVideo{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  z-index:0;
}

/* ÎåÄÌôîÏ∞Ω */
#dialogBar{
  width:100%;
  max-width:720px;
  background:rgba(0,0,0,0.8);
  border:1px solid rgba(255,255,255,0.6);
  padding:14px;
  box-shadow:0 0 20px #000;
  pointer-events:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}

#dialogText{
  font-size:clamp(11px,2vmin,14px);
  font-family:"Courier New",ui-monospace,monospace;
  white-space:pre-wrap;
  line-height:1.7;
}

#dialogChoices{
  margin-top:4px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}

.uiBtn{
  background:rgba(0,0,0,0.7);
  color:#fff;
  border:1px solid #fff;
  padding:6px 10px;
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  font-size:10px;
  cursor:pointer;
}
.uiBtn:active{
  background:#fff;
  color:#000;
}

#dialogNext{
  margin-left:auto;
}

/* HUD */
#hudLeft{
  position:fixed;
  left:calc(var(--frame) + var(--safe-l));
  bottom:calc(var(--frame) + var(--safe-b));
  z-index:40;
}
#hudRight{
  position:fixed;
  right:calc(var(--frame) + var(--safe-r));
  bottom:calc(var(--frame) + var(--safe-b));
  z-index:40;
}

/* D-Pad */
.dpad{
  width:96px;
  height:96px;
  position:relative;
}
.dpad button{
  width:32px;
  height:32px;
  position:absolute;
  border-radius:6px;
  border:1px solid rgba(245,245,245,0.9);
  background:#000;
  color:#fff;
  font-size:10px;
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
}
.dpad-up{    left:32px; top:0; }
.dpad-down{  left:32px; bottom:0; }
.dpad-left{  left:0; top:32px; }
.dpad-right{ right:0; top:32px; }

/* Ïï°ÏÖò Î≤ÑÌäº */
#actionBtn{
  width:72px;
  height:72px;
  border-radius:50%;
  border:2px solid rgba(245,245,245,0.9);
  background:#a2192f;
  color:#fff;
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  font-size:12px;
}

/* ÌéòÏù¥Îìú */
#stageFade{
  position:fixed;
  inset:0;
  background:#000;
  z-index:200;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.8s ease;
}
</style>
</head>
<body>

<canvas id="blobCanvas"></canvas>
<div class="frameBox"></div>

<!-- Í≤åÏûÑ Î†àÏù¥ÏïÑÏõÉ -->
<div id="gameLayout" class="hidden">
  <div id="gameCard">
    <div id="gameScreenWrap">
      <canvas id="gameCanvas" width="320" height="180"></canvas>
      <video id="docVideo" class="hidden" playsinline webkit-playsinline></video>
    </div>

    <div id="dialogBar" class="hidden">
      <div id="dialogText"></div>
      <div id="dialogChoices" class="hidden"></div>
      <button id="dialogNext" class="uiBtn">NEXT</button>
    </div>
  </div>
</div>

<!-- HUD -->
<div id="hudLeft" class="hidden">
  <div class="dpad">
    <button class="dpad-up" data-dir="up">‚ñ≤</button>
    <button class="dpad-down" data-dir="down">‚ñº</button>
    <button class="dpad-left" data-dir="left">‚óÄ</button>
    <button class="dpad-right" data-dir="right">‚ñ∂</button>
  </div>
</div>
<div id="hudRight" class="hidden">
  <button id="actionBtn">A</button>
</div>

<div id="stageFade" class="hidden"></div>

<script>
(() => {
  const qs = s => document.querySelector(s);
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

  const gameLayout = qs('#gameLayout');
  const gameCanvas = qs('#gameCanvas');
  const gctx       = gameCanvas.getContext('2d');
  const dialogBar  = qs('#dialogBar');
  const dialogText = qs('#dialogText');
  const dialogNext = qs('#dialogNext');
  const dialogChoices = qs('#dialogChoices');
  const hudLeft    = qs('#hudLeft');
  const hudRight   = qs('#hudRight');
  const dpad       = qs('#hudLeft .dpad');
  const actionBtn  = qs('#actionBtn');
  const stageFade  = qs('#stageFade');
  const docVideo   = qs('#docVideo');

  /* ==== Ïò§ÎîîÏò§ ==== */
  let audioCtx = null;
  let musicRunning = false;

  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    }
  }
  async function ensureResumed(){
    ensureAudio();
    if(audioCtx.state==='suspended'){
      try{ await audioCtx.resume(); }catch(e){}
    }
  }

  function playNote(freq, dur=0.15, vol=0.4, type='square'){
    try{
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(vol, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
      o.connect(g).connect(ctx.destination);
      o.start(now);
      o.stop(now+dur+0.05);
    }catch(e){}
  }

  // Î∞ùÍ≥† Í∑ÄÏó¨Ïö¥ ÏãúÏûë ÏùåÏïÖ
  function startBrightMusic(){
    if(musicRunning) return;
    musicRunning = true;
    const base = 523.25;
    const pattern = [0,4,7,12,7,4,0,7,2,5,9,14,9,5,2,7];
    let idx = 0;
    function step(){
      if(!musicRunning) return;
      const semi = pattern[idx%pattern.length];
      const f = base * Math.pow(2, semi/12);
      playNote(f, 0.14, 0.4, 'square');
      idx++;
      setTimeout(step, 150);
    }
    step();
  }

  // ÎØ∏Î°úÏö© Îã§ÌÅ¨ BGM
  function startDarkMusic(){
    musicRunning = false;
    setTimeout(()=>{
      if(musicRunning) return;
      musicRunning = true;
      const base = 440;
      const pattern = [0,3,7,10,3,7,0,-2];
      let idx = 0;
      function step(){
        if(!musicRunning) return;
        const semi = pattern[idx%pattern.length];
        const f = base * Math.pow(2, semi/12);
        playNote(f, 0.22, 0.28, 'sawtooth');
        idx++;
        setTimeout(step, 260);
      }
      step();
    }, 400);
  }

  // ÏòÅÏÉÅ Ïû¨ÏÉùÏö© Ïö∞Ï£º Ìå®Îìú
  function startVideoAmbientMusic(){
    musicRunning = false;
    setTimeout(()=>{
      if(musicRunning) return;
      musicRunning = true;
      const base = 220;
      const pattern = [0,7,12,5,0,-5];
      let idx = 0;
      function step(){
        if(!musicRunning) return;
        const semi = pattern[idx%pattern.length];
        const f = base * Math.pow(2, semi/12);
        playNote(f, 0.8, 0.18, 'sine');
        idx++;
        setTimeout(step, 900);
      }
      step();
    }, 400);
  }

  /* ==== ÏûÖÎ†• ==== */
  let moveLeft=false, moveRight=false, moveUp=false, moveDown=false, actionPressed=false;

  if(dpad){
    dpad.addEventListener('pointerdown', e=>{
      const b=e.target.closest('button[data-dir]');
      if(!b) return;
      const d=b.dataset.dir;
      if(d==='left') moveLeft=true;
      if(d==='right') moveRight=true;
      if(d==='up') moveUp=true;
      if(d==='down') moveDown=true;
    });
    dpad.addEventListener('pointerup', e=>{
      const b=e.target.closest('button[data-dir]');
      if(!b) return;
      const d=b.dataset.dir;
      if(d==='left') moveLeft=false;
      if(d==='right') moveRight=false;
      if(d==='up') moveUp=false;
      if(d==='down') moveDown=false;
    });
  }

  actionBtn.addEventListener('pointerdown',()=>actionPressed=true);
  actionBtn.addEventListener('pointerup',()=>actionPressed=false);
  actionBtn.addEventListener('pointercancel',()=>actionPressed=false);

  window.addEventListener('keydown', e=>{
    if(e.code==='ArrowLeft') moveLeft=true;
    if(e.code==='ArrowRight') moveRight=true;
    if(e.code==='ArrowUp') moveUp=true;
    if(e.code==='ArrowDown') moveDown=true;
    if(e.code==='Space') actionPressed=true;
  });
  window.addEventListener('keyup', e=>{
    if(e.code==='ArrowLeft') moveLeft=false;
    if(e.code==='ArrowRight') moveRight=false;
    if(e.code==='ArrowUp') moveUp=false;
    if(e.code==='ArrowDown') moveDown=false;
    if(e.code==='Space') actionPressed=false;
  });

  /* ==== Í∏∞Î≥∏ ÏÇ¨Ïù¥ÎìúÎ∑∞ ==== */
  const W = gameCanvas.width;
  const H = gameCanvas.height;
  const groundY = 145;
  const sofaX = 210;
  const sofaWidth = 70;
  const sofaHeight = 26;

  let playerX = 40;
  let playerY = groundY - 16;
  let playerVX = 0;

  function drawRedRabbit(ctx,x,y,scale=1){
    ctx.fillStyle='#ff3333';
    ctx.fillRect(x+2*scale,y+1*scale,4*scale,3*scale);
    ctx.fillRect(x+1*scale,y-1*scale,scale,3*scale);
    ctx.fillRect(x+4*scale,y-1*scale,scale,3*scale);
    ctx.fillRect(x+2*scale,y+4*scale,4*scale,3*scale);
    ctx.fillRect(x+6*scale,y+4*scale,2*scale,2*scale);
  }

  /* ==== ÎØ∏Î°ú ==== */
  const tileSize=16;
  const mazeMap=[
    "11111111111111111111",
    "10000001000000000001",
    "10111101011111111001",
    "10100100010000001001",
    "10100111110111101001",
    "10100000000100101001",
    "10101111110100101001",
    "10101000010100101001",
    "10101011110100101001",
    "10001000000000100001",
    "11111111111111111111"
  ];

  const mazeBlobs=[
    {tx:10,ty:2},
    {tx:10,ty:8},
    {tx:4, ty:5},
    {tx:16,ty:5},
    {tx:10,ty:5}
  ];
  let blobVisited=[false,false,false,false,false];

  const mazeStartTile={tx:1,ty:8};
  const mazeStartX=(mazeStartTile.tx+0.5)*tileSize;
  const mazeStartY=(mazeStartTile.ty+0.5)*tileSize;
  let mazePlayerX=mazeStartX;
  let mazePlayerY=mazeStartY;
  const mazeSpeed=1.1;

  function isWall(px,py){
    const tx=Math.floor(px/tileSize);
    const ty=Math.floor(py/tileSize);
    if(ty<0||ty>=mazeMap.length) return true;
    if(tx<0||tx>=mazeMap[0].length) return true;
    return mazeMap[ty].charAt(tx)==='1';
  }

  /* ==== ÎåÄÌôî ==== */
  let currentLines=[];
  let currentIdx=0;
  let typing=false;
  let fullLine="";
  let onDialogDone=null;
  let gameState='introWalk';
  let gameStarted=false;
  let introStart=0;
  let currentBlobIndex=-1;

  async function typeLine(line){
    typing=true;
    dialogText.textContent="";
    fullLine=line;
    for(let i=0;i<line.length;i++){
      dialogText.textContent+=line[i];
      await sleep(40);
      if(!typing) break;
    }
    typing=false;
    dialogText.textContent=fullLine;
  }

  async function showDialog(lines, cb=null){
    currentLines=lines;
    currentIdx=0;
    onDialogDone=cb;
    dialogBar.classList.remove('hidden');
    dialogChoices.classList.add('hidden');
    dialogNext.classList.remove('hidden');
    await typeLine(currentLines[0]||"");
  }

  dialogNext.addEventListener('click',()=>{
    if(typing){
      typing=false;
      dialogText.textContent=fullLine;
      return;
    }
    currentIdx++;
    if(currentIdx>=currentLines.length){
      dialogBar.classList.add('hidden');
      if(onDialogDone) onDialogDone();
      return;
    }
    typeLine(currentLines[currentIdx]);
  });

  /* ==== ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ==== */
  function update(){
    if(!gameStarted) return;

    if(gameState==='introWalk'){
      const t = clamp((performance.now()-introStart)/1200,0,1);
      const sx=-24, ex=56;
      playerX = sx + (ex-sx)*t;
      playerY = groundY-16;
      if(t>=1){
        gameState='introDialog';
        showDialog([
          "ÏïàÎÖï?",
          "ÎÇòÎäî ÎÑàÏïº.",
          "Ìïú Î≤à Í±∏Ïñ¥Î≥ºÍπå?",
          "Ï†ÄÍ∏∞ ÏÜåÌåå Î≥¥Ïù¥ÏßÄ?"
        ],()=>{
          gameState='freeSofa';
        });
      }
      return;
    }

    if(gameState==='freeSofa'){
      let ax=0;
      if(moveLeft) ax-=0.14;
      if(moveRight) ax+=0.14;
      playerVX+=ax;
      playerVX*=0.85;
      playerX+=playerVX;

      if(playerX<8){
        playerX=8;
        playerVX=0;
      }
      if(playerX>W-24){
        playerX=W-24;
        playerVX=0;
      }

      if(playerX>sofaX-12 && actionPressed){
        sitSofa();
      }
      return;
    }

    if(gameState==='freeBlob'){
      let ax=0;
      if(moveLeft) ax-=0.14;
      if(moveRight) ax+=0.14;
      playerVX+=ax;
      playerVX*=0.85;
      playerX+=playerVX;

      if(playerX<8){
        playerX=8;
        playerVX=0;
      }
      if(playerX>W-24){
        playerX=W-24;
        playerVX=0;
      }

      if(Math.abs(playerX - W/2) < 20 && actionPressed){
        enterBlob();
      }
      return;
    }

    if(gameState==='maze'){
      let dx=0,dy=0;
      if(moveLeft) dx-=mazeSpeed;
      if(moveRight) dx+=mazeSpeed;
      if(moveUp) dy-=mazeSpeed;
      if(moveDown) dy+=mazeSpeed;

      const nx=mazePlayerX+dx;
      const ny=mazePlayerY+dy;

      if(!isWall(nx,mazePlayerY)) mazePlayerX=nx;
      if(!isWall(mazePlayerX,ny)) mazePlayerY=ny;

      checkMazeBlobs();
      return;
    }

    if(gameState==='mazeDialog' || gameState==='blobVideo' || gameState==='blobVideoBlack'){
      // Ï†ïÏßÄ ÏÉÅÌÉú
      return;
    }
  }

  /* ==== Í∑∏Î¶¨Í∏∞ ==== */
  function drawSide(){
    const ctx=gctx;
    ctx.fillStyle='#05210f';
    ctx.fillRect(0,0,W,H);

    ctx.fillStyle='#0b2f18';
    ctx.fillRect(0,groundY,W,H-groundY);

    // ÏÜåÌåå
    ctx.save();
    ctx.translate(sofaX, groundY-sofaHeight);
    ctx.fillStyle='#e8c93b';
    ctx.fillRect(0,8,sofaWidth,sofaHeight-8);
    ctx.restore();

    drawRedRabbit(ctx, playerX, playerY, 3);
  }

  function drawMaze(){
    const ctx=gctx;
    ctx.fillStyle='#001307';
    ctx.fillRect(0,0,W,H);

    for(let y=0;y<mazeMap.length;y++){
      for(let x=0;x<mazeMap[0].length;x++){
        const t=mazeMap[y].charAt(x);
        const px=x*tileSize;
        const py=y*tileSize;
        if(t==='1'){
          ctx.fillStyle='#062711';
          ctx.fillRect(px,py,tileSize,tileSize);
        }else{
          ctx.fillStyle='#07351a';
          ctx.fillRect(px,py,tileSize,tileSize);
        }
      }
    }

    // Î∏îÎûôÌôÄ
    mazeBlobs.forEach(b=>{
      const cx=(b.tx+0.5)*tileSize;
      const cy=(b.ty+0.5)*tileSize;
      ctx.beginPath();
      ctx.arc(cx,cy,5,0,Math.PI*2);
      ctx.fillStyle='#000';
      ctx.fill();
      ctx.strokeStyle='rgba(190,230,190,0.8)';
      ctx.stroke();
    });

    drawRedRabbit(ctx, mazePlayerX-6, mazePlayerY-6, 1.2);
  }

  function drawBlobVideoFrame(){
    const ctx=gctx;
    ctx.clearRect(0,0,W,H);
    drawRedRabbit(ctx, W/2-12, H-40, 3);
  }

  function draw(){
    if(gameState==='maze' || gameState==='mazeDialog'){
      drawMaze();
      return;
    }
    if(gameState==='blobVideo'){
      drawBlobVideoFrame();
      return;
    }
    if(gameState==='blobVideoBlack'){
      gctx.fillStyle='#000';
      gctx.fillRect(0,0,W,H);
      return;
    }
    drawSide();
  }

  /* ==== ÎØ∏Î°ú Î∏îÎûôÌôÄ Ï≤òÎ¶¨ ==== */
  function checkMazeBlobs(){
    for(let i=0;i<mazeBlobs.length;i++){
      if(blobVisited[i]) continue;
      const b=mazeBlobs[i];
      const cx=(b.tx+0.5)*tileSize;
      const cy=(b.ty+0.5)*tileSize;
      const dx=mazePlayerX-cx;
      const dy=mazePlayerY-cy;
      const dist=Math.hypot(dx,dy);
      if(dist<10){
        blobVisited[i]=true;
        currentBlobIndex=i;
        showMazeBlobDialog(i);
        break;
      }
    }
  }

  function showMazeBlobDialog(i){
    gameState='mazeDialog';
    showDialog(["Ïñ¥Ïñ¥..? ÏÜåÎ¶¨Í∞Ä Îì§Î¶∞Îã§."],()=>{
      showBlobChoices(i);
    });
  }

  function showBlobChoices(i){
    dialogChoices.innerHTML='';
    dialogChoices.classList.remove('hidden');
    dialogNext.classList.add('hidden');

    const b1=document.createElement('button');
    b1.className='uiBtn';
    b1.textContent='Îì§Ïñ¥Î≥¥Í∏∞';
    b1.onclick=()=>playBlobStory(i);

    const b2=document.createElement('button');
    b2.className='uiBtn';
    b2.textContent='Î¨¥ÏãúÌïòÍ∏∞';
    b2.onclick=()=>{
      dialogBar.classList.add('hidden');
      gameState='maze';
    };

    dialogChoices.appendChild(b1);
    dialogChoices.appendChild(b2);
  }

  const blobStories=[
    "Ïù¥Í≥≥Ïù¥ ÎÇòÎ•º ÏõêÌïòÏßÄ ÏïäÎäîÎã§Î©¥ Ïñ¥Ï©î Ïàò ÏóÜÏñ¥Ïöî. ÌïòÏßÄÎßå Ï†ÄÎäî ÏÑ†ÌÉùÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§. Ïù¥Í≥≥Ïóê Î®∏Î¨¥Îäî Í≤ÉÎ∞ñÏóê.",
    "ÌëúÎ∞±Í≥µÏû•Ïùò ÎçîÎü¨Ïö¥ Î¨ºÏù¥ Î∞©Î•òÎêòÏñ¥ ÎßàÏùÑÍ≥º Í∞ïÏúºÎ°ú ÌùòÎü¨Îì†Îã§.",
    "Í±∞ÎåÄÌïú Ïì∞Î†àÍ∏∞ ÏÇ∞ ÏúÑÏóê ÍπåÎßàÍ∑ÄÍ∞Ä Îß¥ÎèåÍ≥† Îì§Í∞úÍ∞Ä ÏûîÌï¥Î•º Î¨ºÏñ¥ÎúØÎäîÎã§.",
    "GPSÎ•º ÎÑ£ÏùÄ Ïã†Î∞úÏùÄ 3500kmÎ•º Ïù¥ÎèôÌñàÎã§.",
    "Î∂ïÎåÄÎäî Î∞úÍ∞ÄÎùΩ ÎåÄÏã† Î™∏Ïùò Í∑†ÌòïÏùÑ Ïû°ÏïÑÏ§ÄÎã§."
  ];

  function playBlobStory(i){
    dialogChoices.classList.add('hidden');
    dialogNext.classList.remove('hidden');
    showDialog([blobStories[i]],()=>{
      askEnter(i);
    });
  }

  function askEnter(i){
    showDialog(["Îì§Ïñ¥Í∞ÄÎ≥ºÍπå?"],()=>{
      dialogChoices.innerHTML='';
      dialogChoices.classList.remove('hidden');
      dialogNext.classList.add('hidden');

      const b1=document.createElement('button');
      b1.className='uiBtn';
      b1.textContent='Îì§Ïñ¥Í∞ÄÏßÄ';
      b1.onclick=()=>startBlobVideo(i);

      const b2=document.createElement('button');
      b2.className='uiBtn';
      b2.textContent='Îçî ÎëòÎü¨Î≥¥Í∏∞';
      b2.onclick=()=>{
        dialogBar.classList.add('hidden');
        gameState='maze';
      };

      dialogChoices.appendChild(b1);
      dialogChoices.appendChild(b2);
    });
  }

  function getBlobVideoSrc(i){
    return `video/blob${i+1}.mp4`;
  }

  function startBlobVideo(i){
    dialogBar.classList.add('hidden');
    musicRunning=false;
    startVideoAmbientMusic();

    const src=getBlobVideoSrc(i);
    docVideo.src=src;
    docVideo.classList.remove('hidden');

    ensureResumed().then(()=> docVideo.play().catch(()=>{}));

    docVideo.onended=()=>{
      docVideo.classList.add('hidden');
      gameState='blobVideoBlack';
      musicRunning=false;
    };

    gameState='blobVideo';
  }

  /* ==== ÏÜåÌåå ==== */
  function sitSofa(){
    gameState='sofaDialog';
    showDialog([
      "Ï¢ãÏïÑ, ÏïâÏïòÎÑ§?",
      "Ï†ú 2Ïû•Ïóê Îì§Ïñ¥Í∞ÄÎ≥¥Ïûê.",
      "ÍøÄÎ†ÅÏù¥Î•º ÎàåÎü¨Ï§ò."
    ],()=>{
      gameState='freeBlob';
    });
  }

  /* ==== ÍøÄÎ†ÅÏù¥ ÏûÖÏû• ==== */
  function enterBlob(){
    dialogBar.classList.add('hidden');
    stageFade.classList.remove('hidden');
    requestAnimationFrame(()=> stageFade.style.opacity='1');

    musicRunning=false;
    startDarkMusic();

    setTimeout(()=>{
      stageFade.style.opacity='0';
      setTimeout(()=> stageFade.classList.add('hidden'),800);

      mazePlayerX=(mazeStartTile.tx-1)*tileSize;
      mazePlayerY=mazeStartY;
      gameState='maze';
    },900);
  }

  /* ==== Î©îÏù∏ Î£®ÌîÑ ==== */
  function loop(){
    update();
    draw();
    requestAnimationFrame(loop);
  }

  /* ==== ÏãúÏûë ÏÑ∏ÌåÖ ==== */
  window.addEventListener('load', async ()=>{
    ensureAudio();
    await ensureResumed();

    gameLayout.classList.remove('hidden');
    hudLeft.classList.remove('hidden');
    hudRight.classList.remove('hidden');

    introStart = performance.now();
    gameStarted = true;
    startBrightMusic();
  });

  // üî• Ïó¨Í∏∞ÏÑú Î£®ÌîÑÎ•º Ïã§Ï†úÎ°ú ÎèåÎ†§Ï§å
  loop();

})();
</script>
</body>
</html>
