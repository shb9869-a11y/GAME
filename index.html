<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no">
<title>Polycam Style Scanner</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#000;
  font-family:sans-serif;
}

/* ğŸ”¥ ì¹´ë©”ë¼ ì˜ìƒ: í™”ë©´ì— ë³´ì´ê²Œ */
#video{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  object-fit:cover;
  z-index:0;
}

/* ìŠ¤ìºë‹ ê·¸ë¦¬ê¸° ë ˆì´ì–´ */
#scanCanvas{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  pointer-events:none;
  z-index:1;
}

/* ê²°ê³¼ 3D í™”ë©´ */
#modelCanvas{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  display:none;
  z-index:2;
}

#startBtn, #confirmBtn{
  position:fixed;
  bottom:40px;
  padding:18px 26px;
  border-radius:30px;
  border:none;
  font-size:17px;
  z-index:10;
}

#startBtn{
  left:50%; transform:translateX(-50%);
  background:#fff;color:#000;
}

#confirmBtn{
  right:40px;
  background:#3a7bff;color:#fff;
  display:none;
}

#status{
  position:fixed;
  top:20px;
  left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.4);
  padding:8px 18px;
  border-radius:20px;
  color:#fff;
  z-index:10;
}
</style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>
<canvas id="scanCanvas"></canvas>
<canvas id="modelCanvas"></canvas>

<div id="status">ìŠ¤ìº” ì¤€ë¹„ ì¤‘...</div>
<button id="startBtn">ì „ì²´í™”ë©´ ì‹œì‘</button>
<button id="confirmBtn">í™•ì¸</button>

<script>
/* -----------------------------
 * 1. ì „ì²´í™”ë©´ ì‹œì‘
 * --------------------------- */
const startBtn   = document.getElementById("startBtn");
const confirmBtn = document.getElementById("confirmBtn");
const statusDiv  = document.getElementById("status");

startBtn.onclick = async () => {
  try{ await document.documentElement.requestFullscreen(); }catch(e){}
  startBtn.style.display="none";
  statusDiv.textContent = "ìŠ¤ìº” ì¤‘...";
  if(audioCtx.state==="suspended") audioCtx.resume();
};

/* -----------------------------
 * 2. ì¹´ë©”ë¼ ì¼œê¸°
 * --------------------------- */
const video = document.getElementById("video");
navigator.mediaDevices.getUserMedia({
  video:{ facingMode:"environment" },
  audio:false
}).then(stream => video.srcObject = stream);

/* -----------------------------
 * 3. ìº”ë²„ìŠ¤ ì¤€ë¹„
 * --------------------------- */
const scanCanvas = document.getElementById("scanCanvas");
const sCtx = scanCanvas.getContext("2d");

const modelCanvas = document.getElementById("modelCanvas");
const mCtx = modelCanvas.getContext("2d");

function resize(){
  scanCanvas.width = innerWidth;
  scanCanvas.height = innerHeight;
  modelCanvas.width = innerWidth;
  modelCanvas.height = innerHeight;
}
resize();
window.addEventListener("resize", resize);

/* -----------------------------
 * 4. ì°°ì¹µ ì‚¬ìš´ë“œ (mp3 ì—†ì´ ìƒì„±)
 * --------------------------- */
const AudioContextClass = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContextClass();

function playClick(){
  try{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type="square";
    o.frequency.value=2000;
    g.gain.value=0.4;
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.07);
    o.connect(g).connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime+0.07);
  }catch(e){}
}

/* -----------------------------
 * 5. ìŠ¤ìº” ë°ì´í„° ì €ì¥
 * --------------------------- */
let pointCloud = [];  // {x,y,z,r,g,b}
let lastFeatureCount = 0;
let scanning = true;

/* íŠ¹ì§•ì  ì¶”ì¶œ (ê°„ë‹¨ ë²„ì „) */
function extractFeatures(img){
  const pts=[];
  const data = img.data;
  const w = img.width;

  for(let i=0;i<data.length;i+=16){
    const sum=data[i]+data[i+1]+data[i+2];
    if(sum <80 || sum>700){
      const idx=i/4;
      pts.push({x:idx%w, y:Math.floor(idx/w)});
    }
  }
  return pts;
}

function addPoints(features,img,tw,th){
  const d=img.data;
  for(let i=0;i<features.length;i+=2){
    const f = features[i];
    const px = f.x;
    const py = f.y;

    const idx = (py*tw + px)*4;
    const r=d[idx], g=d[idx+1], b=d[idx+2];

    pointCloud.push({
      x:(px/tw -0.5)*2,
      y:(py/th -0.5)*2,
      z:(Math.random()-0.5)*2,
      r,g,b
    });

    if(pointCloud.length>3500) pointCloud.shift();
  }
}

/* -----------------------------
 * 6. ìŠ¤ìº” í™”ë©´(ì¹´ë©”ë¼ ìœ„ì— ê²¹ì¹¨)
 * --------------------------- */
function drawScan(){
  const w=scanCanvas.width, h=scanCanvas.height;
  sCtx.clearRect(0,0,w,h);

  // ì 
  for(const p of pointCloud){
    const sx=(p.x*0.5+0.5)*w;
    const sy=(p.y*0.5+0.5)*h;
    sCtx.fillStyle=`rgba(${p.r},${p.g},${p.b},1)`;
    sCtx.fillRect(sx, sy, 2, 2);
  }

  // ì„ (ê·¼ì ‘í•œ ì ë¼ë¦¬)
  sCtx.strokeStyle="rgba(0,255,255,0.4)";
  for(let i=0;i<pointCloud.length;i+=3){
    for(let j=i+1;j<i+6 && j<pointCloud.length;j++){
      const p1=pointCloud[i], p2=pointCloud[j];
      const dx=p1.x-p2.x, dy=p1.y-p2.y, dz=p1.z-p2.z;
      if(dx*dx+dy*dy+dz*dz<0.2){
        sCtx.beginPath();
        sCtx.moveTo((p1.x*0.5+0.5)*w,(p1.y*0.5+0.5)*h);
        sCtx.lineTo((p2.x*0.5+0.5)*w,(p2.y*0.5+0.5)*h);
        sCtx.stroke();
      }
    }
  }
}

/* -----------------------------
 * 7. ìŠ¤ìº” ë£¨í”„
 * --------------------------- */
function scanLoop(){
  if(!scanning) return;

  if(video.readyState>=2){
    const tw=200, th=150;
    const temp=document.createElement("canvas");
    temp.width=tw; temp.height=th;
    const tctx=temp.getContext("2d");
    tctx.drawImage(video,0,0,tw,th);
    const frame=tctx.getImageData(0,0,tw,th);

    const features=extractFeatures(frame);
    const diff=Math.abs(features.length-lastFeatureCount);

    if(diff>40){
      playClick();
      addPoints(features,frame,tw,th);
    }

    lastFeatureCount=features.length;

    drawScan();
    confirmBtn.style.display="block";
  }

  requestAnimationFrame(scanLoop);
}
requestAnimationFrame(scanLoop);

/* -----------------------------
 * 8. í™•ì¸ â†’ 3D ê²°ê³¼ í™”ë©´
 * --------------------------- */
confirmBtn.onclick = ()=>{
  scanning=false;
  scanCanvas.style.display="none";
  modelCanvas.style.display="block";
  statusDiv.textContent="3D ëª¨ë¸";

  show3DModel();
};

/* -----------------------------
 * 9. 3D ëª¨ë¸ ë·°ì–´ (ì»¬ëŸ¬ í¬ì¸íŠ¸í´ë¼ìš°ë“œ)
 * --------------------------- */
let angle=0;
function show3DModel(){

  function loop(){
    const w=modelCanvas.width, h=modelCanvas.height;
    const cx=w/2, cy=h/2;
    const scale=Math.min(w,h)*0.45;

    mCtx.clearRect(0,0,w,h);
    mCtx.fillStyle="#000";
    mCtx.fillRect(0,0,w,h);

    const cosA=Math.cos(angle), sinA=Math.sin(angle);

    for(const p of pointCloud){
      const x = p.x*cosA - p.z*sinA;
      const z = p.x*sinA + p.z*cosA;
      const y = p.y;

      const depth=(z+3)/2.2;
      const sx=cx + x*scale/depth;
      const sy=cy + y*scale/depth;

      mCtx.fillStyle=`rgba(${p.r},${p.g},${p.b},${1-depth/3})`;
      mCtx.beginPath();
      mCtx.arc(sx,sy,2/depth,0,Math.PI*2);
      mCtx.fill();
    }

    angle+=0.003;
    requestAnimationFrame(loop);
  }

  requestAnimationFrame(loop);
}
</script>
</body>
</html>