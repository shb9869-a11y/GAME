<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>TOEM-style Island Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- 홈 화면 추가용 (PWA 최소 설정) -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
  *{box-sizing:border-box;margin:0;padding:0;}

  :root{
    --camX: 0px;
    --camY: 0px;
  }

  body{
    background:#000;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    color:#fff;
    overscroll-behavior:none;
  }

  /* 가로 모드 안내 */
  .rotate-warning{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:#000;
    color:#fff;
    font-size:18px;
    text-align:center;
    padding:20px;
    z-index:1000;
  }

  .game-root{
    position:relative;
    width: 900px;
    height: 520px;
    background:#cfd2d6; /* TOEM 느낌의 회색 하늘/물 */
    overflow:hidden;
    border-radius:16px;
    box-shadow:0 0 40px rgba(0,0,0,0.8);
  }

  @media (orientation:portrait){
    .game-root{display:none;}
    .rotate-warning{display:flex;}
  }
  @media (orientation:landscape){
    .game-root{display:block;}
  }

  /* 전체 월드 (카메라 pan) */
  .world{
    position:absolute;
    left:50%;
    top:55%;
    width:800px;
    height:480px;
    transform:translate(calc(-50% + var(--camX)),
                        calc(-50% + var(--camY)));
    transition:transform .18s ease-out;
    pointer-events:none;
  }

  .scene-layer{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  /* ===== 섬 / 플랫폼 (TOEM식 공간) ===== */

  /* 큰 섬 바닥 */
  .island{
    position:absolute;
    left:50%;
    top:58%;
    width:520px;
    height:260px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#f4f4f4;
    border:4px solid #000;
    box-shadow:0 22px 0 #000;
  }
  .island::after{
    /* 주변에 잔잔한 물결 느낌 */
    content:"";
    position:absolute;
    inset:-20px;
    border:1px dashed rgba(0,0,0,0.15);
    pointer-events:none;
  }

  /* 위쪽 높은 플랫폼 (집 있는 곳) */
  .plateau{
    position:absolute;
    left:50%;
    top:35%;
    width:300px;
    height:160px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#f7f7f7;
    border:4px solid #000;
    box-shadow:0 18px 0 #000;
  }

  /* 계단 램프(간단한 사다리꼴) */
  .stairs{
    position:absolute;
    left:50%;
    top:46%;
    width:90px;
    height:70px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#e0e0e0;
    border:3px solid #000;
    box-shadow:0 8px 0 #000;
  }

  /* 집 */
  .house{
    position:absolute;
    left:50%;
    top:27%;
    width:160px;
    height:90px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#fdfdfd;
    border:4px solid #000;
    box-shadow:0 12px 0 #000;
  }
  .house-roof{
    position:absolute;
    left:50%;
    top:16%;
    width:190px;
    height:60px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#333;
    border:4px solid #000;
  }

  /* 집 문 (문으로 들어가는 포인트) */
  .house-door{
    position:absolute;
    left:50%;
    top:35%;
    width:40px;
    height:40px;
    transform:translateX(-50%) skewY(-26deg);
    background:#000;
    border:3px solid #000;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .house-door span{
    transform:skewY(26deg);
    color:#fff;
    font-size:10px;
    letter-spacing:0.1em;
  }

  /* 나무들(간단히) */
  .tree{
    position:absolute;
    width:50px;
    height:130px;
    transform-origin:center bottom;
  }
  .tree-trunk{
    position:absolute;
    left:50%;
    bottom:0;
    width:10px;
    height:50px;
    transform:translateX(-50%);
    background:#555;
    border:3px solid #000;
  }
  .tree-crown{
    position:absolute;
    left:50%;
    bottom:40px;
    width:60px;
    height:50px;
    transform:translateX(-50%);
    background:#e0e0e0;
    border:3px solid #000;
    border-radius:30px;
  }

  /* 두 번째 씬: 물가 섬의 간이 플랫폼 */
  .dock-platform{
    position:absolute;
    left:50%;
    top:60%;
    width:460px;
    height:230px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#f6f6f6;
    border:4px solid #000;
    box-shadow:0 18px 0 #000;
  }

  .dock-ramp{
    position:absolute;
    left:28%;
    top:72%;
    width:120px;
    height:90px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#e3e3e3;
    border:3px solid #000;
    box-shadow:0 10px 0 #000;
  }

  /* 두 번째 씬 문 (섬 한쪽에 세운 기둥문) */
  .dock-door{
    position:absolute;
    right:16%;
    top:46%;
    width:60px;
    height:80px;
    transform:skewY(-26deg);
    background:#000;
    border:4px solid #000;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .dock-door span{
    transform:skewY(26deg);
    color:#fff;
    font-size:10px;
    letter-spacing:0.1em;
  }

  /* 플레이어 */
  .player{
    position:absolute;
    width:32px;
    height:48px;
    transform-origin:center bottom;
  }
  .player .shadow{
    position:absolute;
    left:50%;
    bottom:0;
    width:32px;
    height:12px;
    transform:translateX(-50%);
    background:radial-gradient(ellipse at center,
             rgba(0,0,0,0.45) 0, transparent 70%);
  }
  .player .body{
    position:absolute;
    left:50%;
    bottom:14px;
    transform:translateX(-50%);
    width:24px;
    height:22px;
    border-radius:4px;
    background:#fff;
    border:3px solid #000;
  }
  .player .head{
    position:absolute;
    left:50%;
    bottom:34px;
    transform:translateX(-50%);
    width:18px;
    height:18px;
    border-radius:50%;
    background:#fff;
    border:3px solid #000;
  }

  /* 문 근처에서 보여줄 작은 말풍선 */
  .door-hint{
    position:absolute;
    transform:translate(-50%,-100%);
    padding:4px 8px;
    border-radius:8px;
    border:2px solid #000;
    background:#000;
    color:#fff;
    font-size:10px;
    letter-spacing:0.08em;
  }

  /* 동그라미 조이스틱 – 왼쪽 아래 */
  .joystick{
    position:absolute;
    left:40px;
    bottom:40px;
    width:140px;
    height:140px;
    z-index:30;
  }
  .joystick-base{
    position:absolute;
    left:50%;
    top:50%;
    width:110px;
    height:110px;
    transform:translate(-50%,-50%);
    border-radius:50%;
    border:3px solid #fff;
    background:rgba(255,255,255,0.05);
    box-shadow:0 4px 0 #000;
  }
  .joystick-knob{
    position:absolute;
    left:50%;
    top:50%;
    width:50px;
    height:50px;
    transform:translate(-50%,-50%);
    border-radius:50%;
    background:#ffffff;
    border:3px solid #000;
    box-shadow:0 3px 0 #000;
  }

  .log{
    position:absolute;
    left:10px;
    top:10px;
    font-size:12px;
    color:#333;
    background:rgba(255,255,255,0.8);
    padding:4px 8px;
    border-radius:6px;
    border:2px solid #000;
    z-index:40;
  }

  .fade-overlay{
    position:absolute;
    inset:0;
    background:#000;
    opacity:0;
    pointer-events:none;
    transition:opacity .5s ease;
    z-index:50;
  }
  .fade-overlay.active{
    opacity:1;
    pointer-events:auto;
  }
</style>
</head>
<body>

<div class="rotate-warning">
  이 게임은 <strong>가로 모드</strong>에서 즐겨 주세요.<br><br>
  기기를 가로로 돌려 주세요.
</div>

<div class="game-root">
  <div class="world" id="world">
    <div class="scene-layer" id="sceneLayer">
      <!-- 씬은 JS에서 그림 -->
    </div>
    <div class="scene-layer">
      <div class="player" id="player">
        <div class="shadow"></div>
        <div class="body"></div>
        <div class="head"></div>
      </div>
    </div>
  </div>

  <!-- 동그라미 조이스틱 -->
  <div class="joystick" id="joystick">
    <div class="joystick-base"></div>
    <div class="joystick-knob" id="joystickKnob"></div>
  </div>

  <div class="log" id="log">
    숲 섬을 자유롭게 걸어 다니다가, 오두막 문(검은 직사각형) 쪽으로 다가가 보세요.
  </div>

  <div class="fade-overlay" id="fade"></div>
</div>

<script>
  /*********** 씬(섬) 정의 ***********/
  const worldEl   = document.getElementById('world');
  const sceneEl   = document.getElementById('sceneLayer');
  const playerEl  = document.getElementById('player');
  const logEl     = document.getElementById('log');
  const fadeEl    = document.getElementById('fade');

  const tileW = 64;
  const tileH = 32;
  const originX = 360;
  const originY = 80;

  // 방바닥 좌표계 (x,y) – 섬 안을 직사각형으로 제한
  const scenes = {
    yard: {
      key:'yard',
      limitX: 4.0,
      limitY: 4.5,
      door: {            // 집 문 위치 (월드 좌표)
        x: 0,
        y: -3.3,
        target:'dock'
      },
      trees: [
        {x:-3.3,y: 1.5},
        {x:-2.0,y: 2.2},
        {x: 2.8,y: 1.7},
        {x: 3.2,y:-0.5},
        {x:-2.8,y:-0.8}
      ]
    },
    dock: {
      key:'dock',
      limitX: 4.2,
      limitY: 3.2,
      door: {            // 부두 섬에서 야드로 넘어가는 문
        x: 3.1,
        y:-0.4,
        target:'yard'
      },
      trees: [
        {x:-2.5,y: 1.2},
        {x:-3.0,y:-0.4},
        {x:-1.0,y: 1.8}
      ]
    }
  };

  let currentSceneKey = 'yard';
  let currentScene = scenes[currentSceneKey];

  function buildScene(){
    sceneEl.innerHTML = '';

    if(currentSceneKey === 'yard'){
      // 큰 섬 + 높은 플랫폼 + 집
      const island = document.createElement('div');
      island.className = 'island';
      sceneEl.appendChild(island);

      const plateau = document.createElement('div');
      plateau.className = 'plateau';
      sceneEl.appendChild(plateau);

      const stairs = document.createElement('div');
      stairs.className = 'stairs';
      sceneEl.appendChild(stairs);

      const house = document.createElement('div');
      house.className = 'house';
      sceneEl.appendChild(house);

      const roof = document.createElement('div');
      roof.className = 'house-roof';
      sceneEl.appendChild(roof);

      const door = document.createElement('div');
      door.className = 'house-door';
      door.innerHTML = '<span>EXIT</span>';
      sceneEl.appendChild(door);
    }else{
      // 부두 섬
      const dock = document.createElement('div');
      dock.className = 'dock-platform';
      sceneEl.appendChild(dock);

      const ramp = document.createElement('div');
      ramp.className = 'dock-ramp';
      sceneEl.appendChild(ramp);

      const ddoor = document.createElement('div');
      ddoor.className = 'dock-door';
      ddoor.innerHTML = '<span>EXIT</span>';
      sceneEl.appendChild(ddoor);
    }

    // 나무들
    currentScene.trees.forEach(t=>{
      const tree = document.createElement('div');
      tree.className = 'tree';
      const trunk = document.createElement('div');
      trunk.className = 'tree-trunk';
      const crown = document.createElement('div');
      crown.className = 'tree-crown';
      tree.appendChild(trunk);
      tree.appendChild(crown);
      const pos = worldToScreen(t.x, t.y);
      tree.style.left = pos.x + 'px';
      tree.style.top  = pos.y + 'px';
      tree.style.zIndex = 50 + Math.round(t.x + t.y);
      sceneEl.appendChild(tree);
    });
  }

  /*********** 좌표/카메라 ***********/
  let playerX = 0;
  let playerY = 0;
  let velX = 0;
  let velY = 0;
  const speed = 1.8;

  function worldToScreen(x, y){
    const isoX = (x - y) * (tileW/2);
    const isoY = (x + y) * (tileH/2);
    return {
      x: originX + isoX,
      y: originY + isoY + 80
    };
  }

  function clampToScene(){
    const lx = currentScene.limitX;
    const ly = currentScene.limitY;
    playerX = Math.max(-lx, Math.min(lx, playerX));
    playerY = Math.max(-ly, Math.min(ly, playerY));
  }

  function updatePlayerVisual(){
    const pos = worldToScreen(playerX, playerY);
    playerEl.style.left = pos.x + 'px';
    playerEl.style.top  = pos.y + 'px';
    playerEl.style.zIndex = 100 + Math.round(playerX + playerY);

    // 카메라: 플레이어 중심으로 살짝 이동
    const desiredX = 430;
    const desiredY = 260;
    const diffX = desiredX - pos.x;
    const diffY = desiredY - pos.y;
    const camX = diffX * 0.15;
    const camY = diffY * 0.15;
    document.documentElement.style.setProperty('--camX', camX + 'px');
    document.documentElement.style.setProperty('--camY', camY + 'px');
  }

  /*********** 문(door) 처리 ***********/
  let doorHintEl = null;

  function showDoorHint(screenPos){
    if(!doorHintEl){
      doorHintEl = document.createElement('div');
      doorHintEl.className = 'door-hint';
      doorHintEl.textContent = '문을 지나갑니다…';
      sceneEl.appendChild(doorHintEl);
    }
    doorHintEl.style.left = screenPos.x + 'px';
    doorHintEl.style.top  = (screenPos.y - 20) + 'px';
  }

  function hideDoorHint(){
    if(doorHintEl){
      doorHintEl.remove();
      doorHintEl = null;
    }
  }

  function checkDoor(){
    const door = currentScene.door;
    const dx = playerX - door.x;
    const dy = playerY - door.y;
    const dist = Math.hypot(dx, dy);

    if(dist < 0.9){
      const pos = worldToScreen(door.x, door.y);
      showDoorHint(pos);
      goToScene(door.target);
    }else if(dist > 1.5){
      hideDoorHint();
    }
  }

  function goToScene(key){
    fadeEl.classList.add('active');
    hideDoorHint();
    setTimeout(()=>{
      currentSceneKey = key;
      currentScene = scenes[currentSceneKey];
      buildScene();
      // 씬 바뀔 때 플레이어 시작 위치 설정
      if(key === 'dock'){
        playerX = -2.0;
        playerY = 1.5;
        logEl.textContent = '물가 섬에 도착했습니다. 섬을 걷다가 오른쪽 EXIT 기둥으로 가면 다시 돌아갈 수 있습니다.';
      }else{
        playerX = 0;
        playerY = 1.5;
        logEl.textContent = '숲 섬으로 돌아왔습니다. 오두막 문 근처로 가면 다시 다른 섬으로 갈 수 있습니다.';
      }
      clampToScene();
      updatePlayerVisual();
      fadeEl.classList.remove('active');
    }, 500);
  }

  /*********** 조이스틱 ***********/
  const joystick     = document.getElementById('joystick');
  const joystickKnob = document.getElementById('joystickKnob');
  let joyActive = false;
  let joyCenter = {x:0,y:0};
  let joyVector = {x:0,y:0};
  const joyMaxRadius = 45;

  function setJoyVector(clientX, clientY){
    const dx = clientX - joyCenter.x;
    const dy = clientY - joyCenter.y;
    const angle = Math.atan2(dy, dx);
    const dist  = Math.min(joyMaxRadius, Math.hypot(dx,dy));
    const nx = Math.cos(angle) * (dist/joyMaxRadius);
    const ny = Math.sin(angle) * (dist/joyMaxRadius);
    joyVector.x = nx;
    joyVector.y = ny;

    joystickKnob.style.left = 50 + (nx * 40) + '%';
    joystickKnob.style.top  = 50 + (ny * 40) + '%';
  }

  function resetJoystick(){
    joyVector.x = 0;
    joyVector.y = 0;
    joystickKnob.style.left = '50%';
    joystickKnob.style.top  = '50%';
  }

  // 조이스틱 영역에서만 기본 동작 막기 → 다른 곳은 꾹 눌러도 복사/선택 가능
  joystick.addEventListener('pointerdown', e=>{
    e.preventDefault();
    joyActive = true;
    const rect = joystick.getBoundingClientRect();
    joyCenter.x = rect.left + rect.width/2;
    joyCenter.y = rect.top  + rect.height/2;
    setJoyVector(e.clientX, e.clientY);
  });

  window.addEventListener('pointermove', e=>{
    if(!joyActive) return;
    e.preventDefault();
    setJoyVector(e.clientX, e.clientY);
  });

  window.addEventListener('pointerup', ()=>{
    if(!joyActive) return;
    joyActive = false;
    resetJoystick();
  });
  window.addEventListener('pointercancel', ()=>{
    if(!joyActive) return;
    joyActive = false;
    resetJoystick();
  });

  // 키보드 테스트용 (선택)
  window.addEventListener('keydown', e=>{
    if(e.key === 'ArrowUp')    joyVector.y = -1;
    if(e.key === 'ArrowDown')  joyVector.y =  1;
    if(e.key === 'ArrowLeft')  joyVector.x = -1;
    if(e.key === 'ArrowRight') joyVector.x =  1;
  });
  window.addEventListener('keyup', e=>{
    if(['ArrowUp','ArrowDown'].includes(e.key)) joyVector.y = 0;
    if(['ArrowLeft','ArrowRight'].includes(e.key)) joyVector.x = 0;
  });

  /*********** 메인 루프 ***********/
  let lastTime = performance.now();

  function loop(now){
    const dt = Math.min(0.05, (now - lastTime) / 1000);
    lastTime = now;

    velX = joyVector.x * speed;
    velY = joyVector.y * speed;

    playerX += velX * dt;
    playerY += velY * dt;

    clampToScene();
    updatePlayerVisual();
    checkDoor();

    requestAnimationFrame(loop);
  }

  /*********** 초기화 ***********/
  buildScene();
  clampToScene();
  updatePlayerVisual();
  requestAnimationFrame(loop);

  // 서비스워커(선택) – sw.js를 같은 폴더에 두면 홈화면 앱처럼 캐시 가능
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('sw.js').catch(console.error);
    });
  }
</script>

</body>
</html>