<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,interactive-widget=resizes-content">
<title>SLEEEEEEEP – THE SECOND SLEEP</title>

<!-- 픽셀 게임 폰트 -->
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEP">
<meta name="theme-color" content="#000000">

<style>
:root{
  --appH: 100svh;
  --frame: clamp(16px, 4vmin, 40px);
  --ui-gap: 8px;

  --fs-body: clamp(12px, 2.2vmin, 16px);
  --fs-strong: clamp(14px, 2.8vmin, 20px);
  --fs-small: clamp(11px, 1.8vmin, 14px);

  --pad-btn-y: clamp(6px, 1.1vmin, 10px);
  --pad-btn-x: clamp(10px, 1.8vmin, 20px);

  --safe-t: env(safe-area-inset-top, 0px);
  --safe-b: env(safe-area-inset-bottom, 0px);
  --safe-l: env(safe-area-inset-left, 0px);
  --safe-r: env(safe-area-inset-right, 0px);

  --accent: #f5f5f5;
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  -webkit-user-select:none;
  user-select:none;
  -webkit-touch-callout:none;
  -webkit-tap-highlight-color: transparent;
}

html, body{
  width:100%;
  height:100%;
  overflow:hidden;
  touch-action:manipulation;
}

body{
  background:#000;
  color:var(--accent);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans KR",sans-serif;
}

input, textarea{
  -webkit-user-select:text;
  user-select:text;
}

/* 공통 버튼 */
.uiBtn{
  background:transparent;
  color:var(--accent);
  border:1px solid rgba(245,245,245,0.8);
  font-size:var(--fs-small);
  padding:var(--pad-btn-y) var(--pad-btn-x);
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  white-space:nowrap;
  cursor:pointer;
}
.uiBtn.flat{
  border:none;
  background:transparent;
}
.uiBtn[disabled]{
  opacity:0.4;
  pointer-events:none;
}

/* 프레임 박스 */
.frameBox{
  position:fixed;
  left:calc(var(--frame) + var(--safe-l));
  top:calc(var(--frame) + var(--safe-t));
  right:calc(var(--frame) + var(--safe-r));
  bottom:calc(var(--frame) + var(--safe-b));
  border:2px solid rgba(245,245,245,0.85);
  z-index:5;
  pointer-events:none;
}

/* 회전 안내 */
#rotateOverlay{
  position:fixed;
  inset:0;
  z-index:2000;
  display:none;
  align-items:center;
  justify-content:center;
  text-align:center;
  background:#000;
  color:var(--accent);
  padding:40px;
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
}

/* 시작 게이트 */
#startOverlay{
  position:fixed;
  inset:0;
  z-index:1500;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.9);
  color:var(--accent);
  text-align:center;
  padding:24px;
}
#startInner{
  max-width:72ch;
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  line-height:1.8;
}

/* 중앙 꿀렁이 (전체 배경) */
#blobCanvas{
  position:fixed;
  inset:0;
  z-index:0;
  width:100vw;
  height:100vh;
  display:block;
  image-rendering:pixelated;
}

/* 2장 타이틀 */
#titleOverlay{
  position:fixed;
  inset:0;
  z-index:30;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}
.sleepLine{
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  letter-spacing:.16em;
  font-size:clamp(32px, 9vmin, 110px);
  text-transform:uppercase;
  white-space:nowrap;
  text-shadow:0 0 8px rgba(0,0,0,0.85);
}

/* 게임 카드 (인트로 카드 위치에 맞게, 팝업 느낌) */
#gameLayout{
  position:fixed;
  inset:0;
  z-index:20;
  padding:calc(var(--frame) + var(--safe-t))
           calc(var(--frame) + var(--safe-r))
           calc(var(--frame) + var(--safe-b) + 90px)
           calc(var(--frame) + var(--safe-l));
  display:flex;
  align-items:center;           /* 중앙 정렬 */
  justify-content:center;
  pointer-events:none;          /* 실제 입력은 캔버스, HUD에만 */
}
#gameCard{
  width:100%;
  max-width:1120px;
  height:auto;
  background:transparent;
  display:flex;
  align-items:center;
  justify-content:center;
}
#gameScreenWrap{
  position:relative;
  width:100%;
  max-width:720px;
  aspect-ratio:16/9;
  background:#050505;
  border:1px solid rgba(245,245,245,0.4);
  box-shadow:0 0 0 2px rgba(0,0,0,0.85), 0 0 30px rgba(0,0,0,0.9);
  overflow:hidden;
  pointer-events:auto;
}
#gameCanvas{
  width:100%;
  height:100%;
  display:block;
  image-rendering:pixelated;
}

/* 닉네임 라벨 */
#nameTag{
  position:absolute;
  left:8px;
  top:8px;
  padding:4px 8px;
  background:rgba(0,0,0,0.6);
  border:1px solid rgba(245,245,245,0.7);
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  font-size:clamp(9px,1.6vmin,12px);
}

/* 대화창 */
#dialogBar{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:calc(var(--frame) + var(--safe-b) + 10px);
  z-index:30;
  max-width:1120px;
  width:calc(100vw - 2*(var(--frame) + var(--safe-l)));
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  padding:10px 12px;
  background:rgba(0,0,0,0.9);
  border:1px solid rgba(245,245,245,0.6);
  box-shadow:0 0 18px rgba(0,0,0,0.9);
}
#dialogTextWrap{
  flex:1;
}
#dialogText{
  font-family:"Courier New",ui-monospace,monospace;
  font-size:clamp(11px,2.0vmin,14px);
  line-height:1.7;
  white-space:pre-wrap;
}
#dialogHint{
  margin-top:4px;
  font-size:clamp(10px,1.8vmin,13px);
  opacity:0.7;
}
#dialogNext{
  flex:0 0 auto;
}

/* HUD – 방향키 & 액션 버튼 (프레임 밖) */
#hudLeft{
  position:fixed;
  left:calc(var(--frame) + var(--safe-l));
  bottom:calc(var(--frame) + var(--safe-b));
  z-index:40;
}
#hudRight{
  position:fixed;
  right:calc(var(--frame) + var(--safe-r));
  bottom:calc(var(--frame) + var(--safe-b));
  z-index:40;
}

/* D-Pad */
.dpad{
  width:96px;
  height:96px;
  position:relative;
}
.dpad button{
  position:absolute;
  width:32px;
  height:32px;
  border-radius:6px;
  border:1px solid rgba(245,245,245,0.8);
  background:rgba(0,0,0,0.85);
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  font-size:10px;
  color:var(--accent);
  cursor:pointer;
}
.dpad button:active{
  background:#f5f5f5;
  color:#000;
}
.dpad-up{    left:32px; top:0; }
.dpad-down{  left:32px; bottom:0; }
.dpad-left{  left:0; top:32px; }
.dpad-right{ right:0; top:32px; }

/* 액션 버튼 */
#actionBtn{
  width:72px;
  height:72px;
  border-radius:50%;
  border:2px solid rgba(245,245,245,0.9);
  background:rgba(156,31,60,0.95);
  color:#fff;
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  font-size:11px;
  cursor:pointer;
  box-shadow:0 4px 0 rgba(0,0,0,0.9);
}
#actionBtn:active{
  transform:translateY(2px);
  box-shadow:0 2px 0 rgba(0,0,0,0.9);
}

/* 페이드 유틸 */
.fade-hidden{ opacity:0; transition:opacity 1800ms ease; }
.fade-show{ opacity:1; }

/* 가시성 제어 */
.hidden{ display:none !important; }

</style>
</head>
<body>

<canvas id="blobCanvas"></canvas>
<div class="frameBox" aria-hidden="true"></div>

<!-- 회전 안내 -->
<div id="rotateOverlay">
  <div>
    <b>Landscape mode required</b><br/>
    Please rotate your device to landscape to continue.
  </div>
</div>

<!-- 시작 게이트 -->
<div id="startOverlay">
  <div id="startInner">
    <p>WELCOME TO</p>
    <p style="margin-top:8px;">SLEEEEEEEEP – THE SECOND SLEEP</p>
    <p style="margin-top:18px;font-size:clamp(10px,2vmin,13px);">
      Tap START to continue.<br/>
      (카메라와 마이크는 사용하지 않지만, 전체 화면 및 사운드 사용을 위해 한 번 터치가 필요합니다.)
    </p>
    <button id="startBtn" class="uiBtn flat" style="margin-top:20px;">START</button>
  </div>
</div>

<!-- 2장 타이틀 -->
<div id="titleOverlay" class="fade-hidden">
  <div id="titleText" class="sleepLine"></div>
</div>

<!-- 게임 레이아웃 : 중앙 팝업 카드 -->
<div id="gameLayout" class="hidden">
  <div id="gameCard">
    <div id="gameScreenWrap">
      <canvas id="gameCanvas" width="320" height="180"></canvas>
      <div id="nameTag"></div>
    </div>
  </div>
</div>

<!-- HUD -->
<div id="hudLeft" class="hidden">
  <div class="dpad">
    <button class="dpad-up"    data-dir="up">▲</button>
    <button class="dpad-down"  data-dir="down">▼</button>
    <button class="dpad-left"  data-dir="left">◀</button>
    <button class="dpad-right" data-dir="right">▶</button>
  </div>
</div>
<div id="hudRight" class="hidden">
  <button id="actionBtn">A</button>
</div>

<!-- 대화창 -->
<div id="dialogBar" class="hidden">
  <div id="dialogTextWrap">
    <div id="dialogText"></div>
    <div id="dialogHint"></div>
  </div>
  <button id="dialogNext" class="uiBtn">NEXT</button>
</div>

<script>
(() => {
  /* ===== 유틸 ===== */
  const qs = s => document.querySelector(s);
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  function setAppH(){
    document.documentElement.style.setProperty('--appH', window.innerHeight + 'px');
  }
  setAppH();
  addEventListener('resize', ()=>setTimeout(setAppH,50), {passive:true});

  /* ===== 회전 안내 ===== */
  const rotateOverlay = qs('#rotateOverlay');
  function isPortrait(){
    const vv = window.visualViewport;
    const w = vv?vv.width:innerWidth;
    const h = vv?vv.height:innerHeight;
    return h > w;
  }
  function updateRotateOverlay(){
    rotateOverlay.style.display = isPortrait() ? 'flex' : 'none';
  }
  ['load','resize','orientationchange','pageshow'].forEach(ev=>{
    addEventListener(ev, updateRotateOverlay, {passive:true});
  });
  updateRotateOverlay();

  /* ===== 전체 화면 & 오디오 ===== */
  let audioCtx = null;
  let audioPrimed = false;
  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }
  async function primeAudio(){
    ensureAudio();
    if(audioCtx.state === 'suspended'){
      try{ await audioCtx.resume(); }catch(e){}
    }
    audioPrimed = true;
  }
  async function ensureResumed(){
    ensureAudio();
    if(audioCtx.state === 'suspended'){
      try{ await audioCtx.resume(); }catch(e){}
    }
  }

  async function enterFullscreen(){
    const el = document.documentElement;
    try{
      if(!document.fullscreenElement){
        if(el.requestFullscreen) await el.requestFullscreen({navigationUI:'hide'});
        else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      }
    }catch(e){}
  }

  /* ===== 타자 소리 ===== */
  let typeBuffer = null;
  let lastTypeSoundTime = 0;

  function buildTypeBuffer(ctx){
    const duration   = 0.05;
    const sampleRate = ctx.sampleRate;
    const length     = Math.floor(sampleRate * duration);
    const buffer     = ctx.createBuffer(1, length, sampleRate);
    const data       = buffer.getChannelData(0);
    const freq       = 780;
    for(let i=0;i<length;i++){
      const t   = i / sampleRate;
      const env = Math.exp(-t * 11);
      const phase = 2*Math.PI*freq*t;
      data[i] = Math.sin(phase)*env*0.9;
    }
    return buffer;
  }

  function playTypeTick(){
    try{
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime || 0;
      if(now - lastTypeSoundTime < 0.05) return;
      lastTypeSoundTime = now;
      if(!typeBuffer) typeBuffer = buildTypeBuffer(ctx);
      const src = ctx.createBufferSource();
      src.buffer = typeBuffer;
      const g = ctx.createGain();
      g.gain.value = 0.35;
      src.connect(g).connect(ctx.destination);
      src.start();
    }catch(e){}
  }

  async function typeText(el, text, speed=40){
    el.textContent = '';
    for(let i=0;i<text.length;i++){
      el.textContent += text[i];
      playTypeTick();
      await sleep(speed);
    }
  }

  /* ===== 간단한 팅~ (ding) 효과 ===== */
  async function playDing(){
    try{
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;
      const o1 = ctx.createOscillator();
      const o2 = ctx.createOscillator();
      const g  = ctx.createGain();
      o1.type='sine';
      o2.type='sine';
      o1.frequency.setValueAtTime(523.25, now);
      o2.frequency.setValueAtTime(784.0,  now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.5, now+0.03);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.6);
      o1.connect(g); o2.connect(g); g.connect(ctx.destination);
      o1.start(now); o2.start(now);
      o1.stop(now+0.65); o2.stop(now+0.65);
    }catch(e){}
  }

  /* ===== 게임풍 OST : 좀 더 빠르고 귀엽게 ===== */
  let musicRunning = false;
  function playNote(freq, dur=0.16, vol=0.38){
    try{
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type='square';
      o.frequency.setValueAtTime(freq, now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(vol, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
      o.connect(g).connect(ctx.destination);
      o.start(now);
      o.stop(now+dur+0.02);
    }catch(e){}
  }

  function startGameMusic(){
    if(musicRunning) return;
    musicRunning = true;
    // 밝고 튀는 패턴
    const base = 523.25; // C5
    const pattern = [
      0, 4, 7, 12,
      7, 4, 0, 7,
      2, 5, 9, 14,
      9, 5, 2, 7
    ];
    let idx = 0;
    const stepDur = 150; // ms

    function step(){
      if(!musicRunning) return;
      const semi = pattern[idx % pattern.length];
      const f = base * Math.pow(2, semi/12);
      playNote(f, 0.14, 0.4);
      idx++;
      setTimeout(step, stepDur);
    }
    step();
  }

  /* ===== 중앙 꿀렁이 (전체 배경) ===== */
  const blobCanvas = qs('#blobCanvas');
  const blobCtx = blobCanvas.getContext('2d');
  let blobAlpha = 0;
  let blobFadeIn = true;
  let blobStartTime = performance.now();

  function resizeBlob(){
    const dpr = window.devicePixelRatio || 1;
    blobCanvas.width = innerWidth * dpr;
    blobCanvas.height = innerHeight * dpr;
    blobCtx.setTransform(dpr,0,0,dpr,0,0);
  }
  resizeBlob();
  addEventListener('resize', ()=>setTimeout(resizeBlob,30), {passive:true});

  function drawBlob(){
    const w = innerWidth;
    const h = innerHeight;
    blobCtx.clearRect(0,0,w,h);
    if(blobAlpha <= 0) return;

    const t = (performance.now() - blobStartTime) * 0.001;
    const cx = w/2;
    const cy = h/2;
    const baseR = Math.min(w,h)*0.32;
    const N = 40;

    blobCtx.save();
    blobCtx.globalAlpha = blobAlpha;
    blobCtx.beginPath();
    for(let i=0;i<N;i++){
      const ang = (i/N)*Math.PI*2;
      const wob = 0.2*Math.sin(t*2 + i*0.7);
      const rr = baseR * (0.8 + wob);
      const x = cx + Math.cos(ang)*rr;
      const y = cy + Math.sin(ang)*rr*0.55;
      if(i===0) blobCtx.moveTo(x,y); else blobCtx.lineTo(x,y);
    }
    blobCtx.closePath();
    const grad = blobCtx.createRadialGradient(cx,cy,baseR*0.1, cx,cy,baseR*1.1);
    grad.addColorStop(0,'#000000');
    grad.addColorStop(1,'#101010');
    blobCtx.fillStyle = grad;
    blobCtx.strokeStyle = 'rgba(245,245,245,0.3)';
    blobCtx.lineWidth = 2.3;
    blobCtx.fill();
    blobCtx.stroke();
    blobCtx.restore();
  }

  function blobLoop(){
    requestAnimationFrame(blobLoop);
    const now = performance.now();
    if(blobFadeIn && blobAlpha < 1){
      const k = clamp((now - blobStartTime)/2000, 0, 1);
      blobAlpha = k;
    }
    drawBlob();
  }
  blobLoop();

  /* ===== 2장 타이틀 연출 ===== */
  const titleOverlay = qs('#titleOverlay');
  const titleText = qs('#titleText');

  async function showTitleSequence(){
    titleOverlay.classList.remove('fade-show');
    titleOverlay.classList.add('fade-hidden');
    titleOverlay.style.display = 'flex';

    await sleep(50);

    titleOverlay.classList.remove('fade-hidden');
    titleOverlay.classList.add('fade-show');

    await typeText(titleText, 'THE SECOND SLEEP', 55);
    await sleep(1000);

    // 페이드 아웃
    titleOverlay.classList.remove('fade-show');
    titleOverlay.classList.add('fade-hidden');
    await sleep(1400);
    titleOverlay.style.display = 'none';

    // 타이틀 사라진 뒤 OST 시작 & 게임 UI 등장
    await ensureResumed();
    await playDing();
    startGameMusic();
    startGameScene();
  }

  /* ===== 게임 영역 ===== */
  const gameLayout      = qs('#gameLayout');
  const gameCanvas      = qs('#gameCanvas');
  const gctx            = gameCanvas.getContext('2d');
  const nameTag         = qs('#nameTag');
  const dialogBar       = qs('#dialogBar');
  const dialogText      = qs('#dialogText');
  const dialogHint      = qs('#dialogHint');
  const dialogNextBtn   = qs('#dialogNext');
  const hudLeft         = qs('#hudLeft');
  const hudRight        = qs('#hudRight');
  const startOverlay    = qs('#startOverlay');
  const startBtn        = qs('#startBtn');

  // 닉네임 (SLEEP 본편에서 localStorage.sleepNick 사용했다고 가정)
  const nick = (()=>{
    try{
      const v = localStorage.getItem('sleepNick');
      if(v && v.trim().length>0) return v.trim();
    }catch(e){}
    return 'YOU';
  })();
  nameTag.textContent = nick;

  /* 픽셀 토끼 */
  function drawRedRabbit(ctx, x, y, scale=1){
    ctx.fillStyle = '#ff3333';
    // 머리
    ctx.fillRect(x + 2*scale, y + 1*scale, 4*scale, 3*scale);
    // 귀
    ctx.fillRect(x + 1*scale, y - 1*scale, 1*scale, 3*scale);
    ctx.fillRect(x + 4*scale, y - 1*scale, 1*scale, 3*scale);
    // 몸통
    ctx.fillRect(x + 2*scale, y + 4*scale, 4*scale, 3*scale);
    // 꼬리
    ctx.fillRect(x + 6*scale, y + 4*scale, 2*scale, 2*scale);
  }

  /* 게임 월드 */
  const W = gameCanvas.width;
  const H = gameCanvas.height;
  const groundY = 145;
  const floorY = groundY;
  const sofaX = 210;
  const sofaWidth = 70;
  const sofaHeight = 26;

  let playerX = 40;
  let playerY = groundY - 16;
  let playerVX = 0;
  let playerVY = 0;
  const speed = 0.14;
  const gravity = 0.18;
  const maxVX = 1.4;

  let moveLeft=false, moveRight=false, moveUp=false, moveDown=false, actionPressed=false;
  let gameStarted = false;
  let introWalkStartTime = 0;

  let gameState = 'title'; // 'introWalk', 'introDialog', 'free', 'seated', 'done'

  /* 대화 시스템 */
  let currentLines = [];
  let currentIdx = 0;
  let typing = false;
  let fullLine = '';
  let onDialogDone = null;

  async function showDialog(lines, hint='', cb=null){
    currentLines = lines;
    currentIdx = 0;
    onDialogDone = cb;
    dialogHint.textContent = hint || '';
    dialogBar.classList.remove('hidden');
    await typeCurrentLine();
  }

  async function typeCurrentLine(){
    const line = currentLines[currentIdx] || '';
    fullLine = line;
    typing = true;
    await typeText(dialogText, line, 40);
    typing = false;
  }

  dialogNextBtn.addEventListener('click', async ()=>{
    await ensureResumed();
    if(typing){
      // 타이핑 중이면 즉시 완성
      typing = false;
      dialogText.textContent = fullLine;
      return;
    }
    currentIdx++;
    if(currentIdx >= currentLines.length){
      if(onDialogDone) onDialogDone();
      return;
    }
    await typeCurrentLine();
  });

  /* HUD 입력 */
  const dpad = hudLeft.querySelector('.dpad');
  if(dpad){
    dpad.addEventListener('pointerdown', (e)=>{
      const btn = e.target.closest('button[data-dir]');
      if(!btn) return;
      const dir = btn.dataset.dir;
      if(dir==='left')  moveLeft=true;
      if(dir==='right') moveRight=true;
      if(dir==='up')    moveUp=true;
      if(dir==='down')  moveDown=true;
      e.target.setPointerCapture(e.pointerId);
    });
    dpad.addEventListener('pointerup', (e)=>{
      const btn = e.target.closest('button[data-dir]');
      if(!btn) return;
      const dir = btn.dataset.dir;
      if(dir==='left')  moveLeft=false;
      if(dir==='right') moveRight=false;
      if(dir==='up')    moveUp=false;
      if(dir==='down')  moveDown=false;
    });
    dpad.addEventListener('pointercancel', ()=>{
      moveLeft=moveRight=moveUp=moveDown=false;
    });
  }

  const actionBtn = qs('#actionBtn');
  actionBtn.addEventListener('pointerdown', ()=>{
    actionPressed = true;
  });
  actionBtn.addEventListener('pointerup', ()=>{
    actionPressed = false;
  });
  actionBtn.addEventListener('pointercancel', ()=>{
    actionPressed = false;
  });

  /* 키보드(테스트용) */
  window.addEventListener('keydown', (e)=>{
    if(e.code === 'ArrowLeft')  moveLeft=true;
    if(e.code === 'ArrowRight') moveRight=true;
    if(e.code === 'ArrowUp')    moveUp=true;
    if(e.code === 'Space')      actionPressed=true;
  });
  window.addEventListener('keyup', (e)=>{
    if(e.code === 'ArrowLeft')  moveLeft=false;
    if(e.code === 'ArrowRight') moveRight=false;
    if(e.code === 'ArrowUp')    moveUp=false;
    if(e.code === 'Space')      actionPressed=false;
  });

  /* 게임 안에 들어가는 작은 꿀렁이 */
  function drawInnerBlob(ctx){
    const cx = W/2;
    const cy = 70;
    const baseR = 40;
    const N = 22;
    const t = performance.now()*0.001;

    ctx.beginPath();
    for(let i=0;i<N;i++){
      const ang = (i/N)*Math.PI*2;
      const wob = 0.25*Math.sin(t*2 + i*0.6);
      const r = baseR * (0.8 + wob);
      const x = cx + Math.cos(ang)*r;
      const y = cy + Math.sin(ang)*r*0.6;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.fillStyle = '#000000';
    ctx.strokeStyle = 'rgba(245,245,245,0.4)';
    ctx.lineWidth = 1.5;
    ctx.fill();
    ctx.stroke();
  }

  /* 게임 루프 */
  function update(){
    if(!gameStarted) return;

    // 인트로 걷기 (왼쪽에서 등장)
    if(gameState === 'introWalk'){
      const elapsed = (performance.now() - introWalkStartTime) / 1000;
      const startX = -24;
      const targetX = 56;
      const t = clamp(elapsed / 1.2, 0, 1);
      playerX = startX + (targetX - startX)*t;
      playerY = groundY - 16;
      if(t >= 1){
        gameState = 'introDialog';
        startIntroDialog();
      }
      return;
    }

    if(gameState === 'free'){
      let ax = 0;
      if(moveLeft)  ax -= speed;
      if(moveRight) ax += speed;
      playerVX += ax;
      playerVX *= 0.82;
      playerVX = clamp(playerVX, -maxVX, maxVX);

      // 수평 이동만 (점프/위아래는 사용 안 함)
      playerX += playerVX;

      // 바닥 고정
      playerY = groundY - 16;

      // 화면 밖 제한
      if(playerX < 8){
        playerX = 8;
        playerVX = 0;
      }
      if(playerX > W-24){
        playerX = W-24;
        playerVX = 0;
      }

      // 쇼파 근처에서 A 버튼 → 앉기
      const nearSofa = (playerX > sofaX - 12);
      if(nearSofa && actionPressed){
        sitOnSofa();
      }
    }
  }

  function draw(){
    const ctx = gctx;
    ctx.clearRect(0,0,W,H);

    // 배경
    ctx.fillStyle = '#050505';
    ctx.fillRect(0,0,W,H);

    // 안쪽 꿀렁이 (게임 화면 안)
    drawInnerBlob(ctx);

    // 바닥
    ctx.fillStyle = '#141414';
    ctx.fillRect(0, groundY, W, H-groundY);
    ctx.strokeStyle = '#333';
    ctx.beginPath();
    ctx.moveTo(0,groundY);
    ctx.lineTo(W,groundY);
    ctx.stroke();

    // 왼쪽 단
    ctx.fillStyle = '#202020';
    ctx.fillRect(8, groundY-10, 32, 10);

    // 쇼파
    ctx.save();
    ctx.translate(sofaX, groundY - sofaHeight);
    ctx.fillStyle = '#e8c93b';
    ctx.fillRect(0, 8, sofaWidth, sofaHeight-8);   // 몸통
    ctx.fillRect(4, 0, sofaWidth-8, 10);           // 등받이
    ctx.fillStyle = '#c6a629';
    ctx.fillRect(6, 12, sofaWidth-12, sofaHeight-14); // 쿠션
    ctx.fillStyle = '#b09324';
    ctx.fillRect(4, sofaHeight-2, 8, 4);           // 다리
    ctx.fillRect(sofaWidth-12, sofaHeight-2, 8, 4);
    ctx.restore();

    // 플레이어 (토끼)
    const scale = 3;
    drawRedRabbit(ctx, playerX, playerY, scale);
  }

  function gameLoop(){
    requestAnimationFrame(gameLoop);
    update();
    draw();
  }
  gameLoop();

  /* ===== 상태 전환 ===== */
  function startGameScene(){
    gameLayout.classList.remove('hidden');
    hudLeft.classList.remove('hidden');
    hudRight.classList.remove('hidden');
    dialogBar.classList.remove('hidden');

    gameStarted = true;

    // 1초 후 왼쪽에서 토끼 등장
    setTimeout(()=>{
      gameState = 'introWalk';
      introWalkStartTime = performance.now();
    }, 1000);
  }

  async function startIntroDialog(){
    const lines = [
      "안녕?",
      `나는 ${nick}이야.`,
      "꽤 오래 걸어온 것 같지?\n이제 어디 편한 곳에 좀 앉아볼까?",
      "어라? 저기 노란 소파가 있다.\n저기에 앉아보자!"
    ];
    const hint =
      "안내 : 캐릭터를 오른쪽으로 이동시켜 A 버튼을 눌러 쇼파에 앉으세요.\n" +
      "당신도 이 공간에서 편한 자리를 찾아 앉아보세요.";
    showDialog(lines, hint, ()=>{
      gameState = 'free';
    });
  }

  function sitOnSofa(){
    if(gameState !== 'free') return;
    gameState = 'seated';

    // 쇼파 위 위치로 스냅
    playerX = sofaX + sofaWidth*0.4;
    playerY = groundY - sofaHeight - 2;
    playerVX = 0;
    playerVY = 0;

    const lines = [
      "앉았어?",
      "그래. 좋아.",
      "이제 진짜로, 두 번째 낮잠이 시작될 거야.",
      "THE SECOND SLEEP."
    ];
    dialogHint.textContent = '';
    showDialog(lines, '', ()=>{
      gameState = 'done';
      dialogNextBtn.disabled = true;
      dialogHint.textContent = "메인 프로그램으로 돌아가 두 번째 잠을 계속 이어가주세요.";
    });
  }

  /* ===== 시작 오버레이 ===== */
  async function startAll(){
    await primeAudio();
    await enterFullscreen();
    startOverlay.style.display = 'none';
    blobStartTime = performance.now();
    blobFadeIn = true;
    blobAlpha = 0;

    await ensureResumed();
    await showTitleSequence();
  }

  ['click','touchstart','pointerdown'].forEach(ev=>{
    startBtn.addEventListener(ev, (e)=>{
      e.preventDefault();
      if(startOverlay.style.display === 'none') return;
      startAll();
    }, {passive:false});
  });

})();
</script>
</body>
</html>
