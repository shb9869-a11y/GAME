<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LIMEN WORKSHOP â€“ Monitorable Sound/Touch Reactive Field</title>
<style>
Â  html,body{margin:0;height:100%;background:#000;overflow:hidden;touch-action:none;}
Â  canvas{display:block;width:100vw;height:100vh;}

Â  /* Entry */
Â  #hint{
Â  Â  position:fixed; inset:0;
Â  Â  display:flex; align-items:center; justify-content:center;
Â  Â  background:rgba(0,0,0,.72);
Â  Â  color:#ddd; font-family:system-ui, -apple-system, sans-serif;
Â  Â  text-align:center; padding:20px;
Â  Â  z-index:50;
Â  }
Â  #hint .box{
Â  Â  width:min(720px, 94vw);
Â  Â  border:1px solid rgba(255,255,255,.12);
Â  Â  border-radius:14px;
Â  Â  padding:18px 16px;
Â  Â  background:rgba(0,0,0,.55);
Â  Â  text-align:left;
Â  }

Â  /* Top-right buttons */
Â  #topRight{
Â  Â  position:fixed; right:12px; top:12px;
Â  Â  display:flex; gap:8px;
Â  Â  z-index:40;
Â  }
Â  .iconBtn{
Â  Â  width:42px; height:42px;
Â  Â  display:grid; place-items:center;
Â  Â  background:rgba(0,0,0,.38);
Â  Â  color:#eee;
Â  Â  border:1px solid rgba(255,255,255,.14);
Â  Â  border-radius:12px;
Â  Â  backdrop-filter: blur(10px);
Â  Â  cursor:pointer;
Â  Â  user-select:none;
Â  Â  font-size:18px;
Â  }
Â  .iconBtn:hover{border-color:rgba(255,255,255,.30)}
Â  .iconBtn:active{transform:translateY(1px)}

Â  /* Hidden in main (we use popup window as control tower) */
Â  #ui{display:none !important;}

Â  /* tiny HUD for touch */
Â  #touchHUD{
Â  Â  position:fixed; left:12px; bottom:12px;
Â  Â  z-index:39;
Â  Â  color:#ddd;
Â  Â  font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
Â  Â  font-size:11px;
Â  Â  background:rgba(0,0,0,.28);
Â  Â  border:1px solid rgba(255,255,255,.10);
Â  Â  border-radius:12px;
Â  Â  padding:8px 10px;
Â  Â  backdrop-filter: blur(10px);
Â  Â  pointer-events:none;
Â  }
Â  #touchHUD .bar{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10);margin-top:6px;}
Â  #touchHUD .bar i{display:block;height:100%;width:0%;background:rgba(255,80,80,.90);}

Â  /* Entry header */
Â  .entryTitle{font-weight:900; font-size:16px; margin-bottom:10px;}
Â  .entryGrid{
Â  Â  display:grid;
Â  Â  grid-template-columns: 1fr;
Â  Â  gap:10px;
Â  }
Â  @media (min-width:720px){
Â  Â  .entryGrid{grid-template-columns: 1fr 1fr;}
Â  }
Â  .entryCard{
Â  Â  border:1px solid rgba(255,255,255,.10);
Â  Â  border-radius:12px;
Â  Â  padding:10px;
Â  Â  background:rgba(0,0,0,.20);
Â  }

Â  button, select, input[type="range"], input[type="number"]{
Â  Â  background:#0f0f0f; color:#eee;
Â  Â  border:1px solid rgba(255,255,255,.16);
Â  Â  border-radius:10px;
Â  Â  padding:8px 10px;
Â  Â  font-weight:650;
Â  Â  outline:none;
Â  }
Â  input[type="range"]{padding:6px 10px;}
Â  button:hover, select:hover{border-color:rgba(255,255,255,.32)}
Â  button:disabled, select:disabled{opacity:.5; cursor:not-allowed}

Â  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:8px 0;}
Â  .label{font-size:12px; color:#aaa; width:132px;}
Â  .grow{flex:1; min-width:200px;}
Â  .small{font-size:11px; color:#9aa; line-height:1.45;}
Â  .fileLine{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
Â  .fileLine input[type="file"]{
Â  Â  padding:6px 10px;
Â  Â  border-radius:10px;
Â  Â  border:1px solid rgba(255,255,255,.16);
Â  Â  background:rgba(0,0,0,.22);
Â  Â  color:#ddd;
Â  }
</style>
</head>
<body>

<div id="hint">
Â  <div class="box">
Â  Â  <div class="entryTitle">LIMEN WORKSHOP â€“ Entry</div>
Â  Â  <div class="small" style="margin-bottom:12px;">
Â  Â  Â  1) <b>Start Audio</b>ë¡œ ì˜¤ë””ì˜¤ ì ê¸ˆ í•´ì œ<br/>
Â  Â  Â  2) ì—¬ê¸°ì„œ <b>Mic / File</b> ì„ íƒ í›„ <b>Mic ON</b> ë˜ëŠ” <b>File Play</b>ë¡œ ì…ì¥<br/>
Â  Â  Â  3) ì»¨íŠ¸ë¡¤ íƒ€ì›Œ(íŒì—…): âš™ï¸ ë²„íŠ¼ â†’ ë³„ë„ ì°½ì—ì„œ ì „ì²´ ì„¤ì •/ë…¹í™”/í”„ë¦¬ì…‹ ì»¨íŠ¸ë¡¤
Â  Â  </div>

Â  Â  <div class="row" style="justify-content:space-between;">
Â  Â  Â  <div class="row" style="margin:0;">
Â  Â  Â  Â  <button id="btnStartAudio">Start Audio</button>
Â  Â  Â  Â  <button id="btnFS">Fullscreen</button>
Â  Â  Â  Â  <button id="btnOpenTower">Open Control Tower</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="small" id="startStatus" style="opacity:.9; margin-left:10px;"></div>
Â  Â  </div>

Â  Â  <div class="entryGrid">
Â  Â  Â  Â  Â  Â  <div class="entryCard">
Â  Â  Â  Â  <div class="row" style="margin-top:0;">
Â  Â  Â  Â  Â  <div class="label">Input</div>
Â  Â  Â  Â  Â  <select id="entrySelSrc" class="grow">
Â  Â  Â  Â  Â  Â  <option value="mic" selected>Mic (Live input)</option>
Â  Â  Â  Â  Â  Â  <option value="file">File (MP3/WAV)</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="entryMicBox">
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Mic device</div>
Â  Â  Â  Â  Â  Â  <select id="entrySelMic" class="grow" disabled>
Â  Â  Â  Â  Â  Â  Â  <option>Start Audio í›„ ëª©ë¡ ë¡œë“œ</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <button id="entryMicOn" class="grow" disabled>Mic ON (Enter)</button>
Â  Â  Â  Â  Â  Â  <button id="entryMicOff" class="grow" disabled>Mic OFF</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="small">Mic ONì„ ëˆ„ë¥´ë©´ Entry í™”ë©´ì´ ë‹«íˆê³ (ì…ì¥) ë¹„ì£¼ì–¼ì´ ì‹œì‘ë©ë‹ˆë‹¤.</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="entryFileBox" style="display:none;">
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Audio file</div>
Â  Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  Â  <div class="fileLine">
Â  Â  Â  Â  Â  Â  Â  Â  <input id="entryFileAudio" type="file" accept="audio/*">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="small" id="entryFileTxt">íŒŒì¼ ì„ íƒ í›„ Playë¡œ ì…ì¥</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <button id="entryFilePlay" class="grow" disabled>Play (Enter)</button>
Â  Â  Â  Â  Â  Â  <button id="entryFilePause" class="grow" disabled>Pause</button>
Â  Â  Â  Â  Â  Â  <button id="entryFileStop" class="grow" disabled>Stop</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="entryCard">
Â  Â  Â  Â  <div class="small" style="margin-bottom:8px;">
Â  Â  Â  Â  Â  âœ… ë ‰(í”„ë¦¬ì¦ˆ/ê³¼ë¶€í•˜) ê°ì§€ ì‹œ <b>ìë™ìœ¼ë¡œ ì´ Entry í™”ë©´ìœ¼ë¡œ ë˜ëŒì•„ì˜µë‹ˆë‹¤</b>.<br/>
Â  Â  Â  Â  Â  (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ì´ ì•„ë‹ˆë¼ â€œì…ì¥ ë‹¨ê³„ë¡œ ë³µê·€â€)
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="small" style="margin-bottom:8px;">
Â  Â  Â  Â  Â  âœ… ì»¨íŠ¸ë¡¤ íƒ€ì›ŒëŠ” <b>ë³„ë„ íŒì—… ì°½</b>ìœ¼ë¡œ ì—´ë ¤ì„œ, í™•ì¥ ìŠ¤í¬ë¦°(ë¹”)ì—ëŠ” í’€ìŠ¤í¬ë¦°ë§Œ ë„ìš°ê³ <br/>
Â  Â  Â  Â  Â  ë…¸íŠ¸ë¶ í™”ë©´ì—ì„œ ì„¤ì •/ë…¹í™”/í”„ë¦¬ì…‹ì„ ì»¨íŠ¸ë¡¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="small">
Â  Â  Â  Â  Â  âœ… íŒŒì¼(mp3) ë³¼ë¥¨ ìŠ¬ë¼ì´ë” + <b>í™”ë©´+ì‚¬ìš´ë“œ ë…¹í™”(ë ˆì½”ë”©)</b> ê¸°ëŠ¥ ì¶”ê°€ë¨ (Chrome ê¶Œì¥)
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<canvas id="c"></canvas>

<div id="touchHUD">
Â  touch: <span id="hudTouch">0.000</span> | amp: <span id="hudAmp">0.000</span><br/>
Â  <span id="hudMidi">midi: -</span>
Â  <div class="bar"><i id="hudTouchBar"></i></div>
</div>

<div id="topRight">
Â  <div class="iconBtn" id="btnGear" title="Control Tower">âš™ï¸</div>
Â  <div class="iconBtn" id="btnMuteQuick" title="Mute">ğŸ”ˆ</div>
Â  <div class="iconBtn" id="btnFSQuick" title="Fullscreen">â›¶</div>
</div>

<div id="ui">
Â  <div id="bar">
Â  Â  <div class="title">Settings</div>
Â  Â  <button id="btnHideUI" title="Close">ë‹«ê¸°</button>
Â  Â  <div class="pill" id="topPill">audio:off | src:off | q:1.00</div>
Â  </div>

Â  <div id="tabs">
Â  Â  <div class="tab active" data-tab="visual">VISUAL</div>
Â  Â  <div class="tab" data-tab="audio">AUDIO</div>
Â  Â  <div class="tab" data-tab="midi">MIDI</div>
Â  Â  <div class="tab" data-tab="system">SYSTEM</div>
Â  </div>

Â  <div id="panels">
Â  Â  Â  Â  <div class="panel active" id="panel-visual">
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Mode</div>
Â  Â  Â  Â  <select id="selMode" class="grow">
Â  Â  Â  Â  Â  <option value="calm">Calm (quiet 3D dots)</option>
Â  Â  Â  Â  Â  <option value="pulse" selected>Pulse (amp-driven)</option>
Â  Â  Â  Â  Â  <option value="burst">Burst (delta-driven)</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Particles</div>
Â  Â  Â  Â  <select id="selN" class="grow">
Â  Â  Â  Â  Â  <option value="160">160</option>
Â  Â  Â  Â  Â  <option value="220" selected>220</option>
Â  Â  Â  Â  Â  <option value="320">320</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Keep in screen</div>
Â  Â  Â  Â  <select id="selBounds" class="grow">
Â  Â  Â  Â  Â  <option value="soft" selected>Soft boundary</option>
Â  Â  Â  Â  Â  <option value="bounce">Bounce</option>
Â  Â  Â  Â  Â  <option value="wrap">Wrap</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Quiet lines</div>
Â  Â  Â  Â  <select id="selQuietLines" class="grow">
Â  Â  Â  Â  Â  <option value="0">Off</option>
Â  Â  Â  Â  Â  <option value="1" selected>Very subtle</option>
Â  Â  Â  Â  Â  <option value="2">On</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Point color</div>
Â  Â  Â  Â  <select id="selPointColor" class="grow">
Â  Â  Â  Â  Â  <option value="red" selected>Red</option>
Â  Â  Â  Â  Â  <option value="white">White</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Idle Drama</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngIdleDrama" type="range" min="0" max="1" step="0.01" value="0.55" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtIdleDrama">idle drama: 0.55</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Visual Sens</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngVisSens" type="range" min="0.6" max="2.6" step="0.01" value="1.55" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtVisSens">visual sens: 1.55Ã—</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Line density</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngLine" type="range" min="0.2" max="1.2" step="0.01" value="0.75" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtLine">line density: 0.75Ã—</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Perf limit</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngPerf" type="range" min="0.25" max="1" step="0.01" value="0.72" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtPerf">perf limit: 0.72</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">BG fade</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngFade" type="range" min="0.02" max="0.20" step="0.005" value="0.03" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtFade">fade: 0.030</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Point size</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngPointSize" type="range" min="0.4" max="1.2" step="0.01" value="0.60" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtPointSize">point size: 0.60Ã—</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Glow</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngGlow" type="range" min="0.10" max="1.0" step="0.01" value="0.45" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtGlow">glow: 0.45Ã—</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Motion speed</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngSpeed" type="range" min="0.35" max="1.25" step="0.01" value="0.72" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtSpeed">speed: 0.72Ã— (slower)</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="small">
Â  Â  Â  Â  âœ… ëŠë¦¬ê²Œ: <b>Motion speedâ†“</b> / <b>Idle Dramaâ†“</b><br/>
Â  Â  Â  Â  âœ… ë ‰/ë©ˆì¶¤: <b>Perf limitâ†“</b> â†’ <b>Line densityâ†“</b> â†’ <b>Particlesâ†“</b>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="panel" id="panel-audio">
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Input level</div>
Â  Â  Â  Â  <div class="grow"><div class="meter"><i id="meterIn"></i></div></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Media Gain</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngMediaGain" type="range" min="0.2" max="3.0" step="0.01" value="1.00" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtMediaGain">media gain: 1.00Ã—</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">File volume</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngFileVol" type="range" min="0" max="1" step="0.01" value="0.85" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtFileVol">file volume: 0.85</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Analysis Sens</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngSens" type="range" min="1" max="12" step="0.1" value="7.0" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtSens">analysis sens: 7.0Ã—</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Gamma boost</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngGamma" type="range" min="0.45" max="1.20" step="0.01" value="0.72" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtGamma">gamma: 0.72</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Amp cap</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngCap" type="range" min="0.10" max="0.70" step="0.01" value="0.42" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtCap">amp cap: 0.42</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Touch FX preset</div>
Â  Â  Â  Â  <select id="selFXPreset" class="grow">
Â  Â  Â  Â  Â  <option value="digital" selected>1) Digital Touch (default)</option>
Â  Â  Â  Â  Â  <option value="piano">2) Piano-ish (bright, less gloomy)</option>
Â  Â  Â  Â  Â  <option value="bells">3) Bells / Shimmer</option>
Â  Â  Â  Â  Â  <option value="warm">4) Warm Tape</option>
Â  Â  Â  Â  Â  <option value="glitch">5) Glitch / Ring</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">EQ Low</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngEQLow" type="range" min="-20" max="20" step="0.5" value="0" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtEQLow">low: 0 dB (200Hz)</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">EQ Mid</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngEQMid" type="range" min="-20" max="20" step="0.5" value="0" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtEQMid">mid: 0 dB (1kHz)</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">EQ High</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <input id="rngEQHigh" type="range" min="-20" max="20" step="0.5" value="0" style="width:100%;">
Â  Â  Â  Â  Â  <div class="small" id="txtEQHigh">high: 0 dB (4kHz)</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Amp / Î”</div>
Â  Â  Â  Â  <div class="mono grow" id="txtAmp">amp: 0.0000 | dAmp: 0.0000</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">FX (Touch)</div>
Â  Â  Â  Â  <div class="mono grow" id="txtFx">drive: - | filter: - | ring: - | widen: -</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="small">
Â  Â  Â  Â  âœ… â€œFile volumeâ€ì€ <b>mp3 ìì²´ ë³¼ë¥¨</b>ì´ê³ , â€œMedia Gainâ€ì€ <b>ë¶„ì„/ë°˜ì‘ ê°•ë„</b>ì— ë” ê°€ê¹ê²Œ ì“°ì„¸ìš”.<br/>
Â  Â  Â  Â  âœ… í”„ë¦¬ì…‹ì€ TouchMe(touch)ë¡œ ëˆŒë €ì„ ë•Œì˜ ì‚¬ìš´ë“œ ìºë¦­í„°ë¥¼ 5ê°œ í…œí”Œë¦¿ìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="panel" id="panel-midi">
Â  Â  Â  <div class="row" style="justify-content:space-between;">
Â  Â  Â  Â  <div class="small" id="txtMIDISupport" style="opacity:.95"></div>
Â  Â  Â  Â  <div style="display:flex; gap:6px; flex-wrap:wrap;">
Â  Â  Â  Â  Â  <button id="btnMIDIInit" class="pillBtn">Connect MIDI</button>
Â  Â  Â  Â  Â  <button id="btnMIDILearn" class="pillBtn">LEARN</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="two">
Â  Â  Â  Â  <div class="box">
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">MIDI Input</div>
Â  Â  Â  Â  Â  Â  <select id="selMIDIIn" class="grow">
Â  Â  Â  Â  Â  Â  Â  <option value="">Loadingâ€¦</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Map Source</div>
Â  Â  Â  Â  Â  Â  <select id="selMIDIType" class="grow">
Â  Â  Â  Â  Â  Â  Â  <option value="cc" selected>Control Change (CC)</option>
Â  Â  Â  Â  Â  Â  Â  <option value="note">Note Velocity</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">CC / Note#</div>
Â  Â  Â  Â  Â  Â  <input id="numMIDINum" class="grow" type="number" min="0" max="127" step="1" value="1" />
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Channel</div>
Â  Â  Â  Â  Â  Â  <select id="selMIDICh" class="grow">
Â  Â  Â  Â  Â  Â  Â  <option value="-1" selected>Any</option>
Â  Â  Â  Â  Â  Â  Â  <option value="0">1</option><option value="1">2</option><option value="2">3</option><option value="3">4</option>
Â  Â  Â  Â  Â  Â  Â  <option value="4">5</option><option value="5">6</option><option value="6">7</option><option value="7">8</option>
Â  Â  Â  Â  Â  Â  Â  <option value="8">9</option><option value="9">10</option><option value="10">11</option><option value="11">12</option>
Â  Â  Â  Â  Â  Â  Â  <option value="12">13</option><option value="13">14</option><option value="14">15</option><option value="15">16</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Invert</div>
Â  Â  Â  Â  Â  Â  <select id="selMIDIInvert" class="grow">
Â  Â  Â  Â  Â  Â  Â  <option value="0" selected>Normal</option>
Â  Â  Â  Â  Â  Â  Â  <option value="1">Invert (1-x)</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Deadzone</div>
Â  Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  Â  <input id="rngMIDIDead" type="range" min="0" max="0.25" step="0.005" value="0.02" style="width:100%;">
Â  Â  Â  Â  Â  Â  Â  <div class="small" id="txtMIDIDead">deadzone: 0.020</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Gain</div>
Â  Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  Â  <input id="rngMIDIGain" type="range" min="0.3" max="3.0" step="0.01" value="1.60" style="width:100%;">
Â  Â  Â  Â  Â  Â  Â  <div class="small" id="txtMIDIGain">gain: 1.60Ã—</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Curve</div>
Â  Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  Â  <input id="rngMIDICurve" type="range" min="0.4" max="2.8" step="0.01" value="0.85" style="width:100%;">
Â  Â  Â  Â  Â  Â  Â  <div class="small" id="txtMIDICurve">curve: 0.85 ( <1 = ë” ì˜ˆë¯¼ )</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Smoothing</div>
Â  Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  Â  <input id="rngMIDISmooth" type="range" min="0.02" max="0.50" step="0.01" value="0.22" style="width:100%;">
Â  Â  Â  Â  Â  Â  Â  <div class="small" id="txtMIDISmooth">smooth: 0.22</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Sim Touch</div>
Â  Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  Â  <input id="rngSimTouch" type="range" min="0" max="1" step="0.001" value="0" style="width:100%;">
Â  Â  Â  Â  Â  Â  Â  <div class="small">ë¯¸ë””ê°€ ë§‰íŒ í™˜ê²½ì—ì„œ ì´ ìŠ¬ë¼ì´ë”ë¡œ FX/ë¹„ì£¼ì–¼ í…ŒìŠ¤íŠ¸</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="box">
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Touch value</div>
Â  Â  Â  Â  Â  Â  <div class="grow"><div class="meter"><i id="meterTouch"></i></div></div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Mapped</div>
Â  Â  Â  Â  Â  Â  <div class="mono grow" id="txtMIDIRaw">raw: -</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Last MIDI (raw)</div>
Â  Â  Â  Â  Â  Â  <div class="mono grow" id="txtMIDILast">Waitingâ€¦</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">MIDI log</div>
Â  Â  Â  Â  Â  Â  <div class="mono grow" id="txtMIDI">Waitingâ€¦</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="small">
Â  Â  Â  Â  Â  Â  âœ… <b>LEARN</b> ëˆ„ë¥´ê³  TouchMe í•œë²ˆ í„°ì¹˜ â†’ ìë™ìœ¼ë¡œ CC/NOTE#, ì±„ë„ ì„¤ì •<br/>
Â  Â  Â  Â  Â  Â  âœ… â€œLast MIDI(raw)â€ ê°±ì‹  = ë¯¸ë”” ë“¤ì–´ì˜¤ëŠ” ì¤‘
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="panel" id="panel-system">
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Audio context</div>
Â  Â  Â  Â  <button id="btnResume" class="grow">Resume / Unlock Audio</button>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Input source</div>
Â  Â  Â  Â  <select id="selSrc" class="grow">
Â  Â  Â  Â  Â  <option value="mic" selected>Mic (Live input)</option>
Â  Â  Â  Â  Â  <option value="file">File (MP3/WAV)</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="row" id="rowMic">
Â  Â  Â  Â  <div class="label">Mic input</div>
Â  Â  Â  Â  <select id="selMic" class="grow" disabled>
Â  Â  Â  Â  Â  <option>ì¥ì¹˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="row" id="rowFile" style="display:none;">
Â  Â  Â  Â  <div class="label">Audio file</div>
Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  <div class="fileLine">
Â  Â  Â  Â  Â  Â  <input id="fileAudio" type="file" accept="audio/*">
Â  Â  Â  Â  Â  Â  <button id="btnFilePlay" disabled>Play</button>
Â  Â  Â  Â  Â  Â  <button id="btnFilePause" disabled>Pause</button>
Â  Â  Â  Â  Â  Â  <button id="btnFileStop" disabled>Stop</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="small" id="txtFile">íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì…ë ¥ ì²´ì¸(preGainâ†’EQâ†’FXâ†’analyser)ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Auto Reboot</div>
Â  Â  Â  Â  <select id="selAutoReboot" class="grow">
Â  Â  Â  Â  Â  <option value="1" selected>ON (lag/freeze â†’ ENTRY)</option>
Â  Â  Â  Â  Â  <option value="0">OFF</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Recording</div>
Â  Â  Â  Â  <button id="btnRecStart" class="grow">Start Rec</button>
Â  Â  Â  Â  <button id="btnRecStop" class="grow" disabled>Stop Rec</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="label">Last clip</div>
Â  Â  Â  Â  <a id="aRecDownload" class="small" href="#" download="limen_recording.webm" style="display:none;">Download recording</a>
Â  Â  Â  Â  <div class="small" id="txtRecInfo" style="opacity:.95;"></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="small" id="txtSupport"></div>
Â  Â  Â  <div class="small">
Â  Â  Â  Â  âœ… ì„¤ì •ì€ íŒì—…(ì»¨íŠ¸ë¡¤ íƒ€ì›Œ)ì—ì„œë§Œ ë³´ì´ë©°, í”„ë¡œì í„° í™”ë©´ì—ëŠ” ë°©í•´ ì—†ìŒ.<br/>
Â  Â  Â  Â  âœ… ë…¹í™”ëŠ” <b>canvas + master audio</b>ë¥¼ webmìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤. (Chrome ê¶Œì¥ / SafariëŠ” ì œì•½ ê°€ëŠ¥)
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<script>
/* ==========================================================
Â Â  SETTINGS PERSISTENCE (localStorage)
========================================================== */
const STORE_KEY = "limen_workshop_settings_v4_popup_record_fx";
function loadSettings(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||"{}"); }catch(e){ return {}; } }
function saveSettings(obj){ localStorage.setItem(STORE_KEY, JSON.stringify(obj)); }
const S = loadSettings();

function applySelectValue(id, fallback){
Â  const el = document.getElementById(id);
Â  const v = (S[id] ?? fallback);
Â  if(el) el.value = v;
}
function hookSelectSave(id){
Â  const el = document.getElementById(id);
Â  if(!el) return;
Â  el.addEventListener('change', ()=>{ S[id] = el.value; saveSettings(S); notifyTowerValue(id, el.value); });
}
function hookRangeSave(id, fallback){
Â  const el = document.getElementById(id);
Â  if(!el) return;
Â  el.value = (S[id] ?? fallback);
Â  el.addEventListener('input', ()=>{ S[id] = parseFloat(el.value); saveSettings(S); notifyTowerValue(id, el.value); });
}
function hookNumberSave(id, fallback){
Â  const el = document.getElementById(id);
Â  if(!el) return;
Â  el.value = (S[id] ?? fallback);
Â  el.addEventListener('input', ()=>{ S[id] = parseInt(el.value,10); saveSettings(S); notifyTowerValue(id, el.value); });
}

/* ==========================================================
Â Â  CANVAS / DPR
========================================================== */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', { alpha:false });
let W=0,H=0,DPR=1;

function resize(){
Â  DPR = Math.max(1, Math.min(2, devicePixelRatio||1));
Â  W = innerWidth|0; H = innerHeight|0;
Â  canvas.widthÂ  = (W*DPR)|0;
Â  canvas.height = (H*DPR)|0;
Â  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', resize);
resize();

/* ==========================================================
Â Â  AUDIO CORE + ANALYSER
========================================================== */
let audioCtx;
let analyser, timeData;

let micStream = null;
let inputNode = null;

let masterGain, isMuted=false;

// EQ nodes
let eqLow, eqMid, eqHigh;

// FX nodes
let preGain, driveWS, driveGain, filter, ringOsc, ringGain, ringMult, dL, dR, merger, comp;
let splitter;

// NEW: separate gain for file playback volume
let fileGain = null;

let amp=0, ampSmooth=0, ampDelta=0, prevAmp=0;

// file source
let fileAudioEl = null;
let fileNode = null;
let currentSource = S.currentSource ?? "mic"; // "mic" | "file"

function makeWaveshaper(amount=20){
Â  const n=2048;
Â  const curve=new Float32Array(n);
Â  const k=amount;
Â  for(let i=0;i<n;i++){
Â  Â  const x = (i*2/n)-1;
Â  Â  curve[i] = (1+k)*x/(1+k*Math.abs(x));
Â  }
Â  return curve;
}

function ensureAudio(){
Â  if(audioCtx) return;
Â  audioCtx = new (window.AudioContext||window.webkitAudioContext)();

Â  analyser = audioCtx.createAnalyser();
Â  analyser.fftSize = 1024;
Â  timeData = new Uint8Array(analyser.fftSize);

Â  masterGain = audioCtx.createGain();
Â  masterGain.gain.value = 0.9;

Â  preGain = audioCtx.createGain(); preGain.gain.value = 1.0;

Â  // EQ (ê³µìš©)
Â  eqLow = audioCtx.createBiquadFilter();
Â  eqLow.type = "lowshelf";
Â  eqLow.frequency.value = 200;
Â  eqLow.gain.value = 0;

Â  eqMid = audioCtx.createBiquadFilter();
Â  eqMid.type = "peaking";
Â  eqMid.frequency.value = 1000;
Â  eqMid.Q.value = 1.0;
Â  eqMid.gain.value = 0;

Â  eqHigh = audioCtx.createBiquadFilter();
Â  eqHigh.type = "highshelf";
Â  eqHigh.frequency.value = 4000;
Â  eqHigh.gain.value = 0;

Â  driveWS = audioCtx.createWaveShaper();
Â  driveWS.curve = makeWaveshaper(10);
Â  driveWS.oversample = '4x';
Â  driveGain = audioCtx.createGain(); driveGain.gain.value = 1.0;

Â  filter = audioCtx.createBiquadFilter();
Â  filter.type = 'bandpass';
Â  filter.frequency.value = 900;
Â  filter.Q.value = 2.0;

Â  ringOsc = audioCtx.createOscillator();
Â  ringOsc.type = 'sine';
Â  ringOsc.frequency.value = 35;

Â  ringGain = audioCtx.createGain();
Â  ringGain.gain.value = 0.0;

Â  ringMult = audioCtx.createGain();
Â  ringMult.gain.value = 1.0;
Â  ringOsc.connect(ringGain);
Â  ringGain.connect(ringMult.gain);

Â  splitter = audioCtx.createChannelSplitter(2);

Â  dL = audioCtx.createDelay(0.05);
Â  dR = audioCtx.createDelay(0.05);
Â  dL.delayTime.value = 0.004;
Â  dR.delayTime.value = 0.011;

Â  merger = audioCtx.createChannelMerger(2);

Â  comp = audioCtx.createDynamicsCompressor();
Â  comp.threshold.value = -22;
Â  comp.knee.value = 28;
Â  comp.ratio.value = 7;
Â  comp.attack.value = 0.003;
Â  comp.release.value = 0.14;

Â  // NEW: file volume gain (only used when source is file)
Â  fileGain = audioCtx.createGain();
Â  fileGain.gain.value = getFileVol();

Â  // chain: (mic OR file->fileGain) â†’ preGain â†’ EQ â†’ drive â†’ filter â†’ ring â†’ widen â†’ comp â†’ analyser â†’ master
Â  preGain.connect(eqLow);
Â  eqLow.connect(eqMid);
Â  eqMid.connect(eqHigh);

Â  eqHigh.connect(driveWS);
Â  driveWS.connect(driveGain);
Â  driveGain.connect(filter);
Â  filter.connect(ringMult);

Â  ringMult.connect(splitter);
Â  splitter.connect(dL, 0);
Â  splitter.connect(dR, 1);
Â  dL.connect(merger, 0, 0);
Â  dR.connect(merger, 0, 1);

Â  merger.connect(comp);
Â  comp.connect(analyser);
Â  analyser.connect(masterGain);
Â  masterGain.connect(audioCtx.destination);

Â  ringOsc.start();
Â  updateTopPill(1);
}

/* ==========================================================
Â Â  AUDIO UI + PARAMS
========================================================== */
hookRangeSave('rngMediaGain', 1.00);
hookRangeSave('rngFileVol', 0.85);
hookRangeSave('rngSens', 7.0);
hookRangeSave('rngGamma', 0.72);
hookRangeSave('rngCap', 0.42);

hookRangeSave('rngEQLow', 0);
hookRangeSave('rngEQMid', 0);
hookRangeSave('rngEQHigh', 0);

applySelectValue('selFXPreset','digital');
hookSelectSave('selFXPreset');

const rngMediaGain = document.getElementById('rngMediaGain');
const rngFileVol Â  = document.getElementById('rngFileVol');
const rngSens = document.getElementById('rngSens');
const rngGamma = document.getElementById('rngGamma');
const rngCap = document.getElementById('rngCap');

const rngEQLow = document.getElementById('rngEQLow');
const rngEQMid = document.getElementById('rngEQMid');
const rngEQHigh = document.getElementById('rngEQHigh');

const txtMediaGain = document.getElementById('txtMediaGain');
const txtFileVol Â  = document.getElementById('txtFileVol');
const txtSens = document.getElementById('txtSens');
const txtGamma = document.getElementById('txtGamma');
const txtCap = document.getElementById('txtCap');

const txtEQLow = document.getElementById('txtEQLow');
const txtEQMid = document.getElementById('txtEQMid');
const txtEQHigh = document.getElementById('txtEQHigh');

function getMediaGain(){ return Math.max(0.2, Math.min(3.0, parseFloat(rngMediaGain.value)||1)); }
function getFileVol(){ return Math.max(0, Math.min(1, parseFloat(rngFileVol.value)||0.85)); }
function getSens(){ return Math.max(1, Math.min(12, parseFloat(rngSens.value)||7)); }
function getGamma(){ return Math.max(0.45, Math.min(1.20, parseFloat(rngGamma.value)||0.72)); }
function getCap(){ return Math.max(0.10, Math.min(0.70, parseFloat(rngCap.value)||0.42)); }

function getEQLow(){ return Math.max(-20, Math.min(20, parseFloat(rngEQLow.value)||0)); }
function getEQMid(){ return Math.max(-20, Math.min(20, parseFloat(rngEQMid.value)||0)); }
function getEQHigh(){ return Math.max(-20, Math.min(20, parseFloat(rngEQHigh.value)||0)); }

function refreshAudioLabels(){
Â  txtMediaGain.textContent = `media gain: ${getMediaGain().toFixed(2)}Ã—`;
Â  txtFileVol.textContent Â  = `file volume: ${getFileVol().toFixed(2)}`;
Â  txtSens.textContentÂ  Â  Â  = `analysis sens: ${getSens().toFixed(1)}Ã—`;
Â  txtGamma.textContent Â  Â  = `gamma: ${getGamma().toFixed(2)}`;
Â  txtCap.textContent Â  Â  Â  = `amp cap: ${getCap().toFixed(2)}`;

Â  txtEQLow.textContentÂ  = `low: ${getEQLow().toFixed(1)} dB (200Hz)`;
Â  txtEQMid.textContentÂ  = `mid: ${getEQMid().toFixed(1)} dB (1kHz)`;
Â  txtEQHigh.textContent = `high: ${getEQHigh().toFixed(1)} dB (4kHz)`;
}
['input','change'].forEach(ev=>{
Â  [rngMediaGain,rngFileVol,rngSens,rngGamma,rngCap,rngEQLow,rngEQMid,rngEQHigh].forEach(el=>{
Â  Â  el.addEventListener(ev, refreshAudioLabels);
Â  });
});
refreshAudioLabels();

function applyEQ(){
Â  if(!audioCtx || !eqLow) return;
Â  eqLow.gain.setTargetAtTime(getEQLow(), audioCtx.currentTime, 0.02);
Â  eqMid.gain.setTargetAtTime(getEQMid(), audioCtx.currentTime, 0.02);
Â  eqHigh.gain.setTargetAtTime(getEQHigh(), audioCtx.currentTime, 0.02);
}

function applyFileVol(){
Â  if(!audioCtx) return;
Â  if(fileGain) fileGain.gain.setTargetAtTime(getFileVol(), audioCtx.currentTime, 0.02);
Â  if(fileAudioEl) fileAudioEl.volume = getFileVol(); // (ë³´ì¡°) element level
}
rngFileVol.addEventListener('input', applyFileVol);
rngFileVol.addEventListener('change', applyFileVol);

function updateAmp(){
Â  if(!analyser) return;

Â  analyser.getByteTimeDomainData(timeData);
Â  let sum=0;
Â  for(let i=0;i<timeData.length;i++){
Â  Â  const v=(timeData[i]-128)/128;
Â  Â  sum+=v*v;
Â  }
Â  const rms=Math.sqrt(sum/timeData.length);

Â  const rmsG = rms * getMediaGain();
Â  ampSmooth += (rmsG-ampSmooth)*0.12;

Â  const boosted = Math.pow(Math.max(0, ampSmooth * getSens()), getGamma());
Â  const scaled = Math.min(getCap(), boosted);

Â  amp = scaled;
Â  ampDelta = Math.abs(amp - prevAmp);
Â  prevAmp = amp;
}

/* ==========================================================
Â Â  OUTPUT ROUTING (for recording + optional routing)
========================================================== */
const selMic = document.getElementById('selMic');
const txtSupport = document.getElementById('txtSupport');

let currentMicDeviceId = S.currentMicDeviceId ?? "default";

const monitorAudio = new Audio();
monitorAudio.autoplay = true;
monitorAudio.playsInline = true;
let monitorDest = null;

function setupOutputRouting(){
Â  if(!audioCtx) return;
Â  if(monitorDest) return;
Â  monitorDest = audioCtx.createMediaStreamDestination();
Â  masterGain.connect(monitorDest);
Â  monitorAudio.srcObject = monitorDest.stream;
}

async function listDevices(){
Â  let devices = [];
Â  try{ devices = await navigator.mediaDevices.enumerateDevices(); }catch(e){}
Â  const mics = devices.filter(d=>d.kind==="audioinput");

Â  // SYSTEM mic select
Â  selMic.innerHTML = "";
Â  if(mics.length===0){
Â  Â  selMic.disabled = true;
Â  Â  selMic.innerHTML = `<option>ë§ˆì´í¬ ì¥ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</option>`;
Â  }else{
Â  Â  selMic.disabled = false;
Â  Â  for(const d of mics){
Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  opt.value = d.deviceId;
Â  Â  Â  opt.textContent = d.label || `Mic (${d.deviceId.slice(0,6)}â€¦)`;
Â  Â  Â  if(d.deviceId === currentMicDeviceId) opt.selected = true;
Â  Â  Â  selMic.appendChild(opt);
Â  Â  }
Â  }

Â  // ENTRY mic select (mirror)
Â  const entrySelMic = document.getElementById('entrySelMic');
Â  entrySelMic.innerHTML = "";
Â  if(mics.length===0){
Â  Â  entrySelMic.disabled = true;
Â  Â  entrySelMic.innerHTML = `<option>ë§ˆì´í¬ ì¥ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</option>`;
Â  }else{
Â  Â  entrySelMic.disabled = false;
Â  Â  for(const d of mics){
Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  opt.value = d.deviceId;
Â  Â  Â  opt.textContent = d.label || `Mic (${d.deviceId.slice(0,6)}â€¦)`;
Â  Â  Â  if(d.deviceId === currentMicDeviceId) opt.selected = true;
Â  Â  Â  entrySelMic.appendChild(opt);
Â  Â  }
Â  }

Â  txtSupport.textContent =
Â  Â  `ì§€ì› ìƒíƒœ: mic=${mics.length}\n`+
Â  Â  `ë ‰/í”„ë¦¬ì¦ˆ ê°ì§€ ì‹œ ìë™ìœ¼ë¡œ Entryë¡œ ë³µê·€ (SYSTEM > Auto Reboot)\n`+
Â  Â  `ë…¹í™”(MediaRecorder)ëŠ” Chrome/Edge ê¶Œì¥ (Safari ì œí•œ ê°€ëŠ¥)`;
}

selMic.addEventListener('change', async ()=>{
Â  currentMicDeviceId = selMic.value;
Â  S.currentMicDeviceId = currentMicDeviceId;
Â  saveSettings(S);
Â  // mirror to entry
Â  const entrySelMic = document.getElementById('entrySelMic');
Â  if(entrySelMic) entrySelMic.value = currentMicDeviceId;

Â  if(currentSource==="mic" && micStream) await startMic(currentMicDeviceId, false);
});
document.getElementById('entrySelMic').addEventListener('change', async (e)=>{
Â  currentMicDeviceId = e.target.value;
Â  S.currentMicDeviceId = currentMicDeviceId;
Â  saveSettings(S);
Â  selMic.value = currentMicDeviceId;
Â  if(currentSource==="mic" && micStream) await startMic(currentMicDeviceId, false);
});

/* ==========================================================
Â Â  INPUT SOURCE: MIC / FILE
========================================================== */
function disconnectInputs(){
Â  if(inputNode){ try{ inputNode.disconnect(); }catch(e){} inputNode = null; }
Â  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream = null; }
Â  if(fileNode){ try{ fileNode.disconnect(); }catch(e){} fileNode = null; }
}

async function startMic(deviceId="default", hideEntry=true){
Â  ensureAudio();
Â  await audioCtx.resume();
Â  setupOutputRouting();

Â  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream = null; }
Â  if(inputNode){ try{ inputNode.disconnect(); }catch(e){} inputNode = null; }
Â  if(fileNode){ try{ fileNode.disconnect(); }catch(e){} fileNode = null; }

Â  try{
Â  Â  micStream = await navigator.mediaDevices.getUserMedia({
Â  Â  Â  audio: {
Â  Â  Â  Â  deviceId: deviceId ? { exact: deviceId } : undefined,
Â  Â  Â  Â  echoCancellation:false,
Â  Â  Â  Â  noiseSuppression:false,
Â  Â  Â  Â  autoGainControl:false
Â  Â  Â  }
Â  Â  });

Â  Â  const src = audioCtx.createMediaStreamSource(micStream);
Â  Â  inputNode = src;
Â  Â  src.connect(preGain);

Â  Â  await listDevices();
Â  Â  setMicButtons(true);
Â  Â  updateTopPill(1);
Â  Â  startStatus("Mic ON. (Entryì—ì„œ ë°”ë¡œ ì…ì¥ ê°€ëŠ¥)");

Â  Â  if(hideEntry) hideEntryAndEnter();
Â  }catch(e){
Â  Â  console.error(e);
Â  Â  startStatus("Mic ON ì‹¤íŒ¨. ê¶Œí•œ/ì¥ì¹˜ ì„ íƒ í™•ì¸.");
Â  Â  alert("ë§ˆì´í¬ ê¶Œí•œ ë˜ëŠ” ì¥ì¹˜ ì„ íƒì— ì‹¤íŒ¨í–ˆì–´ìš”. í¬ë¡¬ ê¶Œí•œ í™•ì¸!");
Â  }
}

function stopMic(){
Â  if(micStream){
Â  Â  micStream.getTracks().forEach(t=>t.stop());
Â  Â  micStream = null;
Â  }
Â  if(inputNode){
Â  Â  try{ inputNode.disconnect(); }catch(e){}
Â  Â  inputNode = null;
Â  }
Â  setMicButtons(false);
Â  updateTopPill(1);
}

function ensureFileAudioEl(){
Â  if(fileAudioEl) return;
Â  fileAudioEl = new Audio();
Â  fileAudioEl.crossOrigin = "anonymous";
Â  fileAudioEl.loop = true;
Â  fileAudioEl.preload = "auto";
Â  fileAudioEl.playsInline = true;
Â  fileAudioEl.volume = getFileVol();
}

function connectFileToChain(){
Â  ensureAudio();
Â  ensureFileAudioEl();
Â  if(!fileAudioEl.src) return;

Â  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream = null; }
Â  if(inputNode){ try{ inputNode.disconnect(); }catch(e){} inputNode = null; }
Â  if(fileNode){ try{ fileNode.disconnect(); }catch(e){} fileNode = null; }

Â  try{
Â  Â  fileNode = audioCtx.createMediaElementSource(fileAudioEl);
Â  Â  // NEW: fileNode -> fileGain -> preGain
Â  Â  fileGain.gain.setTargetAtTime(getFileVol(), audioCtx.currentTime, 0.01);
Â  Â  fileNode.connect(fileGain);
Â  Â  fileGain.connect(preGain);
Â  }catch(e){
Â  Â  try{
Â  Â  Â  const oldSrc = fileAudioEl.src;
Â  Â  Â  fileAudioEl.pause();
Â  Â  Â  fileAudioEl.srcObject = null;
Â  Â  Â  fileAudioEl = null;
Â  Â  Â  ensureFileAudioEl();
Â  Â  Â  fileAudioEl.src = oldSrc;
Â  Â  Â  fileNode = audioCtx.createMediaElementSource(fileAudioEl);
Â  Â  Â  fileNode.connect(fileGain);
Â  Â  Â  fileGain.connect(preGain);
Â  Â  }catch(err){
Â  Â  Â  console.error(err);
Â  Â  Â  alert("íŒŒì¼ ì†ŒìŠ¤ë¥¼ ì˜¤ë””ì˜¤ ì²´ì¸ì— ì—°ê²°í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆì–´ìš”.");
Â  Â  }
Â  }
Â  setMicButtons(false);
Â  applyFileVol();
Â  updateTopPill(1);
}

/* ENTRY <-> SYSTEM ë²„íŠ¼ ìƒíƒœë¥¼ ë™ì‹œì— ê´€ë¦¬ */
function setMicButtons(micOn){
Â  document.getElementById('entryMicOn').disabledÂ  = !audioCtx || micOn || (currentSource!=="mic");
Â  document.getElementById('entryMicOff').disabled = !micOn;
}

function startStatus(msg){
Â  const el = document.getElementById('startStatus');
Â  if(el) el.textContent = msg;
}

/* ==========================================================
Â Â  AFTER AUDIO UNLOCKED
========================================================== */
async function afterAudioUnlocked(){
Â  await listDevices();
Â  setMicButtons(!!micStream);
Â  updateTopPill(1);
}

/* ==========================================================
Â Â  MIDI (TouchMe)
========================================================== */
let midiAccess = null;
let midiInput = null;

let touchRaw = 0;
let touch = 0;
let touchSmooth = 0;
let lastMidiAt = 0;
let lastMidiRawText = "Waitingâ€¦";

let midiName="MIDI: ?";
let midiLog = [];
let midiLearn = false;

function pushMidiLog(line){
Â  midiLog.push(line);
Â  if(midiLog.length>18) midiLog.shift();
Â  document.getElementById('txtMIDI').textContent = `${midiName}\n` + midiLog.join('\n');
}

const selMIDIIn = document.getElementById('selMIDIIn');
const selMIDIType = document.getElementById('selMIDIType');
const numMIDINum = document.getElementById('numMIDINum');
const selMIDICh = document.getElementById('selMIDICh');
const selMIDIInvert = document.getElementById('selMIDIInvert');

hookSelectSave('selMIDIType');
hookNumberSave('numMIDINum', 1);
hookSelectSave('selMIDICh');
hookSelectSave('selMIDIInvert');

hookRangeSave('rngMIDIDead', 0.02);
hookRangeSave('rngMIDIGain', 1.60);
hookRangeSave('rngMIDICurve', 0.85);
hookRangeSave('rngMIDISmooth', 0.22);

const rngMIDIDead = document.getElementById('rngMIDIDead');
const rngMIDIGain = document.getElementById('rngMIDIGain');
const rngMIDICurve = document.getElementById('rngMIDICurve');
const rngMIDISmooth = document.getElementById('rngMIDISmooth');
const txtMIDIDead = document.getElementById('txtMIDIDead');
const txtMIDIGain = document.getElementById('txtMIDIGain');
const txtMIDICurve = document.getElementById('txtMIDICurve');
const txtMIDISmooth = document.getElementById('txtMIDISmooth');
const txtMIDIRaw = document.getElementById('txtMIDIRaw');
const txtMIDILast = document.getElementById('txtMIDILast');
const txtMIDISupport = document.getElementById('txtMIDISupport');
const rngSimTouch = document.getElementById('rngSimTouch');

function refreshMIDILabels(){
Â  txtMIDIDead.textContent = `deadzone: ${parseFloat(rngMIDIDead.value).toFixed(3)}`;
Â  txtMIDIGain.textContent = `gain: ${parseFloat(rngMIDIGain.value).toFixed(2)}Ã—`;
Â  txtMIDICurve.textContent = `curve: ${parseFloat(rngMIDICurve.value).toFixed(2)} ( <1 = ë” ì˜ˆë¯¼ )`;
Â  txtMIDISmooth.textContent = `smooth: ${parseFloat(rngMIDISmooth.value).toFixed(2)}`;
}
['input','change'].forEach(ev=>{
Â  [rngMIDIDead,rngMIDIGain,rngMIDICurve,rngMIDISmooth].forEach(el=>el.addEventListener(ev, refreshMIDILabels));
});
refreshMIDILabels();

function getMIDIDead(){ return Math.max(0, Math.min(0.25, parseFloat(rngMIDIDead.value)||0)); }
function getMIDIGain(){ return Math.max(0.3, Math.min(3.0, parseFloat(rngMIDIGain.value)||1)); }
function getMIDICurve(){ return Math.max(0.4, Math.min(2.8, parseFloat(rngMIDICurve.value)||1)); }
function getMIDISmooth(){ return Math.max(0.02, Math.min(0.50, parseFloat(rngMIDISmooth.value)||0.18)); }

function shapeMIDI(x){
Â  const inv = (selMIDIInvert.value==="1");
Â  if(inv) x = 1-x;

Â  const dead = getMIDIDead();
Â  if(x < dead) x = 0;
Â  else x = (x-dead) / (1-dead);

Â  x *= getMIDIGain();
Â  x = Math.max(0, Math.min(1, x));

Â  const curve = getMIDICurve();
Â  x = Math.pow(x, curve);
Â  return Math.max(0, Math.min(1, x));
}

function updateTouch(){
Â  const k = getMIDISmooth();
Â  touchSmooth += (touch - touchSmooth) * k;

Â  const now = performance.now();
Â  const idleMs = now - lastMidiAt;
Â  if(idleMs > 250 && !midiLearn){
Â  Â  touch *= 0.985;
Â  }
}

function midiParseRaw(data){
Â  const st = data[0] & 0xF0;
Â  const ch = data[0] & 0x0F;
Â  const d1 = data[1] ?? 0;
Â  const d2 = data[2] ?? 0;

Â  let type = "other";
Â  if(st===0xB0) type="cc";
Â  else if(st===0x90) type="noteon";
Â  else if(st===0x80) type="noteoff";
Â  return {st, ch, d1, d2, type};
}

function midiMsgToValue(data){
Â  const st = data[0] & 0xF0;
Â  const ch = data[0] & 0x0F;
Â  const d1 = data[1] ?? 0;
Â  const d2 = data[2] ?? 0;

Â  const wantCh = parseInt(selMIDICh.value,10);
Â  if(wantCh !== -1 && ch !== wantCh) return null;

Â  const mode = selMIDIType.value;
Â  const num = Math.max(0, Math.min(127, parseInt(numMIDINum.value,10)||0));

Â  if(mode==="cc"){
Â  Â  if(st !== 0xB0) return null;
Â  Â  if(d1 !== num) return null;
Â  Â  return { raw01: d2/127, ch, type:"cc", num:d1, val:d2 };
Â  }else{
Â  Â  if(st !== 0x90 && st !== 0x80) return null;
Â  Â  if(d1 !== num) return null;
Â  Â  const vel = (st===0x80) ? 0 : d2;
Â  Â  return { raw01: vel/127, ch, type:"note", num:d1, val:vel };
Â  }
}

async function initMIDI(){
Â  if(!navigator.requestMIDIAccess){
Â  Â  midiName="MIDI: not supported";
Â  Â  txtMIDISupport.textContent = "âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” WebMIDIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. â†’ Sim Touchë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥";
Â  Â  pushMidiLog("requestMIDIAccess ì—†ìŒ");
Â  Â  return;
Â  }
Â  try{
Â  Â  midiAccess = await navigator.requestMIDIAccess({sysex:false});
Â  Â  midiAccess.onstatechange = ()=> rebuildMIDIInputs();
Â  Â  rebuildMIDIInputs(true);
Â  Â  txtMIDISupport.textContent = "âœ… WebMIDI OK. TouchMe ì—°ê²° í›„ LEARN ëˆ„ë¥´ê³  í•œ ë²ˆ í„°ì¹˜í•˜ì„¸ìš”.";
Â  Â  pushMidiLog("MIDI ready.");
Â  }catch(e){
Â  Â  console.error(e);
Â  Â  midiName="MIDI: blocked";
Â  Â  txtMIDISupport.textContent = "âš ï¸ MIDI ì ‘ê·¼ì´ ì°¨ë‹¨ë¨. Chrome ê¶Œí•œ/ë³´ì•ˆ(https) í™•ì¸.";
Â  Â  pushMidiLog("MIDI access failed");
Â  }
}

function rebuildMIDIInputs(autoselect=false){
Â  if(!midiAccess){
Â  Â  selMIDIIn.innerHTML = `<option value="">MIDI not ready</option>`;
Â  Â  return;
Â  }
Â  const inputs = [...midiAccess.inputs.values()];
Â  selMIDIIn.innerHTML = "";
Â  if(inputs.length===0){
Â  Â  selMIDIIn.innerHTML = `<option value="">No MIDI inputs</option>`;
Â  Â  midiName="MIDI: no inputs";
Â  Â  pushMidiLog("No MIDI devices. TouchMe USB/BT í™•ì¸.");
Â  Â  return;
Â  }

Â  for(const inp of inputs){
Â  Â  const opt = document.createElement('option');
Â  Â  opt.value = inp.id;
Â  Â  opt.textContent = inp.name || `MIDI (${inp.id.slice(0,6)}â€¦)`;
Â  Â  selMIDIIn.appendChild(opt);
Â  }

Â  const savedId = S.midiInputId ?? "";
Â  const hasSaved = inputs.some(i=>i.id===savedId);

Â  if(hasSaved){
Â  Â  selMIDIIn.value = savedId;
Â  Â  attachMIDIInput(savedId);
Â  }else if(autoselect){
Â  Â  selMIDIIn.value = inputs[0].id;
Â  Â  attachMIDIInput(inputs[0].id);
Â  }
}

function setLearn(on){
Â  midiLearn = on;
Â  const b = document.getElementById('btnMIDILearn');
Â  b.classList.toggle('on', on);
Â  b.textContent = on ? "LEARN (ON)" : "LEARN";
Â  if(on) pushMidiLog("LEARN: TouchMeë¥¼ í•œ ë²ˆ í„°ì¹˜í•˜ì„¸ìš” (CC/NOTE ìë™ ë§¤í•‘).");
}

function attachMIDIInput(id){
Â  if(!midiAccess) return;
Â  const inp = [...midiAccess.inputs.values()].find(i=>i.id===id);
Â  if(!inp) return;

Â  if(midiInput) midiInput.onmidimessage = null;
Â  midiInput = inp;
Â  S.midiInputId = id;
Â  saveSettings(S);

Â  midiName = "MIDI: " + (midiInput.name || "input");
Â  pushMidiLog("Connected: " + midiName);

Â  midiInput.onmidimessage = (e)=>{
Â  Â  const data = e.data;
Â  Â  const r = midiParseRaw(data);
Â  Â  lastMidiAt = performance.now();
Â  Â  lastMidiRawText = `st:0x${r.st.toString(16)} | ch:${r.ch+1} | d1:${r.d1} | d2:${r.d2} | type:${r.type}`;
Â  Â  txtMIDILast.textContent = lastMidiRawText;

Â  Â  if(midiLearn){
Â  Â  Â  if(r.st===0xB0){
Â  Â  Â  Â  selMIDIType.value = "cc";
Â  Â  Â  Â  numMIDINum.value = r.d1;
Â  Â  Â  Â  selMIDICh.value = String(r.ch);
Â  Â  Â  Â  saveSettings(Object.assign(S, { selMIDIType:"cc", numMIDINum: r.d1, selMIDICh: String(r.ch) }));
Â  Â  Â  Â  pushMidiLog(`LEARN OK: CC #${r.d1} ch:${r.ch+1}`);
Â  Â  Â  Â  setLearn(false);
Â  Â  Â  }else if(r.st===0x90 || r.st===0x80){
Â  Â  Â  Â  selMIDIType.value = "note";
Â  Â  Â  Â  numMIDINum.value = r.d1;
Â  Â  Â  Â  selMIDICh.value = String(r.ch);
Â  Â  Â  Â  saveSettings(Object.assign(S, { selMIDIType:"note", numMIDINum: r.d1, selMIDICh: String(r.ch) }));
Â  Â  Â  Â  pushMidiLog(`LEARN OK: NOTE #${r.d1} ch:${r.ch+1}`);
Â  Â  Â  Â  setLearn(false);
Â  Â  Â  }
Â  Â  }

Â  Â  const parsed = midiMsgToValue(data);
Â  Â  if(!parsed){
Â  Â  Â  if(Math.random() < 0.18) pushMidiLog(`raw=[${[...data].join(',')}] (not mapped)`);
Â  Â  Â  return;
Â  Â  }

Â  Â  touchRaw = parsed.raw01;
Â  Â  touch = shapeMIDI(touchRaw);

Â  Â  txtMIDIRaw.textContent =
Â  Â  Â  `raw01:${touchRaw.toFixed(3)} -> touch:${touch.toFixed(3)} | ${parsed.type.toUpperCase()} #${parsed.num} ch:${parsed.ch+1} val:${parsed.val}`;

Â  Â  if(Math.random() < 0.22){
Â  Â  Â  pushMidiLog(`mapped ${parsed.type} #${parsed.num} ch:${parsed.ch+1} -> touch=${touch.toFixed(3)}`);
Â  Â  }
Â  };
}

selMIDIIn.addEventListener('change', ()=> attachMIDIInput(selMIDIIn.value));
document.getElementById('btnMIDIInit').addEventListener('click', initMIDI);
document.getElementById('btnMIDILearn').addEventListener('click', ()=> setLearn(!midiLearn));

/* restore midi controls */
applySelectValue('selMIDIType', 'cc');
applySelectValue('selMIDICh', '-1');
applySelectValue('selMIDIInvert', '0');
hookSelectSave('selMIDIType');
hookSelectSave('selMIDICh');
hookSelectSave('selMIDIInvert');
hookNumberSave('numMIDINum', 1);

rngSimTouch.value = (S.rngSimTouch ?? 0);
rngSimTouch.addEventListener('input', ()=>{
Â  S.rngSimTouch = parseFloat(rngSimTouch.value);
Â  saveSettings(S);
Â  notifyTowerValue('rngSimTouch', rngSimTouch.value);
});

/* ==========================================================
Â Â  FX PRESETS + MAPPING (Touch)
========================================================== */
function getPreset(){
Â  return document.getElementById('selFXPreset').value || "digital";
}

/* Core knobs that presets affect (base targets) */
function presetParams(preset){
Â  // Return base settings; touch(t) will modulate around these
Â  switch(preset){
Â  Â  case "piano":
Â  Â  Â  return {
Â  Â  Â  Â  pre: 0.95, preMax: 1.25,
Â  Â  Â  Â  driveBase: 6, driveMax: 28,
Â  Â  Â  Â  bpFreq: 1400, bpMax: 5200, bpQ: 0.9, bpQMax: 5.5,
Â  Â  Â  Â  ringBase: 0, ringMax: 0.22, ringHz: 0, ringHzMax: 120,
Â  Â  Â  Â  widenBase: 0.25, widenMax: 0.65,
Â  Â  Â  Â  compTh: -20, compRt: 5.5
Â  Â  Â  };
Â  Â  case "bells":
Â  Â  Â  return {
Â  Â  Â  Â  pre: 0.80, preMax: 1.10,
Â  Â  Â  Â  driveBase: 5, driveMax: 18,
Â  Â  Â  Â  bpFreq: 2400, bpMax: 7800, bpQ: 1.4, bpQMax: 10,
Â  Â  Â  Â  ringBase: 0.10, ringMax: 0.55, ringHz: 120, ringHzMax: 520,
Â  Â  Â  Â  widenBase: 0.30, widenMax: 0.95,
Â  Â  Â  Â  compTh: -22, compRt: 6.0
Â  Â  Â  };
Â  Â  case "warm":
Â  Â  Â  return {
Â  Â  Â  Â  pre: 1.05, preMax: 1.55,
Â  Â  Â  Â  driveBase: 12, driveMax: 55,
Â  Â  Â  Â  bpFreq: 550, bpMax: 2400, bpQ: 0.8, bpQMax: 4.2,
Â  Â  Â  Â  ringBase: 0.00, ringMax: 0.15, ringHz: 0, ringHzMax: 60,
Â  Â  Â  Â  widenBase: 0.18, widenMax: 0.55,
Â  Â  Â  Â  compTh: -24, compRt: 7.5
Â  Â  Â  };
Â  Â  case "glitch":
Â  Â  Â  return {
Â  Â  Â  Â  pre: 0.75, preMax: 1.25,
Â  Â  Â  Â  driveBase: 18, driveMax: 95,
Â  Â  Â  Â  bpFreq: 900, bpMax: 7200, bpQ: 2.0, bpQMax: 18,
Â  Â  Â  Â  ringBase: 0.15, ringMax: 0.95, ringHz: 60, ringHzMax: 460,
Â  Â  Â  Â  widenBase: 0.20, widenMax: 1.00,
Â  Â  Â  Â  compTh: -26, compRt: 8.5
Â  Â  Â  };
Â  Â  default: // "digital"
Â  Â  Â  return {
Â  Â  Â  Â  pre: 0.85, preMax: 2.10,
Â  Â  Â  Â  driveBase: 10, driveMax: 105,
Â  Â  Â  Â  bpFreq: 180, bpMax: 7200, bpQ: 1.0, bpQMax: 19,
Â  Â  Â  Â  ringBase: 0.00, ringMax: 0.95, ringHz: 10, ringHzMax: 370,
Â  Â  Â  Â  widenBase: 0.10, widenMax: 0.95,
Â  Â  Â  Â  compTh: -22, compRt: 7.0
Â  Â  Â  };
Â  }
}

function applyFX(){
Â  if(!audioCtx) return;

Â  const sim = Math.max(0, Math.min(1, parseFloat(rngSimTouch.value)||0));
Â  const t = Math.max(touchSmooth, sim);

Â  const P = presetParams(getPreset());

Â  // mild wobble always (keeps lively)
Â  const wob = (Math.sin(performance.now()*0.0017)*0.5+0.5);

Â  // Drive
Â  const driveAmt = P.driveBase + t*(P.driveMax - P.driveBase);
Â  driveWS.curve = makeWaveshaper(driveAmt);

Â  // Gain staging
Â  preGain.gain.setTargetAtTime(P.pre + t*(P.preMax - P.pre), audioCtx.currentTime, 0.03);
Â  driveGain.gain.setTargetAtTime(0.95 + t*0.90, audioCtx.currentTime, 0.03);

Â  // Filter
Â  const f = P.bpFreq + Math.pow(t, 1.35) * (P.bpMax - P.bpFreq);
Â  const q = P.bpQ + t*(P.bpQMax - P.bpQ);
Â  filter.frequency.setTargetAtTime(f, audioCtx.currentTime, 0.03);
Â  filter.Q.setTargetAtTime(q, audioCtx.currentTime, 0.03);

Â  // Ring
Â  const ringDepth = P.ringBase + t*(P.ringMax - P.ringBase);
Â  const ringHz = (P.ringHz===0 && P.ringHzMax===0) ? 0 : (P.ringHz + t*(P.ringHzMax - P.ringHz));
Â  ringOsc.frequency.setTargetAtTime(Math.max(1, ringHz||1), audioCtx.currentTime, 0.03);
Â  ringGain.gain.setTargetAtTime(ringDepth, audioCtx.currentTime, 0.03);

Â  // Widen (delay)
Â  const widen = P.widenBase + t*(P.widenMax - P.widenBase);
Â  dL.delayTime.setTargetAtTime(0.0015 + widen*0.014 + wob*0.0012, audioCtx.currentTime, 0.05);
Â  dR.delayTime.setTargetAtTime(0.0040 + widen*0.020 + (1-wob)*0.0014, audioCtx.currentTime, 0.05);

Â  // Compressor (preset-tuned)
Â  comp.threshold.setTargetAtTime(P.compTh, audioCtx.currentTime, 0.08);
Â  comp.ratio.setTargetAtTime(P.compRt, audioCtx.currentTime, 0.08);

Â  document.getElementById('txtFx').textContent =
Â  Â  `preset:${getPreset()} | drive:${driveAmt.toFixed(1)} | filter:${f.toFixed(0)}Hz Q:${q.toFixed(1)} | ring:${(ringHz||0).toFixed(1)}Hz depth:${ringDepth.toFixed(2)} | widen:${widen.toFixed(2)}`;
}

/* ==========================================================
Â Â  VISUAL UI + PARAMS
========================================================== */
hookRangeSave('rngIdleDrama', 0.55);
hookRangeSave('rngVisSens', 1.55);
hookRangeSave('rngLine', 0.75);
hookRangeSave('rngPerf', 0.72);
hookRangeSave('rngFade', 0.03);
hookRangeSave('rngPointSize', 0.60);
hookRangeSave('rngGlow', 0.45);
hookRangeSave('rngSpeed', 0.72);

applySelectValue('selPointColor', 'red');
hookSelectSave('selPointColor');

const rngIdleDrama = document.getElementById('rngIdleDrama');
const rngVisSens Â  = document.getElementById('rngVisSens');
const rngLineÂ  Â  Â  = document.getElementById('rngLine');
const rngPerfÂ  Â  Â  = document.getElementById('rngPerf');
const rngFadeÂ  Â  Â  = document.getElementById('rngFade');
const rngPointSize = document.getElementById('rngPointSize');
const rngGlowÂ  Â  Â  = document.getElementById('rngGlow');
const rngSpeed Â  Â  = document.getElementById('rngSpeed');

const txtIdleDrama = document.getElementById('txtIdleDrama');
const txtVisSens Â  = document.getElementById('txtVisSens');
const txtLineÂ  Â  Â  = document.getElementById('txtLine');
const txtPerfÂ  Â  Â  = document.getElementById('txtPerf');
const txtFadeÂ  Â  Â  = document.getElementById('txtFade');
const txtPointSize = document.getElementById('txtPointSize');
const txtGlowÂ  Â  Â  = document.getElementById('txtGlow');
const txtSpeed Â  Â  = document.getElementById('txtSpeed');

function getIdleDrama(){ return Math.max(0, Math.min(1, parseFloat(rngIdleDrama.value)||0.55)); }
function getVisSens(){ return Math.max(0.6, Math.min(2.6, parseFloat(rngVisSens.value)||1.55)); }
function getLineMul(){ return Math.max(0.2, Math.min(1.2, parseFloat(rngLine.value)||0.75)); }
function getPerfLim(){ return Math.max(0.25, Math.min(1.0, parseFloat(rngPerf.value)||0.72)); }
function getFade(){ return Math.max(0.02, Math.min(0.20, parseFloat(rngFade.value)||0.03)); }
function getPointSize(){ return Math.max(0.4, Math.min(1.2, parseFloat(rngPointSize.value)||0.6)); }
function getGlow(){ return Math.max(0.10, Math.min(1.0, parseFloat(rngGlow.value)||0.45)); }
function getSpeedMul(){ return Math.max(0.35, Math.min(1.25, parseFloat(rngSpeed.value)||0.72)); }
function getPointColor(){
Â  return (document.getElementById('selPointColor').value === "red") ? "#ff3b3b" : "#ffffff";
}

function refreshVisualLabels(){
Â  txtIdleDrama.textContent = `idle drama: ${getIdleDrama().toFixed(2)}`;
Â  txtVisSens.textContent Â  = `visual sens: ${getVisSens().toFixed(2)}Ã—`;
Â  txtLine.textContentÂ  Â  Â  = `line density: ${getLineMul().toFixed(2)}Ã—`;
Â  txtPerf.textContentÂ  Â  Â  = `perf limit: ${getPerfLim().toFixed(2)}`;
Â  txtFade.textContentÂ  Â  Â  = `fade: ${getFade().toFixed(3)}`;
Â  txtPointSize.textContent = `point size: ${getPointSize().toFixed(2)}Ã—`;
Â  txtGlow.textContentÂ  Â  Â  = `glow: ${getGlow().toFixed(2)}Ã—`;
Â  txtSpeed.textContent Â  Â  = `speed: ${getSpeedMul().toFixed(2)}Ã— (slower)`;
}
['input','change'].forEach(ev=>{
Â  [rngIdleDrama,rngVisSens,rngLine,rngPerf,rngFade,rngPointSize,rngGlow,rngSpeed].forEach(el=>{
Â  Â  el.addEventListener(ev, refreshVisualLabels);
Â  });
});
refreshVisualLabels();

/* ==========================================================
Â Â  VISUAL FIELD
========================================================== */
let N = 220;
let pts = [];
let rot = 0;

const BASE_QUIET_TH = 0.0032;
const BASE_ACTIVE_TH = 0.0065;
const BASE_ONSET_THÂ  = 0.0060;

let energy = 0;
let burstEnergy = 0;

function initPoints(){
Â  pts = [];
Â  for(let i=0;i<N;i++){
Â  Â  pts.push({
Â  Â  Â  x:(Math.random()*2-1)*(W*0.34),
Â  Â  Â  y:(Math.random()*2-1)*(H*0.34),
Â  Â  Â  z:(Math.random()*2-1)*340,
Â  Â  Â  vx:0,vy:0,vz:0
Â  Â  });
Â  }
}
initPoints();

function project(p){
Â  const s=Math.sin(rot), c=Math.cos(rot);
Â  const x = p.x*c - p.z*s;
Â  const z = p.x*s + p.z*c;
Â  const depth = 900;
Â  const k = depth/(depth+z);
Â  return { x:x*k + W/2, y:p.y*k + H/2, k, z };
}

function applyBounds(p, mode){
Â  if(mode==="wrap"){
Â  Â  const maxX=W*0.65, maxY=H*0.65, maxZ=560;
Â  Â  if(p.x> maxX) p.x=-maxX;
Â  Â  if(p.x<-maxX) p.x= maxX;
Â  Â  if(p.y> maxY) p.y=-maxY;
Â  Â  if(p.y<-maxY) p.y= maxY;
Â  Â  if(p.z> maxZ) p.z=-maxZ;
Â  Â  if(p.z<-maxZ) p.z= maxZ;
Â  Â  return;
Â  }

Â  const maxX=W*0.58, maxY=H*0.58, maxZ=560;

Â  if(mode==="bounce"){
Â  Â  if(p.x> maxX){ p.x=maxX; p.vx*=-0.7; }
Â  Â  if(p.x<-maxX){ p.x=-maxX; p.vx*=-0.7; }
Â  Â  if(p.y> maxY){ p.y=maxY; p.vy*=-0.7; }
Â  Â  if(p.y<-maxY){ p.y=-maxY; p.vy*=-0.7; }
Â  Â  if(p.z> maxZ){ p.z=maxZ; p.vz*=-0.7; }
Â  Â  if(p.z<-maxZ){ p.z=-maxZ; p.vz*=-0.7; }
Â  Â  return;
Â  }

Â  const pull = 0.0026;
Â  const edgeX = Math.max(0, Math.abs(p.x) - maxX);
Â  const edgeY = Math.max(0, Math.abs(p.y) - maxY);
Â  const edgeZ = Math.max(0, Math.abs(p.z) - maxZ);
Â  if(edgeX>0) p.vx += (-Math.sign(p.x)) * edgeX * pull;
Â  if(edgeY>0) p.vy += (-Math.sign(p.y)) * edgeY * pull;
Â  if(edgeZ>0) p.vz += (-Math.sign(p.z)) * edgeZ * pull;
}

/* ==========================================================
Â Â  TOP UI / TOGGLES
========================================================== */
function updateTopPill(q=1){
Â  const pill = document.getElementById('topPill');
Â  const a = audioCtx ? audioCtx.state : 'off';
Â  const src = (currentSource==="mic")
Â  Â  ? (micStream ? "mic:on" : "mic:off")
Â  Â  : (fileAudioEl && fileAudioEl.src ? (fileAudioEl.paused ? "file:loaded" : "file:play") : "file:empty");
Â  pill.textContent = `audio:${a} | src:${src} | q:${q.toFixed(2)}`;
}

document.getElementById('btnMuteQuick').addEventListener('click', ()=>{
Â  if(!audioCtx) return;
Â  isMuted = !isMuted;
Â  masterGain.gain.setTargetAtTime(isMuted?0:0.9, audioCtx.currentTime, 0.02);
Â  document.getElementById('btnMuteQuick').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”ˆ';
});

function toggleFullscreen(){
Â  const el = document.documentElement;
Â  if(!document.fullscreenElement) el.requestFullscreen?.();
Â  else document.exitFullscreen?.();
}
document.getElementById('btnFS').addEventListener('click', toggleFullscreen);
document.getElementById('btnFSQuick').addEventListener('click', toggleFullscreen);

/* ==========================================================
Â Â  SOURCE SELECT UI (SYSTEM) + (ENTRY mirror)
========================================================== */
const selSrc = document.getElementById('selSrc');
const rowMic = document.getElementById('rowMic');
const rowFile = document.getElementById('rowFile');

const entrySelSrc = document.getElementById('entrySelSrc');
const entryMicBox = document.getElementById('entryMicBox');
const entryFileBox = document.getElementById('entryFileBox');

function applySourceUI(){
Â  currentSource = selSrc.value;
Â  S.currentSource = currentSource;
Â  saveSettings(S);
Â  notifyTowerValue('selSrc', currentSource);

Â  rowMic.style.display = (currentSource==="mic") ? "" : "none";
Â  rowFile.style.display = (currentSource==="file") ? "" : "none";

Â  // entry mirror
Â  entrySelSrc.value = currentSource;
Â  entryMicBox.style.display = (currentSource==="mic") ? "" : "none";
Â  entryFileBox.style.display = (currentSource==="file") ? "" : "none";

Â  setMicButtons(!!micStream);
Â  updateTopPill(1);
}
selSrc.addEventListener('change', async ()=>{
Â  applySourceUI();
Â  if(currentSource==="mic"){
Â  Â  if(fileAudioEl){ try{ fileAudioEl.pause(); }catch(e){} }
Â  Â  if(fileNode){ try{ fileNode.disconnect(); }catch(e){} fileNode=null; }
Â  Â  ampSmooth=amp=ampDelta=prevAmp=0;
Â  }else{
Â  Â  stopMic();
Â  Â  if(inputNode){ try{ inputNode.disconnect(); }catch(e){} inputNode=null; }
Â  Â  ampSmooth=amp=ampDelta=prevAmp=0;
Â  Â  if(fileAudioEl && fileAudioEl.src){
Â  Â  Â  ensureAudio(); await audioCtx.resume();
Â  Â  Â  connectFileToChain();
Â  Â  Â  applyFileVol();
Â  Â  }
Â  }
});
entrySelSrc.addEventListener('change', async ()=>{
Â  selSrc.value = entrySelSrc.value;
Â  applySourceUI();
Â  if(currentSource==="file"){
Â  Â  stopMic();
Â  }
});

applySelectValue('selSrc', (S.currentSource ?? 'mic'));
hookSelectSave('selSrc');
applySourceUI();

/* ==========================================================
Â Â  FILE CONTROLS (SYSTEM + ENTRY mirror)
========================================================== */
const fileAudio = document.getElementById('fileAudio');
const btnFilePlay = document.getElementById('btnFilePlay');
const btnFilePause = document.getElementById('btnFilePause');
const btnFileStop = document.getElementById('btnFileStop');
const txtFile = document.getElementById('txtFile');

const entryFileAudio = document.getElementById('entryFileAudio');
const entryFilePlay = document.getElementById('entryFilePlay');
const entryFilePause = document.getElementById('entryFilePause');
const entryFileStop = document.getElementById('entryFileStop');
const entryFileTxt = document.getElementById('entryFileTxt');

function setSystemFileBtns(enabled){
Â  btnFilePlay.disabled = !enabled;
Â  btnFilePause.disabled = !enabled;
Â  btnFileStop.disabled = !enabled;
}
function setEntryFileBtns(enabled){
Â  entryFilePlay.disabled = !enabled;
Â  entryFilePause.disabled = !enabled;
Â  entryFileStop.disabled = !enabled;
}
setSystemFileBtns(false);
setEntryFileBtns(false);

async function loadFileFromInput(file){
Â  if(!file) return;

Â  ensureAudio();
Â  await audioCtx.resume();
Â  setupOutputRouting();
Â  ensureFileAudioEl();

Â  const url = URL.createObjectURL(file);
Â  try{ fileAudioEl.pause(); }catch(e){}
Â  fileAudioEl.src = url;
Â  fileAudioEl.loop = true;
Â  fileAudioEl.volume = getFileVol();

Â  txtFile.textContent = `loaded: ${file.name} (${Math.round(file.size/1024)} KB)`;
Â  entryFileTxt.textContent = `loaded: ${file.name} (${Math.round(file.size/1024)} KB)`;

Â  if(currentSource!=="file"){
Â  Â  selSrc.value = "file";
Â  Â  applySourceUI();
Â  }

Â  connectFileToChain();
Â  setSystemFileBtns(true);
Â  setEntryFileBtns(true);
Â  applyFileVol();
Â  updateTopPill(1);
}

fileAudio.addEventListener('change', async ()=>{
Â  const f = fileAudio.files && fileAudio.files[0];
Â  if(!f) return;
Â  await loadFileFromInput(f);
});
entryFileAudio.addEventListener('change', async ()=>{
Â  const f = entryFileAudio.files && entryFileAudio.files[0];
Â  if(!f) return;
Â  await loadFileFromInput(f);
});

/* ==========================================================
Â Â  ENTRY ENTER
========================================================== */
function hideEntryAndEnter(){ document.getElementById('hint').style.display='none'; }
function showEntry(msg=""){
Â  document.getElementById('hint').style.display='flex';
Â  if(msg) startStatus(msg);
}

entryFilePlay.addEventListener('click', async ()=>{
Â  if(!fileAudioEl || !fileAudioEl.src) return;
Â  ensureAudio(); await audioCtx.resume();
Â  connectFileToChain();
Â  applyFileVol();
Â  try{ await fileAudioEl.play(); }catch(e){
Â  Â  alert("ì¬ìƒì´ ë§‰í˜”ì–´ìš”. í™”ë©´ì„ í•œë²ˆ í„°ì¹˜/í´ë¦­í•œ ë’¤ ë‹¤ì‹œ Play ëˆŒëŸ¬ì£¼ì„¸ìš”.");
Â  Â  return;
Â  }
Â  updateTopPill(1);
Â  hideEntryAndEnter();
});
entryFilePause.addEventListener('click', ()=>{
Â  if(!fileAudioEl) return;
Â  try{ fileAudioEl.pause(); }catch(e){}
Â  updateTopPill(1);
});
entryFileStop.addEventListener('click', ()=>{
Â  if(!fileAudioEl) return;
Â  try{ fileAudioEl.pause(); fileAudioEl.currentTime = 0; }catch(e){}
Â  updateTopPill(1);
});

btnFilePlay.addEventListener('click', async ()=>{
Â  if(!fileAudioEl || !fileAudioEl.src) return;
Â  ensureAudio(); await audioCtx.resume();
Â  connectFileToChain();
Â  applyFileVol();
Â  try{ await fileAudioEl.play(); }catch(e){
Â  Â  alert("ì¬ìƒì´ ë§‰í˜”ì–´ìš”. í™”ë©´ì„ í•œë²ˆ í„°ì¹˜/í´ë¦­í•œ ë’¤ ë‹¤ì‹œ Play ëˆŒëŸ¬ì£¼ì„¸ìš”.");
Â  }
Â  updateTopPill(1);
});
btnFilePause.addEventListener('click', ()=>{
Â  if(!fileAudioEl) return;
Â  try{ fileAudioEl.pause(); }catch(e){}
Â  updateTopPill(1);
});
btnFileStop.addEventListener('click', ()=>{
Â  if(!fileAudioEl) return;
Â  try{ fileAudioEl.pause(); fileAudioEl.currentTime = 0; }catch(e){}
Â  updateTopPill(1);
});

/* ENTRY mic buttons */
document.getElementById('entryMicOn').addEventListener('click', async ()=>{
Â  if(currentSource!=="mic") return;
Â  await startMic(currentMicDeviceId, true);
});
document.getElementById('entryMicOff').addEventListener('click', ()=> stopMic());

/* ==========================================================
Â Â  ENTRY: Start Audio (unlock) + device list + MIDI init
========================================================== */
// [ìˆ˜ì •ëœ ë¶€ë¶„: Start Audio ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ]
document.getElementById('btnStartAudio').addEventListener('click', async ()=>{
Â  // Ensure the audio context is created (if not already)
Â  ensureAudio();
Â  
Â  // Try to resume/unlock the audio context
Â  if (audioCtx.state === 'suspended') {
Â  Â  try {
Â  Â  Â  await audioCtx.resume();
Â  Â  Â  await afterAudioUnlocked();
Â  Â  Â  await initMIDI();
Â  Â  Â  applyFileVol();
Â  Â  Â  startStatus("Audio unlocked. ì´ì œ Mic/File ì„ íƒ í›„ Enter ë²„íŠ¼ìœ¼ë¡œ ì…ì¥!");
Â  Â  } catch (e) {
Â  Â  Â  console.error("Audio Context Resume failed:", e);
Â  Â  Â  startStatus("Audio unlock ì‹¤íŒ¨. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
Â  Â  }
Â  } else if (audioCtx.state === 'running') {
Â  Â  // Already running, just refresh device list and status
Â  Â  await afterAudioUnlocked();
Â  Â  await initMIDI();
Â  Â  applyFileVol();
Â  Â  startStatus("Audio already unlocked. Mic/File ì„ íƒ í›„ Enter ë²„íŠ¼ìœ¼ë¡œ ì…ì¥!");
Â  }
});
// [ìˆ˜ì •ëœ ë¶€ë¶„ ë]

addEventListener('pointerdown', async ()=>{
Â  if(audioCtx && audioCtx.state==='suspended'){
Â  Â  await audioCtx.resume();
Â  }
},{passive:true});

/* ==========================================================
Â Â  VISUAL SELECT RESTORE
========================================================== */
applySelectValue('selMode', 'pulse');
applySelectValue('selN', '220');
applySelectValue('selBounds', 'soft');
applySelectValue('selQuietLines', '1');
applySelectValue('selAutoReboot', '1');

['selMode','selN','selBounds','selQuietLines','selAutoReboot'].forEach(hookSelectSave);

document.getElementById('selN').addEventListener('change', (e)=>{
Â  N = parseInt(e.target.value,10);
Â  initPoints();
});

/* ==========================================================
Â Â  ENTRY REBOOT (lag/freeze â†’ Entry)
========================================================== */
function clearRuntime(){
Â  amp = 0; ampSmooth = 0; ampDelta = 0; prevAmp = 0;
Â  touchRaw = 0; touch = 0; touchSmooth = 0; lastMidiAt = 0;
Â  energy = 0; burstEnergy = 0; rot = 0;
Â  initPoints();

Â  document.getElementById('hudMidi').textContent = "midi: -";
Â  document.getElementById('hudTouch').textContent = "0.000";
Â  document.getElementById('hudAmp').textContent = "0.000";
Â  document.getElementById('hudTouchBar').style.width = "0%";

Â  ctx.setTransform(DPR,0,0,DPR,0,0);
Â  ctx.fillStyle="#000";
Â  ctx.fillRect(0,0,W,H);
}

async function entryReboot(reason="lag"){
Â  console.warn("ENTRY REBOOT:", reason);

Â  try{ stopMic(); }catch(e){}
Â  try{
Â  Â  if(fileAudioEl){ try{ fileAudioEl.pause(); }catch(e){} }
Â  }catch(e){}

Â  try{ disconnectInputs(); }catch(e){}
Â  fileNode = null;
Â  inputNode = null;

Â  // close audio context to truly clear overload (user wants "Start Audio" stage again)
Â  try{
Â  Â  if(audioCtx){
Â  Â  Â  try{ await audioCtx.close(); }catch(e){}
Â  Â  }
Â  }catch(e){}
Â  audioCtx = null;
Â  analyser = null;
Â  timeData = null;
Â  masterGain = null;
Â  preGain = null;
Â  eqLow = eqMid = eqHigh = null;
Â  driveWS = driveGain = null;
Â  filter = null;
Â  ringOsc = null;
Â  ringGain = null;
Â  ringMult = null;
Â  splitter = null;
Â  dL = dR = null;
Â  merger = null;
Â  comp = null;
Â  monitorDest = null;
Â  fileGain = null;

Â  clearRuntime();

Â  setMicButtons(false);
Â  updateTopPill(1);

Â  // Entry UI states (Start Audio must be pressed again)
Â  document.getElementById('entrySelMic').disabled = true;
Â  document.getElementById('entrySelMic').innerHTML = `<option>Start Audio í›„ ëª©ë¡ ë¡œë“œ</option>`;
Â  document.getElementById('entryMicOn').disabled = true;
Â  document.getElementById('entryMicOff').disabled = true;

Â  showEntry(`ë ‰ ê°ì§€ â†’ Entryë¡œ ë³µê·€ (reason: ${reason})`);
}

/* ==========================================================
Â Â  AUTO REBOOT ON LAG / FREEZE
========================================================== */
const selAutoReboot = document.getElementById('selAutoReboot');
function autoRebootEnabled(){ return (selAutoReboot.value === "1"); }

let lastFrameT = performance.now();
let frameMsSmooth = 16.7;
let lagTimer = 0;

let lastAnimTick = performance.now();
setInterval(()=>{
Â  const now = performance.now();
Â  if(!autoRebootEnabled()) return;
Â  if(now - lastAnimTick > 1600){
Â  Â  entryReboot("freeze watchdog");
Â  Â  lastAnimTick = now;
Â  }
}, 400);

function checkLag(dt){
Â  if(!autoRebootEnabled()) return;
Â  if(dt > 45){
Â  Â  lagTimer += dt;
Â  Â  if(lagTimer > 2200){
Â  Â  Â  entryReboot("lag reboot");
Â  Â  Â  lagTimer = 0;
Â  Â  }
Â  }else{
Â  Â  lagTimer = Math.max(0, lagTimer - 50);
Â  }
}

/* ==========================================================
Â Â  RECORDING (canvas + master audio)
========================================================== */
let rec = { recorder:null, chunks:[], stream:null, url:null, startedAt:0 };

function canRecord(){
Â  return typeof MediaRecorder !== "undefined" && typeof canvas.captureStream === "function";
}

function buildRecordStream(){
Â  setupOutputRouting();
Â  const vStream = canvas.captureStream(30);
Â  const aTrack = (monitorDest && monitorDest.stream.getAudioTracks()[0]) ? monitorDest.stream.getAudioTracks()[0] : null;

Â  // video stream + (optional) audio track into one MediaStream
Â  const mixed = new MediaStream();
Â  vStream.getVideoTracks().forEach(t=>mixed.addTrack(t));
Â  if(aTrack) mixed.addTrack(aTrack);

Â  return mixed;
}

function pickMimeType(){
Â  const candidates = [
Â  Â  'video/webm;codecs=vp9,opus',
Â  Â  'video/webm;codecs=vp8,opus',
Â  Â  'video/webm;codecs=opus',
Â  Â  'video/webm'
Â  ];
Â  for(const m of candidates){
Â  Â  if(MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(m)) return m;
Â  }
Â  return '';
}

const btnRecStart = document.getElementById('btnRecStart');
const btnRecStopÂ  = document.getElementById('btnRecStop');
const aRecDownload = document.getElementById('aRecDownload');
const txtRecInfo = document.getElementById('txtRecInfo');

function resetRecUI(){
Â  btnRecStart.disabled = false;
Â  btnRecStop.disabled = true;
Â  aRecDownload.style.display = "none";
Â  txtRecInfo.textContent = "";
}

async function startRecording(){
Â  if(!canRecord()){
Â  Â  alert("ì´ ë¸Œë¼ìš°ì €ëŠ” canvas ë…¹í™”ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ê¶Œì¥)");
Â  Â  return;
Â  }
Â  ensureAudio();
Â  await audioCtx.resume();
Â  setupOutputRouting();

Â  // already recording?
Â  if(rec.recorder && rec.recorder.state==="recording") return;

Â  // cleanup previous
Â  if(rec.url){
Â  Â  try{ URL.revokeObjectURL(rec.url); }catch(e){}
Â  Â  rec.url = null;
Â  }
Â  rec.chunks = [];

Â  try{
Â  Â  rec.stream = buildRecordStream();
Â  Â  const mimeType = pickMimeType();

Â  Â  const opts = {};
Â  Â  if(mimeType) opts.mimeType = mimeType;

Â  Â  rec.recorder = new MediaRecorder(rec.stream, opts);

Â  Â  rec.recorder.ondataavailable = (e)=>{
Â  Â  Â  if(e.data && e.data.size>0) rec.chunks.push(e.data);
Â  Â  };

Â  Â  rec.recorder.onstop = ()=>{
Â  Â  Â  try{
Â  Â  Â  Â  const type = (rec.recorder && rec.recorder.mimeType) ? rec.recorder.mimeType : 'video/webm';
Â  Â  Â  Â  const blob = new Blob(rec.chunks, { type });
Â  Â  Â  Â  rec.url = URL.createObjectURL(blob);

Â  Â  Â  Â  aRecDownload.href = rec.url;
Â  Â  Â  Â  aRecDownload.download = `limen_recording_${new Date().toISOString().replace(/[:.]/g,'-')}.webm`;
Â  Â  Â  Â  aRecDownload.style.display = "inline-block";

Â  Â  Â  Â  const sec = (performance.now() - rec.startedAt) / 1000;
Â  Â  Â  Â  txtRecInfo.textContent = `Saved: ${blob.size.toLocaleString()} bytes | ${sec.toFixed(1)} sec | ${type}`;

Â  Â  Â  }catch(err){
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  txtRecInfo.textContent = "Recording saved, but download link creation failed.";
Â  Â  Â  }

Â  Â  Â  // stop tracks so it doesn't keep capturing
Â  Â  Â  try{
Â  Â  Â  Â  if(rec.stream){
Â  Â  Â  Â  Â  rec.stream.getTracks().forEach(t=>t.stop());
Â  Â  Â  Â  }
Â  Â  Â  }catch(e){}
Â  Â  Â  rec.stream = null;

Â  Â  Â  btnRecStart.disabled = false;
Â  Â  Â  btnRecStop.disabled = true;
Â  Â  Â  notifyTowerValue('recState', 'stopped');
Â  Â  };

Â  Â  rec.startedAt = performance.now();
Â  Â  rec.recorder.start(100); // collect chunks periodically

Â  Â  btnRecStart.disabled = true;
Â  Â  btnRecStop.disabledÂ  = false;
Â  Â  aRecDownload.style.display = "none";
Â  Â  txtRecInfo.textContent = "Recordingâ€¦";

Â  Â  notifyTowerValue('recState', 'recording');

Â  }catch(e){
Â  Â  console.error(e);
Â  Â  alert("ë…¹í™” ì‹œì‘ ì‹¤íŒ¨. (ê¶Œí•œ/ì½”ë±/ë¸Œë¼ìš°ì € í™•ì¸)");
Â  Â  resetRecUI();
Â  }
}

function stopRecording(){
Â  if(!rec.recorder) return;
Â  if(rec.recorder.state !== "recording") return;
Â  try{ rec.recorder.stop(); }catch(e){ console.error(e); }
}

btnRecStart.addEventListener('click', startRecording);
btnRecStop.addEventListener('click', stopRecording);

/* ==========================================================
Â Â  UI SHOW/HIDE (hidden main) - kept for popup
========================================================== */
const ui = document.getElementById('ui');
document.getElementById('btnHideUI').addEventListener('click', ()=>{
Â  ui.classList.remove('show');
});

/* ==========================================================
Â Â  CONTROL TOWER (popup window)
Â Â  - main í™”ë©´ì€ ì„¤ì • ìˆ¨ê¹€
Â Â  - popupì€ ë™ì¼ UIë¥¼ "ë³µì œ ë Œë”"ë¡œ ë³´ì—¬ì£¼ê³ ,
Â Â  Â  ê°’ ë³€ê²½ì€ postMessageë¡œ ë©”ì¸ì— ì „ë‹¬
========================================================== */
let towerWin = null;
const TOWER_NAME = "limen_control_tower_v4";

function openTower(){
Â  // if already open, focus
Â  if(towerWin && !towerWin.closed){
Â  Â  towerWin.focus();
Â  Â  return;
Â  }

Â  // popup content: we build a minimal HTML and inject the UI markup
Â  const w = Math.min(520, Math.floor(screen.width*0.42));
Â  const h = Math.min(860, Math.floor(screen.height*0.86));
Â  const left = Math.floor(screenX + (outerWidth - w) - 20);
Â  const topÂ  = Math.floor(screenY + 20);

Â  towerWin = window.open('', TOWER_NAME, `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`);

Â  if(!towerWin){
Â  Â  alert("íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì—ì„œ íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
Â  Â  return;
Â  }

Â  const css = `
Â  <style>
Â  Â  html,body{margin:0;height:100%;background:#070707;color:#eee;font-family:system-ui,-apple-system,sans-serif;}
Â  Â  .wrap{padding:12px;}
Â  Â  .hint{font-size:12px;color:#9aa;line-height:1.5;margin:0 0 10px;}
Â  Â  /* bring over original #ui styles minimally */
Â  Â  #ui{display:block !important; position:relative; width:100%; max-width:none; height:auto; max-height:none; overflow:visible;}
Â  Â  #ui *{box-sizing:border-box;}
Â  Â  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;}
Â  Â  .pillBtn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.24);color:#eee;font-weight:700;cursor:pointer;}
Â  Â  .pillBtn.on{border-color:rgba(255,80,80,.9); box-shadow:0 0 0 2px rgba(255,80,80,.14) inset;}
Â  Â  .meter{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10);}
Â  Â  .meter i{display:block;height:100%;width:0%;background:rgba(255,80,80,.90);}
Â  Â  /* Tabs/panels aesthetics */
Â  Â  #bar{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px;}
Â  Â  #bar .title{font-weight:900}
Â  Â  #bar .pill{font-size:12px;color:#bbb;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.30)}
Â  Â  #tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;}
Â  Â  .tab{cursor:pointer;border:1px solid rgba(255,255,255,.12);padding:8px 10px;border-radius:10px;background:rgba(0,0,0,.25);font-weight:800;font-size:12px;color:#ddd;}
Â  Â  .tab.active{border-color:rgba(255,255,255,.32)}
Â  Â  .panel{display:none;border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;background:rgba(0,0,0,.20)}
Â  Â  .panel.active{display:block;}
Â  Â  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0;}
Â  Â  .label{font-size:12px;color:#aaa;width:128px;}
Â  Â  .grow{flex:1;min-width:200px;}
Â  Â  button,select,input[type="range"],input[type="number"]{background:#0f0f0f;color:#eee;border:1px solid rgba(255,255,255,.16);border-radius:10px;padding:8px 10px;font-weight:650;outline:none;}
Â  Â  input[type="range"]{padding:6px 10px;}
Â  Â  button:hover,select:hover{border-color:rgba(255,255,255,.32)}
Â  Â  button:disabled,select:disabled{opacity:.5;cursor:not-allowed}
Â  Â  .small{font-size:11px;color:#9aa;line-height:1.45;}
Â  Â  .two{display:grid;grid-template-columns:1fr;gap:10px;}
Â  Â  @media(min-width:720px){.two{grid-template-columns:1fr 1fr;}}
Â  Â  .box{border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;background:rgba(0,0,0,.18);}
Â  </style>`;

Â  // clone UI node HTML (hidden in main) into popup
Â  const uiHTML = document.getElementById('ui').outerHTML;

Â  // Build popup doc
Â  towerWin.document.open();
Â  towerWin.document.write(`
Â  Â  <!doctype html><html><head><meta charset="utf-8">
Â  Â  <meta name="viewport" content="width=device-width,initial-scale=1">
Â  Â  <title>Control Tower</title>
Â  Â  ${css}
Â  Â  </head><body>
Â  Â  Â  <div class="wrap">
Â  Â  Â  Â  <p class="hint">âš™ï¸ Control Tower (íŒì—…)<br/>ê°’ ë³€ê²½ì€ ì¦‰ì‹œ ë©”ì¸ í™”ë©´ì— ë°˜ì˜ë©ë‹ˆë‹¤. (Chrome ê¶Œì¥)</p>
Â  Â  Â  Â  ${uiHTML}
Â  Â  Â  </div>

Â  Â  Â  <script>
Â  Â  Â  Â  // Bridge: forward any changes in popup to opener
Â  Â  Â  Â  const send = (type, payload)=> {
Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  window.opener && window.opener.postMessage({ __limen_tower: true, type, payload }, "*");
Â  Â  Â  Â  Â  }catch(e){}
Â  Â  Â  Â  };

Â  Â  Â  Â  // Tabs
Â  Â  Â  Â  const tabs = [...document.querySelectorAll(".tab")];
Â  Â  Â  Â  const panels = [...document.querySelectorAll(".panel")];
Â  Â  Â  Â  tabs.forEach(t=>{
Â  Â  Â  Â  Â  t.addEventListener("click", ()=>{
Â  Â  Â  Â  Â  Â  tabs.forEach(x=>x.classList.remove("active"));
Â  Â  Â  Â  Â  Â  panels.forEach(p=>p.classList.remove("active"));
Â  Â  Â  Â  Â  Â  t.classList.add("active");
Â  Â  Â  Â  Â  Â  const id = "panel-" + t.dataset.tab;
Â  Â  Â  Â  Â  Â  const p = document.getElementById(id);
Â  Â  Â  Â  Â  Â  p && p.classList.add("active");
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  // Remove close button function (it only hides in popup - optional)
Â  Â  Â  Â  const hideBtn = document.getElementById("btnHideUI");
Â  Â  Â  Â  if(hideBtn){
Â  Â  Â  Â  Â  hideBtn.textContent = "Close Tower";
Â  Â  Â  Â  Â  hideBtn.addEventListener("click", ()=> window.close());
Â  Â  Â  Â  }

Â  Â  Â  Â  // Hook all inputs/selects/ranges to send changes
Â  Â  Â  Â  function hook(el){
Â  Â  Â  Â  Â  const id = el.id;
Â  Â  Â  Â  Â  if(!id) return;
Â  Â  Â  Â  Â  const ev = (el.type==="range" || el.type==="number") ? "input" : "change";
Â  Â  Â  Â  Â  el.addEventListener(ev, ()=>{
Â  Â  Â  Â  Â  Â  let v = el.value;
Â  Â  Â  Â  Â  Â  send("set", { id, value:v });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  [...document.querySelectorAll("input,select")].forEach(hook);

Â  Â  Â  Â  // Buttons (specific)
Â  Â  Â  Â  const mapBtn = (id, msgType)=>{
Â  Â  Â  Â  Â  const b = document.getElementById(id);
Â  Â  Â  Â  Â  if(!b) return;
Â  Â  Â  Â  Â  b.addEventListener("click", ()=> send("btn", { id, msgType }));
Â  Â  Â  Â  };
Â  Â  Â  Â  mapBtn("btnResume","resume");
Â  Â  Â  Â  mapBtn("btnFilePlay","filePlay");
Â  Â  Â  Â  mapBtn("btnFilePause","filePause");
Â  Â  Â  Â  mapBtn("btnFileStop","fileStop");
Â  Â  Â  Â  mapBtn("btnMIDIInit","midiInit");
Â  Â  Â  Â  mapBtn("btnMIDILearn","midiLearnToggle");
Â  Â  Â  Â  mapBtn("btnRecStart","recStart");
Â  Â  Â  Â  mapBtn("btnRecStop","recStop");

Â  Â  Â  Â  // file input: can't pass File object; user must choose file in MAIN entry/system.
Â  Â  Â  Â  const f1 = document.getElementById("fileAudio");
Â  Â  Â  Â  if(f1){
Â  Â  Â  Â  Â  f1.disabled = true;
Â  Â  Â  Â  Â  const txt = document.getElementById("txtFile");
Â  Â  Â  Â  Â  if(txt) txt.textContent = "â€» íŒŒì¼ ì„ íƒì€ ë©”ì¸ í™”ë©´ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤ (ë¸Œë¼ìš°ì € ë³´ì•ˆ).";
Â  Â  Â  Â  }

Â  Â  Â  Â  // receive state update from main
Â  Â  Â  Â  window.addEventListener("message", (e)=>{
Â  Â  Â  Â  Â  const d = e.data;
Â  Â  Â  Â  Â  if(!d || !d.__limen_main) return;
Â  Â  Â  Â  Â  if(d.type==="state"){
Â  Â  Â  Â  Â  Â  const {id, value} = d.payload||{};
Â  Â  Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  Â  Â  if(el){
Â  Â  Â  Â  Â  Â  Â  // do not overwrite file input
Â  Â  Â  Â  Â  Â  Â  if(el.type==="file") return;
Â  Â  Â  Â  Â  Â  Â  el.value = value;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // special text updates
Â  Â  Â  Â  Â  Â  if(id==="topPill"){
Â  Â  Â  Â  Â  Â  Â  const pill = document.getElementById("topPill");
Â  Â  Â  Â  Â  Â  Â  if(pill) pill.textContent = value;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(id==="txtRecInfo"){
Â  Â  Â  Â  Â  Â  Â  const t = document.getElementById("txtRecInfo");
Â  Â  Â  Â  Â  Â  Â  if(t) t.textContent = value;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // tell main we are ready
Â  Â  Â  Â  send("ready", {});
Â  Â  Â  <\/script>
Â  Â  </body></html>
Â  `);
Â  towerWin.document.close();

Â  // small delay then sync values
Â  setTimeout(syncTowerAll, 120);
}

document.getElementById('btnOpenTower').addEventListener('click', openTower);
document.getElementById('btnGear').addEventListener('click', openTower);

function notifyTowerValue(id, value){
Â  if(!towerWin || towerWin.closed) return;
Â  try{
Â  Â  towerWin.postMessage({ __limen_main:true, type:"state", payload:{ id, value } }, "*");
Â  }catch(e){}
}

function syncTowerAll(){
Â  if(!towerWin || towerWin.closed) return;

Â  // sync all visible controls' current values
Â  const ids = [
Â  Â  // tabs + core
Â  Â  'selMode','selN','selBounds','selQuietLines','selPointColor',
Â  Â  'rngIdleDrama','rngVisSens','rngLine','rngPerf','rngFade','rngPointSize','rngGlow','rngSpeed',

Â  Â  // audio
Â  Â  'rngMediaGain','rngFileVol','rngSens','rngGamma','rngCap',
Â  Â  'selFXPreset','rngEQLow','rngEQMid','rngEQHigh',

Â  Â  // midi
Â  Â  'selMIDIIn','selMIDIType','numMIDINum','selMIDICh','selMIDIInvert',
Â  Â  'rngMIDIDead','rngMIDIGain','rngMIDICurve','rngMIDISmooth','rngSimTouch',

Â  Â  // system
Â  Â  'selSrc','selMic','selAutoReboot'
Â  ];

Â  for(const id of ids){
Â  Â  const el = document.getElementById(id);
Â  Â  if(!el) continue;
Â  Â  notifyTowerValue(id, el.value);
Â  }

Â  // topPill + rec info
Â  const pill = document.getElementById('topPill');
Â  if(pill) notifyTowerValue('topPill', pill.textContent);

Â  if(txtRecInfo) notifyTowerValue('txtRecInfo', txtRecInfo.textContent || "");
}

/* Listen messages from tower */
window.addEventListener("message", async (e)=>{
Â  const d = e.data;
Â  if(!d || !d.__limen_tower) return;

Â  if(d.type==="ready"){
Â  Â  syncTowerAll();
Â  Â  return;
Â  }

Â  if(d.type==="set"){
Â  Â  const {id, value} = d.payload||{};
Â  Â  const el = document.getElementById(id);
Â  Â  if(el){
Â  Â  Â  // set local value & trigger proper handlers
Â  Â  Â  el.value = value;

Â  Â  Â  // Some need extra apply
Â  Â  Â  if(id==="rngFileVol") applyFileVol();
Â  Â  Â  if(id==="rngEQLow" || id==="rngEQMid" || id==="rngEQHigh") applyEQ();
Â  Â  Â  if(id==="selSrc") applySourceUI();

Â  Â  Â  // For others, fire events
Â  Â  Â  const evName = (el.type==="range" || el.type==="number") ? "input" : "change";
Â  Â  Â  el.dispatchEvent(new Event(evName, { bubbles:true }));
Â  Â  }
Â  Â  return;
Â  }

Â  if(d.type==="btn"){
Â  Â  const {msgType} = d.payload||{};
Â  Â  // map tower button actions to main
Â  Â  if(msgType==="resume"){
Â  Â  Â  ensureAudio();
Â  Â  Â  await audioCtx.resume();
Â  Â  Â  await afterAudioUnlocked();
Â  Â  Â  applyFileVol();
Â  Â  Â  break;
Â  Â  }
Â  Â  if(msgType==="filePlay") btnFilePlay.click();
Â  Â  if(msgType==="filePause") btnFilePause.click();
Â  Â  if(msgType==="fileStop") btnFileStop.click();
Â  Â  if(msgType==="midiInit") await initMIDI();
Â  Â  if(msgType==="midiLearnToggle") document.getElementById('btnMIDILearn').click();
Â  Â  if(msgType==="recStart") await startRecording();
Â  Â  if(msgType==="recStop") stopRecording();
Â  Â  return;
Â  }
});

/* ==========================================================
Â Â  TAB LOGIC (main hidden, but used by popup too)
========================================================== */
(function setupTabs(){
Â  const tabs = [...document.querySelectorAll("#tabs .tab")];
Â  const panels = [...document.querySelectorAll("#panels .panel")];
Â  tabs.forEach(t=>{
Â  Â  t.addEventListener('click', ()=>{
Â  Â  Â  tabs.forEach(x=>x.classList.remove('active'));
Â  Â  Â  panels.forEach(p=>p.classList.remove('active'));
Â  Â  Â  t.classList.add('active');
Â  Â  Â  const p = document.getElementById('panel-'+t.dataset.tab);
Â  Â  Â  p && p.classList.add('active');
Â  Â  });
Â  });
})();

/* ==========================================================
Â Â  SYSTEM buttons
========================================================== */
document.getElementById('btnResume').addEventListener('click', async ()=>{
Â  ensureAudio();
Â  await audioCtx.resume();
Â  await afterAudioUnlocked();
Â  applyFileVol();
Â  startStatus("Audio resumed / unlocked.");
});

document.getElementById('entryFilePause').addEventListener('click', ()=>{});
document.getElementById('entryFileStop').addEventListener('click', ()=>{});

document.getElementById('entryMicOff').addEventListener('click', ()=> stopMic());

document.getElementById('entryMicOn').disabled = true;
document.getElementById('entryMicOff').disabled = true;

/* ==========================================================
Â Â  FULLSCREEN quick buttons
========================================================== */
document.getElementById('btnFSQuick').addEventListener('click', toggleFullscreen);

/* ==========================================================
Â Â  HUD updates
========================================================== */
const hudTouch = document.getElementById('hudTouch');
const hudAmp Â  = document.getElementById('hudAmp');
const hudMidiÂ  = document.getElementById('hudMidi');
const hudTouchBar = document.getElementById('hudTouchBar');

function updateHUD(){
Â  const sim = Math.max(0, Math.min(1, parseFloat(rngSimTouch.value)||0));
Â  const t = Math.max(touchSmooth, sim);

Â  hudTouch.textContent = t.toFixed(3);
Â  hudAmp.textContent Â  = amp.toFixed(3);

Â  if(midiInput && !midiInput.connection) hudMidi.textContent = "midi: (connected)";
Â  else if(midiInput) hudMidi.textContent = "midi: " + (midiInput.name||"input");
Â  else hudMidi.textContent = "midi: -";

Â  hudTouchBar.style.width = (t*100).toFixed(1) + "%";
}

/* ==========================================================
Â Â  VISUAL DRAW
========================================================== */
const meterIn = document.getElementById('meterIn');
const meterTouch = document.getElementById('meterTouch');
const txtAmpEl = document.getElementById('txtAmp');

function draw(){
Â  const now = performance.now();
Â  const dt = now - lastFrameT;
Â  lastFrameT = now;
Â  lastAnimTick = now;

Â  // lag check
Â  checkLag(dt);

Â  // background fade
Â  ctx.fillStyle = `rgba(0,0,0,${getFade()})`;
Â  ctx.fillRect(0,0,W,H);

Â  // update audio
Â  if(audioCtx && analyser){
Â  Â  updateAmp();
Â  Â  applyFX();
Â  Â  applyEQ();
Â  }else{
Â  Â  amp *= 0.98;
Â  Â  ampSmooth *= 0.98;
Â  Â  ampDelta *= 0.98;
Â  }

Â  // update midi touch
Â  const sim = Math.max(0, Math.min(1, parseFloat(rngSimTouch.value)||0));
Â  if(sim>0.0001){
Â  Â  touch = sim;
Â  Â  lastMidiAt = performance.now();
Â  }
Â  updateTouch();

Â  // meters
Â  const t01 = Math.max(touchSmooth, sim);
Â  if(meterTouch) meterTouch.style.width = (t01*100).toFixed(1)+"%";
Â  if(meterIn) meterIn.style.width = Math.min(100, (amp/getCap())*100).toFixed(1)+"%";

Â  if(txtAmpEl){
Â  Â  txtAmpEl.textContent = `amp: ${amp.toFixed(4)} | dAmp: ${ampDelta.toFixed(4)}`;
Â  }

Â  // energy
Â  const visSens = getVisSens();
Â  const idleDrama = getIdleDrama();
Â  const speedMul = getSpeedMul();

Â  energy += (amp*visSens - energy) * 0.10;
Â  burstEnergy += (ampDelta*visSens*4 - burstEnergy) * 0.12;

Â  // rotation + subtle idle movement
Â  rot += (0.00065 + idleDrama*0.0012 + energy*0.0022) * speedMul;

Â  // thresholds + density
Â  const quietTh = BASE_QUIET_TH * (1/visSens);
Â  const activeTh= BASE_ACTIVE_TH * (1/visSens);
Â  const onsetTh = BASE_ONSET_TH * (1/visSens);

Â  const mode = document.getElementById('selMode').value;
Â  const boundsMode = document.getElementById('selBounds').value;
Â  const quietLinesMode = parseInt(document.getElementById('selQuietLines').value,10);

Â  // perf quality (reduce connections & dynamics)
Â  const perf = getPerfLim(); // 0.25..1
Â  const maxLinksBase = 520 * perf * getLineMul();
Â  const maxLinks = Math.max(40, Math.floor(maxLinksBase));

Â  // update points
Â  for(const p of pts){
Â  Â  const n = (Math.sin((p.x+p.y+p.z)*0.0009 + now*0.0007)+1)*0.5;

Â  Â  // base drift
Â  Â  const drift = (0.004 + idleDrama*0.012) * speedMul;
Â  Â  p.vx += (n-0.5)*drift;
Â  Â  p.vy += ((1-n)-0.5)*drift;
Â  Â  p.vz += (0.5-n)*drift;

Â  Â  // audio influence
Â  Â  const a = energy;
Â  Â  const d = burstEnergy;

Â  Â  if(mode==="pulse"){
Â  Â  Â  const k = (0.02 + a*0.22) * speedMul;
Â  Â  Â  p.vx += (Math.cos(now*0.0007 + p.z*0.003)*k);
Â  Â  Â  p.vy += (Math.sin(now*0.0008 + p.x*0.003)*k);
Â  Â  Â  p.vz += (Math.sin(now*0.0006 + p.y*0.003)*k*0.6);
Â  Â  }else if(mode==="burst"){
Â  Â  Â  const k = (0.03 + d*0.55) * speedMul;
Â  Â  Â  p.vx += (Math.sin(now*0.0012 + p.y*0.004)*k);
Â  Â  Â  p.vy += (Math.cos(now*0.0010 + p.z*0.004)*k);
Â  Â  Â  p.vz += (Math.sin(now*0.0011 + p.x*0.004)*k);
Â  Â  }else{ // calm
Â  Â  Â  const k = (0.01 + a*0.08) * speedMul;
Â  Â  Â  p.vx += (Math.cos(now*0.0004 + p.y*0.002)*k);
Â  Â  Â  p.vy += (Math.sin(now*0.00045+ p.x*0.002)*k);
Â  Â  Â  p.vz += (Math.cos(now*0.00035+ p.z*0.002)*k*0.5);
Â  Â  }

Â  Â  // touch influence (soft â€œpressâ€)
Â  Â  const t = t01;
Â  Â  if(t>0.001){
Â  Â  Â  const kk = (0.02 + t*0.28) * speedMul;
Â  Â  Â  p.vx += (Math.sin(now*0.0009 + p.x*0.003) * kk);
Â  Â  Â  p.vy += (Math.cos(now*0.0010 + p.y*0.003) * kk);
Â  Â  Â  p.vz += (Math.sin(now*0.0011 + p.z*0.003) * kk * 0.8);
Â  Â  }

Â  Â  // damping
Â  Â  const damp = 0.965 - (1-perf)*0.02; // lower perf => slightly more damping
Â  Â  p.vx *= damp; p.vy *= damp; p.vz *= damp;

Â  Â  p.x += p.vx;
Â  Â  p.y += p.vy;
Â  Â  p.z += p.vz;

Â  Â  applyBounds(p, boundsMode);
Â  }

Â  // draw points & lines
Â  const col = getPointColor();
Â  const glow = getGlow();
Â  const pSize = getPointSize();

Â  // connection distance depends on energy
Â  const baseDist = Math.min(W,H) * (0.10 + 0.12*perf);
Â  const dist = baseDist * (0.85 + energy*2.2) * getLineMul();

Â  // gather projected positions
Â  const proj = pts.map(p=>project(p));

Â  // sort by depth for nicer layering
Â  const idx = proj.map((o,i)=>({i, z:o.z})).sort((a,b)=>a.z-b.z).map(o=>o.i);

Â  // lines
Â  let links=0;
Â  const wantLines = (amp > activeTh) || (quietLinesMode>0);
Â  if(wantLines){
Â  Â  ctx.globalCompositeOperation = "lighter";

Â  Â  const quietAlphaBase = (quietLinesMode===2)? 0.16 : 0.08;
Â  Â  const quietAlpha = quietAlphaBase * perf * (0.7 + glow*0.8);

Â  Â  // create a lightweight distance check
Â  Â  for(let a=0; a<idx.length; a++){
Â  Â  Â  const i = idx[a];
Â  Â  Â  const pi = proj[i];
Â  Â  Â  for(let b=a+1; b<idx.length; b++){
Â  Â  Â  Â  const j = idx[b];
Â  Â  Â  Â  const pj = proj[j];

Â  Â  Â  Â  const dx = pi.x - pj.x;
Â  Â  Â  Â  const dy = pi.y - pj.y;
Â  Â  Â  Â  const dd = Math.sqrt(dx*dx + dy*dy);

Â  Â  Â  Â  if(dd < dist){
Â  Â  Â  Â  Â  links++;
Â  Â  Â  Â  Â  if(links > maxLinks) break;

Â  Â  Â  Â  Â  // alpha depends on amp/touch, distance, glow
Â  Â  Â  Â  Â  let alpha = 0.0;

Â  Â  Â  Â  Â  if(amp > activeTh){
Â  Â  Â  Â  Â  Â  const k = 1 - (dd/dist);
Â  Â  Â  Â  Â  Â  alpha = (0.06 + energy*0.55 + t01*0.35) * k * perf;
Â  Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  Â  // quiet lines
Â  Â  Â  Â  Â  Â  const k = 1 - (dd/dist);
Â  Â  Â  Â  Â  Â  alpha = quietAlpha * k;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  alpha = Math.min(0.45, alpha);

Â  Â  Â  Â  Â  ctx.strokeStyle = `rgba(${col==="#ffffff"?"255,255,255":"255,80,80"},${alpha})`;
Â  Â  Â  Â  Â  ctx.lineWidth = 1.0;

Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  ctx.moveTo(pi.x, pi.y);
Â  Â  Â  Â  Â  ctx.lineTo(pj.x, pj.y);
Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  if(links > maxLinks) break;
Â  Â  }

Â  Â  ctx.globalCompositeOperation = "source-over";
Â  }

Â  // points
Â  for(const i of idx){
Â  Â  const p = proj[i];
Â  Â  const k = (p.k||1);
Â  Â  const r = (1.6 + 2.8*energy + 1.6*t01) * k * pSize;

Â  Â  // subtle glow
Â  Â  const a = 0.10 + 0.65*energy + 0.25*t01;
Â  Â  const aa = Math.min(0.95, a) * (0.65 + glow*0.75);

Â  Â  ctx.fillStyle = `rgba(${col==="#ffffff"?"255,255,255":"255,80,80"},${aa})`;
Â  Â  ctx.beginPath();
Â  Â  ctx.arc(p.x, p.y, r, 0, Math.PI*2);
Â  Â  ctx.fill();
Â  }

Â  // onset sparkle (tiny flash)
Â  if(ampDelta > onsetTh){
Â  Â  ctx.fillStyle = `rgba(255,255,255,0.06)`;
Â  Â  ctx.fillRect(0,0,W,H);
Â  }

Â  updateHUD();
Â  updateTopPill(perf);

Â  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

/* ==========================================================
Â Â  ENTRY quick controls
========================================================== */
document.getElementById('btnFS').addEventListener('click', toggleFullscreen);
document.getElementById('btnFSQuick').addEventListener('click', toggleFullscreen);

/* ==========================================================
Â Â  FILE volume initial apply
========================================================== */
function applyAllInitial(){
Â  refreshAudioLabels();
Â  refreshVisualLabels();
Â  refreshMIDILabels();
Â  applyFileVol();
Â  applySourceUI();
Â  resetRecUI();
}
applyAllInitial();

/* ==========================================================
Â Â  ENTRY buttons states for file (after load)
========================================================== */
function refreshFileBtnState(){
Â  const ok = (fileAudioEl && fileAudioEl.src);
Â  setSystemFileBtns(!!ok);
Â  setEntryFileBtns(!!ok);
}
setInterval(refreshFileBtnState, 700);

/* ==========================================================
Â Â  INITIAL startup status text
========================================================== */
startStatus("Start Audioë¥¼ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.");

</script>
</body>
</html>
