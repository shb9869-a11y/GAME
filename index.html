<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>SLEEEEP · Maze</title>
<style>
/* ... 기존 CSS 그대로 ... */
</style>
</head>
<body>
<div id="desk">
  <div class="gameWin" id="gameWin">
    <canvas id="view" width="960" height="540" aria-label="게임 화면"></canvas>
    <div class="scan"></div>
    <div id="roundInfo">ROUND <span id="roundNum">1</span></div>
    <div id="hint">FACTORY ↑</div>
    <div class="controls">
      <div class="dirpad" id="dirpad">
        <button class="dir-btn" data-dir="up">↑</button>
        <button class="dir-btn" data-dir="right">→</button>
        <button class="dir-btn" data-dir="left">←</button>
        <button class="dir-btn" data-dir="down">↓</button>
      </div>
    </div>
    <div id="clearPopup">
      <div class="clearBox">
        <h2>ROUND CLEAR!</h2>
        <p style="margin:0 0 24px; opacity:.8;">공장에 도착했습니다</p>
        <button id="nextRoundBtn">NEXT ROUND</button>
        <button id="restartBtn">RESTART</button>
      </div>
    </div>
  </div>
</div>
<script>
class AudioManager{constructor(){this.SFX_ON=new URLSearchParams(location.search).get('sfx')!=='0';this.ready=false;}init(){if(!this.SFX_ON||this.ready)return;this.AC=new(window.AudioContext||window.webkitAudioContext)();this.master=this.AC.createGain();this.master.gain.value=0.35;this.master.connect(this.AC.destination);this.footGain=this.AC.createGain();this.footGain.gain.value=0;this.footGain.connect(this.master);this.rustleGain=this.AC.createGain();this.rustleGain.gain.value=0;this.rustleGain.connect(this.master);const noiseBuf=this.AC.createBuffer(1,this.AC.sampleRate*2,this.AC.sampleRate);const data=noiseBuf.getChannelData(0);for(let i=0;i<data.length;i++)data[i]=(Math.random()*2-1)*0.35;const noise=this.AC.createBufferSource();noise.buffer=noiseBuf;noise.loop=true;const bp=this.AC.createBiquadFilter();bp.type='bandpass';bp.frequency.value=2200;bp.Q.value=1.3;noise.connect(bp).connect(this.rustleGain);noise.start();this.ready=true;}async unlock(){try{this.init();if(this.AC?.state==='suspended')await this.AC.resume();}catch(e){}}footstep(){if(!this.ready)return;const t=this.AC.currentTime;const osc=this.AC.createOscillator();osc.type='triangle';const g=this.AC.createGain();g.gain.value=0;osc.frequency.setValueAtTime(120+Math.random()*25,t);g.gain.linearRampToValueAtTime(0.35,t+0.005);g.gain.exponentialRampToValueAtTime(0.001,t+0.10);osc.connect(g).connect(this.footGain);osc.start(t);osc.stop(t+0.12);this.rustleGain.gain.cancelScheduledValues(t);this.rustleGain.gain.linearRampToValueAtTime(0.22,t+0.01);this.rustleGain.gain.exponentialRampToValueAtTime(0.02,t+0.25);}}
const audio=new AudioManager();['pointerdown','touchstart','keydown'].forEach(ev=>addEventListener(ev,()=>audio.unlock(),{passive:true}));
class Maze{constructor(seed){this.TILE=24;this.W=960;this.H=540;this.COLS=(this.W/this.TILE)|0;this.ROWS=(this.H/this.TILE)|0;this.OPEN=0;this.WALL=1;this.SEED=seed;this.grid=Array.from({length:this.ROWS},()=>Array(this.COLS).fill(this.WALL));this.colors={grassD:'#0b0f0b',grassM:'#171f17',grassH:'#293329',path:'#cfd6d9',edgeTop:'#f5f9fb',edgeBot:'#4a5053',factory:'#fff'};}rnd(){this.SEED=(this.SEED*1664525+1013904223)>>>0;return this.SEED/0xFFFFFFFF;}
generate(){
  const sx=1|1,sy=this.ROWS-2;
  const stack=[[sx,sy]];
  this.grid[sy][sx]=this.OPEN;
  const dirs=[[2,0],[-2,0],[0,2],[0,-2]];
  while(stack.length){
    const[x,y]=stack[stack.length-1];
    const cand=dirs.map(d=>[x+d[0],y+d[1]]).filter(([nx,ny])=>nx>0&&ny>0&&nx<this.COLS-1&&ny<this.ROWS-1&&this.grid[ny][nx]===this.WALL);
    if(!cand.length){stack.pop();continue;}
    const[nx,ny]=cand[(this.rnd()*cand.length)|0];
    this.grid[(y+ny)/2][(x+nx)/2]=this.OPEN;
    this.grid[ny][nx]=this.OPEN;
    stack.push([nx,ny]);
  }
  const exitX=this.COLS-2|1;
  for(let y=1;y<4;y++)this.grid[y][exitX]=this.OPEN;
  for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++)this.grid[1+dy][exitX+dx]=this.OPEN;
  
  // ✅ 이 부분 수정됨
  this.exit = [exitX, 1];
  
  return{start:[sx,sy],exit:[exitX,1]};
}
prng(n){n=(n<<13)^n;return(1-((n*(n*n*15731+789221)+1376312589)&0x7fffffff)/1073741824.0);}draw(ctx){ctx.fillStyle='#000';ctx.fillRect(0,0,this.W,this.H);for(let y=0;y<this.ROWS;y++){for(let x=0;x<this.COLS;x++){const tx=x*this.TILE;const ty=y*this.TILE;if(this.grid[y][x]===this.OPEN){ctx.fillStyle=this.colors.path;ctx.fillRect(tx,ty,this.TILE,this.TILE);ctx.fillStyle=this.colors.edgeTop;ctx.fillRect(tx,ty,this.TILE,1);ctx.fillStyle=this.colors.edgeBot;ctx.fillRect(tx,ty+this.TILE-1,this.TILE,1);}else{const r=Math.abs(this.prng(x*73856093^y*19349663));ctx.fillStyle=r<0.33?this.colors.grassD:r<0.66?this.colors.grassM:this.colors.grassH;const cx=tx+(this.TILE>>1);const cy=ty+(this.TILE>>1);ctx.fillRect(cx-1,cy-4,2,5);ctx.fillRect(cx-4,cy-1,2,3);ctx.fillRect(cx+2,cy-1,2,3);if(r>0.7)ctx.fillRect(cx-6,cy+4,1,1);if(r<0.25)ctx.fillRect(cx+5,cy+3,1,1);}}}
const ex=this.exit[0]*this.TILE;const ey=this.exit[1]*this.TILE;ctx.fillStyle=this.colors.factory;ctx.fillRect(ex-this.TILE,ey-this.TILE,this.TILE*3,this.TILE*3);ctx.fillStyle='#ccc';ctx.fillRect(ex-this.TILE+2,ey-this.TILE+2,this.TILE*3-4,this.TILE*3-4);ctx.fillStyle='#888';ctx.fillRect(ex-4,ey-4,8,8);ctx.fillStyle='#aaa';ctx.fillRect(ex-2,ey-6,4,2);ctx.fillStyle='#777';ctx.fillRect(ex-6,ey-2,2,4);ctx.fillRect(ex+4,ey-2,2,4);ctx.fillRect(ex-2,ey+4,4,2);}
isOpen(px,py){const tx=(px/this.TILE)|0;const ty=(py/this.TILE)|0;if(tx<0||ty<0||tx>=this.COLS||ty>=this.ROWS)return false;return this.grid[ty][tx]===this.OPEN;}}
class Player{constructor(start,tileSize){this.x=start[0]*tileSize+(tileSize>>1);this.y=start[1]*tileSize+(tileSize>>1);this.spd=3.5;this.size=0.9;this.lastStepX=this.x;this.lastStepY=this.y;this.stepAcc=0;this.STEP_DIST=10;this.pixelSize=(tileSize/8);this.colors={fill:'#fff',edge:'#000',shadow:'rgba(0,0,0,.55)'};this.pixelData=[[0,0,1,1,1,1,0,0],[0,1,1,1,1,1,1,0],[0,0,1,0,0,1,0,0],[0,0,1,0,0,1,0,0],[0,0,1,1,1,1,0,0],[0,1,1,0,0,1,1,0],[1,1,0,0,0,0,1,1],[1,0,0,0,0,0,0,1]];}move(ax,ay,maze){let moved=false;const m=Math.hypot(ax,ay)||1;ax/=m;ay/=m;const nx=this.x+ax*this.spd;const ny=this.y+ay*this.spd;if(maze.isOpen(nx,this.y)){this.x=nx;moved=true;}if(maze.isOpen(this.x,ny)){this.y=ny;moved=true;}if(moved){const dx=this.x-this.lastStepX;const dy=this.y-this.lastStepY;this.stepAcc+=Math.hypot(dx,dy);if(this.stepAcc>=this.STEP_DIST){audio.footstep();this.stepAcc=0;}this.lastStepX=this.x;this.lastStepY=this.y;}}draw(ctx){const s=this.size;const px=this.x;const py=this.y;ctx.fillStyle=this.colors.shadow;ctx.fillRect(px-6*s,py+6*s,12*s,3*s);for(let row=0;row<8;row++){for(let col=0;col<8;col++){if(this.pixelData[row][col]){ctx.fillStyle=this.colors.fill;ctx.fillRect(px-8*s+col*this.pixelSize*s,py-14*s+row*this.pixelSize*s,this.pixelSize*s,this.pixelSize*s);ctx.fillStyle=this.colors.edge;ctx.fillRect(px-8*s+col*this.pixelSize*s,py-14*s+row*this.pixelSize*s,this.pixelSize*s,1);ctx.fillRect(px-8*s+col*this.pixelSize*s,py-14*s+row*this.pixelSize*s,1,this.pixelSize*s);ctx.fillRect(px-8*s+col*this.pixelSize*s,py-14*s+(row+1)*this.pixelSize*s-1,this.pixelSize*s,1);ctx.fillRect(px-8*s+(col+1)*this.pixelSize*s-1,py-14*s+row*this.pixelSize*s,1,this.pixelSize*s);}}}}}
class Game{constructor(){this.canvas=document.getElementById('view');this.ctx=this.canvas.getContext('2d',{alpha:false});this.ctx.imageSmoothingEnabled=false;this.keys=new Set();this.dstate={ax:0,ay:0};this.round=1;this.state='maze';this.maze=new Maze(this.round*1000+2025);const{start,exit}=this.maze.generate();this.start=start;this.exit=exit;this.player=new Player(start,this.maze.TILE);this.factoryScreen=false;this.setupControls();this.gameLoop();}
setupControls(){addEventListener('keydown',e=>{const k=e.key.toLowerCase();if(['arrowup','arrowdown','arrowleft','arrowright','w','a','s','d'].includes(k)){e.preventDefault();this.keys.add(k);}});addEventListener('keyup',e=>this.keys.delete(e.key.toLowerCase()));const held=new Set();const setHeld=(dir,on)=>{if(on)held.add(dir);else held.delete(dir);let ax=0,ay=0;if(held.has('left'))ax-=1;if(held.has('right'))ax+=1;if(held.has('up'))ay-=1;if(held.has('down'))ay+=1;this.dstate.ax=ax;this.dstate.ay=ay;};document.querySelectorAll('[data-dir]').forEach(b=>{const dir=b.dataset.dir;const off=e=>{e.preventDefault();setHeld(dir,false);};b.addEventListener('pointerdown',e=>{e.preventDefault();setHeld(dir,true);},{passive:false});b.addEventListener('pointerup',off,{passive:false});b.addEventListener('pointerleave',off,{passive:false});});document.getElementById('nextRoundBtn').onclick=()=>this.nextRound();document.getElementById('restartBtn').onclick=()=>this.restart();}
checkFactory(){const fx=this.exit[0]*this.maze.TILE+this.maze.TILE/2;const fy=this.exit[1]*this.maze.TILE+this.maze.TILE/2;const dx=this.player.x-fx;const dy=this.player.y-fy;if(Math.hypot(dx,dy)<this.maze.TILE/2){this.state='factory';document.getElementById('clearPopup').style.display='flex';}}
nextRound(){this.round++;document.getElementById('roundNum').textContent=this.round;document.getElementById('clearPopup').style.display='none';this.state='maze';this.maze=new Maze(this.round*1000+2025);const{start,exit}=this.maze.generate();this.start=start;this.exit=exit;this.player=new Player(start,this.maze.TILE);}restart(){document.getElementById('clearPopup').style.display='none';this.state='maze';this.player=new Player(this.start,this.maze.TILE);}
update(){if(this.state!=='maze')return;let ax=0,ay=0;if(this.keys.has('arrowleft')||this.keys.has('a'))ax-=1;if(this.keys.has('arrowright')||this.keys.has('d'))ax+=1;if(this.keys.has('arrowup')||this.keys.has('w'))ay-=1;if(this.keys.has('arrowdown')||this.keys.has('s'))ay+=1;ax+=this.dstate.ax;ay+=this.dstate.ay;this.player.move(ax,ay,this.maze);this.checkFactory();}render(){this.ctx.fillStyle='#000';this.ctx.fillRect(0,0,960,540);if(this.state==='maze'){this.maze.draw(this.ctx);this.player.draw(this.ctx);}else if(this.state==='factory'){this.ctx.fillStyle='#2d4a2d';this.ctx.fillRect(0,0,960,540);this.ctx.fillStyle='#fff';this.ctx.fillRect(430,170,100,200);this.ctx.fillStyle='#ddd';this.ctx.fillRect(432,172,96,196);this.ctx.fillStyle='#aaa';this.ctx.fillRect(474,160,12,20);this.ctx.fillStyle='#ccc';this.ctx.fillRect(460,140,40,6);}}}
window.addEventListener('load',()=>new Game());
</script>
</body>
</html>
