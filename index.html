<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>SLEEP CITY</title>

  <!-- 픽셀 게임 폰트 -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SLEEP CITY">
  <meta name="theme-color" content="#000000">

  <style>
    :root{
      --window-on: #ffd800;
      --window-off: #000000;
      --text: #f5f5f5;
      --sky: #050509;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    html,body{
      width:100%;
      height:100%;
      overflow:hidden;
      background:#000;
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo",system-ui,sans-serif;
    }

    /* 세로모드 경고 */
    .rotate-warning{
      position:fixed;
      inset:0;
      background:#000;
      color:#fff;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:300;
      text-align:center;
      padding:24px;
      font-size:14px;
      line-height:1.6;
    }
    @media (orientation:portrait){
      .rotate-warning{display:flex;}
    }

    body{
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .app{
      width:100%;
      height:100%;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* 블랙 페이드 레이어 */
    .scene-fade{
      position:absolute;
      inset:0;
      background:#000;
      opacity:0;
      pointer-events:none;
      transition:opacity 1.2s linear;
      z-index:220;
    }
    .scene-fade.on{
      opacity:1;
    }

    /* 안개 레이어 */
    .fog-layer{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      z-index:210;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.12) 0, transparent 55%),
        radial-gradient(circle at 80% 60%, rgba(255,255,255,0.1) 0, transparent 60%);
      mix-blend-mode:screen;
    }
    .fog-play{
      animation:fogPulse 3.5s ease-in-out 3;
    }
    @keyframes fogPulse{
      0%{opacity:0;}
      20%{opacity:0.4;}
      40%{opacity:0;}
      60%{opacity:0.45;}
      80%{opacity:0;}
      100%{opacity:0.2;}
    }

    /* 중앙 팝업 공통 */
    .popup-frame{
      width:70vw;
      max-width:820px;
      height:55vh;
      max-height:420px;
      border:1px solid #555;
      background:#000;
      box-shadow:0 0 20px rgba(0,0,0,0.9);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }

    /* ================== 인트로 씬 ================== */
    #introScene{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:16px;
      padding:16px 24px 24px;
      z-index:100;
      transition:opacity 1s linear;
    }

    .city-window{
      width:100%;
      height:100%;
      background:var(--sky);
      position:relative;
      overflow:hidden;
      image-rendering:pixelated;
    }

    /* 픽셀 초승달 (노란색) */
    .moon{
      position:absolute;
      top:10px;
      left:10px;
      width:16px;
      height:16px;
      background:var(--window-on);
      image-rendering:pixelated;
      box-shadow:
        0 0 4px rgba(255,216,0,0.9),
        0 0 8px rgba(255,216,0,0.7);
      transition:
        filter 3s linear,
        opacity 3s linear;
    }
    .moon::before{
      content:"";
      position:absolute;
      left:6px;
      top:2px;
      width:10px;
      height:12px;
      background:var(--sky);
    }
    body.lights-off .moon{
      filter:brightness(0.15);
      opacity:0.2;
    }

    .city-layers{
      position:absolute;
      inset:0;
    }

    .layer{
      position:absolute;
      left:4px;
      right:4px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:4px;
      pointer-events:none;
    }
    .layer-back{
      bottom:26%;
      transform:scale(0.9);
      opacity:0.6;
    }
    .layer-mid{
      bottom:13%;
      transform:scale(0.96);
      opacity:0.8;
    }
    .layer-front{
      bottom:0;
      opacity:1;
    }

    /* 인트로 건물: 얄쌍 + 많음 */
    .building{
      position:relative;
      display:flex;
      flex-direction:column;
      padding:4px 1px 5px;
      border:1px solid rgba(0,0,0,0.7);
      box-shadow:0 -2px 0 rgba(255,255,255,0.04) inset;
      image-rendering:pixelated;
      flex:0.08;
      max-width:3.5%;
      min-width:1.8%;
    }

    .roof{
      width:90%;
      margin:0 auto 4px;
    }
    .roof-flat{
      height:4px;
      background:#dadada;
    }
    .roof-tri{
      width:0;
      height:0;
      border-left:8px solid transparent;
      border-right:8px solid transparent;
      border-bottom:12px solid #f0f0f0;
    }
    .roof-step{
      height:8px;
      background:#dcdcdc;
      clip-path:polygon(
        0 100%, 0 35%,
        30% 35%, 30% 0,
        70% 0, 70% 35%,
        100% 35%, 100% 100%
      );
    }

    .windows{
      width:100%;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      grid-auto-rows:8px;
      gap:2px;
      padding:0 1px 2px;
    }

    .window{
      width:100%;
      height:100%;
      background:var(--window-on);
      box-shadow:0 0 4px rgba(255,216,0,0.6);
      opacity:0.85;
      animation:windowFlicker 4.2s infinite ease-in-out;
      animation-delay:calc(var(--rand) * 3s);
      transition:
        background 3s linear,
        box-shadow 3s linear,
        opacity 3s linear,
        filter 3s linear;
    }
    @keyframes windowFlicker{
      0%{opacity:0.5; transform:scaleY(1);}
      40%{opacity:0.9; transform:scaleY(1.03);}
      80%{opacity:0.6; transform:scaleY(1);}
      100%{opacity:0.7; transform:scaleY(1.02);}
    }

    /* 3초 동안 불 꺼짐, 검정 창문 유지 */
    body.lights-off .window{
      background:var(--window-off);
      box-shadow:none;
      opacity:1;
      animation:none;
      filter:brightness(0.5);
    }

    /* Start 버튼 */
    .bottom-center{
      margin-top:12px;
    }
    .start-btn{
      padding:10px 30px;
      border:1px solid #f5f5f5;
      background:#101010;
      color:#f5f5f5;
      font-size:13px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      cursor:pointer;
      outline:none;
      min-width:140px;
    }
    .start-btn:active{
      background:#181818;
      transform:translateY(1px);
    }
    .start-btn[disabled]{
      opacity:0.6;
      cursor:default;
    }

    /* 인트로 텍스트 (팝업 안에서만) */
    .overlay{
      position:absolute;
      inset:10% 8%;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      pointer-events:none;
    }
    .overlay.show{
      display:flex;
    }
    .overlay-inner{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-family:"Press Start 2P","Courier New",monospace;
      text-align:center;
      color:#f5f5f5;
    }
    .overlay-lines{
      font-size:clamp(12px,2.3vw,22px);
      line-height:1.6;
      text-shadow:0 0 6px rgba(255,255,255,0.3);
      width:100%;
    }
    .overlay-line{
      min-height:1.3em;
    }
    .overlay-third{
      margin-top:20px;
      font-size:clamp(11px,2vw,20px);
      opacity:0;
      transition:opacity 1.5s linear;
    }
    .overlay-third.show{
      opacity:1;
    }
    .overlay-third.fade-out{
      opacity:0;
    }

    /* ================== 두 번째 씬: 도로 + 캐릭터 (팝업 안) ================== */
    #streetScene{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
      transition:opacity 1.8s ease-out;
      z-index:100;
    }
    #streetScene.active{
      opacity:1;
      pointer-events:auto;
    }

    .street-window{
      width:100%;
      height:100%;
      background:#020207;
      position:relative;
      overflow:hidden;
    }

    /* 좌우 빌딩: 얄쌍 + 많고, 불 꺼진 상태 */
    .side-column{
      position:absolute;
      top:0;
      bottom:0;
      width:20%;
      display:flex;
      flex-direction:column;
      justify-content:space-around;
      align-items:stretch;
      padding:6px 2px;
      transition:opacity 1s linear;
    }
    .side-left{ left:0; }
    .side-right{ right:0; }

    .side-building{
      background:#14151c;
      border:1px solid #000;
      padding:3px 1px 4px;
      box-shadow:0 0 12px rgba(0,0,0,0.8);
    }
    .side-windows{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      grid-auto-rows:7px;
      gap:2px;
    }
    .side-window{
      background:#050509; /* 불 꺼짐 */
      box-shadow:none;
      opacity:0.8;
    }

    /* 중앙 도로 */
    .road{
      position:absolute;
      top:0;
      bottom:0;
      left:20%;
      right:20%;
      background:#050509;
      overflow:hidden;
    }
    .road-center{
      position:absolute;
      inset:8% 30%;
      background:#0c0c10;
      box-shadow:0 0 12px rgba(0,0,0,0.9);
      overflow:hidden;
    }
    .lane{
      position:absolute;
      left:50%;
      top:-100%;
      width:4px;
      height:300%;
      background:repeating-linear-gradient(
        to bottom,
        #f5f5f5 0 18px,
        transparent 18px 36px
      );
      transform:translateX(-50%);
      opacity:0.15;
      animation:laneMove 5s linear infinite;
    }
    @keyframes laneMove{
      from{transform:translate(-50%,0);}
      to{transform:translate(-50%,40px);}
    }

    /* 캐릭터: D패드로 직접 이동 */
    .character{
      position:absolute;
      width:18px;
      height:24px;
      background:#f5f5f5;
      image-rendering:pixelated;
      box-shadow:0 0 6px rgba(255,255,255,0.7);
      left:50%;
      bottom:20%;
      transform:translateX(-50%);
      transition:transform 0.06s linear, opacity 0.06s linear;
    }
    .character::before{
      content:"";
      position:absolute;
      left:4px;
      top:4px;
      width:10px;
      height:8px;
      background:#000;
    }
    .character::after{
      content:"";
      position:absolute;
      left:3px;
      bottom:0;
      width:12px;
      height:8px;
      background:#101010;
    }
    .character.entered{
      opacity:0;
      transform:translateX(-50%) translateY(6px);
      transition:opacity 0.8s ease-out, transform 0.8s ease-out;
    }

    /* 도로 중간 빌딩 (회색, 처음엔 보이게) */
    .end-building{
      position:absolute;
      top:-22%;
      left:32%;
      right:32%;
      height:38%;
      background:#191a22;
      border:1px solid #000;
      box-shadow:0 0 14px rgba(0,0,0,0.9);
      transition:opacity 1s linear;
    }
    .end-windows{
      position:absolute;
      inset:10% 18%;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      grid-auto-rows:8px;
      gap:3px;
    }
    .end-window{
      background:#050509;
      box-shadow:none;
      opacity:0.9;
    }

    /* 길 끝 빨간 건물 – 처음엔 완전 안 보임 */
    .final-building{
      position:absolute;
      top:-10%;
      left:30%;
      right:30%;
      height:50%;
      background:#7b1118;
      border:1px solid #000;
      box-shadow:0 0 16px rgba(0,0,0,0.9);
      opacity:0;
      display:none;
      transition:opacity 1.2s ease-out;
    }
    .final-building.visible{
      display:block;
    }
    .final-door{
      position:absolute;
      bottom:0;
      left:50%;
      transform:translateX(-50%);
      width:22%;
      height:40%;
      background:#1a0507;
      border:2px solid #000;
      box-shadow:0 0 10px rgba(0,0,0,0.9);
    }
    .final-door::before{
      content:"";
      position:absolute;
      right:18%;
      top:45%;
      width:4px;
      height:4px;
      border-radius:50%;
      background:#f5f5f5;
    }

    /* 방향키: 화면 왼쪽 아래 고정 */
    .cursor-pad{
      position:fixed;
      left:14px;
      bottom:16px;
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      justify-content:center;
      font-size:12px;
      z-index:50;
    }
    .cursor-row{
      display:flex;
      gap:4px;
    }
    .cursor-btn{
      width:32px;
      height:32px;
      border:1px solid #777;
      background:#050505;
      color:#f5f5f5;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      cursor:pointer;
    }
    .cursor-btn:active{
      background:#111;
    }

    /* 오른쪽 아래 버튼 (지금은 기능 없음) */
    .side-btn{
      position:fixed;
      right:16px;
      bottom:16px;
      width:40px;
      height:40px;
      border:1px solid #777;
      background:#050505;
      color:#f5f5f5;
      cursor:pointer;
      font-size:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      outline:none;
      z-index:50;
    }
    .side-btn:active{
      background:#111;
    }
  </style>
</head>
<body>
  <div class="rotate-warning">
    화면을 가로 모드로 돌려주세요.<br>
    Please rotate your device to landscape.
  </div>

  <div class="app">
    <!-- 블랙 페이드, 안개 -->
    <div class="scene-fade" id="sceneFade"></div>
    <div class="fog-layer" id="fogLayer"></div>

    <!-- ============ 인트로 씬 ============ -->
    <div id="introScene">
      <div class="popup-frame">
        <div class="city-window">
          <div class="moon"></div>
          <div class="city-layers">
            <div class="layer layer-back" data-count="22"></div>
            <div class="layer layer-mid" data-count="26"></div>
            <div class="layer layer-front" data-count="30"></div>
          </div>

          <!-- 인트로 텍스트 (팝업 안) -->
          <div class="overlay" id="overlay">
            <div class="overlay-inner">
              <div class="overlay-lines" id="overlayLines"></div>
              <div class="overlay-third" id="overlayThird"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="bottom-center">
        <button class="start-btn" id="startBtn">START</button>
      </div>
    </div>

    <!-- ============ 두 번째 씬: 도로 + 캐릭터 (팝업 안) ============ -->
    <div id="streetScene">
      <div class="popup-frame">
        <div class="street-window">
          <!-- 좌우 건물 (불 꺼진 상태, 얄쌍하고 많음) -->
          <div class="side-column side-left" id="sideLeft"></div>
          <div class="side-column side-right" id="sideRight"></div>

          <!-- 도로 -->
          <div class="road">
            <div class="road-center">
              <div class="lane"></div>
              <div class="character" id="character"></div>

              <!-- 중간 회색 빌딩 -->
              <div class="end-building" id="endBuilding">
                <div class="end-windows" id="endWindows"></div>
              </div>

              <!-- 길 끝 빨간 건물 -->
              <div class="final-building" id="finalBuilding">
                <div class="final-door" id="finalDoor"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 방향키 (D패드) -->
    <div class="cursor-pad">
      <button class="cursor-btn" data-dir="up">▲</button>
      <div class="cursor-row">
        <button class="cursor-btn" data-dir="left">◀</button>
        <button class="cursor-btn" data-dir="down">▼</button>
        <button class="cursor-btn" data-dir="right">▶</button>
      </div>
    </div>

    <!-- 오른쪽 아래 버튼 (지금은 기능 없음) -->
    <button class="side-btn" aria-label="extra button">●</button>
  </div>

  <script>
    // ====== 인트로 건물 생성 ======
    const palette = [
      "#16171b","#1b1c22","#20232a",
      "#252831","#2b3038","#313640",
      "#373c46","#1b1c20","#22252c"
    ];

    function makeIntroBuilding(layerName, i){
      const b = document.createElement("div");
      b.className = "building";

      const base = layerName === "back" ? 55 : (layerName === "mid" ? 45 : 35);
      const h = base + (i * 3) % 20;
      b.style.height = h + "%";

      const flexVal = 0.08 + (i % 4)*0.03; // 0.08 ~ 0.17
      b.style.flex = flexVal.toFixed(2);

      const color = palette[(i * 2 + (layerName === "front" ? 1 : 0)) % palette.length];
      b.style.background = color;

      const roof = document.createElement("div");
      roof.classList.add("roof");
      const rt = i % 3;
      if(rt === 0) roof.classList.add("roof-flat");
      else if(rt === 1) roof.classList.add("roof-tri");
      else roof.classList.add("roof-step");
      b.appendChild(roof);

      const windows = document.createElement("div");
      windows.className = "windows";
      const floors = 6 + (i % 4);
      for(let k=0;k<floors*2;k++){
        const w = document.createElement("div");
        w.className = "window";
        w.style.setProperty("--rand", Math.random().toString());
        if(Math.random() < 0.12){
          w.style.background = "#000";
          w.style.boxShadow = "none";
        }
        windows.appendChild(w);
      }
      b.appendChild(windows);

      return b;
    }

    document.querySelectorAll(".layer").forEach(layer=>{
      const count = Number(layer.dataset.count);
      const name =
        layer.classList.contains("layer-back") ? "back" :
        layer.classList.contains("layer-mid") ? "mid" : "front";
      for(let i=0;i<count;i++){
        layer.appendChild(makeIntroBuilding(name,i));
      }
    });

    // ====== 인트로 텍스트 & 전환 ======
    const startBtn = document.getElementById("startBtn");
    const overlay = document.getElementById("overlay");
    const overlayLines = document.getElementById("overlayLines");
    const overlayThird = document.getElementById("overlayThird");
    const sceneFade = document.getElementById("sceneFade");
    const fogLayer = document.getElementById("fogLayer");
    const introScene = document.getElementById("introScene");
    const streetScene = document.getElementById("streetScene");
    let started = false;

    function typeLine(text, pauseAfter, cb){
      const lineEl = document.createElement("div");
      lineEl.className = "overlay-line";
      overlayLines.appendChild(lineEl);

      let idx = 0;
      const speed = 70;
      const timer = setInterval(()=>{
        lineEl.textContent = text.slice(0, idx+1);
        idx++;
        if(idx >= text.length){
          clearInterval(timer);
          if(cb){
            setTimeout(cb, pauseAfter);
          }
        }
      }, speed);
    }

    function startOverlaySequence(){
      overlay.classList.add("show");
      const lines = [
        "SLEEEEEEEEEEP,",
        "SLEEEEEEEEEEP,",
        "SLEEEEEEEEEEP,"
      ];

      typeLine(lines[0], 1300, ()=>{
        typeLine(lines[1], 1300, ()=>{
          typeLine(lines[2], 1300, ()=>{
            overlayThird.textContent = "THE THIRD SLEEP";
            overlayThird.classList.add("show");

            // 1.5초 후 씬 페이드 & 안개 & 도로 씬 전환
            setTimeout(()=>{
              overlayThird.classList.add("fade-out");
              sceneFade.classList.add("on");

              setTimeout(()=>{
                introScene.style.display = "none";
                streetScene.classList.add("active");
                fogLayer.classList.add("fog-play");
                sceneFade.classList.remove("on");
              }, 900);
            }, 1500);
          });
        });
      });
    }

    // Start: 불 3초 페이드 + 텍스트 시퀀스
    startBtn.addEventListener("click", ()=>{
      if(started) return;
      started = true;

      document.body.classList.add("lights-off"); // 3초 동안 전등 꺼짐
      startBtn.disabled = true;
      startBtn.textContent = "OFF";

      startOverlaySequence();
    });

    // ====== 두 번째 씬 빌딩/창문 생성 ======
    function createSideBuildings(container, count){
      for(let i=0;i<count;i++){
        const b = document.createElement("div");
        b.className = "side-building";

        const floors = 4 + (i % 3);
        const gw = document.createElement("div");
        gw.className = "side-windows";

        const total = floors * 2;
        for(let j=0;j<total;j++){
          const w = document.createElement("div");
          w.className = "side-window";
          w.style.setProperty("--rand", Math.random().toString());
          gw.appendChild(w);
        }

        b.appendChild(gw);
        container.appendChild(b);
      }
    }

    const sideLeft = document.getElementById("sideLeft");
    const sideRight = document.getElementById("sideRight");
    createSideBuildings(sideLeft, 14);
    createSideBuildings(sideRight, 14);

    const endBuilding = document.getElementById("endBuilding");
    const endWindows = document.getElementById("endWindows");
    for(let i=0;i<8*4;i++){
      const w = document.createElement("div");
      w.className = "end-window";
      w.style.setProperty("--rand", Math.random().toString());
      endWindows.appendChild(w);
    }

    const finalBuilding = document.getElementById("finalBuilding");

    // ====== 캐릭터 컨트롤 & 길 끝 연출 ======
    const character = document.getElementById("character");
    let charX = 50;   // road-center 안에서 퍼센트
    let charY = 20;   // 20 ~ 80 사이 이동

    function clamp(v,min,max){
      return v < min ? min : (v > max ? max : v);
    }

    // 캐릭터 위치 업데이트 + 주변 환경 변화
    function updateCharacter(){
      if(!character) return;

      charX = clamp(charX, 35, 65);
      charY = clamp(charY, 20, 80);

      character.style.left = charX + "%";
      character.style.bottom = charY + "%";

      updateEnvironment();
      checkDoorEnter();
    }

    // 위로 걸어갈수록: 사이드 + 회색 건물 서서히 사라지고,
    // 충분히 올라가면 빨간 건물이 "나타남"
    function updateEnvironment(){
      const progress = clamp((charY - 20) / 60, 0, 1); // 0~1

      const sideOpacity = 1 - progress;    // 1 → 0
      const midOpacity  = 1 - progress;    // 1 → 0

      sideLeft.style.opacity  = sideOpacity;
      sideRight.style.opacity = sideOpacity;
      endBuilding.style.opacity = midOpacity;

      // 빨간 건물: progress가 0.7 이상이 될 때부터 등장 시작
      if(progress > 0.7){
        const redProg = clamp((progress - 0.7) / 0.3, 0, 1); // 0~1
        finalBuilding.classList.add("visible");
        finalBuilding.style.opacity = redProg;
      }else{
        finalBuilding.style.opacity = 0;
        finalBuilding.classList.remove("visible"); // ⇒ display:none 유지
      }
    }

    // 문 앞 도착 시: 캐릭터 희미 + 화면 페이드 아웃
    let doorEntered = false;
    function checkDoorEnter(){
      if(doorEntered) return;

      const fbOpacity = parseFloat(getComputedStyle(finalBuilding).opacity || "0");
      if(fbOpacity < 0.95) return; // 빨간 건물이 충분히 보일 때만

      const nearDoorX = Math.abs(charX - 50) < 5; // 중앙 근처
      const nearDoorY = charY > 72;               // 거의 맨 위

      if(nearDoorX && nearDoorY){
        doorEntered = true;
        character.classList.add("entered");
        setTimeout(()=>{
          sceneFade.classList.add("on"); // 문 안으로 들어가듯 전체 페이드
          // 여기서 다음 씬 이동 연결 가능 (location.href 등)
        }, 400);
      }
    }

    updateCharacter(); // 초기 상태 반영

    // D-패드 입력
    document.querySelectorAll(".cursor-btn").forEach(btn=>{
      const dir = btn.dataset.dir;
      if(!dir) return;
      btn.addEventListener("click", ()=>{
        if(!streetScene.classList.contains("active")) return;
        const step = 4;

        if(dir === "up")   charY += step;
        if(dir === "down") charY -= step;
        if(dir === "left") charX -= step;
        if(dir === "right")charX += step;

        updateCharacter();
      });
    });
  </script>
</body>
</html>