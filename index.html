<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no">
<title>Polycam Style Scanner</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#000;
  font-family:sans-serif;
}

/* Ïπ¥Î©îÎùº: Îí§Ïóê ÍπîÎ¶¨Í≥† Ìï≠ÏÉÅ Î≥¥Ïù¥Í≤å */
#video{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  object-fit:cover;
  z-index:0;
}

/* Ïä§Ï∫î Ïò§Î≤ÑÎ†àÏù¥ (Ï†ê+ÏÑ†) */
#scanCanvas{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  pointer-events:none;
  z-index:1;
}

/* Í≤∞Í≥º 3D ÌôîÎ©¥ */
#modelCanvas{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  display:none;
  z-index:2;
}

#startBtn,#confirmBtn{
  position:fixed;
  bottom:40px;
  padding:18px 26px;
  border-radius:30px;
  border:none;
  font-size:17px;
  z-index:10;
}

#startBtn{
  left:50%;
  transform:translateX(-50%);
  background:#fff;
  color:#000;
}

#confirmBtn{
  right:40px;
  background:#3a7bff;
  color:#fff;
  display:none;
}

#status{
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.4);
  padding:8px 18px;
  border-radius:20px;
  color:#fff;
  z-index:10;
}
</style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>
<canvas id="scanCanvas"></canvas>
<canvas id="modelCanvas"></canvas>

<div id="status">Ïä§Ï∫î Ï§ÄÎπÑ Ï§ë...</div>
<button id="startBtn">Ï†ÑÏ≤¥ÌôîÎ©¥ ÏãúÏûë</button>
<button id="confirmBtn">ÌôïÏù∏</button>

<script>
/* 1. Ï†ÑÏ≤¥ÌôîÎ©¥ + Ïò§ÎîîÏò§ ÌóàÏö© */
const startBtn   = document.getElementById("startBtn");
const confirmBtn = document.getElementById("confirmBtn");
const statusDiv  = document.getElementById("status");

startBtn.onclick = async () => {
  try{ await document.documentElement.requestFullscreen(); }catch(e){}
  startBtn.style.display = "none";
  statusDiv.textContent  = "Ïä§Ï∫î Ï§ë...";
  if (audioCtx.state === "suspended") audioCtx.resume();
};

/* 2. Ïπ¥Î©îÎùº ÏºúÍ∏∞ */
const video = document.getElementById("video");
navigator.mediaDevices.getUserMedia({
  video:{ facingMode:"environment" },
  audio:false
}).then(stream => video.srcObject = stream);

/* 3. Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï */
const scanCanvas = document.getElementById("scanCanvas");
const sCtx       = scanCanvas.getContext("2d");
const modelCanvas= document.getElementById("modelCanvas");
const mCtx       = modelCanvas.getContext("2d");

function resize(){
  scanCanvas.width  = innerWidth;
  scanCanvas.height = innerHeight;
  modelCanvas.width  = innerWidth;
  modelCanvas.height = innerHeight;
}
resize();
window.addEventListener("resize", resize);

/* 4. Ï∞∞Ïπµ ÏÜåÎ¶¨ (Web Audio) */
const AudioContextClass = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContextClass();

function playClick(){
  try{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "square";
    o.frequency.value = 2000;
    g.gain.value = 0.5;
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.06);
    o.connect(g).connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime+0.06);
  }catch(e){}
}

/* 5. Ïä§Ï∫î Îç∞Ïù¥ÌÑ∞ */
let pointCloud = [];   // {x,y,z,r,g,b}
let lastFeatureCount = 0;
let scanning = true;
const MAX_POINTS = 4000;

/* Í∞ÑÎã® ÌäπÏßïÏ†ê: Ïñ¥Îë°Í±∞ÎÇò ÏïÑÏ£º Î∞ùÏùÄ ÌîΩÏÖÄ */
function extractFeatures(img){
  const pts=[];
  const d = img.data;
  const w = img.width;
  for (let i=0;i<d.length;i+=16){
    const r=d[i], g=d[i+1], b=d[i+2];
    const sum=r+g+b;
    if (sum<80 || sum>700){
      const idx=i/4;
      pts.push({ x: idx%w, y: Math.floor(idx/w) });
    }
  }
  return pts;
}

/* üî• Î∞ùÍ∏∞ Í∏∞Î∞ò ÍπäÏù¥ ÏÇ¨Ïö© */
function addPoints(features,img,tw,th){
  const d = img.data;
  for (let i=0;i<features.length;i+=2){
    const f=features[i];
    const px=f.x, py=f.y;
    const idx=(py*tw+px)*4;
    const r=d[idx], g=d[idx+1], b=d[idx+2];
    const gray=(r+g+b)/3;
    const norm = gray/255;            // 0~1
    const depth = (1 - norm)*2 - 1;   // -1~1 (Î∞ùÏùÑÏàòÎ°ù Î©ÄÎ¶¨)

    pointCloud.push({
      x:(px/tw - 0.5)*2,
      y:(py/th - 0.5)*2,
      z:depth,
      r,g,b
    });
    if(pointCloud.length>MAX_POINTS) pointCloud.shift();
  }
}

/* 6. Ïπ¥Î©îÎùº ÏúÑÏóê Ïä§Ï∫î Î†àÏù¥Ïñ¥ Í∑∏Î¶¨Í∏∞ */
function drawScan(){
  const w=scanCanvas.width, h=scanCanvas.height;
  sCtx.clearRect(0,0,w,h);

  // Ï†ê
  for(const p of pointCloud){
    const sx=(p.x*0.5+0.5)*w;
    const sy=(p.y*0.5+0.5)*h;
    sCtx.fillStyle=`rgba(${p.r},${p.g},${p.b},1)`;
    sCtx.fillRect(sx,sy,2,2);
  }

  // Í∑ºÏ†ë ÏÑ†
  sCtx.strokeStyle="rgba(0,255,255,0.4)";
  for(let i=0;i<pointCloud.length;i+=3){
    for(let j=i+1;j<i+6 && j<pointCloud.length;j++){
      const p1=pointCloud[i], p2=pointCloud[j];
      const dx=p1.x-p2.x, dy=p1.y-p2.y, dz=p1.z-p2.z;
      if(dx*dx+dy*dy+dz*dz<0.25){
        sCtx.beginPath();
        sCtx.moveTo((p1.x*0.5+0.5)*w,(p1.y*0.5+0.5)*h);
        sCtx.lineTo((p2.x*0.5+0.5)*w,(p2.y*0.5+0.5)*h);
        sCtx.stroke();
      }
    }
  }
}

/* 7. Ïä§Ï∫î Î£®ÌîÑ */
function scanLoop(){
  if(!scanning) return;

  if(video.readyState>=2){
    const tw=200, th=150;
    const temp=document.createElement("canvas");
    temp.width=tw; temp.height=th;
    const tctx=temp.getContext("2d");
    tctx.drawImage(video,0,0,tw,th);
    const frame=tctx.getImageData(0,0,tw,th);

    const features = extractFeatures(frame);
    const diff = Math.abs(features.length - lastFeatureCount);

    if(diff>40){
      playClick();
      addPoints(features,frame,tw,th);
    }

    lastFeatureCount = features.length;
    drawScan();
    confirmBtn.style.display="block";
  }
  requestAnimationFrame(scanLoop);
}
requestAnimationFrame(scanLoop);

/* 8. ÌôïÏù∏ ‚Üí 3D Í≤∞Í≥º ÌôîÎ©¥ */
confirmBtn.onclick = ()=>{
  scanning=false;
  scanCanvas.style.display="none";
  modelCanvas.style.display="block";
  statusDiv.textContent="3D Í≤∞Í≥º";

  show3DModel();
};

/* 9. 3D Ìè¨Ïù∏Ìä∏ÌÅ¥ÎùºÏö∞Îìú Î∑∞Ïñ¥ */
let angle=0;
function show3DModel(){
  function loop(){
    const w=modelCanvas.width, h=modelCanvas.height;
    const cx=w/2, cy=h/2;
    const scale=Math.min(w,h)*0.45;

    mCtx.clearRect(0,0,w,h);
    mCtx.fillStyle="#000";
    mCtx.fillRect(0,0,w,h);

    const cosA=Math.cos(angle), sinA=Math.sin(angle);

    for(const p of pointCloud){
      const x = p.x*cosA - p.z*sinA;
      const z = p.x*sinA + p.z*cosA;
      const y = p.y;

      const depth=(z+3)/2.2;
      const sx=cx + x*scale/depth;
      const sy=cy + y*scale/depth;

      mCtx.fillStyle=`rgba(${p.r},${p.g},${p.b},${1-depth/3})`;
      mCtx.beginPath();
      mCtx.arc(sx,sy,2/depth,0,Math.PI*2);
      mCtx.fill();
    }

    angle+=0.003;
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
