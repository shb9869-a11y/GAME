<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Chrome Start Fix + Click Debug</title>
  <style>
    :root{color-scheme:dark}
    html,body{height:100%}
    body{
      margin:0; background:#0b0b0b; color:#eee;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      touch-action:manipulation; /* ✅ 크롬 탭/클릭 안정화 */
    }

    /* ✅ 어떤 레이어가 있어도 눌리게: 화면 최상단 fixed */
    #startOverlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:2147483647; /* max */
      pointer-events:none; /* overlay 자체는 클릭 안 먹음 */
    }
    #startBtn{
      pointer-events:auto; /* 버튼만 클릭 먹음 */
      width:min(520px, calc(100vw - 40px));
      padding:18px 16px;
      border-radius:18px;
      border:2px solid #444;
      background:#111;
      color:#fff;
      font-size:18px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    #startBtn:active{transform:scale(0.99)}
    #panel{
      max-width:1100px; margin:0 auto; padding:18px;
    }
    .card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:16px}
    .mono{
      margin-top:12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:12px;background:#0f0f0f;border:1px solid #2a2a2a;border-radius:12px;
      padding:12px;white-space:pre-wrap
    }
    button, input, select{
      width:100%; margin-top:8px; padding:12px; border-radius:12px;
      border:1px solid #333; background:#0f0f0f; color:#eee;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:220px}
  </style>
</head>
<body>

<!-- ✅ Start 버튼을 “별도 오버레이”로 최상단에 올려서 크롬 클릭 씹힘을 무력화 -->
<div id="startOverlay">
  <button id="startBtn" type="button">START (Chrome Fix / Debug)</button>
</div>

<div id="panel">
  <div class="card">
    <h3 style="margin:0 0 10px">크롬에서 Start 버튼이 안 눌리는 원인 잡는 디버그 페이지</h3>
    <div class="row">
      <button id="micBtn" disabled>Mic On</button>
      <button id="micOffBtn" disabled>Mic Off</button>
      <button id="panicBtn" disabled>Panic</button>
    </div>
    <div id="log" class="mono">대기 중…</div>
  </div>
</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const logEl = $("log");
  const log = (m)=>{ logEl.textContent = m + "\n" + logEl.textContent; };

  // --- CLICK DEBUG: 지금 포인터 아래에 “진짜로” 있는 요소가 뭔지 찍기
  function dumpTopElement(ev){
    const x = (ev.touches && ev.touches[0]) ? ev.touches[0].clientX : ev.clientX;
    const y = (ev.touches && ev.touches[0]) ? ev.touches[0].clientY : ev.clientY;
    const el = document.elementFromPoint(x, y);
    if(!el) return "elementFromPoint: null";
    const cls = (el.className && typeof el.className === "string") ? "."+el.className.split(/\s+/).join(".") : "";
    return `topEl=${el.tagName}${cls}#${el.id||""}`;
  }

  // --- Global capture listener: 크롬에서 클릭이 씹혀도 “캡처 단계”에서 먼저 잡음
  ["pointerdown","mousedown","touchstart","click"].forEach(type=>{
    window.addEventListener(type, (ev)=>{
      // 버튼 영역 근처에서 어떤 요소가 최상단인지 계속 로그로 확인 가능
      if(type==="pointerdown" || type==="touchstart"){
        log(`[CAPTURE ${type}] ` + dumpTopElement(ev));
      }
    }, {capture:true, passive:false});
  });

  let ctx=null, micStream=null, micSrc=null, outGain=null;

  async function startAudio(ev){
    ev.preventDefault();
    ev.stopPropagation();

    log("START FIRED ✅  " + dumpTopElement(ev));

    // 크롬 오디오 언락
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    await ctx.resume();

    outGain = ctx.createGain();
    outGain.gain.value = 0.9;
    outGain.connect(ctx.destination);

    $("micBtn").disabled = false;
    $("panicBtn").disabled = false;

    // 오버레이 제거 (Start 버튼 사라짐)
    $("startOverlay").remove();

    log("AudioContext READY ✅  다음: Mic On");
  }

  // ✅ Start 버튼 이벤트를 여러 방식으로 강제 수신 (크롬 대응)
  const sbtn = $("startBtn");
  ["pointerdown","mousedown","touchstart","click"].forEach(type=>{
    sbtn.addEventListener(type, startAudio, {passive:false});
  });

  $("micBtn").addEventListener("click", async ()=>{
    try{
      micStream = await navigator.mediaDevices.getUserMedia({
        audio:{echoCancellation:false, noiseSuppression:false, autoGainControl:false}
      });
      micSrc = ctx.createMediaStreamSource(micStream);

      // 원음 THRU
      micSrc.connect(outGain);

      $("micBtn").disabled = true;
      $("micOffBtn").disabled = false;

      log("Mic ON ✅ (원음 들려야 정상)");
    }catch(e){
      log("Mic error: " + e.message);
    }
  });

  $("micOffBtn").addEventListener("click", ()=>{
    if(micSrc){ try{ micSrc.disconnect(); }catch(e){} micSrc=null; }
    if(micStream){ try{ micStream.getTracks().forEach(t=>t.stop()); }catch(e){} micStream=null; }
    $("micBtn").disabled = false;
    $("micOffBtn").disabled = true;
    log("Mic OFF");
  });

  $("panicBtn").addEventListener("click", ()=>{
    if(!outGain) return;
    const prev = outGain.gain.value;
    outGain.gain.value = 0;
    setTimeout(()=> outGain.gain.value = prev, 250);
    log("PANIC");
  });
})();
</script>
</body>
</html>
