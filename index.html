<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>SLEEP CITY</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SLEEP CITY">
  <meta name="theme-color" content="#000000">
  <style>
    :root {
      --window-on: #ffd800;
      --window-off: #050509;
      --text: #f5f5f5;
      --sky: #050509;
      --skin: #f5c7a0;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #000; color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", system-ui, sans-serif; }
    body { display: flex; align-items: center; justify-content: center; }
    .app { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
    .scene-fade { position: absolute; inset: 0; background: #000; opacity: 0; pointer-events: none; transition: opacity 0.8s linear; z-index: 220; }
    .scene-fade.on { opacity: 1; }
    .fog-layer { position: absolute; inset: 0; pointer-events: none; opacity: 0; z-index: 210; background: radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.12) 0, transparent 55%), radial-gradient(circle at 80% 60%, rgba(255, 255, 255, 0.1) 0, transparent 60%); mix-blend-mode: screen; }
    .fog-play { animation: fogPulse 3.5s ease-in-out 3; }
    @keyframes fogPulse { 0% { opacity: 0; } 20% { opacity: 0.4; } 40% { opacity: 0; } 60% { opacity: 0.45; } 80% { opacity: 0; } 100% { opacity: 0.2; } }
    .popup-frame { width: 70vw; max-width: 820px; height: 55vh; max-height: 420px; border: 1px solid #555; background: #000; box-shadow: 0 0 20px rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; position: relative; overflow: visible; margin-bottom: 0; transform: translateY(-5vh); }
    .city-window { width: 100%; height: 100%; background: var(--sky); position: relative; overflow: hidden; image-rendering: pixelated; }
    .moon { position: absolute; top: 10px; left: 10px; width: 16px; height: 16px; background: var(--window-on); image-rendering: pixelated; box-shadow: 0 0 4px rgba(255, 216, 0, 0.9), 0 0 8px rgba(255, 216, 0, 0.7); }
    .moon::before { content: ""; position: absolute; left: 6px; top: 2px; width: 10px; height: 12px; background: var(--sky); }
    body.lights-off .moon { filter: brightness(0.15); opacity: 0.2; }
    body.lights-dimming .moon { animation: moonDim 3s forwards; }
    @keyframes moonDim { 0% { filter: brightness(1); opacity: 1; } 100% { filter: brightness(0.2); opacity: 0.25; } }
    .city-layers { position: absolute; inset: 0; }
    .layer { position: absolute; left: 4px; right: 4px; display: flex; align-items: flex-end; justify-content: space-between; gap: 4px; pointer-events: none; }
    .layer-back { bottom: 26%; transform: scale(0.9); opacity: 0.6; }
    .layer-mid { bottom: 13%; transform: scale(0.96); opacity: 0.8; }
    .layer-front { bottom: 0; opacity: 1; }
    .building { position: relative; display: flex; flex-direction: column; padding: 4px 1px 5px; border: 1px solid rgba(0, 0, 0, 0.7); box-shadow: 0 -2px 0 rgba(255, 255, 255, 0.04) inset; image-rendering: pixelated; flex: 0.08; max-width: 3.5%; min-width: 1.8%; }
    .roof { width: 90%; margin: 0 auto 4px; }
    .roof-flat { height: 4px; background: #dadada; }
    .roof-tri { width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 12px solid #f0f0f0; }
    .roof-step { height: 8px; background: #dcdcdc; clip-path: polygon(0 100%, 0 35%, 30% 35%, 30% 0, 70% 0, 70% 35%, 100% 35%, 100% 100%); }
    .windows { width: 100%; display: grid; grid-template-columns: repeat(2, 1fr); grid-auto-rows: 8px; gap: 2px; padding: 0 1px 2px; }
    .window { width: 100%; height: 100%; background: var(--window-on); box-shadow: 0 0 4px rgba(255, 216, 0, 0.6); opacity: 0.85; animation: windowFlicker 4.2s infinite ease-in-out; animation-delay: calc(var(--rand) * 3s); }
    @keyframes windowFlicker { 0% { opacity: 0.5; transform: scaleY(1); } 40% { opacity: 0.9; transform: scaleY(1.03); } 80% { opacity: 0.6; transform: scaleY(1); } 100% { opacity: 0.7; transform: scaleY(1.02); } }
    body.lights-dimming .window { animation: lightsOut 3s forwards; }
    @keyframes lightsOut { 0% { background: var(--window-on); box-shadow: 0 0 4px rgba(255, 216, 0, 0.6); opacity: 0.9; } 100% { background: #000; box-shadow: none; opacity: 1; } }
    body.lights-off .window { background: #000; box-shadow: none; opacity: 1; animation: none; }
    .bottom-center { position: absolute; bottom: 5vh; left: 50%; transform: translateX(-50%); }
    .start-btn { padding: 10px 30px; border: 1px solid #f5f5f5; background: #101010; color: #f5f5f5; font-size: 13px; letter-spacing: 0.18em; text-transform: uppercase; cursor: pointer; outline: none; min-width: 140px; }
    .start-btn[disabled] { opacity: 0; cursor: default; }
    .overlay { position: absolute; inset: 10% 8%; display: none; align-items: center; justify-content: center; z-index: 40; pointer-events: none; }
    .overlay.show { display: flex; }
    .overlay-inner { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: "Press Start 2P", "Courier New", monospace; color: #f5f5f5; text-align: center; }
    .overlay-lines { font-size: clamp(12px, 2.3vw, 22px); line-height: 1.6; text-shadow: 0 0 6px rgba(255, 255, 255, 0.3); display: flex; flex-direction: column; align-items: center; }
    .overlay-line { min-height: 1.3em; width: auto; text-align: center; }
    .overlay-third { margin-top: 20px; font-size: clamp(11px, 2vw, 20px); opacity: 0; transition: opacity 1.5s linear; width: auto; text-align: center; }
    .overlay-third.show { opacity: 1; }
    .overlay-third.fade-out { opacity: 0; }
  </style>
</head>
<body>
  <div class="app">
    <div class="scene-fade" id="sceneFade"></div>
    <div class="fog-layer" id="fogLayer"></div>

    <div class="popup-frame">
      <div class="city-window">
        <div class="moon"></div>
        <div class="city-layers">
          <div class="layer layer-back" data-count="22"></div>
          <div class="layer layer-mid" data-count="26"></div>
          <div class="layer layer-front" data-count="30"></div>
        </div>
        <div class="overlay" id="overlay">
          <div class="overlay-inner">
            <div class="overlay-lines" id="overlayLines"></div>
            <div class="overlay-third" id="overlayThird"></div>
          </div>
        </div>
      </div>
      <div class="bottom-center">
        <button class="start-btn" id="startBtn">START</button>
      </div>
    </div>
  </div>

  <script>
    /* ========= 인트로 건물 생성 ========= */
    const palette = ["#16171b", "#1b1c22", "#20232a", "#252831", "#2b3038", "#313640", "#373c46", "#1b1c20", "#22252c"];
    function makeIntroBuilding(layerName, i) {
      const b = document.createElement("div");
      b.className = "building";
      const base = layerName === "back" ? 55 : (layerName === "mid" ? 45 : 35);
      const h = base + (i * 3) % 20;
      b.style.height = h + "%";
      const flexVal = 0.08 + (i % 4) * 0.03;
      b.style.flex = flexVal.toFixed(2);
      const color = palette[(i * 2 + (layerName === "front" ? 1 : 0)) % palette.length];
      b.style.background = color;
      const roof = document.createElement("div");
      roof.classList.add("roof");
      const rt = i % 3;
      if (rt === 0) roof.classList.add("roof-flat");
      else if (rt === 1) roof.classList.add("roof-tri");
      else roof.classList.add("roof-step");
      b.appendChild(roof);
      const windows = document.createElement("div");
      windows.className = "windows";
      const floors = 6 + (i % 4);
      for (let k = 0; k < floors * 2; k++) {
        const w = document.createElement("div");
        w.className = "window";
        w.style.setProperty("--rand", Math.random().toString());
        windows.appendChild(w);
      }
      b.appendChild(windows);
      return b;
    }
    document.querySelectorAll(".layer").forEach(layer => {
      const count = Number(layer.dataset.count);
      const name = layer.classList.contains("layer-back") ? "back" : layer.classList.contains("layer-mid") ? "mid" : "front";
      for (let i = 0; i < count; i++) layer.appendChild(makeIntroBuilding(name, i));
    });

    /* ========= 인트로 시퀀스 ========= */
    const startBtn = document.getElementById("startBtn");
    const overlay = document.getElementById("overlay");
    const overlayLines = document.getElementById("overlayLines");
    const overlayThird = document.getElementById("overlayThird");
    const sceneFade = document.getElementById("sceneFade");
    const fogLayer = document.getElementById("fogLayer");

    let started = false;
    let audioCtx = null;

    function ensureAudioCtx() {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return null;
      if (!audioCtx) audioCtx = new AC();
      if (audioCtx.state === "suspended") audioCtx.resume().catch(() => {});
      return audioCtx;
    }

    function startBgm() {
      const ctx = ensureAudioCtx();
      if (!ctx) return;
      const master = ctx.createGain();
      master.gain.value = 0.18;
      master.connect(ctx.destination);
      const filter = ctx.createBiquadFilter();
      filter.type = "lowpass";
      filter.frequency.value = 900;
      filter.Q.value = 0.7;
      filter.connect(master);
      const freqs = [90, 140, 220];
      freqs.forEach((f, i) => {
        const osc = ctx.createOscillator();
        osc.type = "sine";
        osc.frequency.value = f;
        const g = ctx.createGain();
        g.gain.value = 0.18 / (i + 1);
        osc.connect(g);
        g.connect(filter);
        osc.start();
      });
      const lfo = ctx.createOscillator();
      lfo.type = "sine";
      lfo.frequency.value = 0.07;
      const lfoGain = ctx.createGain();
      lfoGain.gain.value = 0.08;
      lfo.connect(lfoGain);
      lfoGain.connect(master.gain);
      lfo.start();
    }

    function playTypeSfx() {
      const ctx = ensureAudioCtx();
      if (!ctx) return;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "square";
      osc.frequency.value = 1350;
      const now = ctx.currentTime;
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.08, now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.07);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(now);
      osc.stop(now + 0.08);
    }

    function typeLine(text, pauseAfter, cb) {
      const lineEl = document.createElement("div");
      lineEl.className = "overlay-line";
      overlayLines.appendChild(lineEl);
      let idx = 0;
      const speed = 70;
      const timer = setInterval(() => {
        lineEl.textContent = text.slice(0, idx + 1);
        playTypeSfx();
        idx++;
        if (idx >= text.length) {
          clearInterval(timer);
          if (cb) setTimeout(cb, pauseAfter);
        }
      }, speed);
    }

    function startOverlaySequence() {
      overlay.classList.add("show");
      const lines = ["SLEEEEEEEEEEP,", "SLEEEEEEEEEEP,", "SLEEEEEEEEEEP,"];
      typeLine(lines[0], 1200, () => {
        typeLine(lines[1], 1200, () => {
          typeLine(lines[2], 1200, () => {
            overlayThird.textContent = "THE THIRD SLEEP";
            overlayThird.classList.add("show");
            setTimeout(() => {
              overlayThird.classList.add("fade-out");
              sceneFade.classList.add("on");
              fogLayer.classList.add("fog-play");
            }, 1400);
          });
        });
      });
    }

    startBtn.addEventListener("click", () => {
      if (started) return;
      started = true;
      startBgm();
      document.body.classList.add("lights-dimming");
      startBtn.disabled = true;
      setTimeout(() => {
        document.body.classList.remove("lights-dimming");
        document.body.classList.add("lights-off");
        startOverlaySequence();
      }, 3000);
    });
  </script>
</body>
</html>
