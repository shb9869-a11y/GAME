<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>SLEEP CITY</title>

  <!-- 픽셀 게임 폰트 -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SLEEP CITY">
  <meta name="theme-color" content="#000000">

  <style>
    :root{
      --window-on: #ffd800;
      --window-off: #050509;
      --text: #f5f5f5;
      --sky: #050509;
      --skin: #f5c7a0;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    html,body{
      width:100%;
      height:100%;
      overflow:hidden;
      background:#000;
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo",system-ui,sans-serif;
    }

    /* 세로모드 경고 */
    .rotate-warning{
      position:fixed;
      inset:0;
      background:#000;
      color:#fff;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:300;
      text-align:center;
      padding:24px;
      font-size:14px;
      line-height:1.6;
    }
    @media (orientation:portrait){
      .rotate-warning{display:flex;}
    }

    body{
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .app{
      width:100%;
      height:100%;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* 페이드 레이어 */
    .scene-fade{
      position:absolute;
      inset:0;
      background:#000;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.8s linear;
      z-index:220;
    }
    .scene-fade.on{
      opacity:1;
    }

    /* 안개 레이어 */
    .fog-layer{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      z-index:210;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.12) 0, transparent 55%),
        radial-gradient(circle at 80% 60%, rgba(255,255,255,0.1) 0, transparent 60%);
      mix-blend-mode:screen;
    }
    .fog-play{
      animation:fogPulse 3.5s ease-in-out 3;
    }
    @keyframes fogPulse{
      0%{opacity:0;}
      20%{opacity:0.4;}
      40%{opacity:0;}
      60%{opacity:0.45;}
      80%{opacity:0;}
      100%{opacity:0.2;}
    }

    /* 중앙 팝업 공통 */
    .popup-frame{
      width:70vw;
      max-width:820px;
      height:55vh;
      max-height:420px;
      border:1px solid #555;
      background:#000;
      box-shadow:0 0 20px rgba(0,0,0,0.9);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:visible;      /* 아래 대사창이 밖으로 나오도록 */
      margin-bottom:7vh;     /* 세 씬 모두 동일한 위치 */
    }

    /* ========== 씬1: 인트로 ========== */
    #introScene{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:16px;
      padding:16px 24px 24px;
      z-index:100;
    }

    .city-window{
      width:100%;
      height:100%;
      background:var(--sky);
      position:relative;
      overflow:hidden;
      image-rendering:pixelated;
    }

    .moon{
      position:absolute;
      top:10px;
      left:10px;
      width:16px;
      height:16px;
      background:var(--window-on);
      image-rendering:pixelated;
      box-shadow:
        0 0 4px rgba(255,216,0,0.9),
        0 0 8px rgba(255,216,0,0.7);
    }
    .moon::before{
      content:"";
      position:absolute;
      left:6px;
      top:2px;
      width:10px;
      height:12px;
      background:var(--sky);
    }
    body.lights-off .moon{
      filter:brightness(0.15);
      opacity:0.2;
    }
    body.lights-dimming .moon{
      animation:moonDim 3s forwards;
    }
    @keyframes moonDim{
      0%{filter:brightness(1);opacity:1;}
      100%{filter:brightness(0.2);opacity:0.25;}
    }

    .city-layers{
      position:absolute;
      inset:0;
    }

    .layer{
      position:absolute;
      left:4px;
      right:4px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:4px;
      pointer-events:none;
    }
    .layer-back{
      bottom:26%;
      transform:scale(0.9);
      opacity:0.6;
    }
    .layer-mid{
      bottom:13%;
      transform:scale(0.96);
      opacity:0.8;
    }
    .layer-front{
      bottom:0;
      opacity:1;
    }

    .building{
      position:relative;
      display:flex;
      flex-direction:column;
      padding:4px 1px 5px;
      border:1px solid rgba(0,0,0,0.7);
      box-shadow:0 -2px 0 rgba(255,255,255,0.04) inset;
      image-rendering:pixelated;
      flex:0.08;
      max-width:3.5%;
      min-width:1.8%;
    }

    .roof{
      width:90%;
      margin:0 auto 4px;
    }
    .roof-flat{
      height:4px;
      background:#dadada;
    }
    .roof-tri{
      width:0;
      height:0;
      border-left:8px solid transparent;
      border-right:8px solid transparent;
      border-bottom:12px solid #f0f0f0;
    }
    .roof-step{
      height:8px;
      background:#dcdcdc;
      clip-path:polygon(
        0 100%, 0 35%,
        30% 35%, 30% 0,
        70% 0, 70% 35%,
        100% 35%, 100% 100%
      );
    }

    .windows{
      width:100%;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      grid-auto-rows:8px;
      gap:2px;
      padding:0 1px 2px;
    }

    .window{
      width:100%;
      height:100%;
      background:var(--window-on);
      box-shadow:0 0 4px rgba(255,216,0,0.6);
      opacity:0.85;
      animation:windowFlicker 4.2s infinite ease-in-out;
      animation-delay:calc(var(--rand) * 3s);
    }
    @keyframes windowFlicker{
      0%{opacity:0.5; transform:scaleY(1);}
      40%{opacity:0.9; transform:scaleY(1.03);}
      80%{opacity:0.6; transform:scaleY(1);}
      100%{opacity:0.7; transform:scaleY(1.02);}
    }

    /* START 후 불 페이드 아웃 */
    body.lights-dimming .window{
      animation:lightsOut 3s forwards;
    }
    @keyframes lightsOut{
      0%{
        background:var(--window-on);
        box-shadow:0 0 4px rgba(255,216,0,0.6);
        opacity:0.9;
      }
      100%{
        background:#000;
        box-shadow:none;
        opacity:1;
      }
    }

    /* 완전히 꺼진 상태 */
    body.lights-off .window{
      background:#000;
      box-shadow:none;
      opacity:1;
      animation:none;
    }

    .bottom-center{
      margin-top:12px;
    }
    .start-btn{
      padding:10px 30px;
      border:1px solid #f5f5f5;
      background:#101010;
      color:#f5f5f5;
      font-size:13px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      cursor:pointer;
      outline:none;
      min-width:140px;
      transition:opacity .3s;
    }
    .start-btn[disabled]{
      opacity:0;
      cursor:default;
    }

    .overlay{
      position:absolute;
      inset:10% 8%;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      pointer-events:none;
    }
    .overlay.show{
      display:flex;
    }
    .overlay-inner{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-family:"Press Start 2P","Courier New",monospace;
      color:#f5f5f5;
      text-align:center;
    }
    .overlay-lines{
      font-size:clamp(12px,2.3vw,22px);
      line-height:1.6;
      text-shadow:0 0 6px rgba(255,255,255,0.3);
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .overlay-line{
      min-height:1.3em;
      width:auto;
      text-align:center;
    }
    .overlay-third{
      margin-top:20px;
      font-size:clamp(11px,2vw,20px);
      opacity:0;
      transition:opacity 1.5s linear;
      width:auto;
      text-align:center;
    }
    .overlay-third.show{
      opacity:1;
    }
    .overlay-third.fade-out{
      opacity:0;
    }

    /* ========== 씬2: 좌우 건물 + 길 + 캐릭터 ========== */
    #streetScene{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:110;
    }

    .game-window{
      width:100%;
      height:100%;
      background:#020207;
      position:relative;
      display:flex;
      flex-direction:row;
      overflow:hidden;
    }

    .side-wall{
      flex:0 0 26%;
      background:#11131a;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:6px 4px;
    }

    .wall-building{
      background:#14151c;
      border:1px solid #000;
      padding:3px 2px 4px;
      box-shadow:0 0 12px rgba(0,0,0,0.8);
    }
    .wall-windows{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      grid-auto-rows:7px;
      gap:2px;
    }
    .wall-window{
      background:var(--window-off);
      opacity:0.9;
    }

    .street-road{
      flex:1;
      background:#050509;
      position:relative;
      overflow:hidden;
    }

    .street-road-inner{
      position:absolute;
      inset:5% 6%;
      background:#0b0c11;
      box-shadow:0 0 18px rgba(0,0,0,0.95);
      overflow:hidden;
    }

    .street-lane{
      position:absolute;
      left:50%;
      top:0;
      width:4px;
      height:100%;
      background:repeating-linear-gradient(
        to bottom,
        #dcdcdc 0 18px,
        transparent 18px 36px
      );
      transform:translateX(-50%);
      opacity:0.12;
    }

    /* 사람 캐릭터 (팔/다리 길게) */
    .character{
      position:absolute;
      width:18px;
      height:30px;
      background:var(--skin);
      image-rendering:pixelated;
      left:50%;
      bottom:15%;
      transform:translate(-50%,0);
      transition:opacity 0.4s ease-out;
    }
    .character .eyes{
      position:absolute;
      top:5px;
      left:4px;
      width:3px;
      height:3px;
      background:#111;
      box-shadow:7px 0 0 #111;
    }
    /* 팔 – 좌우로 길게 뻗기 */
    .character::before{
      content:"";
      position:absolute;
      top:12px;
      left:-8px;
      width:34px;
      height:6px;
      background:var(--skin);
    }
    /* 다리 – 아래로 두 가닥 길게 */
    .character::after{
      content:"";
      position:absolute;
      bottom:-4px;
      left:2px;
      width:4px;
      height:14px;
      background:var(--skin);
      box-shadow:8px 0 0 var(--skin);
    }
    .character.fade-out{
      opacity:0;
    }

    /* 위쪽 빨간 건물 (3번 위로 지나간 후 등장, 길게) */
    .red-building{
      position:absolute;
      left:18%;
      right:18%;
      top:1%;
      height:40%;
      background:#7b1118;
      border:1px solid #000;
      box-shadow:0 0 20px rgba(0,0,0,0.95);
      opacity:0;
      display:none;
      transition:opacity 0.4s ease-out;
    }
    .red-building.show{
      display:block;
      opacity:1;
    }
    .red-building-windows{
      position:absolute;
      inset:10% 15% 35% 15%;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      grid-auto-rows:8px;
      gap:3px;
    }
    .red-window{
      background:var(--window-on);
      box-shadow:0 0 8px rgba(255,216,0,0.8);
    }

    .red-door{
      position:absolute;
      bottom:0;
      left:50%;
      transform:translateX(-50%);
      width:24%;
      height:40%;
      background:#050308;
      border:2px solid #000;
      box-shadow:0 0 12px rgba(0,0,0,0.9);
    }
    .red-door::before{
      content:"";
      position:absolute;
      right:18%;
      top:46%;
      width:4px;
      height:4px;
      border-radius:50%;
      background:#f5f5f5;
    }

    /* ========== 씬3: 하얀 방 ========== */
    #whiteScene{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:120;
    }
    #whiteScene .popup-frame{
      background:#ffffff;
      border-color:#ddd;
    }
    .white-room{
      width:100%;
      height:100%;
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .white-room .character{
      bottom:auto;
      top:50%;
      transform:translate(-50%,-50%);
      box-shadow:none;
    }

    /* ========== 조이스틱 ========== */
    .joystick{
      position:fixed;
      left:16px;
      bottom:18px;
      width:96px;
      height:96px;
      z-index:200;
      touch-action:none;
      user-select:none;
    }
    .joy-base{
      position:relative;
      width:100%;
      height:100%;
      border-radius:50%;
      border:1px solid #666;
      background:#050505;
      opacity:0.95;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .joy-knob{
      width:44px;
      height:44px;
      border-radius:50%;
      border:1px solid #aaa;
      background:#111;
      transition:transform 0.08s linear;
    }

    /* ========== 문 앞 대화 텍스트 ========== */
    .dialog-box{
      position:absolute;
      left:-4px;
      right:-4px;
      bottom:-22%;
      display:none;
      align-items:flex-end;
      justify-content:space-between;
      padding:6px 10px 4px;
      font-family:"Press Start 2P","Courier New",monospace;
      font-size:clamp(9px,1.7vw,13px);
      line-height:1.6;
      color:#f5f5f5;
      pointer-events:auto;
    }
    .dialog-box.show{
      display:flex;
    }
    .dialog-text{
      flex:1;
      padding-right:12px;
      white-space:pre-line;
      text-align:left;
    }
    .dialog-next{
      flex:0 0 auto;
      padding:6px 14px;
      border:1px solid #f5f5f5;
      background:#101010;
      color:#f5f5f5;
      font-size:inherit;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="rotate-warning">
    화면을 가로 모드로 돌려주세요.<br>
    Please rotate your device to landscape.
  </div>

  <div class="app">
    <div class="scene-fade" id="sceneFade"></div>
    <div class="fog-layer" id="fogLayer"></div>

    <!-- 씬1: 인트로 -->
    <div id="introScene">
      <div class="popup-frame">
        <div class="city-window">
          <div class="moon"></div>
          <div class="city-layers">
            <div class="layer layer-back" data-count="22"></div>
            <div class="layer layer-mid" data-count="26"></div>
            <div class="layer layer-front" data-count="30"></div>
          </div>

          <div class="overlay" id="overlay">
            <div class="overlay-inner">
              <div class="overlay-lines" id="overlayLines"></div>
              <div class="overlay-third" id="overlayThird"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="bottom-center">
        <button class="start-btn" id="startBtn">START</button>
      </div>
    </div>

    <!-- 씬2: 좌우 건물 + 길 + 캐릭터 -->
    <div id="streetScene">
      <div class="popup-frame">
        <div class="game-window">
          <div class="side-wall" id="leftWall"></div>

          <div class="street-road">
            <div class="street-road-inner" id="roadInner">
              <div class="street-lane"></div>

              <div class="red-building" id="redBuilding">
                <div class="red-building-windows" id="redWindows"></div>
                <div class="red-door"></div>
              </div>

              <div class="character" id="character">
                <div class="eyes"></div>
              </div>
            </div>
          </div>

          <div class="side-wall" id="rightWall"></div>
        </div>

        <!-- 팝업 기준 아래에 대사 -->
        <div class="dialog-box" id="dialogBox">
          <div class="dialog-text" id="dialogText"></div>
          <button class="dialog-next" id="dialogNext">NEXT</button>
        </div>
      </div>
    </div>

    <!-- 씬3: 하얀 방 -->
    <div id="whiteScene">
      <div class="popup-frame">
        <div class="white-room">
          <div class="character" id="whiteCharacter">
            <div class="eyes"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 조이스틱 -->
    <div class="joystick">
      <div class="joy-base" id="joyBase">
        <div class="joy-knob" id="joyKnob"></div>
      </div>
    </div>
  </div>

  <!-- 배경음악 & 움직임 사운드 (파일은 직접 넣기) -->
  <audio id="bgm" src="bgm_sleep_city.mp3" loop></audio>
  <audio id="stepSfx" src="step_move.wav"></audio>

  <script>
    /* ========= 인트로 건물 생성 ========= */
    const palette = [
      "#16171b","#1b1c22","#20232a",
      "#252831","#2b3038","#313640",
      "#373c46","#1b1c20","#22252c"
    ];

    function makeIntroBuilding(layerName, i){
      const b = document.createElement("div");
      b.className = "building";

      const base = layerName === "back" ? 55 : (layerName === "mid" ? 45 : 35);
      const h = base + (i * 3) % 20;
      b.style.height = h + "%";

      const flexVal = 0.08 + (i % 4)*0.03;
      b.style.flex = flexVal.toFixed(2);

      const color = palette[(i * 2 + (layerName === "front" ? 1 : 0)) % palette.length];
      b.style.background = color;

      const roof = document.createElement("div");
      roof.classList.add("roof");
      const rt = i % 3;
      if(rt === 0) roof.classList.add("roof-flat");
      else if(rt === 1) roof.classList.add("roof-tri");
      else roof.classList.add("roof-step");
      b.appendChild(roof);

      const windows = document.createElement("div");
      windows.className = "windows";
      const floors = 6 + (i % 4);
      for(let k=0;k<floors*2;k++){
        const w = document.createElement("div");
        w.className = "window";
        w.style.setProperty("--rand", Math.random().toString());
        windows.appendChild(w);
      }
      b.appendChild(windows);

      return b;
    }

    document.querySelectorAll(".layer").forEach(layer=>{
      const count = Number(layer.dataset.count);
      const name =
        layer.classList.contains("layer-back") ? "back" :
        layer.classList.contains("layer-mid") ? "mid" : "front";
      for(let i=0;i<count;i++){
        layer.appendChild(makeIntroBuilding(name,i));
      }
    });

    /* ========= 인트로 시퀀스 ========= */
    const startBtn      = document.getElementById("startBtn");
    const overlay       = document.getElementById("overlay");
    const overlayLines  = document.getElementById("overlayLines");
    const overlayThird  = document.getElementById("overlayThird");
    const sceneFade     = document.getElementById("sceneFade");
    const fogLayer      = document.getElementById("fogLayer");
    const introScene    = document.getElementById("introScene");
    const streetScene   = document.getElementById("streetScene");
    const whiteScene    = document.getElementById("whiteScene");

    const bgm           = document.getElementById("bgm");
    const stepSfx       = document.getElementById("stepSfx");

    let started = false;

    function typeLine(text, pauseAfter, cb){
      const lineEl = document.createElement("div");
      lineEl.className = "overlay-line";
      overlayLines.appendChild(lineEl);

      let idx = 0;
      const speed = 70;
      const timer = setInterval(()=>{
        lineEl.textContent = text.slice(0, idx+1);
        idx++;
        if(idx >= text.length){
          clearInterval(timer);
          if(cb) setTimeout(cb, pauseAfter);
        }
      }, speed);
    }

    function startOverlaySequence(){
      overlay.classList.add("show");
      const lines = [
        "SLEEEEEEEEEEP,",
        "SLEEEEEEEEEEP,",
        "SLEEEEEEEEEEP,"
      ];

      typeLine(lines[0], 1200, ()=>{
        typeLine(lines[1], 1200, ()=>{
          typeLine(lines[2], 1200, ()=>{
            overlayThird.textContent = "THE THIRD SLEEP";
            overlayThird.classList.add("show");

            setTimeout(()=>{
              overlayThird.classList.add("fade-out");
              sceneFade.classList.add("on");
              fogLayer.classList.add("fog-play");

              setTimeout(()=>{
                introScene.style.display = "none";
                streetScene.style.display = "flex";
                sceneFade.classList.remove("on");
              }, 800);
            }, 1400);
          });
        });
      });
    }

    startBtn.addEventListener("click", ()=>{
      if(started) return;
      started = true;

      // BGM 시작 (어나더코어 느낌의 파일을 bgm_sleep_city.mp3로 넣어두면 됨)
      if(bgm){
        bgm.volume = 0.6;
        bgm.play().catch(()=>{ /* iOS에서 막히면 무시 */ });
      }

      // 불 서서히 꺼지기
      document.body.classList.add("lights-dimming");
      startBtn.disabled = true;

      // 페이드 끝난 뒤 완전 소등 + 타이핑 시작
      setTimeout(()=>{
        document.body.classList.remove("lights-dimming");
        document.body.classList.add("lights-off");
        startOverlaySequence();
      }, 3000);
    });

    /* ========= 씬2: 건물들 생성 ========= */
    const leftWall   = document.getElementById("leftWall");
    const rightWall  = document.getElementById("rightWall");
    const redBuilding= document.getElementById("redBuilding");
    const redWindows = document.getElementById("redWindows");

    function fillWall(container, count){
      for(let i=0;i<count;i++){
        const b = document.createElement("div");
        b.className = "wall-building";

        const wWrap = document.createElement("div");
        wWrap.className = "wall-windows";

        const floors = 5 + (i % 3);
        for(let j=0;j<floors*3;j++){
          const w = document.createElement("div");
          w.className = "wall-window";
          wWrap.appendChild(w);
        }

        b.appendChild(wWrap);
        container.appendChild(b);
      }
    }

    fillWall(leftWall, 7);
    fillWall(rightWall, 7);

    for(let i=0;i<4*3;i++){
      const w = document.createElement("div");
      w.className = "red-window";
      redWindows.appendChild(w);
    }

    /* ========= 캐릭터 & 랩 로직 ========= */
    const character   = document.getElementById("character");
    const whiteChar   = document.getElementById("whiteCharacter");
    const dialogBox   = document.getElementById("dialogBox");
    const dialogText  = document.getElementById("dialogText");
    const dialogNext  = document.getElementById("dialogNext");

    let charX = 50;
    let charY = 15;
    let whiteX = 50;
    let whiteY = 50;

    let laps = 0;          // 위로 넘어간 횟수
    let buildingShown = false;

    function clamp(v,min,max){
      return v < min ? min : (v > max ? max : v);
    }

    function updateCharacter(){
      // 화면 안 범위
      charX = clamp(charX, 8, 92);
      charY = clamp(charY, 8, 92);

      character.style.left   = charX + "%";
      character.style.bottom = charY + "%";

      updateRedBuildingVisibility();
      maybeTriggerDialog();
    }

    function wrapIfNeeded(){
      // 위로 나가면 아래에서 나오고 lap 증가
      if(charY >= 92){
        charY = 10;
        laps++;
        if(laps >= 3){
          buildingShown = true;
          redBuilding.classList.add("show");
        }
      }
    }

    function updateWhiteCharacter(){
      whiteX = clamp(whiteX, 5, 95);
      whiteY = clamp(whiteY, 10, 90);
      whiteChar.style.left = whiteX + "%";
      whiteChar.style.top  = whiteY + "%";
    }

    function updateRedBuildingVisibility(){
      if(buildingShown){
        redBuilding.classList.add("show");
      }else{
        redBuilding.classList.remove("show");
      }
    }

    function isNearDoorOrBuilding(){
      if(!buildingShown || !redBuilding.classList.contains("show")) return false;
      // 빨간 건물 쪽으로 충분히 올라오면 바로 발동 (문 앞 느낌)
      const nearTop = charY > 78;
      return nearTop;
    }

    /* ========= 문 앞 대화 ========= */
    const dialogLines = [
      "문이다.",
      "한 번 들어가볼까?",
      "그래도 무섭잖아",
      "아니야 들어가보자.",
      "왜..?",
      "뭐가 나올지 모르지까.",
      "가자."
    ];

    let dialogStarted = false;
    let dialogActive  = false;
    let dialogIndex   = 0;
    let typing        = false;
    let typingTimer   = null;

    function maybeTriggerDialog(){
      if(dialogStarted) return;
      if(!isNearDoorOrBuilding()) return;
      startDialog();
    }

    function startDialog(){
      dialogStarted = true;
      dialogActive  = true;
      dialogIndex   = 0;
      dialogBox.classList.add("show");
      typeDialogLine(dialogLines[0]);
    }

    function typeDialogLine(text){
      if(typingTimer) clearInterval(typingTimer);
      dialogText.textContent = "";
      let idx = 0;
      typing = true;
      typingTimer = setInterval(()=>{
        dialogText.textContent = text.slice(0, idx+1);
        idx++;
        if(idx >= text.length){
          clearInterval(typingTimer);
          typingTimer = null;
          typing = false;
        }
      }, 60);
    }

    function showNextDialog(){
      if(!dialogActive) return;

      if(typing){
        clearInterval(typingTimer);
        typingTimer = null;
        typing = false;
        dialogText.textContent = dialogLines[dialogIndex];
        return;
      }

      dialogIndex++;
      if(dialogIndex < dialogLines.length){
        typeDialogLine(dialogLines[dialogIndex]);
      }else{
        endDialogAndEnterWhiteRoom();
      }
    }

    function endDialogAndEnterWhiteRoom(){
      dialogActive = false;
      dialogBox.classList.remove("show");
      character.classList.add("fade-out");
      sceneFade.classList.add("on");

      whiteX = 50;
      whiteY = 50;

      setTimeout(()=>{
        streetScene.style.display = "none";
        whiteScene.style.display  = "flex";
        updateWhiteCharacter();
        sceneFade.classList.remove("on");
      }, 800);
    }

    dialogNext.addEventListener("click", e=>{
      e.preventDefault();
      showNextDialog();
    });
    dialogNext.addEventListener("touchstart", e=>{
      e.preventDefault();
      showNextDialog();
    }, {passive:false});

    updateCharacter();
    updateWhiteCharacter();

    /* ========= 조이스틱 ========= */
    const joyBase = document.getElementById("joyBase");
    const joyKnob = document.getElementById("joyKnob");

    let joyActive = false;
    let joyDX = 0;
    let joyDY = 0;

    function setJoyFromEvent(e){
      const rect = joyBase.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;

      const point = e.touches ? e.touches[0] : e;
      let dx = point.clientX - cx;
      let dy = point.clientY - cy;

      const max = rect.width/2;
      let nx = dx / max;
      let ny = dy / max;

      const len = Math.hypot(nx,ny);
      if(len > 1){
        nx /= len;
        ny /= len;
      }

      // 작은 움직임은 0으로
      const dead = 0.25;
      if(Math.hypot(nx,ny) < dead){
        joyDX = 0;
        joyDY = 0;
        joyKnob.style.transform = "translate(0,0)";
        return;
      }

      // 시각적으로는 손가락 방향과 동일하게 움직이고,
      // 이동 방향은 화면 좌표를 고려해 위/아래 반전
      joyDX = nx;
      joyDY = -ny; // 위로 밀면 위로 이동

      const knobR = max * 0.55;
      const kx = nx * knobR;
      const ky = ny * knobR; // 손가락 방향과 동일하게
      joyKnob.style.transform = `translate(${kx}px,${ky}px)`;
    }

    function joyStart(e){
      e.preventDefault();
      joyActive = true;
      setJoyFromEvent(e);
      window.addEventListener("mousemove", joyMove);
      window.addEventListener("touchmove", joyMove, {passive:false});
      window.addEventListener("mouseup", joyEnd);
      window.addEventListener("touchend", joyEnd);
      window.addEventListener("touchcancel", joyEnd);
    }
    function joyMove(e){
      if(!joyActive) return;
      e.preventDefault();
      setJoyFromEvent(e);
    }
    function joyEnd(e){
      joyActive = false;
      joyDX = 0;
      joyDY = 0;
      joyKnob.style.transform = "translate(0,0)";
      window.removeEventListener("mousemove", joyMove);
      window.removeEventListener("touchmove", joyMove);
      window.removeEventListener("mouseup", joyEnd);
      window.removeEventListener("touchend", joyEnd);
      window.removeEventListener("touchcancel", joyEnd);
    }

    joyBase.addEventListener("mousedown", joyStart);
    joyBase.addEventListener("touchstart", joyStart, {passive:false});

    /* ========= 메인 루프 (조이스틱 이동 + 발소리) ========= */
    let lastTime = null;
    let lastStepTime = 0;
    const stepInterval = 220; // ms

    function loop(ts){
      if(lastTime === null) lastTime = ts;
      const dt = (ts - lastTime) / 16.67; // 약 60fps 기준
      lastTime = ts;

      const speed = 0.6; // 퍼센트/프레임 기준 속도

      const movingMagnitude = Math.hypot(joyDX, joyDY);
      const isMoving = movingMagnitude > 0.25;

      if(streetScene.style.display === "flex"){
        if(!dialogActive){
          charX += joyDX * speed * dt;
          charY += joyDY * speed * dt;
          wrapIfNeeded();
          updateCharacter();
        }
      }else if(whiteScene.style.display === "flex"){
        whiteX += joyDX * speed * dt;
        whiteY -= joyDY * speed * dt; // white는 top 기준
        updateWhiteCharacter();
      }

      // 움직일 때 발소리
      if(isMoving && (streetScene.style.display === "flex" || whiteScene.style.display === "flex")){
        if(ts - lastStepTime > stepInterval){
          lastStepTime = ts;
          if(stepSfx){
            try{
              stepSfx.currentTime = 0;
              stepSfx.play();
            }catch(e){}
          }
        }
      }

      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  </script>
</body>
</html>