<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Start Anywhere (Chrome Capture Fix)</title>
  <style>
    :root{color-scheme:dark}
    html,body{height:100%;margin:0}
    body{
      background:#0b0b0b;color:#eee;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      touch-action:manipulation;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }

    /* âœ… ì‹œê° ì•ˆë‚´ìš© ì˜¤ë²„ë ˆì´(í´ë¦­ì€ 'ë§‰ì§€ ì•ŠìŒ' : pointer-events:none) */
    #hint{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      z-index:2147483647;
      pointer-events:none;
      padding:24px;
      text-align:center;
      background:radial-gradient(ellipse at center, rgba(255,255,255,0.06), rgba(0,0,0,0.0) 55%);
    }
    #hint .box{
      max-width:720px;
      border:1px solid #2a2a2a;
      border-radius:18px;
      background:rgba(18,18,18,0.75);
      padding:18px 16px;
      backdrop-filter: blur(6px);
    }
    #hint h1{margin:0 0 10px; font-size:18px}
    #hint p{margin:6px 0; opacity:.9; line-height:1.5}
    .mono{
      position:fixed; left:18px; right:18px; bottom:18px;
      background:#0f0f0f; border:1px solid #2a2a2a; border-radius:14px;
      padding:12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:12px; white-space:pre-wrap;
      z-index:2147483646;
    }

    button, input{
      padding:12px; border-radius:12px; border:1px solid #333; background:#111; color:#eee;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .row>*{flex:1; min-width:220px}

    .meter{height:10px;border-radius:999px;background:#1a1a1a;border:1px solid #2a2a2a;overflow:hidden}
    .meter>div{height:100%;width:0%;background:#eaeaea;opacity:.9}

    #panel{
      max-width:1100px; margin:0 auto; padding:18px;
      position:relative; z-index:1;
    }
    .card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:16px}
  </style>
</head>
<body>

<div id="hint">
  <div class="box">
    <h1>í¬ë¡¬ Start ë²„íŠ¼ ì”¹í˜ í•´ê²°íŒ</h1>
    <p><b>í™”ë©´ ì•„ë¬´ ê³³ì´ë‚˜ í•œ ë²ˆ í´ë¦­/í„°ì¹˜</b>í•˜ë©´ ì˜¤ë””ì˜¤ê°€ ì‹œì‘ë¼.</p>
    <p>ê·¸ ë‹¤ìŒ <b>Mic On</b> ëˆ„ë¥´ë©´ ì›ìŒì´ ë“¤ë ¤ì•¼ ì •ìƒ.</p>
    <p style="opacity:.75">ì´ì–´í°/í—¤ë“œí° ê¶Œì¥(í•˜ìš¸ë§ ë°©ì§€)</p>
  </div>
</div>

<div id="panel">
  <div class="card">
    <div class="row">
      <button id="micBtn" disabled>Mic On</button>
      <button id="micOffBtn" disabled>Mic Off</button>
      <button id="beepBtn" disabled>Test Beep</button>
    </div>

    <div class="row">
      <div>
        <div style="margin:8px 0 6px; font-size:13px; opacity:.9">Mic Level</div>
        <div class="meter"><div id="micBar"></div></div>
      </div>
      <div>
        <div style="margin:8px 0 6px; font-size:13px; opacity:.9">Status</div>
        <div id="status" style="padding:10px 12px;border:1px solid #2a2a2a;border-radius:12px;background:#0f0f0f;opacity:.9">
          waitingâ€¦
        </div>
      </div>
    </div>
  </div>
</div>

<div id="log" class="mono">ëŒ€ê¸° ì¤‘â€¦</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const logEl = $("log");
  const statusEl = $("status");
  const log = (m)=>{ logEl.textContent = m + "\n" + logEl.textContent; };
  const setStatus = (m)=>{ statusEl.textContent = m; };

  let ctx=null;
  let micStream=null, micSrc=null;
  let master=null;

  let analyser=null;

  function dumpTopElement(ev){
    const x = (ev.touches && ev.touches[0]) ? ev.touches[0].clientX : ev.clientX;
    const y = (ev.touches && ev.touches[0]) ? ev.touches[0].clientY : ev.clientY;
    const el = document.elementFromPoint(x, y);
    if(!el) return "topEl=null";
    const cls = (el.className && typeof el.className==="string" && el.className.trim())
      ? "."+el.className.trim().split(/\s+/).join(".") : "";
    return `topEl=${el.tagName}${cls}#${el.id||""}`;
  }

  async function startAudio(ev){
    if(ctx) return;

    log("CAPTURE START âœ…  " + dumpTopElement(ev));
    setStatus("startingâ€¦");

    ctx = new (window.AudioContext||window.webkitAudioContext)();
    await ctx.resume();

    master = ctx.createGain();
    master.gain.value = 0.9;
    master.connect(ctx.destination);

    analyser = ctx.createAnalyser();
    analyser.fftSize = 2048;
    analyser.smoothingTimeConstant = 0.85;

    // tap output level for meter (use a silent connection)
    master.connect(analyser);

    $("micBtn").disabled = false;
    $("beepBtn").disabled = false;

    // ì•ˆë‚´ ì˜¤ë²„ë ˆì´ ì œê±°
    $("hint").remove();

    setStatus("STARTED âœ…  (now press Mic On)");
    log("AudioContext state: " + ctx.state);

    requestAnimationFrame(loopMeter);
  }

  // âœ… í•µì‹¬: â€œì–´ë–¤ ë ˆì´ì–´ê°€ ë®ê³  ìˆì–´ë„â€ ë¬´ì¡°ê±´ ì¡ëŠ” ìº¡ì²˜ ë¦¬ìŠ¤ë„ˆ
  ["pointerdown","touchstart","mousedown"].forEach(type=>{
    window.addEventListener(type, (ev)=>{
      // ì²« ì œìŠ¤ì²˜ì—ì„œë§Œ ì‹œì‘
      if(!ctx) startAudio(ev);
    }, {capture:true, passive:false});
  });

  function testBeep(){
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type="sine";
    osc.frequency.value=880;

    g.gain.value=0;
    g.connect(master);

    const t = ctx.currentTime;
    g.gain.setValueAtTime(0.0, t);
    g.gain.linearRampToValueAtTime(0.18, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.25);

    osc.connect(g);
    osc.start(t);
    osc.stop(t+0.26);

    log("Beep ğŸ”ˆ (ë“¤ë¦¬ë©´ ì¶œë ¥ OK)");
    setStatus("BEEP ğŸ”ˆ");
  }

  async function micOn(){
    micStream = await navigator.mediaDevices.getUserMedia({
      audio:{echoCancellation:false, noiseSuppression:false, autoGainControl:false}
    });
    micSrc = ctx.createMediaStreamSource(micStream);

    // ì›ìŒ ëª¨ë‹ˆí„°ë§
    micSrc.connect(master);

    // ë ˆë²¨ ì¸¡ì • (mic->analyserë„ ì¶”ê°€)
    micSrc.connect(analyser);

    log("Mic ON âœ… (ì›ìŒ ë“¤ë ¤ì•¼ ì •ìƒ)");
    setStatus("MIC ON âœ…");
    $("micBtn").disabled = true;
    $("micOffBtn").disabled = false;
  }

  function micOff(){
    if(micSrc){ try{ micSrc.disconnect(); }catch(e){} micSrc=null; }
    if(micStream){ try{ micStream.getTracks().forEach(t=>t.stop()); }catch(e){} micStream=null; }
    log("Mic OFF");
    setStatus("MIC OFF");
    $("micBtn").disabled = false;
    $("micOffBtn").disabled = true;
  }

  $("beepBtn").addEventListener("click", ()=>{ if(ctx) testBeep(); });
  $("micBtn").addEventListener("click", async ()=>{
    try{ await micOn(); }catch(e){ log("Mic error: "+e.message); setStatus("MIC ERROR"); }
  });
  $("micOffBtn").addEventListener("click", micOff);

  function loopMeter(){
    if(!analyser) return requestAnimationFrame(loopMeter);
    const data = new Uint8Array(analyser.fftSize);
    analyser.getByteTimeDomainData(data);

    let rms=0;
    for(let i=0;i<data.length;i++){
      const v = (data[i]-128)/128;
      rms += v*v;
    }
    rms = Math.sqrt(rms/data.length);
    const level = Math.max(0, Math.min(1, rms*3.0));
    $("micBar").style.width = Math.round(level*100) + "%";

    requestAnimationFrame(loopMeter);
  }
})();
</script>
</body>
</html>
