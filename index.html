<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>SLEEEEP TOEM-style World</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PWA 기본 설정 -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEEEP WORLD">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<style>
  *{box-sizing:border-box;margin:0;padding:0;}

  :root{
    --camX: 0px;
    --camY: 0px;
  }

  body{
    background:#000;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    color:#fff;
  }

  /* 가로 모드 안내 */
  .rotate-warning{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:#000;
    color:#fff;
    font-size:18px;
    text-align:center;
    padding:20px;
    z-index:1000;
  }

  .game-root{
    position:relative;
    width: 800px;
    height: 450px;
    background:#111;
    overflow:hidden;
  }

  @media (orientation:portrait){
    .game-root{display:none;}
    .rotate-warning{display:flex;}
  }
  @media (orientation:landscape){
    .game-root{display:block;}
  }

  /* 월드 (카메라) */
  .world{
    position:absolute;
    left:50%;
    top:55%;
    width:520px;
    height:320px;
    transform:translate(calc(-50% + var(--camX)),
                        calc(-50% + var(--camY)));
    transition:transform .25s ease-out;
    pointer-events:none;
  }

  .tile-layer,
  .entity-layer{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  .tile{
    position:absolute;
    width:64px;
    height:32px;
    transform-origin:center center;
    transform:translate(-50%,-50%);
  }

  .tile-base{
    position:absolute;
    left:50%;
    top:50%;
    width:100%;
    height:100%;
    transform:skewY(-26deg);
    background:#f4f4f4;
    border:2px solid #000;
  }

  /* 씬별 바닥 느낌 */
  .scene-info  .tile-base{ background:#ffffff; }
  .scene-stones .tile-base{ background:#e7e7e7; }
  .scene-rock .tile-base{ background:#2b0202; }

  /* 벽 */
  .tile.wall .wall-block{
    position:absolute;
    left:50%;
    top:30%;
    width:40px;
    height:40px;
    transform:translateX(-50%) skewY(-26deg);
    background:#e0e0e0;
    border:3px solid #000;
    box-shadow:0 12px 0 #000;
  }

  /* 출구 타일 - 항상 표시 */
  .tile.exit .tile-base{
    background:
      repeating-linear-gradient(
        45deg, #dcdcdc 0 6px, #ffffff 6px 12px
      );
    border-color:#000;
  }
  .tile.exit::after{
    content:"EXIT";
    position:absolute;
    left:50%;
    top:40%;
    transform:translate(-50%,-50%);
    font-size:10px;
    letter-spacing:0.1em;
    color:#000;
    font-weight:700;
  }

  /* 플레이어 */
  .player{
    position:absolute;
    width:32px;
    height:48px;
    transform-origin:center bottom;
    transition:left .18s linear, top .18s linear;
  }
  .player .shadow{
    position:absolute;
    left:50%;
    bottom:0;
    width:32px;
    height:12px;
    transform:translateX(-50%);
    background:radial-gradient(ellipse at center,
             rgba(0,0,0,0.45) 0, transparent 70%);
  }
  .player .body{
    position:absolute;
    left:50%;
    bottom:14px;
    transform:translateX(-50%);
    width:24px;
    height:22px;
    border-radius:4px;
    background:#fff;
    border:3px solid #000;
  }
  .player .head{
    position:absolute;
    left:50%;
    bottom:34px;
    transform:translateX(-50%);
    width:18px;
    height:18px;
    border-radius:50%;
    background:#fff;
    border:3px solid #000;
  }

  /* 방/비석/바위 소품 */
  .prop{
    position:absolute;
    transform-origin:center center;
  }
  .prop .block{
    position:absolute;
    left:50%;
    top:50%;
    width:60px;
    height:40px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#f5f5f5;
    border:3px solid #000;
    box-shadow:0 10px 0 #000;
  }
  .prop.bed .block{
    width:80px;
    height:46px;
  }
  .prop.rug .block{
    width:100px;
    height:34px;
    background:#e6e6e6;
    box-shadow:0 0 0 #000;
  }
  .prop.rug .block::after{
    content:"";
    position:absolute;
    inset:6px;
    border:2px dashed #777;
  }

  .prop.stone .block{
    width:40px;
    height:50px;
    background:#f2f2f2;
    box-shadow:0 14px 0 #000;
  }

  .prop.redrock .block{
    width:120px;
    height:80px;
    background:#a30000;
    border-radius:6px;
    box-shadow:0 20px 0 #000;
  }

  /* 좌측 하단 방향키 */
  .dpad{
    position:absolute;
    left:20px;
    bottom:20px;
    width:120px;
    height:120px;
    display:grid;
    grid-template-columns:repeat(3,1fr);
    grid-template-rows:repeat(3,1fr);
    gap:4px;
    z-index:30;
  }
  .dpad button{
    border:none;
    background:#222;
    color:#fff;
    border-radius:10px;
    border:3px solid #fff;
    box-shadow:0 3px 0 #000;
    font-size:16px;
    cursor:pointer;
    touch-action:manipulation;
  }
  .dpad button:active{
    transform:translateY(2px);
    box-shadow:0 1px 0 #000;
  }
  .dpad .empty{
    background:transparent;
    border:none;
    box-shadow:none;
    pointer-events:none;
  }

  .log{
    position:absolute;
    left:10px;
    top:10px;
    font-size:12px;
    color:#ccc;
    z-index:40;
  }

  /* 정보 룸 안내판 */
  .info-panel{
    position:absolute;
    right:20px;
    top:20px;
    width:260px;
    padding:10px 14px;
    background:rgba(255,255,255,0.95);
    color:#000;
    border-radius:8px;
    border:3px solid #000;
    font-size:12px;
    line-height:1.4;
    z-index:35;
  }
  .info-panel h1{
    font-size:14px;
    margin-bottom:6px;
    text-transform:uppercase;
    letter-spacing:0.1em;
  }

  /* 씬 페이드 */
  .fade-overlay{
    position:absolute;
    inset:0;
    background:#000;
    opacity:0;
    pointer-events:none;
    transition:opacity .6s ease;
    z-index:50;
  }
  .fade-overlay.active{
    opacity:1;
    pointer-events:auto;
  }
</style>
</head>
<body>

<div class="rotate-warning">
  이 게임은<br><strong>가로 모드</strong>에서만 플레이할 수 있어요.<br><br>
  기기를 가로로 돌려주세요.
</div>

<div class="game-root" id="gameRoot">
  <div class="world" id="world">
    <div class="tile-layer" id="tileLayer"></div>
    <div class="entity-layer">
      <div class="player" id="player">
        <div class="shadow"></div>
        <div class="body"></div>
        <div class="head"></div>
      </div>
    </div>
    <div class="entity-layer" id="propsLayer"></div>
  </div>

  <!-- 좌측 하단 방향키 -->
  <div class="dpad">
    <div class="empty"></div>
    <button data-dir="up">▲</button>
    <div class="empty"></div>

    <button data-dir="left">◀</button>
    <div class="empty"></div>
    <button data-dir="right">▶</button>

    <div class="empty"></div>
    <button data-dir="down">▼</button>
    <div class="empty"></div>
  </div>

  <div class="log" id="log">
    하얀 방에서 안내를 읽고 EXIT 타일로 나가 보세요.
  </div>

  <div class="info-panel" id="infoPanel">
    <h1>SLEEEEP WORLD</h1>
    <p>이곳은 잠들기 직전의 하얀 방입니다.</p>
    <p>방 안을 천천히 거닐며 안내문을 읽은 뒤,<br>
       바닥에 표시된 <strong>EXIT</strong> 타일을 통해 다음 공간으로 이동하세요.</p>
    <p>← ↑ → ↓ 키 또는 화면 왼쪽 아래 방향키로 움직일 수 있습니다.</p>
  </div>

  <div class="fade-overlay" id="fade"></div>
</div>

<!-- 사운드: 파일 이름은 실제 mp3로 교체해서 사용하세요 -->
<audio id="stoneSound0" src="stone1.mp3" loop></audio>
<audio id="stoneSound1" src="stone2.mp3" loop></audio>
<audio id="stoneSound2" src="stone3.mp3" loop></audio>
<audio id="rockAmbience" src="rock_ambience.mp3" loop></audio>

<script>
  /***********************
   * 맵 데이터
   * 0 = 바닥
   * 1 = 벽
   * 2 = 출구
   ***********************/
  // 1. 하얀 방 (정보룸)
  const infoMap = [
    [1,1,1,1,1,1,1],
    [1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1],
    [1,0,0,0,0,2,1], // 오른쪽 아래 쪽 EXIT
    [1,1,1,1,1,1,1]
  ];

  // 2. 비석 + 사운드 필드
  const stonesMap = [
    [1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,2,1], // 출구 → 붉은 바위
    [1,1,1,1,1,1,1,1,1]
  ];

  // 3. 붉은 바위 공간
  const rockMap = [
    [1,1,1,1,1,1,1],
    [1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1],
    [1,1,1,1,1,1,1]
  ];

  const tileW = 64;
  const tileH = 32;
  const originX = 260;
  const originY = 60;

  const worldEl     = document.getElementById('world');
  const tileLayer   = document.getElementById('tileLayer');
  const propsLayer  = document.getElementById('propsLayer');
  const playerEl    = document.getElementById('player');
  const logEl       = document.getElementById('log');
  const fadeEl      = document.getElementById('fade');
  const infoPanelEl = document.getElementById('infoPanel');

  const stoneAudios = [
    document.getElementById('stoneSound0'),
    document.getElementById('stoneSound1'),
    document.getElementById('stoneSound2')
  ];
  const rockAudio = document.getElementById('rockAmbience');

  // 씬 정의
  const scenes = {
    info: {
      key:'info',
      map: infoMap,
      start:{x:3,y:3},
      exitTargets:[{x:5,y:4,to:'stones'}],
      worldClass:'scene-info',
      props:[
        {type:'bed', x:2, y:3},
        {type:'table', x:4, y:3},
        {type:'rug', x:3, y:4}
      ]
    },
    stones: {
      key:'stones',
      map: stonesMap,
      start:{x:1,y:1},
      exitTargets:[{x:7,y:5,to:'rock'}],
      worldClass:'scene-stones',
      props:[
        {type:'stone', x:2, y:2, soundIndex:0},
        {type:'stone', x:4, y:3, soundIndex:1},
        {type:'stone', x:6, y:2, soundIndex:2}
      ]
    },
    rock: {
      key:'rock',
      map: rockMap,
      start:{x:3,y:4},
      exitTargets:[], // 마지막 씬
      worldClass:'scene-rock',
      props:[
        {type:'redrock', x:3, y:3}
      ]
    }
  };

  let currentSceneKey = 'info';
  let currentScene = scenes[currentSceneKey];
  let currentMap   = currentScene.map;

  const rows = () => currentMap.length;
  const cols = () => currentMap[0].length;

  // 플레이어 좌표
  let px = currentScene.start.x;
  let py = currentScene.start.y;

  function buildWorld(){
    tileLayer.innerHTML = '';
    propsLayer.innerHTML = '';

    worldEl.className = 'world ' + currentScene.worldClass;

    const r = rows();
    const c = cols();

    for(let y=0; y<r; y++){
      for(let x=0; x<c; x++){
        const val = currentMap[y][x];
        const tile = document.createElement('div');
        tile.className = 'tile';
        if(val === 1) tile.classList.add('wall');
        if(val === 2) tile.classList.add('exit');

        const base = document.createElement('div');
        base.className = 'tile-base';
        tile.appendChild(base);

        if(val === 1){
          const wall = document.createElement('div');
          wall.className = 'wall-block';
          tile.appendChild(wall);
        }

        const isoX = (x - y) * (tileW/2);
        const isoY = (x + y) * (tileH/2);
        tile.style.left = (originX + isoX) + 'px';
        tile.style.top  = (originY + isoY) + 'px';
        tile.style.zIndex = 10 + x + y;
        tileLayer.appendChild(tile);
      }
    }

    // 소품 배치
    currentScene.props.forEach(p => addProp(p));
    // info 룸 안내판 On/Off
    infoPanelEl.style.display = (currentSceneKey === 'info') ? 'block' : 'none';
  }

  function addProp(p){
    const wrapper = document.createElement('div');
    wrapper.className = 'prop ' + p.type;
    const block = document.createElement('div');
    block.className = 'block';
    wrapper.appendChild(block);

    const isoX = (p.x - p.y) * (tileW/2);
    const isoY = (p.x + p.y) * (tileH/2);
    wrapper.style.left = (originX + isoX) + 'px';
    wrapper.style.top  = (originY + isoY) + 'px';
    wrapper.style.zIndex = 40 + p.x + p.y;

    propsLayer.appendChild(wrapper);
  }

  function updatePlayerPosition(){
    const isoX = (px - py) * (tileW/2);
    const isoY = (px + py) * (tileH/2);
    const screenX = originX + isoX;
    const screenY = originY + isoY;

    playerEl.style.left = screenX + 'px';
    playerEl.style.top  = screenY + 'px';
    playerEl.style.zIndex = 100 + px + py;

    updateCamera(screenX, screenY);
    if(currentSceneKey === 'stones') updateStoneSound();
  }

  function updateCamera(screenX, screenY){
    const desiredX = 260;
    const desiredY = 140;
    const diffX = desiredX - screenX;
    const diffY = desiredY - screenY;
    const camX = diffX * 0.25;
    const camY = diffY * 0.25;

    document.documentElement.style.setProperty('--camX', camX + 'px');
    document.documentElement.style.setProperty('--camY', camY + 'px');
  }

  function canMove(nx, ny){
    if(nx < 0 || nx >= cols() || ny < 0 || ny >= rows()) return false;
    return currentMap[ny][nx] !== 1;
  }

  function move(dx, dy){
    const nx = px + dx;
    const ny = py + dy;
    if(canMove(nx, ny)){
      px = nx;
      py = ny;
      updatePlayerPosition();
      checkExit();
    }else{
      logEl.textContent =
        (currentSceneKey === 'info')   ? '방의 벽에 막혔어요.' :
        (currentSceneKey === 'stones') ? '비석 사이 길을 찾아보세요.' :
                                         '바위를 둘러싼 경계를 살펴보세요.';
    }
  }

  function checkExit(){
    const val = currentMap[py][px];
    if(val !== 2) return;
    const target = currentScene.exitTargets.find(e => e.x === px && e.y === py);
    if(!target) return;
    goToScene(target.to);
  }

  function goToScene(key){
    fadeEl.classList.add('active');
    setTimeout(()=>{
      currentSceneKey = key;
      currentScene    = scenes[currentSceneKey];
      currentMap      = currentScene.map;
      px = currentScene.start.x;
      py = currentScene.start.y;
      handleSceneAudio();
      buildWorld();
      updatePlayerPosition();
      logEl.textContent =
        (key === 'stones')
          ? '비석 사이를 걸으며 소리를 들어보세요. EXIT를 통해 다음 공간으로 나갈 수 있습니다.'
          : (key === 'rock')
            ? '거대한 붉은 바위 앞입니다. 이곳은 여정의 마지막 공간입니다.'
            : '하얀 방으로 돌아왔습니다.';
      fadeEl.classList.remove('active');
    }, 650);
  }

  function handleSceneAudio(){
    if(currentSceneKey === 'stones'){
      stoneAudios.forEach(a=>{
        try{ a.play(); }catch(e){}
        a.volume = 0.1;
      });
      rockAudio.pause();
    }else if(currentSceneKey === 'rock'){
      stoneAudios.forEach(a=>{ a.pause(); });
      try{ rockAudio.play(); }catch(e){}
      rockAudio.volume = 0.8;
    }else{
      stoneAudios.forEach(a=>{ a.pause(); });
      rockAudio.pause();
    }
  }

  function updateStoneSound(){
    currentScene.props.forEach(p=>{
      if(p.type !== 'stone' || p.soundIndex == null) return;
      const a = stoneAudios[p.soundIndex];
      if(!a) return;
      const dist = Math.abs(px - p.x) + Math.abs(py - p.y);
      let vol = 0.1;
      if(dist <= 1) vol = 1;
      else if(dist <= 2) vol = 0.6;
      else if(dist <= 3) vol = 0.3;
      a.volume = vol;
    });
  }

  // 키보드
  window.addEventListener('keydown', e=>{
    if(e.key === 'ArrowUp')    { move(0,-1); }
    else if(e.key === 'ArrowDown') { move(0,1); }
    else if(e.key === 'ArrowLeft') { move(-1,0); }
    else if(e.key === 'ArrowRight'){ move(1,0); }
  });

  // D-pad
  document.querySelectorAll('.dpad button[data-dir]').forEach(btn=>{
    const dir = btn.dataset.dir;
    btn.addEventListener('click', ()=>{
      if(dir === 'up') move(0,-1);
      if(dir === 'down') move(0,1);
      if(dir === 'left') move(-1,0);
      if(dir === 'right') move(1,0);
    });
  });

  // 초기화
  buildWorld();
  updatePlayerPosition();
  handleSceneAudio();

  // PWA 서비스워커 등록
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('sw.js').catch(console.error);
    });
  }
</script>

</body>
</html>