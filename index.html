<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>SLEEP ‚Äì Stable Sound/Touch Reactive Field</title>

<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden;touch-action:none;}
canvas{display:block;width:100vw;height:100vh;}

#hint{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.72);
  color:#ddd; font-family:system-ui;
  z-index:50;
}
#hint .box{
  width:min(560px,92vw);
  padding:18px;
  border-radius:14px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.15);
}

#topRight{
  position:fixed; right:12px; top:12px;
  display:flex; gap:8px;
  z-index:40;
}
.iconBtn{
  width:42px;height:42px;
  display:grid;place-items:center;
  background:rgba(0,0,0,.35);
  color:#eee;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.2);
  cursor:pointer;
}
</style>
</head>

<body>

<div id="hint">
  <div class="box">
    <b>SLEEP ‚Äì Start</b><br><br>
    1) Start Audio<br>
    2) Mic ON<br><br>
    <button id="btnStartAudio">Start Audio</button>
    <button id="btnStartMic" disabled>Mic ON</button>
  </div>
</div>

<canvas id="c"></canvas>

<div id="topRight">
  <div class="iconBtn" id="btnMute">üîá</div>
  <div class="iconBtn" id="btnFS">‚õ∂</div>
</div>

<script>
/* ==========================================================
   CANVAS
========================================================== */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W,H,DPR;

function resize(){
  DPR=Math.min(2,window.devicePixelRatio||1);
  W=innerWidth; H=innerHeight;
  canvas.width=W*DPR; canvas.height=H*DPR;
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize',resize);
resize();

/* ==========================================================
   AUDIO (STABLE)
========================================================== */
let audioCtx, analyser, timeData;
let masterGain, preGain, driveWS, driveGain, filter;
let ringOsc, ringGain;
let micStream;

let ampRaw=0, amp=0, ampSmooth=0, ampDelta=0, prevAmp=0;

// Í∞êÎèÑ
const MIC_VIS_GAIN = 4.5;
const MIC_VIS_GAMMA = 0.55;

function boostAmp(x){
  return Math.pow(Math.min(1,x*MIC_VIS_GAIN),MIC_VIS_GAMMA);
}

function makeWaveshaper(amount){
  const n=1024, curve=new Float32Array(n);
  for(let i=0;i<n;i++){
    const x=i*2/n-1;
    curve[i]=(1+amount)*x/(1+amount*Math.abs(x));
  }
  return curve;
}

// FX Ïä§Î°úÌãÄ
let lastFX=0, lastDrive=-1;

function ensureAudio(){
  if(audioCtx) return;
  audioCtx=new AudioContext();
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=1024;
  timeData=new Uint8Array(analyser.fftSize);

  masterGain=audioCtx.createGain();
  masterGain.gain.value=0.9;

  preGain=audioCtx.createGain();
  driveWS=audioCtx.createWaveShaper();
  driveGain=audioCtx.createGain();
  filter=audioCtx.createBiquadFilter();
  filter.type='bandpass';

  ringOsc=audioCtx.createOscillator();
  ringGain=audioCtx.createGain();

  preGain.connect(driveWS);
  driveWS.connect(driveGain);
  driveGain.connect(filter);
  filter.connect(ringGain);
  ringGain.connect(analyser);
  analyser.connect(masterGain);
  masterGain.connect(audioCtx.destination);

  ringOsc.frequency.value=40;
  ringOsc.connect(ringGain.gain);
  ringOsc.start();
}

function updateAmp(){
  analyser.getByteTimeDomainData(timeData);
  let s=0;
  for(let i=0;i<timeData.length;i++){
    const v=(timeData[i]-128)/128;
    s+=v*v;
  }
  ampRaw=Math.sqrt(s/timeData.length);
  const boosted=boostAmp(ampRaw);
  ampSmooth+=(boosted-ampSmooth)*0.12;
  amp=ampSmooth;
  ampDelta=Math.abs(amp-prevAmp);
  prevAmp=amp;
}

function applyFX(){
  const now=performance.now();
  if(now-lastFX<33) return; // 30fps Ï†úÌïú
  lastFX=now;

  const drive=6+amp*55;
  if(Math.abs(drive-lastDrive)>1){
    driveWS.curve=makeWaveshaper(drive);
    lastDrive=drive;
  }

  preGain.gain.setTargetAtTime(1+amp, audioCtx.currentTime, 0.03);
  driveGain.gain.setTargetAtTime(1+amp*0.6, audioCtx.currentTime, 0.03);
  filter.frequency.setTargetAtTime(300+amp*5000,audioCtx.currentTime,0.03);
  ringGain.gain.setTargetAtTime(Math.min(0.9,amp*0.8),audioCtx.currentTime,0.03);
}

async function startMic(){
  micStream=await navigator.mediaDevices.getUserMedia({audio:true});
  const src=audioCtx.createMediaStreamSource(micStream);
  src.connect(preGain);
}

/* ==========================================================
   PARTICLES (ANTI FREEZE)
========================================================== */
let N=220, pts=[];
function initPts(){
  pts=[];
  for(let i=0;i<N;i++){
    pts.push({
      x:(Math.random()*2-1)*W*0.3,
      y:(Math.random()*2-1)*H*0.3,
      z:(Math.random()*2-1)*300,
      vx:0,vy:0,vz:0
    });
  }
}
initPts();

let rot=0;

// ÏïàÏ†ïÌôî ÏÉÅÏàò
const MAX_LINES=1500;
const MAX_LINKS_PER_POINT=6;
const LINKDIST_CAP=220;

function project(p){
  const s=Math.sin(rot), c=Math.cos(rot);
  const x=p.x*c-p.z*s;
  const z=p.x*s+p.z*c;
  const k=900/(900+z);
  return {x:x*k+W/2,y:p.y*k+H/2};
}

/* ==========================================================
   LOOP
========================================================== */
function loop(){
  ctx.fillStyle="rgba(0,0,0,0.12)";
  ctx.fillRect(0,0,W,H);

  if(audioCtx){
    updateAmp();
    applyFX();
  }

  rot+=0.002+amp*0.01;

  for(const p of pts){
    p.vx+=(Math.random()-0.5)*(amp*6+0.5);
    p.vy+=(Math.random()-0.5)*(amp*6+0.5);
    p.vz+=(Math.random()-0.5)*(amp*4+0.4);

    p.vx+=(-p.x)*0.004;
    p.vy+=(-p.y)*0.004;
    p.vz+=(-p.z)*0.002;

    p.vx*=0.92; p.vy*=0.92; p.vz*=0.94;
    p.x+=p.vx; p.y+=p.vy; p.z+=p.vz;
  }

  const pr=pts.map(project);

  // ===== ÏïàÏ†ïÌôîÎêú ÎùºÏù∏ =====
  let lines=0;
  const links=new Uint8Array(N);
  const linkDist=Math.min(LINKDIST_CAP,80+amp*320);
  const linkDist2=linkDist*linkDist;

  for(let i=0;i<N && lines<MAX_LINES;i++){
    for(let j=i+1;j<N && lines<MAX_LINES;j++){
      if(links[i]>=MAX_LINKS_PER_POINT) break;
      if(links[j]>=MAX_LINKS_PER_POINT) continue;

      const dx=pr[i].x-pr[j].x;
      const dy=pr[i].y-pr[j].y;
      const d2=dx*dx+dy*dy;
      if(d2<linkDist2){
        const a=1-Math.sqrt(d2)/linkDist;
        ctx.globalAlpha=a*0.8;
        ctx.beginPath();
        ctx.moveTo(pr[i].x,pr[i].y);
        ctx.lineTo(pr[j].x,pr[j].y);
        ctx.strokeStyle="#fff";
        ctx.stroke();
        links[i]++; links[j]++;
        lines++;
      }
    }
  }

  ctx.globalAlpha=1;

  // points
  for(const p of pr){
    ctx.beginPath();
    ctx.arc(p.x,p.y,1.4+amp*3,0,Math.PI*2);
    ctx.fillStyle="rgba(255,255,255,0.85)";
    ctx.fill();
  }

  requestAnimationFrame(loop);
}
loop();

/* ==========================================================
   UI
========================================================== */
document.getElementById('btnStartAudio').onclick=async()=>{
  ensureAudio();
  await audioCtx.resume();
  document.getElementById('btnStartMic').disabled=false;
};

document.getElementById('btnStartMic').onclick=async()=>{
  await startMic();
  document.getElementById('hint').style.display='none';
};

document.getElementById('btnMute').onclick=()=>{
  masterGain.gain.value = masterGain.gain.value>0 ? 0 : 0.9;
};

document.getElementById('btnFS').onclick=()=>{
  document.fullscreenElement
    ? document.exitFullscreen()
    : document.documentElement.requestFullscreen();
};
</script>
</body>
</html>
