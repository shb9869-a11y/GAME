<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Grave Run — Room</title>
<meta name="theme-color" content="#000000">
<style>
  :root{
    --bg:#0a0812; --fg:#eae6ff; --accent:#ff7a33;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bot: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:ui-monospace,"SF Mono",Menlo,Consolas,monospace;}
  #stage{
    position:relative;
    width:100vw; height:100svh;
    padding:var(--safe-top) var(--safe-right) var(--safe-bot) var(--safe-left);
    overflow:hidden;
  }
  canvas{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    image-rendering:pixelated; image-rendering:crisp-edges; touch-action:none;
  }
  .hud{
    position:absolute; left:calc(12px + var(--safe-left)); top:calc(8px + var(--safe-top));
    font-size:12px; opacity:.85; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.15);
    padding:6px 8px; border-radius:10px;
  }
  /* 모바일 D-Pad */
  .dpad{
    position:absolute; left:calc(16px + var(--safe-left)); bottom:calc(16px + var(--safe-bot));
    width:196px; height:196px; display:none; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr);
    gap:10px; opacity:.96; filter:drop-shadow(0 2px 8px rgba(0,0,0,.6));
  }
  .dpad .cell{display:grid;place-items:center;}
  .dpad button{
    width:100%; height:100%; border-radius:14px; border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.08); color:#fff; font:700 14px ui-monospace,monospace;
    user-select:none; -webkit-user-select:none;
  }
  .dpad button:active{background:rgba(255,255,255,.2);}
  @media (pointer:coarse){ .dpad{display:grid;} }
</style>
</head>
<body>
<div id="stage" aria-live="polite">
  <div class="hud" id="hud">연결 중…</div>
  <canvas id="view" width="320" height="320" aria-label="게임 화면"></canvas>

  <div class="dpad" id="dpad" aria-hidden="false">
    <div class="cell"></div>
    <div class="cell"><button data-dir="up">▲</button></div>
    <div class="cell"></div>
    <div class="cell"><button data-dir="left">◀</button></div>
    <div class="cell"></div>
    <div class="cell"><button data-dir="right">▶</button></div>
    <div class="cell"></div>
    <div class="cell"><button data-dir="down">▼</button></div>
    <div class="cell"></div>
  </div>
</div>

<script>
/* ===== Query ===== */
const Q=new URLSearchParams(location.search);
const ROOM=Q.get('room')||'room-a';
const NAME=(Q.get('name')||'guest').slice(0,16);
const SERVER=Q.get('server')||'ws://localhost:3000';
const SFX_ON=(Q.get('sfx')||'1')==='1';

/* ===== Audio ===== */
let AC, G, ready=false;
function initAudio(){ if(ready||!SFX_ON) return; AC=new (window.AudioContext||window.webkitAudioContext)(); G=AC.createGain(); G.gain.value=0.22; G.connect(AC.destination); ready=true; }
async function unlockAudio(){ try{ initAudio(); if(AC && AC.state==='suspended') await AC.resume(); }catch(e){} }
['pointerdown','touchstart','keydown'].forEach(ev=>addEventListener(ev,unlockAudio,{passive:true}));
function blip(f=660,d=0.08,v=0.25){ if(!ready||!SFX_ON) return; const t=AC.currentTime,o=AC.createOscillator(),g=AC.createGain(); o.type='square'; o.frequency.setValueAtTime(f,t); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(v,t+0.01); g.gain.linearRampToValueAtTime(0.0001,t+d+0.06); o.connect(g); g.connect(G); o.start(t); o.stop(t+d+0.06); }

/* ===== Canvas fit ===== */
const stage=document.getElementById('stage');
const cv=document.getElementById('view');
const g=cv.getContext('2d',{alpha:false}); g.imageSmoothingEnabled=false;
function fit(){
  const cw=stage.clientWidth, ch=stage.clientHeight;
  const s=Math.max(1, Math.floor(Math.min(cw/cv.width, ch/cv.height)));
  cv.style.width=(cv.width*s)+'px'; cv.style.height=(cv.height*s)+'px';
}
new ResizeObserver(fit).observe(stage); fit();

/* ===== Map (간단한 두 방) ===== */
const TILE=16, W=20, H=20;
cv.width=W*TILE; cv.height=H*TILE; fit();
const LEVEL0 = Array.from({length:H},()=>Array(W).fill(0));
const LEVEL1 = Array.from({length:H},()=>Array(W).fill(0));
for(let x=0;x<W;x++){ LEVEL0[0][x]=1; LEVEL0[H-1][x]=1; LEVEL1[0][x]=1; LEVEL1[H-1][x]=1; }
for(let y=0;y<H;y++){ LEVEL0[y][0]=1; LEVEL0[y][W-1]=1; LEVEL1[y][0]=1; LEVEL1[y][W-1]=1; }
// 출구(하단 가운데 6..13) 통로
for(let x=6;x<=13;x++){ LEVEL0[H-1][x]=0; LEVEL1[H-1][x]=0; }
// 몇 개의 비석/전화 가구(충돌)
for(let y=3;y<17;y+=3){ LEVEL0[y][5]=1; LEVEL0[y][10]=1; LEVEL0[y][15]=1; }
for(let y=4;y<17;y+=4){ LEVEL1[y][4]=1; LEVEL1[y][8]=1; LEVEL1[y][12]=1; LEVEL1[y][16]=1; }

let room=0; // 0: 비석, 1: 전화
function solidAt(r,tx,ty){
  if(tx<0||ty<0||tx>=W||ty>=H) return true;
  const L = r===0?LEVEL0:LEVEL1;
  return L[ty][tx]===1;
}

/* ===== Player & Others ===== */
const me={ id:null, name:NAME, x:10.5, y:4.5, ax:0, ay:0, spd:0.09, tint:'#ff7a33' };
const others=new Map(); // id -> {name,x,y,tint,ts}
function randTint(){ const hues=[18,30,200,140,280]; const h=hues[(Math.random()*hues.length)|0]; return `hsl(${h} 80% 60%)`; }

/* ===== Input (키보드 + DPad) ===== */
const keys=new Set();
addEventListener('keydown',e=>{ const k=e.key.toLowerCase(); if(['arrowup','arrowdown','arrowleft','arrowright','w','a','s','d','e'].includes(k)) e.preventDefault(); keys.add(k);});
addEventListener('keyup',e=> keys.delete(e.key.toLowerCase()));
const dpad=document.getElementById('dpad'); const heldDirs=new Set(); const dstate={ax:0,ay:0};
function updHeld(){ let ax=0,ay=0; if(heldDirs.has('left')) ax-=1; if(heldDirs.has('right')) ax+=1; if(heldDirs.has('up')) ay-=1; if(heldDirs.has('down')) ay+=1; dstate.ax=ax; dstate.ay=ay; }
function bindBtn(btn){ const dir=btn.dataset.dir;
  const down=(e)=>{e.preventDefault(); heldDirs.add(dir); updHeld();};
  const up=(e)=>{e.preventDefault(); heldDirs.delete(dir); updHeld();};
  btn.addEventListener('pointerdown',down); btn.addEventListener('pointerup',up);
  btn.addEventListener('pointercancel',up); btn.addEventListener('pointerleave',up);
  btn.addEventListener('touchstart',down,{passive:false}); btn.addEventListener('touchend',up,{passive:false}); btn.addEventListener('touchcancel',up,{passive:false});
}
dpad.querySelectorAll('button[data-dir]').forEach(bindBtn);

/* ===== Networking (WebSocket) ===== */
const hud=document.getElementById('hud');
let ws, wsOpen=false, myId=null;
function connect(){
  ws=new WebSocket(SERVER);
  ws.addEventListener('open', ()=>{
    wsOpen=true; hud.textContent=`연결됨 · ROOM=${ROOM}`;
    ws.send(JSON.stringify({t:'join', room:ROOM, name:NAME}));
  });
  ws.addEventListener('message', onMsg);
  ws.addEventListener('close', ()=>{ wsOpen=false; hud.textContent='연결 끊김. 3초 후 재시도…'; setTimeout(connect,3000); });
  ws.addEventListener('error', ()=>{ hud.textContent='서버 오류. 3초 후 재시도…'; try{ws.close();}catch(e){} });
}
connect();

function onMsg(ev){
  const msg=JSON.parse(ev.data||'{}');
  if(msg.t==='welcome'){ myId=msg.id; me.id=myId; if(!me.tint) me.tint=randTint(); }
  else if(msg.t==='state' && msg.id!==myId){
    let o=others.get(msg.id);
    if(!o){ o={id:msg.id, name:msg.name||'guest', x:msg.x, y:msg.y, tint:msg.tint||randTint(), ts:performance.now()}; others.set(msg.id,o); blip(520,0.05,0.18); }
    else{ o.name=msg.name||o.name; o.x=msg.x; o.y=msg.y; o.tint=msg.tint||o.tint; o.ts=performance.now(); }
  }else if(msg.t==='leave'){
    if(others.has(msg.id)) others.delete(msg.id);
  }
}

/* ===== Broadcast my state (15Hz) ===== */
let lastSend=0;
function sendState(now){
  if(!wsOpen||!myId) return;
  if(now-lastSend<66) return; // ~15Hz
  lastSend=now;
  ws.send(JSON.stringify({t:'state', room:ROOM, id:myId, name:NAME, x:+me.x.toFixed(3), y:+me.y.toFixed(3), tint:me.tint}));
}

/* ===== Update & Render ===== */
function moveEntity(e, ax, ay){
  const sp=e.spd; let nx=e.x+ax*sp, ny=e.y+ay*sp;
  if(!solidAt(room, nx|0, e.y|0)) e.x=nx;
  if(!solidAt(room, e.x|0, ny|0)) e.y=ny;
}
function update(dt){
  let ax=0, ay=0;
  if(keys.has('a')||keys.has('arrowleft')) ax-=1; if(keys.has('d')||keys.has('arrowright')) ax+=1;
  if(keys.has('w')||keys.has('arrowup')) ay-=1; if(keys.has('s')||keys.has('arrowdown')) ay+=1;
  ax+=dstate.ax; ay+=dstate.ay; const m=Math.hypot(ax,ay)||1; ax/=m; ay/=m;
  moveEntity(me, ax, ay);

  // 방 이동(하단 통로)
  if((me.y|0)===H-1 && (me.x|0)>=6 && (me.x|0)<=13){
    room = room===0?1:0;
    blip(820,0.06,0.26);
    me.y = H-2.2; // 문 들어오면 살짝 위로 배치
  }
}
function drawCell(px,py,fill){ g.fillStyle=fill; g.fillRect(px,py,TILE,TILE); }
function drawMap(){
  g.fillStyle = room===0 ? '#1b142a' : '#131c2a';
  g.fillRect(0,0,cv.width,cv.height);

  const L = room===0?LEVEL0:LEVEL1;
  for(let y=0;y<H;y++) for(let x=0;x<W;x++){
    if(L[y][x]===1){
      drawCell(x*TILE,y*TILE, room===0 ? '#6d58a5' : '#35506d');
      g.fillStyle='rgba(0,0,0,.35)'; g.fillRect(x*TILE,y*TILE+TILE-3,TILE,3);
    }
  }
  // 출구
  g.fillStyle=room===0?'#584787':'#2c4058';
  g.fillRect(6*TILE,(H-1)*TILE, (8)*TILE, TILE);
}
function drawPlayer(p){
  const px=Math.round(p.x*TILE - TILE/2), py=Math.round(p.y*TILE - TILE/2);
  g.fillStyle='rgba(0,0,0,.5)'; g.fillRect(px+2,py+TILE-2,TILE-4,2);
  g.fillStyle=p.tint; g.fillRect(px+4,py+5,8,7);
  // 이름표
  g.fillStyle='rgba(0,0,0,.6)'; g.fillRect(px-8, py-8, Math.max(40, p.name.length*6), 10);
  g.fillStyle='#fff'; g.font='8px ui-monospace'; g.fillText(p.name, px-6, py);
}
function render(){
  drawMap();
  // others 먼저
  others.forEach(o=> drawPlayer(o));
  drawPlayer(me);
}

let started=false,last=0;
function loop(t){ if(!started) return; requestAnimationFrame(loop); const dt=Math.min(32,(t-last)||16); last=t; update(dt/16); render(); sendState(t); }
started=true; requestAnimationFrame(loop);
</script>
</body>
</html>
