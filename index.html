<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport"
        content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,interactive-widget=resizes-content">
  <title>SLEEEEEEEP – THE SECOND SLEEP</title>

  <!-- 픽셀 게임 폰트 -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

  <style>
    :root{
      --bg-main:#000000;
      --accent:#f5f5f5;
      --frame:clamp(16px,4vmin,40px);
      --fs-small:clamp(9px,1.6vmin,13px);
      --fs-title:clamp(32px,7vmin,72px);

      --safe-t:env(safe-area-inset-top,0px);
      --safe-b:env(safe-area-inset-bottom,0px);
      --safe-l:env(safe-area-inset-left,0px);
      --safe-r:env(safe-area-inset-right,0px);
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      -webkit-tap-highlight-color:transparent;
      -webkit-user-select:none;
      user-select:none;
    }

    html,body{
      width:100%;
      height:100%;
      overflow:hidden;
      background:var(--bg-main);
      color:var(--accent);
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      touch-action:manipulation;
    }

    body{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:calc(var(--frame)+var(--safe-t))
              calc(var(--frame)+var(--safe-r))
              calc(var(--frame)+var(--safe-b))
              calc(var(--frame)+var(--safe-l));
    }

    /* 전체 컨테이너 */
    #root{
      position:relative;
      width:100%;
      height:100%;
      max-width:1100px;
      max-height:650px;
      margin:auto;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* === 중앙 게임 화면창 === */
    #gameFrame{
      position:relative;
      width:min(100%,860px);
      aspect-ratio:16/9;
      background:#050505;
      border:2px solid rgba(245,245,245,0.9);
      box-shadow:0 0 0 4px #000,0 0 30px rgba(0,0,0,0.9);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:visible; /* 컨트롤이 바깥으로 나가도 보이게 */
    }

    #gameInnerBorder{
      position:absolute;
      inset:10px;
      border:1px solid rgba(245,245,245,0.45);
      pointer-events:none;
    }

    #gameCanvas{
      position:absolute;
      inset:20px;
      width:calc(100% - 40px);
      height:calc(100% - 40px);
      image-rendering:pixelated;
      image-rendering:crisp-edges;
      background:#000;
    }

    /* === 타이틀 오버레이 (캔버스 위) === */
    #titleOverlay{
      position:absolute;
      inset:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:transparent;
      pointer-events:none;
      opacity:0;
      transition:opacity 900ms ease;
      z-index:5;
    }
    #titleOverlay.show{
      opacity:1;
    }
    #titleWords{
      text-align:center;
    }
    .sleepLine{
      display:block;
      font-size:var(--fs-title);
      letter-spacing:.18em;
      text-shadow:0 0 8px rgba(0,0,0,.85);
      margin:4px 0;
      white-space:nowrap;
    }

    /* === 대화창 (게임창 아래, 캔버스랑 붙어있는 느낌) === */
    #dialogShell{
      position:absolute;
      left:50%;
      bottom:4px;
      transform:translate(-50%,100%);
      width:min(90%,640px);
      padding:10px 12px 8px;
      background:rgba(0,0,0,0.95);
      border:1px solid rgba(245,245,245,0.7);
      box-shadow:0 0 12px rgba(0,0,0,0.9);
      display:flex;
      justify-content:space-between;
      gap:10px;
      opacity:0;
      transition:opacity 200ms ease,transform 350ms ease;
      z-index:10;
    }
    #dialogShell.show{
      opacity:1;
      transform:translate(-50%,-6px);
    }
    #dialogText{
      flex:1;
      font-size:clamp(10px,1.9vmin,14px);
      line-height:1.6;
      white-space:pre-wrap;
      font-family:"Courier New",ui-monospace,monospace;
    }
    #dialogNext{
      align-self:flex-end;
      padding:5px 8px;
      font-size:var(--fs-small);
      background:transparent;
      border:1px solid rgba(245,245,245,0.9);
      color:var(--accent);
      cursor:pointer;
    }

    /* 안내 텍스트 (게임 화면 상단 중앙) */
    #hintText{
      position:absolute;
      left:50%;
      top:8px;
      transform:translateX(-50%);
      font-size:var(--fs-small);
      opacity:0;
      text-align:center;
      white-space:pre-wrap;
      transition:opacity 400ms ease;
      pointer-events:none;
      font-family:"Courier New",ui-monospace,monospace;
    }
    #hintText.show{
      opacity:0.85;
    }

    /* === 컨트롤러: 게임 화면 “밖” 좌하단 / 우하단 === */
    #controls{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:20;
    }

    /* 좌측 조이스틱: 화면 박스 좌하단 밖 */
    #dpad{
      position:absolute;
      left:-10px;          /* 화면 밖으로 살짝 나가게 */
      bottom:-70px;        /* 아래로 빼서 박스 바깥에 매달리게 */
      width:130px;
      height:130px;
      pointer-events:auto;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .dpad-btn{
      position:absolute;
      width:50px;
      height:50px;
      border-radius:50%;
      border:1px solid rgba(245,245,245,0.8);
      background:rgba(0,0,0,0.85);
      color:var(--accent);
      font-size:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 2px 0 #000;
    }
    .dpad-btn span{
      transform:translateY(1px);
    }
    .dpad-btn:active{
      transform:translateY(2px);
      box-shadow:0 0 0 #000;
    }
    #dpad-left{ left:0;top:50%;transform:translateY(-50%); }
    #dpad-right{ right:0;top:50%;transform:translateY(-50%); }

    /* 우측 A 버튼: 화면 박스 우하단 밖 */
    #actionBtnWrap{
      position:absolute;
      right:-10px;         /* 오른쪽으로 살짝 빠져나가게 */
      bottom:-70px;
      pointer-events:auto;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }
    #btnALabel{
      font-size:var(--fs-small);
      opacity:0.8;
      margin-right:4px;
    }
    #btnA{
      width:76px;
      height:76px;
      border-radius:50%;
      border:2px solid rgba(245,245,245,0.95);
      background:#9c1f3c;
      color:#fffbe0;
      font-size:var(--fs-small);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 3px 0 #000;
    }
    #btnA:active{
      transform:translateY(2px);
      box-shadow:0 0 0 #000;
    }

    /* 세로모드 안내 */
    #rotateOverlay{
      position:fixed;
      inset:0;
      background:#000;
      color:var(--accent);
      display:none;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:40px 20px;
      z-index:999;
    }
    #rotateOverlayInner{
      max-width:400px;
      font-size:var(--fs-small);
    }
  </style>
</head>
<body>
<div id="rotateOverlay">
  <div id="rotateOverlayInner">
    <p>LANDSCAPE ONLY</p>
    <p style="margin-top:8px;">기기를 가로로 돌려주세요.</p>
  </div>
</div>

<div id="root">
  <!-- 중앙 게임 화면창 -->
  <div id="gameFrame">
    <div id="gameInnerBorder"></div>
    <canvas id="gameCanvas"></canvas>

    <!-- 타이틀 (게임 화면 위, 뒤에는 꿀렁이만) -->
    <div id="titleOverlay">
      <div id="titleWords">
        <span id="titleLine1" class="sleepLine"></span>
        <span id="titleLine2" class="sleepLine"></span>
        <span id="titleLine3" class="sleepLine"></span>
      </div>
    </div>

    <!-- 대화 -->
    <div id="dialogShell">
      <div id="dialogText"></div>
      <button id="dialogNext" type="button">NEXT</button>
    </div>

    <!-- 안내 텍스트 -->
    <div id="hintText"></div>

    <!-- 게임 화면 기준 컨트롤 (밖으로 빼냄) -->
    <div id="controls">
      <div id="dpad">
        <button class="dpad-btn" id="dpad-left" type="button"><span>◀</span></button>
        <button class="dpad-btn" id="dpad-right" type="button"><span>▶</span></button>
      </div>

      <div id="actionBtnWrap">
        <div id="btnALabel">INTERACT</div>
        <button id="btnA" type="button">A</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  resizeCanvas();
  window.addEventListener('resize', ()=>setTimeout(resizeCanvas,50), {passive:true});

  /* 세로모드 안내 */
  const rotateOverlay = document.getElementById('rotateOverlay');
  function isPortrait(){ return window.innerHeight > window.innerWidth; }
  function updateRotateOverlay(){
    rotateOverlay.style.display = isPortrait() ? 'flex' : 'none';
  }
  ['load','resize','orientationchange'].forEach(ev=>{
    window.addEventListener(ev,updateRotateOverlay,{passive:true});
  });
  updateRotateOverlay();

  /* ===== 게임 좌표 ===== */
  const WORLD_W = 256;
  const WORLD_H = 144;
  const floorY  = 122;

  const player = {
    x: 24,
    y: floorY - 16,
    w: 12,
    h: 16,
    vx: 0,
    speed: 50,
    walking:false,
    sitting:false
  };

  const sofa = {
    x: 180,
    y: floorY - 16,
    w: 56,
    h: 18
  };

  /* ===== 중앙 꿀렁이 ===== */
  function drawCenterBlob(time){
    const cx = WORLD_W/2;
    const cy = WORLD_H/2 - 10;
    const baseR = 32;

    ctx.beginPath();
    const N = 22;
    for(let i=0;i<N;i++){
      const ang = (i/N)*Math.PI*2;
      const wob = 0.35*Math.sin(time*2 + i*0.7);
      const r = baseR * (0.8 + wob);
      const x = cx + Math.cos(ang)*r;
      const y = cy + Math.sin(ang)*r*0.6;
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.fillStyle = '#000000';
    ctx.strokeStyle = 'rgba(245,245,245,0.45)';
    ctx.lineWidth = 1.6;
    ctx.fill();
    ctx.stroke();
  }

  /* ===== 타이틀 백그라운드: 꿀렁이만 ===== */
  function drawTitleBackground(time){
    ctx.clearRect(0,0,WORLD_W,WORLD_H);
    ctx.fillStyle = '#050505';
    ctx.fillRect(0,0,WORLD_W,WORLD_H);
    drawCenterBlob(time);
  }

  /* ===== 토끼 픽셀 ===== */
  function drawRedRabbit(ctx,x,y,scale=1){
    ctx.fillStyle = '#ff3333';
    // 머리
    ctx.fillRect(x+2*scale,y+1*scale,4*scale,3*scale);
    // 귀
    ctx.fillRect(x+1*scale,y-1*scale,1*scale,3*scale);
    ctx.fillRect(x+4*scale,y-1*scale,1*scale,3*scale);
    // 몸통
    ctx.fillRect(x+2*scale,y+4*scale,4*scale,3*scale);
    // 꼬리
    ctx.fillRect(x+6*scale,y+4*scale,2*scale,2*scale);
  }

  function drawWorld(time){
    ctx.clearRect(0,0,WORLD_W,WORLD_H);

    // 배경
    ctx.fillStyle = '#050505';
    ctx.fillRect(0,0,WORLD_W,WORLD_H);

    // 가운데 꿀렁이 (게임 안에서도 계속 존재)
    drawCenterBlob(time);

    // 바닥
    ctx.strokeStyle = '#f5f5f5';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(8,floorY);
    ctx.lineTo(WORLD_W-8,floorY);
    ctx.stroke();

    // 좌측 단
    ctx.fillStyle = '#202020';
    ctx.fillRect(8,floorY-8,34,8);

    // 노란 쇼파
    ctx.fillStyle = '#e8c93b';
    ctx.fillRect(sofa.x,sofa.y,sofa.w,sofa.h-4);
    ctx.fillStyle = '#f5de73';
    ctx.fillRect(sofa.x+4,sofa.y-6,sofa.w-8,10);
    ctx.fillStyle = '#c6a629';
    ctx.fillRect(sofa.x+6,sofa.y+sofa.h-4,8,4);
    ctx.fillRect(sofa.x+sofa.w-14,sofa.y+sofa.h-4,8,4);
    ctx.strokeStyle = '#111';
    ctx.strokeRect(sofa.x,sofa.y,sofa.w,sofa.h-4);
    ctx.strokeRect(sofa.x+4,sofa.y-6,sofa.w-8,10);

    // 토끼
    const unit = 2;
    if(player.sitting){
      const px = sofa.x + sofa.w/2 - 4*unit;
      const py = sofa.y - 2;
      drawRedRabbit(ctx,px,py,unit);
    }else{
      const hop = player.walking ? Math.sin(time*12)*1.2 : 0;
      drawRedRabbit(ctx,player.x,floorY-player.h+hop,unit);
    }
  }

  function render(time){
    const rect = canvas.getBoundingClientRect();
    const sx = rect.width / WORLD_W;
    const sy = rect.height / WORLD_H;
    const s = Math.min(sx,sy);

    ctx.save();
    ctx.setTransform(s,0,0,s,0,0);

    // phase 0 = 타이틀 구간: 꿀렁이만
    if(phase === 0){
      drawTitleBackground(time);
    }else{
      drawWorld(time);
    }

    ctx.restore();
  }

  /* ===== 입력 ===== */
  const keys = { left:false,right:false };
  const dpadLeft  = document.getElementById('dpad-left');
  const dpadRight = document.getElementById('dpad-right');
  const btnA      = document.getElementById('btnA');

  function bindHold(btn,key){
    const start = e=>{ e.preventDefault(); keys[key]=true; };
    const end   = e=>{ e.preventDefault(); keys[key]=false; };

    btn.addEventListener('mousedown',start);
    btn.addEventListener('touchstart',start,{passive:false});
    ['mouseup','mouseleave'].forEach(ev=>btn.addEventListener(ev,end));
    btn.addEventListener('touchend',end);
    btn.addEventListener('touchcancel',end);
  }
  bindHold(dpadLeft,'left');
  bindHold(dpadRight,'right');

  window.addEventListener('keydown',e=>{
    if(e.key==='ArrowLeft')  keys.left=true;
    if(e.key==='ArrowRight') keys.right=true;
    if(e.key===' ') { e.preventDefault(); onPressA(); }
  });
  window.addEventListener('keyup',e=>{
    if(e.key==='ArrowLeft')  keys.left=false;
    if(e.key==='ArrowRight') keys.right=false;
  });

  /* ===== 오디오: 빠르고 귀여운 BGM ===== */
  let audioCtx=null;
  let bgmTimer=null;
  let bgmStarted=false;

  function ensureAudio(){
    if(!audioCtx){
      audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    }
  }
  async function resumeAudio(){
    ensureAudio();
    if(audioCtx.state==='suspended'){
      try{ await audioCtx.resume(); }catch(e){}
    }
  }

  function playClick(){
    try{
      ensureAudio();
      const ctx=audioCtx;
      const now=ctx.currentTime;
      const osc=ctx.createOscillator();
      const g=ctx.createGain();
      osc.type='square';
      osc.frequency.setValueAtTime(650,now);
      osc.frequency.exponentialRampToValueAtTime(1200,now+0.07);
      g.gain.setValueAtTime(0.0001,now);
      g.gain.exponentialRampToValueAtTime(0.3,now+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,now+0.16);
      osc.connect(g).connect(ctx.destination);
      osc.start(now);
      osc.stop(now+0.2);
    }catch(e){}
  }

  function startCuteBgm(){
    if(bgmStarted) return;
    ensureAudio();
    bgmStarted=true;
    const ctx=audioCtx;
    const master=ctx.createGain();
    master.gain.value=0.2;
    master.connect(ctx.destination);

    let step=0;
    const tempo=184;
    const beatMs=60000/tempo;

    function playNote(freq,beats,vol){
      const now=ctx.currentTime;
      const osc=ctx.createOscillator();
      const g=ctx.createGain();
      osc.type='square';
      osc.frequency.value=freq;
      const dur=(beats*beatMs)/1000;
      g.gain.setValueAtTime(0.0001,now);
      g.gain.exponentialRampToValueAtTime(0.32*vol,now+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,now+dur);
      osc.connect(g).connect(master);
      osc.start(now);
      osc.stop(now+dur+0.05);
    }

    function playBeat(){
      const root=330;
      const pattern=[0,4,7,12,7,4,0,7];
      const n=pattern[step%pattern.length];
      const f=root*Math.pow(2,n/12);
      playNote(f,0.5,1.0);

      if(step%2===0){
        const f2=root*Math.pow(2,(12+7)/12);
        playNote(f2,0.25,0.7);
      }

      const now=ctx.currentTime;
      const noise=ctx.createBufferSource();
      const len=ctx.sampleRate*0.09;
      const buf=ctx.createBuffer(1,len,ctx.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<len;i++){
        const t=i/len;
        data[i]=(Math.random()*2-1)*(1-t);
      }
      noise.buffer=buf;
      const g=ctx.createGain();
      g.gain.value=0.1;
      const bp=ctx.createBiquadFilter();
      bp.type='bandpass';
      bp.frequency.value=step%4===0?1200:2000;
      bp.Q.value=0.8;
      noise.connect(bp).connect(g).connect(master);
      noise.start(now);
      noise.stop(now+0.09);

      step++;
    }

    bgmTimer=setInterval(playBeat,beatMs);
  }

  function stopCuteBgm(){
    if(bgmTimer){
      clearInterval(bgmTimer);
      bgmTimer=null;
    }
  }

  /* ===== 대사 ===== */
  const dialogShell=document.getElementById('dialogShell');
  const dialogText=document.getElementById('dialogText');
  const dialogNext=document.getElementById('dialogNext');
  const hintText=document.getElementById('hintText');

  const nickname=(localStorage.getItem('sleepNick') || 'YOU');

  const dialogPhase1=[
    "안녕?",
    `나는 ${nickname}이야.`,
    "꽤 오래 걸어온 것 같지?\n이제 어디 편한 곳에 좀 앉아볼까?",
    "저기 노란 소파 보이지?\n한번 가볼까!"
  ];

  const dialogPhase2=[
    "앉았어?",
    "그래. 좋아.",
    "이제 진짜로, 두 번째 낮잠이 시작될 거야.",
    "THE SECOND SLEEP."
  ];

  let dialogIndex=0;
  // 0: 타이틀, 1: 걷기 전 대화, 1.5: 걷기, 2: 앉은 후 대화, 3: 끝
  let phase=0;
  let gameStarted=false;

  function showDialog(text){
    dialogText.textContent=text;
    dialogShell.classList.add('show');
  }
  function hideDialog(){
    dialogShell.classList.remove('show');
  }
  function showHint(text){
    hintText.textContent=text;
    hintText.classList.add('show');
  }
  function hideHint(){
    hintText.classList.remove('show');
  }

  dialogNext.addEventListener('click',async ()=>{
    await resumeAudio();
    playClick();

    if(phase===1){
      dialogIndex++;
      if(dialogIndex>=dialogPhase1.length){
        hideDialog();
        phase=1.5;
        showHint("빨간 토끼를 오른쪽 노란 소파까지\n조이스틱으로 움직인 다음, 근처에서 [A] 버튼을 눌러봐.");
      }else{
        showDialog(dialogPhase1[dialogIndex]);
      }
    }else if(phase===2){
      dialogIndex++;
      if(dialogIndex>=dialogPhase2.length){
        phase=3;
        hideDialog();
        hideHint();
        showHint("THE SECOND SLEEP은 메인 프로그램에서 계속됩니다.");
        setTimeout(()=>hideHint(),5000);
      }else{
        showDialog(dialogPhase2[dialogIndex]);
      }
    }
  });

  function onPressA(){
    resumeAudio();
    playClick();

    if(phase===1){
      dialogNext.click();
      return;
    }

    if(phase===1.5){
      const centerX=player.x+player.w/2;
      const near=centerX>sofa.x+6 && centerX<sofa.x+sofa.w-6;
      if(near){
        player.sitting=true;
        keys.left=keys.right=false;
        hideHint();
        phase=2;
        dialogIndex=0;
        showDialog(dialogPhase2[0]);
      }
      return;
    }

    if(phase===2){
      dialogNext.click();
    }
  }

  btnA.addEventListener('click',e=>{
    e.preventDefault();
    onPressA();
  });

  /* ===== 타이틀 타이핑 ===== */
  const titleOverlay=document.getElementById('titleOverlay');
  const titleLine1=document.getElementById('titleLine1');
  const titleLine2=document.getElementById('titleLine2');
  const titleLine3=document.getElementById('titleLine3');

  function typeLine(el,text,speed=45){
    return new Promise(async resolve=>{
      el.textContent='';
      for(let i=0;i<text.length;i++){
        el.textContent+=text[i];
        playClick();
        await new Promise(r=>setTimeout(r,speed));
      }
      resolve();
    });
  }

  async function runTitle(){
    await resumeAudio();
    titleOverlay.classList.add('show');

    await typeLine(titleLine1,'SLEEEEEEEEP,',45);
    await new Promise(r=>setTimeout(r,260));
    await typeLine(titleLine2,'SLEEEEEEEEP,',45);
    await new Promise(r=>setTimeout(r,360));
    await typeLine(titleLine3,'THE SECOND SLEEP',45);
    await new Promise(r=>setTimeout(r,900));

    titleOverlay.style.transition='opacity 1100ms ease';
    titleOverlay.style.opacity='0';
    await new Promise(r=>setTimeout(r,1200));
    titleOverlay.style.display='none';

    // 이제부터는 꿀렁이 위에 게임 월드가 등장
    phase=1;

    startCuteBgm();

    setTimeout(()=>{
      dialogIndex=0;
      showDialog(dialogPhase1[0]);
    },800);
  }

  /* ===== 메인 루프 ===== */
  let lastTime=performance.now();
  function update(dt){
    if(phase===1.5 && !player.sitting){
      player.vx=0;
      if(keys.left)  player.vx-=player.speed;
      if(keys.right) player.vx+=player.speed;
      player.walking=Math.abs(player.vx)>0.1;
      player.x+=player.vx*dt;
      player.x=Math.max(8,Math.min(WORLD_W-player.w-8,player.x));
    }else{
      player.walking=false;
    }
  }

  function loop(now){
    const dt=Math.min(0.05,(now-lastTime)/1000);
    lastTime=now;
    if(gameStarted) update(dt);
    render(now*0.001);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  /* ===== 첫 터치 → 타이틀 + 꿀렁이 시작 ===== */
  function firstInteraction(){
    if(gameStarted) return;
    gameStarted=true;
    window.removeEventListener('pointerdown',firstInteraction);
    resumeAudio().then(runTitle);
  }
  window.addEventListener('pointerdown',firstInteraction,{once:true,passive:true});
})();
</script>
</body>
</html>
