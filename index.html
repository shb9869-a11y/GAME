<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>TOEM-style Isometric Maze & Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  *{box-sizing:border-box;margin:0;padding:0;}

  :root{
    --camX: 0px;
    --camY: 0px;
  }

  body{
    background:#000;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    color:#fff;
  }

  /* 가로 모드 전용 안내 */
  .rotate-warning{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:#000;
    color:#fff;
    font-size:18px;
    text-align:center;
    padding:20px;
    z-index:1000;
  }

  .game-root{
    position:relative;
    width: 800px;
    height: 450px;
    background:#111;
    overflow:hidden;
  }

  @media (orientation:portrait){
    .game-root{display:none;}
    .rotate-warning{display:flex;}
  }
  @media (orientation:landscape){
    .game-root{display:block;}
  }

  /* 월드 (카메라가 따라다니는 공간) */
  .world{
    position:absolute;
    left:50%;
    top:55%;
    width:520px;
    height:320px;
    transform:translate(calc(-50% + var(--camX)),
                        calc(-50% + var(--camY)));
    transition:transform .25s ease-out;
    pointer-events:none;
  }

  .tile-layer,
  .entity-layer{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  /* 기본 바닥 타일 */
  .tile{
    position:absolute;
    width:64px;
    height:32px;
    transform-origin:center center;
    transform:translate(-50%,-50%);
  }

  .tile-base{
    position:absolute;
    left:50%;
    top:50%;
    width:100%;
    height:100%;
    transform:skewY(-26deg);
    background:#f4f4f4;
    border:2px solid #000;
  }

  /* 벽(장애물) */
  .tile.wall .wall-block{
    position:absolute;
    left:50%;
    top:30%;
    width:40px;
    height:40px;
    transform:translateX(-50%) skewY(-26deg);
    background:#e0e0e0;
    border:3px solid #000;
    box-shadow:0 12px 0 #000;
  }

  /* 출구 타일 표시 */
  .tile.exit .tile-base{
    background:repeating-linear-gradient(
      45deg, #dcdcdc 0 6px, #ffffff 6px 12px
    );
  }

  /* ROOM 씬에서 벽은 낮은 벽 느낌으로 */
  .scene-room .tile.wall .wall-block{
    height:25px;
    box-shadow:0 8px 0 #000;
  }

  /* 플레이어 캐릭터 */
  .player{
    position:absolute;
    width:32px;
    height:48px;
    transform-origin:center bottom;
    transition:left .18s linear, top .18s linear;
  }
  .player .shadow{
    position:absolute;
    left:50%;
    bottom:0;
    width:32px;
    height:12px;
    transform:translateX(-50%);
    background:radial-gradient(ellipse at center,
             rgba(0,0,0,0.45) 0, transparent 70%);
  }
  .player .body{
    position:absolute;
    left:50%;
    bottom:14px;
    transform:translateX(-50%);
    width:24px;
    height:22px;
    border-radius:4px;
    background:#fff;
    border:3px solid #000;
  }
  .player .head{
    position:absolute;
    left:50%;
    bottom:34px;
    transform:translateX(-50%);
    width:18px;
    height:18px;
    border-radius:50%;
    background:#fff;
    border:3px solid #000;
  }

  /* ROOM 씬의 가구(침대, 탁자 등) */
  .room-prop{
    position:absolute;
    transform-origin:center center;
  }
  .room-prop .block{
    position:absolute;
    left:50%;
    top:50%;
    width:60px;
    height:40px;
    transform:translate(-50%,-50%) skewY(-26deg);
    background:#f5f5f5;
    border:3px solid #000;
    box-shadow:0 10px 0 #000;
  }
  .room-prop.bed .block{
    width:80px;
    height:46px;
  }
  .room-prop.rug .block{
    width:100px;
    height:34px;
    background:#e6e6e6;
    box-shadow:0 0 0 #000;
  }
  .room-prop.rug .block::after{
    content:"";
    position:absolute;
    inset:6px;
    border:2px dashed #777;
  }

  /* 좌측 하단 방향키 */
  .dpad{
    position:absolute;
    left:20px;
    bottom:20px;
    width:120px;
    height:120px;
    display:grid;
    grid-template-columns:repeat(3,1fr);
    grid-template-rows:repeat(3,1fr);
    gap:4px;
    z-index:30;
  }
  .dpad button{
    border:none;
    background:#222;
    color:#fff;
    border-radius:10px;
    border:3px solid #fff;
    box-shadow:0 3px 0 #000;
    font-size:16px;
    cursor:pointer;
    touch-action:manipulation;
  }
  .dpad button:active{
    transform:translateY(2px);
    box-shadow:0 1px 0 #000;
  }
  .dpad .empty{
    background:transparent;
    border:none;
    box-shadow:none;
    pointer-events:none;
  }

  .log{
    position:absolute;
    left:10px;
    top:10px;
    font-size:12px;
    color:#ccc;
    z-index:40;
  }

  /* 씬 전환용 페이드 */
  .fade-overlay{
    position:absolute;
    inset:0;
    background:#000;
    opacity:0;
    pointer-events:none;
    transition:opacity .6s ease;
    z-index:50;
  }
  .fade-overlay.active{
    opacity:1;
    pointer-events:auto;
  }
</style>
</head>
<body>

<div class="rotate-warning">
  이 게임은<br><strong>가로 모드</strong>에서만 플레이할 수 있어요.<br><br>
  기기를 가로로 돌려주세요.
</div>

<div class="game-root" id="gameRoot">
  <div class="world" id="world">
    <div class="tile-layer" id="tileLayer"></div>
    <div class="entity-layer">
      <div class="player" id="player">
        <div class="shadow"></div>
        <div class="body"></div>
        <div class="head"></div>
      </div>
    </div>
    <!-- ROOM 씬에서만 쓰는 소품 -->
    <div class="entity-layer" id="roomProps"></div>
  </div>

  <!-- 좌측 하단 방향키 -->
  <div class="dpad">
    <div class="empty"></div>
    <button data-dir="up">▲</button>
    <div class="empty"></div>

    <button data-dir="left">◀</button>
    <div class="empty"></div>
    <button data-dir="right">▶</button>

    <div class="empty"></div>
    <button data-dir="down">▼</button>
    <div class="empty"></div>
  </div>

  <div class="log" id="log">
    미로에서 출구까지 걸어가 보세요. (←↑→↓ 또는 D-pad)
  </div>

  <div class="fade-overlay" id="fade"></div>
</div>

<script>
  /***********************
   * 맵 데이터
   * 0 = 바닥
   * 1 = 벽
   * 2 = 출구(maze에서만)
   ***********************/
  const mazeMap = [
    [1,1,1,1,1,1,1,1,1],
    [1,0,0,0,1,0,0,0,1],
    [1,0,1,0,1,0,1,0,1],
    [1,0,1,0,0,0,1,0,1],
    [1,0,1,1,1,0,1,0,1],
    [1,0,0,0,0,0,1,0,1],
    [1,1,1,1,1,0,1,0,1],
    [1,0,0,0,0,0,0,2,1], // 오른쪽 아래 쪽에 출구(2)
    [1,1,1,1,1,1,1,1,1]
  ];

  // 방(ROOM) 맵 – 단순한 사각형 방
  const roomMap = [
    [1,1,1,1,1,1,1],
    [1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1],
    [1,1,1,1,1,1,1]
  ];

  let currentMap = mazeMap;
  let currentScene = 'maze'; // 'maze' | 'room'

  const rows = () => currentMap.length;
  const cols = () => currentMap[0].length;

  const tileLayer = document.getElementById('tileLayer');
  const roomPropsLayer = document.getElementById('roomProps');
  const playerEl = document.getElementById('player');
  const worldEl = document.getElementById('world');
  const logEl = document.getElementById('log');
  const fadeEl = document.getElementById('fade');

  // 아이소메트릭 투영 값
  const tileW = 64;
  const tileH = 32;
  const originX = 260; // 월드 내부 기준
  const originY = 60;

  // 플레이어 위치 (맵 좌표)
  let px = 1;
  let py = 1;

  function buildWorld(){
    tileLayer.innerHTML = '';
    roomPropsLayer.innerHTML = '';

    const r = rows();
    const c = cols();

    for(let y=0; y<r; y++){
      for(let x=0; x<c; x++){
        const val = currentMap[y][x];
        const tile = document.createElement('div');
        tile.className = 'tile';

        if(val === 1) tile.classList.add('wall');
        if(currentScene === 'maze' && val === 2) tile.classList.add('exit');

        const base = document.createElement('div');
        base.className = 'tile-base';
        tile.appendChild(base);

        if(val === 1){
          const wall = document.createElement('div');
          wall.className = 'wall-block';
          tile.appendChild(wall);
        }

        const isoX = (x - y) * (tileW/2);
        const isoY = (x + y) * (tileH/2);
        tile.style.left = (originX + isoX) + 'px';
        tile.style.top  = (originY + isoY) + 'px';
        tile.style.zIndex = 10 + x + y;

        tileLayer.appendChild(tile);
      }
    }

    if(currentScene === 'room'){
      worldEl.classList.add('scene-room');
      // 간단한 방 소품 배치: 침대, 탁자, 러그
      addRoomProp('bed', 2, 2);
      addRoomProp('table', 4, 2);
      addRoomProp('rug', 3, 3);
    } else {
      worldEl.classList.remove('scene-room');
    }
  }

  function addRoomProp(type, gx, gy){
    const wrapper = document.createElement('div');
    wrapper.className = 'room-prop ' + type;

    const block = document.createElement('div');
    block.className = 'block';
    wrapper.appendChild(block);

    const isoX = (gx - gy) * (tileW/2);
    const isoY = (gx + gy) * (tileH/2);

    wrapper.style.left = (originX + isoX) + 'px';
    wrapper.style.top  = (originY + isoY) + 'px';
    wrapper.style.zIndex = 40 + gx + gy;

    roomPropsLayer.appendChild(wrapper);
  }

  function updatePlayerPosition(){
    const isoX = (px - py) * (tileW/2);
    const isoY = (px + py) * (tileH/2);
    const screenX = originX + isoX;
    const screenY = originY + isoY;

    playerEl.style.left = screenX + 'px';
    playerEl.style.top  = screenY + 'px';
    playerEl.style.zIndex = 100 + px + py;

    updateCamera(screenX, screenY);
  }

  function updateCamera(screenX, screenY){
    // 플레이어를 대략 월드 중앙 근처에 두도록 카메라 이동
    const desiredX = 260;
    const desiredY = 140;
    const diffX = desiredX - screenX;
    const diffY = desiredY - screenY;
    const camX = diffX * 0.25; // 값을 줄수록 움직임이 미묘해짐
    const camY = diffY * 0.25;

    document.documentElement.style.setProperty('--camX', camX + 'px');
    document.documentElement.style.setProperty('--camY', camY + 'px');
  }

  function canMove(nx, ny){
    if(nx < 0 || nx >= cols() || ny < 0 || ny >= rows()) return false;
    return currentMap[ny][nx] !== 1; // 벽(1)만 막음
  }

  function move(dx, dy){
    const nx = px + dx;
    const ny = py + dy;
    if(canMove(nx, ny)){
      px = nx;
      py = ny;
      updatePlayerPosition();

      const tileVal = currentMap[py][px];
      if(currentScene === 'maze' && tileVal === 2){
        // 출구 도착 → 방으로 전환
        enterRoomScene();
      }
    }else{
      logEl.textContent = (currentScene === 'maze')
        ? '벽이 있어요. 다른 길을 찾아보세요.'
        : '방의 벽에 막혔어요.';
    }
  }

  function enterRoomScene(){
    logEl.textContent = '출구를 찾았습니다. 방으로 이동 중...';
    fadeEl.classList.add('active');

    setTimeout(()=>{
      currentScene = 'room';
      currentMap = roomMap;
      // 방 안 시작 위치 (대략 중앙)
      px = 3;
      py = 3;
      buildWorld();
      updatePlayerPosition();
      logEl.textContent = '방 안으로 들어왔습니다. 자유롭게 걸어보세요.';
      fadeEl.classList.remove('active');
    }, 650);
  }

  /*************
   * 입력 처리
   *************/
  window.addEventListener('keydown', e=>{
    if(e.key === 'ArrowUp') move(0,-1);
    else if(e.key === 'ArrowDown') move(0,1);
    else if(e.key === 'ArrowLeft') move(-1,0);
    else if(e.key === 'ArrowRight') move(1,0);
  });

  document.querySelectorAll('.dpad button[data-dir]').forEach(btn=>{
    const dir = btn.dataset.dir;
    btn.addEventListener('click', ()=>{
      if(dir === 'up') move(0,-1);
      if(dir === 'down') move(0,1);
      if(dir === 'left') move(-1,0);
      if(dir === 'right') move(1,0);
    });
  });

  /*************
   * 초기화
   *************/
  buildWorld();
  updatePlayerPosition();
</script>

</body>
</html>