<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Flat Floor + Door</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
  *{box-sizing:border-box;margin:0;padding:0;}

  :root{
    --camX: 0px;
    --camY: 0px;
  }

  body{
    background:#000;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    color:#fff;
  }

  /* 가로 모드 안내 */
  .rotate-warning{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:#000;
    color:#fff;
    font-size:18px;
    text-align:center;
    padding:20px;
    z-index:1000;
  }

  .game-root{
    position:relative;
    width: 900px;
    height: 520px;
    background:#d0d2d6;
    overflow:hidden;
    border-radius:16px;
    box-shadow:0 0 40px rgba(0,0,0,0.8);
  }

  @media (orientation:portrait){
    .game-root{display:none;}
    .rotate-warning{display:flex;}
  }
  @media (orientation:landscape){
    .game-root{display:block;}
  }

  .world{
    position:absolute;
    left:50%;
    top:50%;
    width:800px;
    height:480px;
    transform:translate(calc(-50% + var(--camX)),
                        calc(-50% + var(--camY)));
    transition:transform .16s ease-out;
    pointer-events:none;
  }

  .scene-layer{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  /* ============ 평면 직사각형 바닥만 남긴 공간 ============ */

  .room{
    position:absolute;
    left:50%;
    top:52%;
    width:800px;
    height:380px;
    transform:translate(-50%,-50%) scale(0.9);
    transform-origin:center center;
  }

  /* 넓은 바닥: 완전 직각 사각형 */
  .floor{
    position:absolute;
    left:50%;
    top:50%;
    width:700px;
    height:320px;
    transform:translate(-50%,-50%);
    background:#ffffff;
    border:4px solid #000;
    box-shadow:0 10px 0 #000;
  }

  /* 검정 사각형 문 (바닥 위 아무 데나) */
  .door-block{
    position:absolute;
    /* 바닥 안에서의 위치를 퍼센트로 잡음 */
    left:70%;
    top:40%;
    width:80px;
    height:140px;
    transform:translate(-50%,-50%);
    background:#000;
    box-shadow:0 4px 0 rgba(0,0,0,0.6);
  }

  /* SLEEEEEP 느낌 캐릭터: 주황 몸통 */
  .player{
    position:absolute;
    width:26px;
    height:46px;
    transform-origin:center bottom;
  }
  .player .head{
    position:absolute;
    left:50%;
    bottom:30px;
    width:18px;
    height:18px;
    transform:translateX(-50%);
    border-radius:4px;            /* 살짝 네모난 머리 */
    border:3px solid #000;
    background:#ffd5a6;           /* 살구색 머리 */
  }
  .player .body{
    position:absolute;
    left:50%;
    bottom:8px;
    width:20px;
    height:22px;
    transform:translateX(-50%);
    border-radius:4px;
    border:3px solid #000;
    background:#ff8a3c;           /* 주황색 몸통 */
  }
  .player .shadow{
    position:absolute;
    left:50%;
    bottom:0;
    width:36px;
    height:10px;
    transform:translateX(-50%);
    background:radial-gradient(ellipse at center,
            rgba(0,0,0,0.45) 0, transparent 70%);
  }

  /* 조이스틱 – 왼쪽 아래 */
  .joystick{
    position:absolute;
    left:40px;
    bottom:40px;
    width:140px;
    height:140px;
    z-index:30;
  }
  .joystick-base{
    position:absolute;
    left:50%;
    top:50%;
    width:110px;
    height:110px;
    transform:translate(-50%,-50%);
    border-radius:50%;
    border:3px solid #fff;
    background:rgba(255,255,255,0.05);
    box-shadow:0 4px 0 #000;
  }
  .joystick-knob{
    position:absolute;
    left:50%;
    top:50%;
    width:50px;
    height:50px;
    transform:translate(-50%,-50%);
    border-radius:50%;
    background:#ffffff;
    border:3px solid #000;
    box-shadow:0 3px 0 #000;
  }

  .log{
    position:absolute;
    left:10px;
    top:10px;
    font-size:12px;
    color:#333;
    background:rgba(255,255,255,0.9);
    padding:4px 8px;
    border-radius:6px;
    border:2px solid #000;
    z-index:40;
  }
</style>
</head>
<body>

<div class="rotate-warning">
  이 게임은 <strong>가로 모드</strong>에서 사용해 주세요.<br><br>
  기기를 가로로 돌려 주세요.
</div>

<div class="game-root">
  <div class="world" id="world">
    <div class="scene-layer" id="sceneLayer"></div>
    <div class="scene-layer">
      <div class="player" id="player">
        <div class="head"></div>
        <div class="body"></div>
        <div class="shadow"></div>
      </div>
    </div>
  </div>

  <div class="joystick" id="joystick">
    <div class="joystick-base"></div>
    <div class="joystick-knob" id="joystickKnob"></div>
  </div>

  <div class="log" id="log">
    넓은 직사각형 바닥과 검정 문 하나가 있는 공간입니다. 조이스틱으로 돌아다녀 보세요.
  </div>
</div>

<script>
  const worldEl   = document.getElementById('world');
  const sceneEl   = document.getElementById('sceneLayer');
  const playerEl  = document.getElementById('player');

  function buildScene(){
    sceneEl.innerHTML = '';
    worldEl.className = 'world';

    const room = document.createElement('div');
    room.className = 'room';
    room.innerHTML = `
      <div class="floor"></div>
      <div class="door-block"></div>
    `;
    sceneEl.appendChild(room);
  }

  // 좌표계: x,y ∈ [-2,2] (넓은 평면)
  let playerX = 0;
  let playerY = 0;
  const limitX = 2.0;
  const limitY = 2.0;
  const speed  = 1.6;

  let joyVector = {x:0,y:0};

  function clampToFloor(){
    playerX = Math.max(-limitX, Math.min(limitX, playerX));
    playerY = Math.max(-limitY, Math.min(limitY, playerY));
  }

  function worldToScreen(x, y){
    const baseX = 400; // 바닥 중앙
    const baseY = 260;
    const sx = baseX + x * 160; // 좌우
    const sy = baseY + y * 80;  // 앞뒤
    return { x:sx, y:sy };
  }

  function updatePlayerVisual(){
    const pos = worldToScreen(playerX, playerY);
    playerEl.style.left = pos.x + 'px';
    playerEl.style.top  = (pos.y - 6) + 'px';

    // 카메라 살짝 따라오기
    const desiredX = 450;
    const desiredY = 260;
    const diffX = desiredX - pos.x;
    const diffY = desiredY - pos.y;
    const camX = diffX * 0.18;
    const camY = diffY * 0.18;
    document.documentElement.style.setProperty('--camX', camX + 'px');
    document.documentElement.style.setProperty('--camY', camY + 'px');
  }

  /* 조이스틱 */
  const joystick     = document.getElementById('joystick');
  const joystickKnob = document.getElementById('joystickKnob');
  let joyActive = false;
  let joyCenter = {x:0,y:0};
  const joyMaxRadius = 45;

  function setJoyVector(cx, cy){
    const dx = cx - joyCenter.x;
    const dy = cy - joyCenter.y;
    if(dx === 0 && dy === 0){
      joyVector.x = 0; joyVector.y = 0;
      joystickKnob.style.left = '50%';
      joystickKnob.style.top  = '50%';
      return;
    }
    const angle = Math.atan2(dy, dx);
    const dist  = Math.min(joyMaxRadius, Math.hypot(dx,dy));
    const nx = Math.cos(angle) * (dist/joyMaxRadius);
    const ny = Math.sin(angle) * (dist/joyMaxRadius);
    joyVector.x = nx;
    joyVector.y = ny;

    joystickKnob.style.left = 50 + (nx * 40) + '%';
    joystickKnob.style.top  = 50 + (ny * 40) + '%';
  }

  function resetJoystick(){
    joyVector.x = 0;
    joyVector.y = 0;
    joystickKnob.style.left = '50%';
    joystickKnob.style.top  = '50%';
  }

  joystick.addEventListener('pointerdown', e=>{
    e.preventDefault();
    joyActive = true;
    const rect = joystick.getBoundingClientRect();
    joyCenter.x = rect.left + rect.width/2;
    joyCenter.y = rect.top  + rect.height/2;
    setJoyVector(e.clientX, e.clientY);
  });

  window.addEventListener('pointermove', e=>{
    if(!joyActive) return;
    e.preventDefault();
    setJoyVector(e.clientX, e.clientY);
  });

  window.addEventListener('pointerup', ()=>{
    if(!joyActive) return;
    joyActive = false;
    resetJoystick();
  });

  window.addEventListener('pointercancel', ()=>{
    if(!joyActive) return;
    joyActive = false;
    resetJoystick();
  });

  // 키보드 테스트 (원하면 지워도 됨)
  window.addEventListener('keydown', e=>{
    if(e.key === 'ArrowUp')    joyVector.y = -1;
    if(e.key === 'ArrowDown')  joyVector.y =  1;
    if(e.key === 'ArrowLeft')  joyVector.x = -1;
    if(e.key === 'ArrowRight') joyVector.x =  1;
  });
  window.addEventListener('keyup', e=>{
    if(['ArrowUp','ArrowDown'].includes(e.key)) joyVector.y = 0;
    if(['ArrowLeft','ArrowRight'].includes(e.key)) joyVector.x = 0;
  });

  /* 메인 루프 */
  let lastTime = performance.now();
  function loop(now){
    const dt = Math.min(0.05, (now - lastTime) / 1000);
    lastTime = now;

    playerX += joyVector.x * speed * dt;
    playerY += joyVector.y * speed * dt;

    clampToFloor();
    updatePlayerVisual();

    requestAnimationFrame(loop);
  }

  buildScene();
  clampToFloor();
  updatePlayerVisual();
  requestAnimationFrame(loop);

  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('sw.js').catch(console.error);
    });
  }
</script>

</body>
</html>