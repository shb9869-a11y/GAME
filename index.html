<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>SLEEEEP · Prologue — Red Roof House (Clean BW)</title>
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#0a0a0c; --fg:#e8e8ee;
    --safe-top:env(safe-area-inset-top,0px);
    --safe-bot:env(safe-area-inset-bottom,0px);
    --safe-left:env(safe-area-inset-left,0px);
    --safe-right:env(safe-area-inset-right,0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:ui-monospace,Menlo,Consolas,monospace;}
  #stage{position:relative;width:100vw;height:100svh;overflow:hidden;
    padding:var(--safe-top) var(--safe-right) var(--safe-bot) var(--safe-left);}
  canvas{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    image-rendering:pixelated;image-rendering:crisp-edges;background:#0f0f14}
  /* Top buttons */
  .topbtn{position:absolute;top:14px;height:36px;padding:0 12px;display:grid;place-items:center;
    border-radius:10px;background:rgba(255,255,255,.05);color:#fff;border:1px solid rgba(255,255,255,.14);
    font:700 12px ui-monospace,monospace;letter-spacing:.02em;z-index:3}
  #btnMap{left:14px}
  #btnInv{right:14px}
  /* Minimal controls */
  .dpad{position:absolute;left:18px;bottom:18px;width:180px;height:180px;z-index:3;display:none;
    grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:8px}
  .dpad .cell{display:grid;place-items:center}
  .chip{width:100%;height:100%;border-radius:12px;background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.16);color:#fff;font:800 14px ui-monospace,monospace}
  .chip:active{background:rgba(255,255,255,.18)}
  @media (pointer:coarse){ .dpad{display:grid} }
  .act{position:absolute;right:18px;bottom:18px;z-index:3;width:120px;height:56px;display:grid;place-items:center;
    border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);
    font:800 13px ui-monospace,monospace}
  .hint{opacity:.7}
  /* Modal clean */
  .modal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:5;
    background:rgba(0,0,0,.5)}
  .sheet{min-width:520px;max-width:86vw;min-height:320px;max-height:72vh;overflow:auto;
    border-radius:16px;background:#121218;border:1px solid rgba(255,255,255,.14);padding:16px}
  .sheet h3{margin:0 0 10px;font:800 13px ui-monospace,monospace;color:#ffd9b0}
  .close{float:right;border:1px solid rgba(255,255,255,.16);background:transparent;color:#fff;
    border-radius:8px;padding:6px 10px;font-weight:800}
  .grid{display:grid;grid-template-columns:repeat(6,48px);gap:8px;margin-top:10px}
  .slot{width:48px;height:48px;border-radius:10px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.04);display:grid;place-items:center}
  /* Rotate overlay */
  #rotate{position:absolute;inset:0;display:none;background:#000c;color:#fff;z-index:10;
    align-items:center;justify-content:center;text-align:center;padding:24px}
  #rotate .box{max-width:520px;border:1px solid rgba(255,255,255,.2);border-radius:14px;
    padding:18px 20px;background:#141418}
  /* Tiny HUD */
  #hud{position:absolute;left:14px;bottom:14px;padding:6px 8px;border-radius:10px;
    background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.14);font-size:11px;z-index:3}
</style>
</head>
<body>
<div id="stage">
  <canvas id="view" width="1280" height="720" aria-label="게임 화면"></canvas>

  <button id="btnMap" class="topbtn">MAP</button>
  <button id="btnInv" class="topbtn">INVENTORY</button>

  <div id="dpad" class="dpad" aria-hidden="false">
    <div class="cell"></div><div class="cell"><button class="chip" data-dir="up">▲</button></div><div class="cell"></div>
    <div class="cell"><button class="chip" data-dir="left">◀</button></div><div class="cell"></div><div class="cell"><button class="chip" data-dir="right">▶</button></div>
    <div class="cell"></div><div class="cell"><button class="chip" data-dir="down">▼</button></div><div class="cell"></div>
  </div>
  <button id="btnAct" class="act">ACT <span class="hint">E/Enter</span></button>

  <div id="hud">← → ↑ ↓ 이동 · ACT로 대화/줍기</div>

  <!-- MAP modal -->
  <div id="mapModal" class="modal"><div class="sheet">
    <button class="close" data-close>닫기</button>
    <h3>MAP — (미리보기 전용)</h3>
    <p style="opacity:.8">지금은 창만 준비해두었어요. 나중에 타일/방 레이아웃을 여기에 그려 붙이면 됩니다.</p>
    <div style="height:220px;background:#0e0e13;border:1px dashed rgba(255,255,255,.18);border-radius:12px"></div>
  </div></div>

  <!-- INVENTORY modal -->
  <div id="invModal" class="modal"><div class="sheet">
    <button class="close" data-close>닫기</button>
    <h3>INVENTORY — (수집품 미리보기)</h3>
    <div class="grid" id="invGrid">
      <!-- 빈 슬롯 -->
      <div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div>
      <div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div>
    </div>
  </div></div>

  <div id="rotate"><div class="box">이 게임은 <b>가로 모드 전용</b>입니다.<br>기기를 가로로 돌려주세요.</div></div>
</div>

<script>
/* ===== Params ===== */
const Q=new URLSearchParams(location.search);
const BW=(Q.get('bw')||'1')==='1'; // 기본 흑백, ?bw=0이면 컬러
/* ===== Orientation guard ===== */
const rotate=document.getElementById('rotate');
function checkOrient(){
  const landscape = (window.innerWidth>=window.innerHeight);
  rotate.style.display = landscape ? 'none' : 'flex';
}
addEventListener('resize',checkOrient,{passive:true}); checkOrient();

/* ===== Canvas fit (16:9) ===== */
const stage=document.getElementById('stage');
const cv=document.getElementById('view');
const g=cv.getContext('2d'); g.imageSmoothingEnabled=false;
function fit(){
  const vw=stage.clientWidth, vh=stage.clientHeight;
  const s=Math.floor(Math.min(vw/cv.width, vh/cv.height)); // 정수 배수 스케일
  cv.style.width=(cv.width*s)+'px'; cv.style.height=(cv.height*s)+'px';
  cv.style.left='50%'; cv.style.top='50%'; cv.style.transform='translate(-50%,-50%)';
}
new ResizeObserver(fit).observe(stage); fit();

/* ===== Palette ===== */
const C = BW ? {
  grass1:'#121212', grass2:'#0f0f0f', path:'#2a2a2a',
  trunk:'#b5b5b5', branch:'#d8d8d8',
  wall:'#e2e2e2', roof:'#bfbfbf', roofAccent:'#bfbfbf', door:'#7a7a7a', win:'#f5f5f5', shade:'rgba(0,0,0,.18)',
  actor:'#ffffff', actorEdge:'#1e1e1e', leaf:'#d0d0d0', stone:'#bdbdbd'
}:{
  grass1:'#24311f', grass2:'#1d281a', path:'#5e5138',
  trunk:'#6e5844', branch:'#a08a75',
  wall:'#e6e6e8', roof:'#b01014', roofAccent:'#9b0d12', door:'#7d6d4f', win:'#f4f7ff', shade:'rgba(0,0,0,.18)',
  actor:'#ffcf8a', actorEdge:'#1d1d1d', leaf:'#8fcf6a', stone:'#c7c2b8'
};

/* ===== World ===== */
const W=cv.width, H=cv.height;
const player={x:W*0.5, y:H*0.78, spd:2.4, trail:[]};
const items=[{x:W*0.52,y:H*0.74,type:'leaf',picked:false},{x:W*0.48,y:H*0.73,type:'stone',picked:false}];

/* ===== Input (clean) ===== */
const keys=new Set();
addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(['arrowup','arrowdown','arrowleft','arrowright','w','a','s','d','e','enter'].includes(k)) e.preventDefault();
  keys.add(k);
  if(k==='e'||k==='enter') act();
});
addEventListener('keyup',e=>keys.delete(e.key.toLowerCase()));
// Touch dpad
const dpad=document.getElementById('dpad');
const held=new Set(); const dstate={ax:0,ay:0};
function updHeld(){ let ax=0,ay=0; if(held.has('left')) ax-=1; if(held.has('right')) ax+=1; if(held.has('up')) ay-=1; if(held.has('down')) ay+=1; dstate.ax=ax; dstate.ay=ay; }
dpad.querySelectorAll('[data-dir]').forEach(b=>{
  const dir=b.dataset.dir;
  const down=e=>{e.preventDefault();held.add(dir);updHeld();};
  const up=e=>{e.preventDefault();held.delete(dir);updHeld();};
  b.addEventListener('pointerdown',down); b.addEventListener('pointerup',up);
  b.addEventListener('pointercancel',up); b.addEventListener('pointerleave',up);
  b.addEventListener('touchstart',down,{passive:false}); b.addEventListener('touchend',up,{passive:false}); b.addEventListener('touchcancel',up,{passive:false});
});
document.getElementById('btnAct').onclick=()=>act();

/* ===== Minimal modals ===== */
const mapModal=document.getElementById('mapModal');
const invModal=document.getElementById('invModal');
document.getElementById('btnMap').onclick=()=>mapModal.style.display='flex';
document.getElementById('btnInv').onclick=()=>invModal.style.display='flex';
mapModal.addEventListener('click',e=>{ if(e.target===mapModal||e.target.dataset.close!=null) mapModal.style.display='none';});
invModal.addEventListener('click',e=>{ if(e.target===invModal||e.target.dataset.close!=null) invModal.style.display='none';});

/* ===== Scene drawing ===== */
function drawGrass(){
  g.fillStyle=C.grass1; g.fillRect(0,0,W,H);
  // subtle dither
  for(let i=0;i<1200;i++){
    g.fillStyle=(i%2)?C.grass2:C.grass1;
    const x=(Math.random()*W)|0, y=(Math.random()*H)|0;
    g.fillRect(x,y,2,2);
  }
  // path to door
  g.fillStyle=C.path;
  g.beginPath();
  g.moveTo(W*0.46,H); g.lineTo(W*0.54,H); g.lineTo(W*0.525,H*0.60); g.lineTo(W*0.475,H*0.60); g.closePath(); g.fill();
}
function drawTree(x,y,scale=1){
  g.fillStyle=C.trunk; g.fillRect(x-2*scale,y-24*scale,4*scale,24*scale);
  g.strokeStyle=C.branch; g.lineWidth=1*scale; g.beginPath();
  for(let i=0;i<6;i++){
    const bx=x + (Math.random()*26-13)*scale;
    const by=y-24*scale - i*9*scale;
    g.moveTo(x, y-24*scale - i*6*scale);
    g.lineTo(bx, by);
  }
  g.stroke();
}
function drawHouse(){
  const cx=W*0.5, baseY=H*0.60, w=560, h=230;
  // body
  g.fillStyle=C.wall; g.fillRect(cx-w/2, baseY-h, w, h);
  // porch
  const pw=180, ph=126;
  g.fillRect(cx-pw/2, baseY-ph, pw, ph);
  // roof main
  g.fillStyle=C.roof;
  g.beginPath(); g.moveTo(cx-w/2, baseY-h); g.lineTo(cx, baseY-h-100); g.lineTo(cx+w/2, baseY-h); g.closePath(); g.fill();
  // roof porch
  g.fillStyle=C.roofAccent;
  g.beginPath(); g.moveTo(cx-pw/2, baseY-ph); g.lineTo(cx, baseY-ph-64); g.lineTo(cx+pw/2, baseY-ph); g.closePath(); g.fill();
  // windows
  g.fillStyle=C.win;
  const cols=6, rows=2, ww=52, wh=30, gapX=36, gapY=34, offY=baseY-h+38;
  let sx=cx - (cols*ww + (cols-1)*gapX)/2;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const x=sx + c*(ww+gapX), y=offY + r*(wh+gapY);
      g.fillRect(x,y,ww,wh);
      g.fillStyle=C.shade; g.fillRect(x,y+wh-4,ww,4); g.fillStyle=C.win;
    }
  }
  // door + porch window
  g.fillStyle=C.door; g.fillRect(cx-36, baseY-72, 72, 72);
  g.fillStyle=C.win; g.fillRect(cx-56, baseY-ph+26, 112, 38);
}
function drawItems(){
  items.forEach(it=>{
    if(it.picked) return;
    g.fillStyle = it.type==='leaf' ? C.leaf : C.stone;
    g.fillRect(it.x-3,it.y-3,6,6);
  });
}
function drawPlayer(){
  // trail
  g.globalAlpha=0.6;
  for(let i=0;i<player.trail.length;i++){
    const t=player.trail[i]; const a=(i+1)/player.trail.length*0.45;
    g.fillStyle= `rgba(255,255,255,${a})`;
    g.fillRect((t.x|0)-1,(t.y|0)-1,2,2);
  }
  g.globalAlpha=1;
  // shadow
  g.fillStyle='rgba(0,0,0,.45)'; g.fillRect(player.x-12,player.y+12,24,5);
  // body/head (사람 형상)
  g.fillStyle=C.actor; g.fillRect(player.x-12,player.y-20,24,16);
  g.fillStyle=BW?'#eaeaea':'#ffe6c7'; g.fillRect(player.x-10,player.y-34,20,12);
  g.fillStyle=C.actorEdge; g.fillRect(player.x-12,player.y-4,24,2);
}

/* ===== ACT ===== */
let flashT=0, flashMsg='';
function flash(m){ flashMsg=m; flashT=60; }
function act(){
  // pick if near
  let did=false;
  for(const it of items){
    if(it.picked) continue;
    if(Math.hypot(player.x-it.x, player.y-it.y)<22){ it.picked=true; did=true; }
  }
  // door test
  const doorX=W*0.5, doorY=H*0.60-10;
  if(Math.hypot(player.x-doorX, player.y-doorY)<30){ flash('문이 굳게 잠겨 있다.'); did=true; }
  if(!did) flash('…');
}

/* ===== Loop ===== */
function update(){
  let ax=0,ay=0;
  if(keys.has('arrowleft')||keys.has('a')) ax-=1;
  if(keys.has('arrowright')||keys.has('d')) ax+=1;
  if(keys.has('arrowup')||keys.has('w')) ay-=1;
  if(keys.has('arrowdown')||keys.has('s')) ay+=1;
  // touch
  ax+=dstate.ax; ay+=dstate.ay;
  const m=Math.hypot(ax,ay)||1; ax/=m; ay/=m;

  const nx=player.x + ax*player.spd;
  const ny=player.y + ay*player.spd;
  // 카메라에 확실히 보이도록 여유있는 범위
  player.x = Math.max(60, Math.min(W-60, nx));
  player.y = Math.max(H*0.55, Math.min(H-40, ny));

  player.trail.push({x:player.x,y:player.y});
  if(player.trail.length>12) player.trail.shift();

  if(flashT>0) flashT--;
}
function render(){
  drawGrass();
  // background trees
  for(let i=0;i<18;i++) drawTree((i*63+90)%W, 150+ (i%4)*20, 1.2);
  for(let i=0;i<14;i++) drawTree( (i*97+30)%W, 190+ (i%5)*22, 1.0);
  drawHouse();
  drawItems();
  drawPlayer();

  if(flashT>0){
    g.fillStyle='rgba(0,0,0,.55)'; const w=220, h=22;
    g.fillRect(player.x-w/2, player.y-64, w, h);
    g.fillStyle='#fff'; g.font='12px ui-monospace';
    g.fillText(flashMsg, player.x-w/2+10, player.y-48);
  }
}
function tick(){ update(); render(); requestAnimationFrame(tick); }
tick();

/* ===== D-pad live state ===== */
(function bindDpad(){
  const cells = dpad.querySelectorAll('[data-dir]');
  function set(dir,on){ if(on) held.add(dir); else held.delete(dir); updHeld(); }
  cells.forEach(btn=>{
    const dir=btn.dataset.dir;
    btn.addEventListener('pointerdown',e=>{e.preventDefault();set(dir,true);},{passive:false});
    btn.addEventListener('pointerup',e=>{e.preventDefault();set(dir,false);},{passive:false});
    btn.addEventListener('pointerleave',e=>{e.preventDefault();set(dir,false);},{passive:false});
  });
})();
</script>
</body>
</html>
