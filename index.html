<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Yard → Stone Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEP-YARD">
<meta name="theme-color" content="#000000">

<style>
  *{
    box-sizing:border-box;
    margin:0;
    padding:0;
  }
  :root{
    --camX: 0px;
    --camY: 0px;
  }

  body{
    background:#000;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    color:#fff;

    -webkit-user-select:none;
    user-select:none;
    -webkit-touch-callout:none;
    -webkit-tap-highlight-color:transparent;
  }

  .rotate-warning{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:#000;
    color:#fff;
    font-size:18px;
    text-align:center;
    padding:20px;
    z-index:1000;
  }

  .game-root{
    position:relative;
    width: 900px;
    height: 520px;
    background:#d0d2d6;
    overflow:hidden;
    border-radius:16px;
    box-shadow:0 0 40px rgba(0,0,0,0.8);

    -webkit-user-select:none;
    user-select:none;
    -webkit-touch-callout:none;
    -webkit-tap-highlight-color:transparent;
  }

  @media (orientation:portrait){
    .game-root{display:none;}
    .rotate-warning{display:flex;}
  }
  @media (orientation:landscape){
    .game-root{display:block;}
  }

  .world{
    position:absolute;
    left:50%;
    top:50%;
    width:800px;
    height:480px;
    transform:translate(calc(-50% + var(--camX)),
                        calc(-50% + var(--camY)));
    transition:transform .16s ease-out;
    pointer-events:none;
  }

  .scene-layer{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  /* =============== 공통: 이소메트릭 섬 =============== */

  .island{
    position:absolute;
    left:50%;
    top:55%;
    width:520px;
    height:320px;
    transform:translate(-50%,-50%) skewX(-25deg);
    background:#f7f7f7;
    border:4px solid #000;
    box-shadow:0 18px 0 #000;
    overflow:visible;
  }
  .scene-stone .island{
    background:#fff5f5;
  }

  .platform{
    position:absolute;
    width:120px;
    height:60px;
    background:#f7f7f7;
    border:4px solid #000;
    box-shadow:0 12px 0 #000;
  }
  .scene-stone .platform{
    background:#fff5f5;
  }
  .platform.p1{ left:-40px; bottom:30px; transform:skewX(25deg); }
  .platform.p2{ right:-60px; bottom:120px; transform:skewX(25deg); }
  .platform.p3{ left:140px; top:-40px; transform:skewX(25deg); }

  .grass-dot{
    position:absolute;
    width:3px;
    height:10px;
    border-radius:50px;
    background:#b5b5b5;
    opacity:0.6;
  }

  /* =============== 타워 =============== */

  .tower{
    position:absolute;
    left:50%;
    bottom:72px;
    width:110px;
    height:230px;
    transform:translateX(-50%) skewX(25deg);
    background:#f2f2f2;
    border:4px solid #000;
    box-shadow:0 16px 0 #000;
  }

  .tower-window{
    position:absolute;
    width:30px;
    height:30px;
    background:#000;
    border:3px solid #000;
  }
  .tower-window.w1{ left:50%; top:40px; transform:translateX(-50%); }
  .tower-window.w2{ left:14px; top:100px; }
  .tower-window.w3{ right:14px; top:140px; }

  .tower-door{
    position:absolute;
    left:50%;
    bottom:0;
    width:44px;
    height:70px;
    transform:translate(-50%,0);
    background:#000;
    border:4px solid #000;
  }

  /* =============== 바위 / 덤불 / 울타리 =============== */

  .rock{
    position:absolute;
    width:46px;
    height:30px;
    background:linear-gradient(to bottom,#f2f2f2 0 40%, #b9b9b9 40% 100%);
    border-radius:18px;
    border:3px solid #000;
    box-shadow:0 5px 0 rgba(0,0,0,0.35);
  }
  .rock::after{
    content:'';
    position:absolute;
    left:5px;
    top:4px;
    width:18px;
    height:10px;
    border-radius:50%;
    border:2px solid rgba(255,255,255,0.6);
    opacity:0.5;
  }

  .bush{
    position:absolute;
    width:70px;
    height:36px;
    background:#e6e6e6;
    border-radius:24px;
    border:3px solid #000;
    box-shadow:0 4px 0 rgba(0,0,0,0.35);
  }
  .bush::after{
    content:'';
    position:absolute;
    left:8px;
    right:8px;
    top:8px;
    height:16px;
    border-radius:18px;
    border:2px solid rgba(0,0,0,0.3);
  }

  .fence{
    position:absolute;
    height:18px;
    background:
      repeating-linear-gradient(
        to right,
        #000 0 4px,
        #000 4px 6px,
        transparent 6px 20px
      );
    border:3px solid #000;
    background-color:#fefefe;
  }

  /* =============== SCENE 2: 붉은 비석 + 선베드 =============== */

  .stone{
    position:absolute;
    left:50%;
    top:45%;
    width:90px;
    height:220px;
    transform:translate(-50%,-50%);
    background:linear-gradient(to bottom,#6a5a4b 0 45%, #4a3b34 45% 60%, #c00000 60% 100%);
    border-radius:46px 46px 32px 32px;
    border:4px solid #000;
    box-shadow:0 12px 0 rgba(0,0,0,0.55);
  }

  .stone::after{
    content:'';
    position:absolute;
    left:18px;
    top:18px;
    width:36px;
    height:16px;
    border-radius:18px;
    border:2px solid rgba(255,255,255,0.6);
    opacity:0.8;
  }

  /* 왼쪽 위 건물 블록 */
  .stone-building{
    position:absolute;
    left:24%;
    top:12%;
    width:220px;
    height:80px;
    background:#fff5f5;
    border:4px solid #000;
    box-shadow:0 10px 0 #000;
    transform:skewX(25deg);
  }

  .lounger{
    position:absolute;
    width:82px;
    height:26px;
    background:linear-gradient(to bottom,#ffffff 0 60%, #e4e4e4 60% 100%);
    border-radius:18px;
    border:3px solid #000;
    box-shadow:0 4px 0 rgba(0,0,0,0.35);
  }
  .lounger::after{
    content:'';
    position:absolute;
    inset:5px 10px;
    border-radius:14px;
    border:2px solid rgba(0,0,0,0.35);
  }

  .umbrella{
    position:absolute;
    width:60px;
    height:60px;
    border-radius:50%;
    background:radial-gradient(circle at 30% 25%, #ffecec 0, #ffdfdf 45%, #f4caca 100%);
    border:3px solid #000;
    box-shadow:0 4px 0 rgba(0,0,0,0.35);
  }
  .umbrella::after{
    content:'';
    position:absolute;
    left:50%;
    top:55%;
    width:4px;
    height:40px;
    transform:translateX(-50%);
    background:#000;
  }

  /* =============== 플레이어 =============== */

  .player{
    position:absolute;
    width:26px;
    height:46px;
    transform-origin:center bottom;
  }
  .player .head{
    position:absolute;
    left:50%;
    bottom:30px;
    width:18px;
    height:18px;
    transform:translateX(-50%);
    border-radius:4px;
    border:3px solid #000;
    background:#ffd5a6;
  }
  .player .body{
    position:absolute;
    left:50%;
    bottom:8px;
    width:20px;
    height:22px;
    transform:translateX(-50%);
    border-radius:4px;
    border:3px solid #000;
    background:#ff8a3c;
  }
  .player .shadow{
    position:absolute;
    left:50%;
    bottom:0;
    width:36px;
    height:10px;
    transform:translateX(-50%);
    background:radial-gradient(ellipse at center,
            rgba(0,0,0,0.45) 0, transparent 70%);
  }

  /* =============== 조이스틱 =============== */

  .joystick{
    position:absolute;
    left:40px;
    bottom:40px;
    width:140px;
    height:140px;
    z-index:30;

    -webkit-user-select:none;
    user-select:none;
    -webkit-touch-callout:none;
    -webkit-tap-highlight-color:transparent;
  }
  .joystick-base{
    position:absolute;
    left:50%;
    top:50%;
    width:110px;
    height:110px;
    transform:translate(-50%,-50%);
    border-radius:50%;
    border:3px solid #fff;
    background:rgba(255,255,255,0.05);
    box-shadow:0 4px 0 #000;
  }
  .joystick-knob{
    position:absolute;
    left:50%;
    top:50%;
    width:50px;
    height:50px;
    transform:translate(-50%,-50%);
    border-radius:50%;
    background:#ffffff;
    border:3px solid #000;
    box-shadow:0 3px 0 #000;
  }

  .log{
    position:absolute;
    left:10px;
    top:10px;
    font-size:12px;
    color:#333;
    background:rgba(255,255,255,0.9);
    padding:4px 8px;
    border-radius:6px;
    border:2px solid #000;
    z-index:40;
  }

  .fade-overlay{
    position:absolute;
    inset:0;
    background:#000;
    opacity:0;
    pointer-events:none;
    transition:opacity .4s ease;
    z-index:50;
  }
  .fade-overlay.active{
    opacity:1;
    pointer-events:auto;
  }
</style>
</head>
<body>

<div class="rotate-warning">
  이 게임은 <strong>가로 모드</strong>에서 사용해 주세요.<br><br>
  기기를 가로로 돌려 주세요.
</div>

<div class="game-root">
  <div class="world" id="world">
    <div class="scene-layer" id="sceneLayer"></div>

    <!-- 플레이어 -->
    <div class="scene-layer">
      <div class="player" id="player">
        <div class="head"></div>
        <div class="body"></div>
        <div class="shadow"></div>
      </div>
    </div>
  </div>

  <div class="joystick" id="joystick">
    <div class="joystick-base"></div>
    <div class="joystick-knob" id="joystickKnob"></div>
  </div>

  <div class="log" id="log">
    마당에서 타워의 검은 문까지 걸어가면 붉은 비석 방으로 이동합니다.
  </div>

  <div class="fade-overlay" id="fade"></div>
</div>

<script>
  const worldEl   = document.getElementById('world');
  const sceneEl   = document.getElementById('sceneLayer');
  const playerEl  = document.getElementById('player');
  const logEl     = document.getElementById('log');
  const fadeEl    = document.getElementById('fade');

  /* ===== 씬 정의 ===== */
  const scenes = {
    yard:{
      key:'yard',
      hasDoor:true,
      doorPos:{x:0, y:-0.6} // 타워 문 위치(대략)
    },
    stone:{
      key:'stone',
      hasDoor:false
    }
  };

  let currentSceneKey = 'yard';
  let currentScene    = scenes[currentSceneKey];

  /* ===== 빌드 ===== */

  function buildScene(){
    sceneEl.innerHTML = '';
    worldEl.className = 'world scene-' + currentSceneKey;

    const island = document.createElement('div');
    island.className = 'island';

    // 플랫폼
    ['p1','p2','p3'].forEach(cls=>{
      const p = document.createElement('div');
      p.className = 'platform ' + cls;
      island.appendChild(p);
    });

    // 잔디 도트
    const grassSpots = [
      {x:20,y:60},{x:30,y:50},{x:40,y:55},{x:60,y:62},
      {x:70,y:50},{x:25,y:40},{x:55,y:42},{x:45,y:70}
    ];
    grassSpots.forEach(g=>{
      const dot = document.createElement('div');
      dot.className = 'grass-dot';
      dot.style.left = g.x + '%';
      dot.style.top  = g.y + '%';
      island.appendChild(dot);
    });

    if(currentSceneKey === 'yard'){
      /* 타워 */
      const tower = document.createElement('div');
      tower.className = 'tower';
      tower.innerHTML = `
        <div class="tower-window w1"></div>
        <div class="tower-window w2"></div>
        <div class="tower-window w3"></div>
        <div class="tower-door"></div>
      `;
      island.appendChild(tower);

      /* 바위 */
      const rocks = [
        {x:14,y:72},{x:30,y:76},{x:70,y:76}
      ];
      rocks.forEach(r=>{
        const el = document.createElement('div');
        el.className = 'rock';
        el.style.left = r.x + '%';
        el.style.top  = r.y + '%';
        el.style.transform = 'translate(-50%,-50%)';
        island.appendChild(el);
      });

      /* 덤불 */
      const bushes = [
        {x:16,y:50},{x:84,y:50}
      ];
      bushes.forEach(b=>{
        const el = document.createElement('div');
        el.className = 'bush';
        el.style.left = b.x + '%';
        el.style.top  = b.y + '%';
        el.style.transform = 'translate(-50%,-50%)';
        island.appendChild(el);
      });

      /* 울타리 */
      const fenceBottom = document.createElement('div');
      fenceBottom.className = 'fence';
      fenceBottom.style.left = '8%';
      fenceBottom.style.bottom = '18px';
      fenceBottom.style.width = '84%';
      island.appendChild(fenceBottom);

      const fenceLeft = document.createElement('div');
      fenceLeft.className = 'fence';
      fenceLeft.style.width = '120px';
      fenceLeft.style.left = '-4%';
      fenceLeft.style.top = '40%';
      fenceLeft.style.transform = 'rotate(90deg)';
      island.appendChild(fenceLeft);

      const fenceRight = document.createElement('div');
      fenceRight.className = 'fence';
      fenceRight.style.width = '120px';
      fenceRight.style.right = '-4%';
      fenceRight.style.top = '38%';
      fenceRight.style.transform = 'rotate(90deg)';
      island.appendChild(fenceRight);

      logEl.textContent = '마당입니다. 타워의 검은 문에 닿으면 붉은 비석 방으로 이동합니다.';
    } else if(currentSceneKey === 'stone'){
      /* 왼쪽 위 건물 블록 */
      const block = document.createElement('div');
      block.className = 'stone-building';
      island.appendChild(block);

      /* 중앙 붉은 비석 */
      const stone = document.createElement('div');
      stone.className = 'stone';
      island.appendChild(stone);

      /* 선베드 + 파라솔 8세트 */
      const spots = [
        {x:25,y:25},{x:50,y:20},{x:75,y:25},
        {x:25,y:75},{x:50,y:80},{x:75,y:75},
        {x:15,y:50},{x:85,y:50}
      ];
      spots.forEach((s)=>{
        const lounger = document.createElement('div');
        lounger.className = 'lounger';
        lounger.style.left = s.x + '%';
        lounger.style.top  = s.y + '%';
        lounger.style.transform = 'translate(-50%,-50%)';

        const umb = document.createElement('div');
        umb.className = 'umbrella';
        umb.style.left = (s.x + (s.x<50? -6:6)) + '%';
        umb.style.top  = (s.y - 18) + '%';
        umb.style.transform = 'translate(-50%,-50%)';

        island.appendChild(lounger);
        island.appendChild(umb);
      });

      logEl.textContent = '붉은 비석과 선베드가 놓인 방입니다. 자유롭게 걸어 다니며 공간을 느껴보세요.';
    }

    sceneEl.appendChild(island);
  }

  /* ===== 플레이어 & 카메라 ===== */

  // x,y ∈ [-2,2] 영역
  let playerX = 0;
  let playerY = 0.6;  // 약간 아래
  const limitX = 2.0;
  const limitY = 2.0;
  const speed  = 1.6;
  let joyVector = {x:0,y:0};

  function clampToIsland(){
    playerX = Math.max(-limitX, Math.min(limitX, playerX));
    playerY = Math.max(-limitY, Math.min(limitY, playerY));
  }

  function worldToScreen(x, y){
    const baseX = 400;
    const baseY = 280;
    const sx = baseX + x * 140;
    const sy = baseY + y * 70;
    return { x:sx, y:sy };
  }

  function updatePlayerVisual(){
    const pos = worldToScreen(playerX, playerY);
    playerEl.style.left = pos.x + 'px';
    playerEl.style.top  = (pos.y - 4) + 'px';

    const desiredX = 450;
    const desiredY = 260;
    const diffX = desiredX - pos.x;
    const diffY = desiredY - pos.y;
    const camX = diffX * 0.12;
    const camY = diffY * 0.12;
    document.documentElement.style.setProperty('--camX', camX + 'px');
    document.documentElement.style.setProperty('--camY', camY + 'px');
  }

  /* ===== 문 충돌 체크 ===== */

  function checkDoor(){
    if(!currentScene.hasDoor) return;
    const dx = playerX - currentScene.doorPos.x;
    const dy = playerY - currentScene.doorPos.y;
    const dist = Math.hypot(dx, dy);
    if(dist < 0.35){
      goToScene('stone');
    }
  }

  function goToScene(key){
    fadeEl.classList.add('active');
    setTimeout(()=>{
      currentSceneKey = key;
      currentScene    = scenes[currentSceneKey];

      if(key === 'stone'){
        playerX = 0;
        playerY = 1.0;
      }else{
        playerX = 0;
        playerY = 0.6;
      }
      clampToIsland();
      buildScene();
      updatePlayerVisual();
      fadeEl.classList.remove('active');
    }, 350);
  }

  /* ===== 조이스틱 ===== */

  const joystick     = document.getElementById('joystick');
  const joystickKnob = document.getElementById('joystickKnob');
  let joyActive = false;
  let joyCenter = {x:0,y:0};
  const joyMaxRadius = 45;

  function setJoyVector(cx, cy){
    const dx = cx - joyCenter.x;
    const dy = cy - joyCenter.y;
    if(dx === 0 && dy === 0){
      joyVector.x = 0; joyVector.y = 0;
      joystickKnob.style.left = '50%';
      joystickKnob.style.top  = '50%';
      return;
    }
    const angle = Math.atan2(dy, dx);
    const dist  = Math.min(joyMaxRadius, Math.hypot(dx,dy));
    const nx = Math.cos(angle) * (dist/joyMaxRadius);
    const ny = Math.sin(angle) * (dist/joyMaxRadius);
    joyVector.x = nx;
    joyVector.y = ny;

    joystickKnob.style.left = 50 + (nx * 40) + '%';
    joystickKnob.style.top  = 50 + (ny * 40) + '%';
  }

  function resetJoystick(){
    joyVector.x = 0;
    joyVector.y = 0;
    joystickKnob.style.left = '50%';
    joystickKnob.style.top  = '50%';
  }

  joystick.addEventListener('pointerdown', e=>{
    e.preventDefault();
    joyActive = true;
    const rect = joystick.getBoundingClientRect();
    joyCenter.x = rect.left + rect.width/2;
    joyCenter.y = rect.top  + rect.height/2;
    setJoyVector(e.clientX, e.clientY);
  });

  window.addEventListener('pointermove', e=>{
    if(!joyActive) return;
    e.preventDefault();
    setJoyVector(e.clientX, e.clientY);
  });

  window.addEventListener('pointerup', ()=>{
    if(!joyActive) return;
    joyActive = false;
    resetJoystick();
  });

  window.addEventListener('pointercancel', ()=>{
    if(!joyActive) return;
    joyActive = false;
    resetJoystick();
  });

  // 키보드 테스트용
  window.addEventListener('keydown', e=>{
    if(e.key === 'ArrowUp')    joyVector.y = -1;
    if(e.key === 'ArrowDown')  joyVector.y =  1;
    if(e.key === 'ArrowLeft')  joyVector.x = -1;
    if(e.key === 'ArrowRight') joyVector.x =  1;
  });
  window.addEventListener('keyup', e=>{
    if(['ArrowUp','ArrowDown'].includes(e.key)) joyVector.y = 0;
    if(['ArrowLeft','ArrowRight'].includes(e.key)) joyVector.x = 0;
  });

  /* ===== 메인 루프 ===== */

  let lastTime = performance.now();
  function loop(now){
    const dt = Math.min(0.05, (now - lastTime) / 1000);
    lastTime = now;

    playerX += joyVector.x * speed * dt;
    playerY += joyVector.y * speed * dt;

    clampToIsland();
    updatePlayerVisual();
    checkDoor();

    requestAnimationFrame(loop);
  }

  buildScene();
  clampToIsland();
  updatePlayerVisual();
  requestAnimationFrame(loop);
</script>

</body>
</html>