<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sound Reactive Field (MIC BASE)</title>
<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden}
canvas{display:block}
#hint{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  color:#aaa; font-family:sans-serif;
  background:rgba(0,0,0,.6);
}
</style>
</head>
<body>

<div id="hint">화면을 한 번 클릭 / 터치</div>
<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
let w,h,dpr;

function resize(){
  dpr = window.devicePixelRatio||1;
  w = canvas.width = innerWidth*dpr;
  h = canvas.height = innerHeight*dpr;
}
window.addEventListener("resize",resize);
resize();

/* ===== MIC ===== */
let audioCtx, analyser, data;
let amp=0, ampSmooth=0, ampDelta=0;

async function initMic(){
  audioCtx = new AudioContext();
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const src = audioCtx.createMediaStreamSource(stream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  data = new Uint8Array(analyser.fftSize);
  src.connect(analyser);
}

function updateAmp(){
  analyser.getByteTimeDomainData(data);
  let sum=0;
  for(let i=0;i<data.length;i++){
    const v=(data[i]-128)/128;
    sum+=v*v;
  }
  const rms=Math.sqrt(sum/data.length);
  ampDelta = Math.abs(rms-ampSmooth);
  ampSmooth += (rms-ampSmooth)*0.15;
  amp = ampSmooth;
}

/* ===== POINT FIELD ===== */
const N=160;
const pts=[];
for(let i=0;i<N;i++){
  pts.push({
    x:Math.random()*w,
    y:Math.random()*h,
    vx:0, vy:0
  });
}

function draw(){
  updateAmp();

  ctx.fillStyle="rgba(0,0,0,0.18)";
  ctx.fillRect(0,0,w,h);

  const speed = 0.2 + amp*10;
  const linkDist = 40 + amp*220;
  const chaos = ampDelta*140;

  for(const p of pts){
    p.vx += (Math.random()-0.5)*chaos;
    p.vy += (Math.random()-0.5)*chaos;
    p.vx *= 0.9;
    p.vy *= 0.9;
    p.x += p.vx*speed;
    p.y += p.vy*speed;

    if(p.x<0)p.x+=w; if(p.x>w)p.x-=w;
    if(p.y<0)p.y+=h; if(p.y>h)p.y-=h;
  }

  ctx.strokeStyle="rgba(255,255,255,0.25)";
  ctx.lineWidth=1*dpr;

  for(let i=0;i<N;i++){
    for(let j=i+1;j<N;j++){
      const a=pts[i], b=pts[j];
      const d=Math.hypot(a.x-b.x,a.y-b.y);
      if(d<linkDist){
        ctx.globalAlpha = 1 - d/linkDist;
        ctx.beginPath();
        ctx.moveTo(a.x,a.y);
        ctx.lineTo(b.x,b.y);
        ctx.stroke();
      }
    }
  }

  ctx.globalAlpha=1;
  ctx.fillStyle="#fff";
  for(const p of pts){
    ctx.beginPath();
    ctx.arc(p.x,p.y,(1.4+amp*3)*dpr,0,Math.PI*2);
    ctx.fill();
  }

  requestAnimationFrame(draw);
}

/* ===== START ===== */
async function start(){
  document.getElementById("hint").remove();
  await initMic();
  draw();
}
["pointerdown","touchstart","mousedown"].forEach(e=>{
  window.addEventListener(e,start,{once:true});
});
</script>
</body>
</html>
