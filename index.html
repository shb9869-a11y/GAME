<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LIMEN WORKSHOP â€“ Monitorable Sound/Touch Reactive Field</title>
<style>
Â  html,body{margin:0;height:100%;background:#000;overflow:hidden;touch-action:none;}
Â  canvas{display:block;width:100vw;height:100vh;}

Â  /* Hint / Entry */
Â  #hint{
Â  Â  position:fixed; inset:0;
Â  Â  display:flex; align-items:center; justify-content:center;
Â  Â  background:rgba(0,0,0,.72);
Â  Â  color:#ddd; font-family:system-ui, -apple-system, sans-serif;
Â  Â  text-align:center; padding:20px;
Â  Â  z-index:50;
Â  }
Â  #hint .box{
Â  Â  width:min(720px, 94vw);
Â  Â  border:1px solid rgba(255,255,255,.12);
Â  Â  border-radius:14px;
Â  Â  padding:18px 16px;
Â  Â  background:rgba(0,0,0,.55);
Â  Â  text-align:left;
Â  }

Â  /* Top-left / Top-right buttons */
Â  #topLeft{
Â  Â  position:fixed; left:12px; top:12px;
Â  Â  display:flex; gap:8px;
Â  Â  z-index:40;
Â  }
Â  #topRight{
Â  Â  position:fixed; right:12px; top:12px;
Â  Â  display:flex; gap:8px;
Â  Â  z-index:40;
Â  }
Â  .iconBtn{
Â  Â  width:42px; height:42px;
Â  Â  display:grid; place-items:center;
Â  Â  background:rgba(0,0,0,.38);
Â  Â  color:#eee;
Â  Â  border:1px solid rgba(255,255,255,.14);
Â  Â  border-radius:12px;
Â  Â  backdrop-filter: blur(10px);
Â  Â  cursor:pointer;
Â  Â  user-select:none;
Â  Â  font-size:18px;
Â  }
Â  .iconBtn:hover{border-color:rgba(255,255,255,.30)}
Â  .iconBtn:active{transform:translateY(1px)}
Â  .iconBtn.danger{
Â  Â  border-color:rgba(255,80,80,.55);
Â  Â  color:#ffb9b9;
Â  }
Â  .iconBtn.danger:hover{border-color:rgba(255,120,120,.75)}

Â  /* Settings panel (HIDDEN in main - popup only) */
Â  #ui{display:none !important;}

Â  button, select, input[type="range"], input[type="number"]{
Â  Â  background:#0f0f0f; color:#eee;
Â  Â  border:1px solid rgba(255,255,255,.16);
Â  Â  border-radius:10px;
Â  Â  padding:8px 10px;
Â  Â  font-weight:650;
Â  Â  outline:none;
Â  }
Â  input[type="range"]{padding:6px 10px;}
Â  button:hover, select:hover{border-color:rgba(255,255,255,.32)}
Â  button:disabled, select:disabled{opacity:.5; cursor:not-allowed}

Â  .meter{
Â  Â  height:10px; border-radius:999px;
Â  Â  background:rgba(255,255,255,.08);
Â  Â  border:1px solid rgba(255,255,255,.10);
Â  Â  overflow:hidden;
Â  }
Â  .meter > i{
Â  Â  display:block; height:100%;
Â  Â  width:0%;
Â  Â  background:rgba(255,255,255,.85);
Â  }

Â  .small{font-size:11px; color:#9aa; line-height:1.45;}
Â  .mono{
Â  Â  font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
Â  Â  font-size:11px;
Â  Â  color:#bbb;
Â  Â  white-space:pre-wrap;
Â  Â  word-break:break-word;
Â  Â  background:rgba(0,0,0,.28);
Â  Â  border:1px solid rgba(255,255,255,.10);
Â  Â  border-radius:10px;
Â  Â  padding:8px;
Â  Â  max-height:190px;
Â  Â  overflow:auto;
Â  }

Â  .fileLine{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
Â  .fileLine input[type="file"]{
Â  Â  padding:6px 10px;
Â  Â  border-radius:10px;
Â  Â  border:1px solid rgba(255,255,255,.16);
Â  Â  background:rgba(0,0,0,.22);
Â  Â  color:#ddd;
Â  }

Â  /* tiny HUD for touch */
Â  #touchHUD{
Â  Â  position:fixed; left:12px; bottom:12px;
Â  Â  z-index:39;
Â  Â  color:#ddd;
Â  Â  font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
Â  Â  font-size:11px;
Â  Â  background:rgba(0,0,0,.28);
Â  Â  border:1px solid rgba(255,255,255,.10);
Â  Â  border-radius:12px;
Â  Â  padding:8px 10px;
Â  Â  backdrop-filter: blur(10px);
Â  Â  pointer-events:none;
Â  }
Â  #touchHUD .bar{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10);margin-top:6px;}
Â  #touchHUD .bar i{display:block;height:100%;width:0%;background:rgba(255,80,80,.90);}

Â  /* Entry header */
Â  .entryTitle{font-weight:900; font-size:16px; margin-bottom:10px;}
Â  .entryGrid{
Â  Â  display:grid;
Â  Â  grid-template-columns: 1fr;
Â  Â  gap:10px;
Â  }
Â  @media (min-width:720px){
Â  Â  .entryGrid{grid-template-columns: 1fr 1fr;}
Â  }
Â  .entryCard{
Â  Â  border:1px solid rgba(255,255,255,.10);
Â  Â  border-radius:12px;
Â  Â  padding:10px;
Â  Â  background:rgba(0,0,0,.20);
Â  }

Â  /* Recording indicator */
Â  #recordingIndicator {
Â  Â  position: fixed; right: 12px; bottom: 12px;
Â  Â  z-index: 41;
Â  Â  display: none; /* Initial state */
Â  Â  padding: 8px 12px;
Â  Â  border-radius: 999px;
Â  Â  background-color: rgba(255, 0, 0, 0.7);
Â  Â  color: white;
Â  Â  font-family: system-ui, -apple-system, sans-serif;
Â  Â  font-size: 14px;
Â  Â  font-weight: bold;
Â  Â  animation: blinker 1s linear infinite;
Â  }
Â  @keyframes blinker {
Â  Â  50% { opacity: 0.4; }
Â  }
</style>
</head>
<body>

<div id="hint">
Â  <div class="box">
Â  Â  <div class="entryTitle">LIMEN WORKSHOP â€“ Entry</div>
Â  Â  <div class="small" style="margin-bottom:12px;">
Â  Â  Â  1) <b>Start Audio</b>ë¡œ ì˜¤ë””ì˜¤ ì ê¸ˆ í•´ì œ<br/>
Â  Â  Â  2) ì—¬ê¸°ì„œ <b>Mic / File</b> ì„ íƒ í›„ <b>Mic ON</b> ë˜ëŠ” <b>File Play</b>ë¡œ ì…ì¥<br/>
Â  Â  Â  3) TouchMeëŠ” ì…ì¥ í›„ âš™ï¸(íŒì—… ì»¨íŠ¸ë¡¤) â†’ MIDI íƒ­ì—ì„œ <b>LEARN</b><br/>
Â  Â  Â  4) ë…¹í™” ê¸°ëŠ¥ì€ âš™ï¸(íŒì—… ì»¨íŠ¸ë¡¤) â†’ System íƒ­ì—ì„œ ì‚¬ìš© ê°€ëŠ¥
Â  Â  </div>

Â  Â  <div class="row" style="justify-content:space-between;">
Â  Â  Â  <div class="row" style="margin:0;">
Â  Â  Â  Â  <button id="btnStartAudio">Start Audio</button>
Â  Â  Â  Â  <button id="btnFS">Fullscreen</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="small" id="startStatus" style="opacity:.9; margin-left:10px;"></div>
Â  Â  </div>

Â  Â  <div class="entryGrid">
Â  Â  Â  Â  Â  Â  <div class="entryCard">
Â  Â  Â  Â  <div class="row" style="margin-top:0;">
Â  Â  Â  Â  Â  <div class="label">Input</div>
Â  Â  Â  Â  Â  <select id="entrySelSrc" class="grow">
Â  Â  Â  Â  Â  Â  <option value="mic" selected>Mic (Live input)</option>
Â  Â  Â  Â  Â  Â  <option value="file">File (MP3/WAV)</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="entryMicBox">
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Mic device</div>
Â  Â  Â  Â  Â  Â  <select id="entrySelMic" class="grow" disabled>
Â  Â  Â  Â  Â  Â  Â  <option>Start Audio í›„ ëª©ë¡ ë¡œë“œ</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <button id="entryMicOn" class="grow" disabled>Mic ON (Enter)</button>
Â  Â  Â  Â  Â  Â  <button id="entryMicOff" class="grow" disabled>Mic OFF</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="small">Mic ONì„ ëˆ„ë¥´ë©´ Entry í™”ë©´ì´ ë‹«íˆê³ (ì…ì¥) ë¹„ì£¼ì–¼ì´ ì‹œì‘ë©ë‹ˆë‹¤.</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="entryFileBox" style="display:none;">
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="label">Audio file</div>
Â  Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  Â  <div class="fileLine">
Â  Â  Â  Â  Â  Â  Â  Â  <input id="entryFileAudio" type="file" accept="audio/*">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="small" id="entryFileTxt">íŒŒì¼ ì„ íƒ í›„ Playë¡œ ì…ì¥</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <button id="entryFilePlay" class="grow" disabled>Play (Enter)</button>
Â  Â  Â  Â  Â  Â  <button id="entryFilePause" class="grow" disabled>Pause</button>
Â  Â  Â  Â  Â  Â  <button id="entryFileStop" class="grow" disabled>Stop</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="entryCard">
Â  Â  Â  Â  <div class="small" style="margin-bottom:8px;">
Â  Â  Â  Â  Â  âœ… ë ‰(í”„ë¦¬ì¦ˆ/ê³¼ë¶€í•˜) ê°ì§€ ì‹œ <b>ìë™ìœ¼ë¡œ ì´ Entry í™”ë©´ìœ¼ë¡œ ë˜ëŒì•„ì˜µë‹ˆë‹¤</b>.<br/>
Â  Â  Â  Â  Â  (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ì´ ì•„ë‹ˆë¼ â€œì…ì¥ ë‹¨ê³„ë¡œ ë³µê·€â€)
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="small" style="margin-bottom:8px;">
Â  Â  Â  Â  Â  âœ… âš™ï¸ ë²„íŠ¼ì€ <b>íŒì—… ì»¨íŠ¸ë¡¤ íƒ€ì›Œ</b>ë¥¼ ë„ì›ë‹ˆë‹¤ (í”„ë¡œì í„° í’€ìŠ¤í¬ë¦° ìœ ì§€ OK)
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="small">
Â  Â  Â  Â  Â  âœ… ì /ì„  ì†ë„ëŠ” <b>ì „ì²´ì ìœ¼ë¡œ ë” ëŠë¦¬ê²Œ</b> ì¡°ì •í•´ë‘ì—ˆìŠµë‹ˆë‹¤.
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<canvas id="c"></canvas>

<div id="touchHUD">
Â  touch: <span id="hudTouch">0.000</span> | amp: <span id="hudAmp">0.000</span><br/>
Â  <span id="hudMidi">midi: -</span>
Â  <div class="bar"><i id="hudTouchBar"></i></div>
</div>

<div id="recordingIndicator">REC</div>

<div id="topLeft">
  <div class="iconBtn danger" id="btnReboot" title="RESET (Back to Entry)">âŸ²</div>
</div>

<div id="topRight">
Â  <div class="iconBtn" id="btnGear" title="Control Tower (Popup)">âš™ï¸</div>
Â  <div class="iconBtn" id="btnMuteQuick" title="Mute">ğŸ”ˆ</div>
Â  <div class="iconBtn" id="btnFSQuick" title="Fullscreen">â›¶</div>
</div>

<div id="ui" aria-hidden="true"></div>

<script>
/* ==========================================================
Â  Â SETTINGS PERSISTENCE (localStorage)
========================================================== */
const STORE_KEY = "limen_workshop_settings_v4_popup_templates";
function loadSettings(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||"{}"); }catch(e){ return {}; } }
function saveSettings(obj){ localStorage.setItem(STORE_KEY, JSON.stringify(obj)); }
const S = loadSettings();

function applySelectValue(id, fallback){
Â  const el = document.getElementById(id);
Â  const v = (S[id] ?? fallback);
Â  if(el) el.value = v;
}
function hookSelectSave(id){
Â  const el = document.getElementById(id);
Â  if(!el) return;
Â  el.addEventListener('change', ()=>{ S[id] = el.value; saveSettings(S); });
}
function hookRangeSave(id, fallback){
Â  const el = document.getElementById(id);
Â  if(!el) return;
Â  el.value = (S[id] ?? fallback);
Â  el.addEventListener('input', ()=>{ S[id] = parseFloat(el.value); saveSettings(S); });
}
function hookNumberSave(id, fallback){
Â  const el = document.getElementById(id);
Â  if(!el) return;
Â  el.value = (S[id] ?? fallback);
Â  el.addEventListener('input', ()=>{ S[id] = parseInt(el.value,10); saveSettings(S); });
}

/* ==========================================================
Â  Â CANVAS / DPR
========================================================== */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', { alpha:false });
let W=0,H=0,DPR=1;

function resize(){
Â  DPR = Math.max(1, Math.min(2, devicePixelRatio||1));
Â  W = innerWidth|0; H = innerHeight|0;
Â  canvas.width Â = (W*DPR)|0;
Â  canvas.height = (H*DPR)|0;
Â  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', resize);
resize();

/* ==========================================================
Â  Â AUDIO CORE + ANALYSER
========================================================== */
let audioCtx;
let analyser, timeData;

let micStream = null;
let inputNode = null;

let masterGain, isMuted=false;

// EQ nodes
let eqLow, eqMid, eqHigh;

// FX nodes
let preGain, driveWS, driveGain, filter, ringOsc, ringGain, ringMult, dL, dR, merger, comp;
let splitter;

let amp=0, ampSmooth=0, ampDelta=0, prevAmp=0;

// file source
let fileAudioEl = null;
let fileNode = null;
let currentSource = S.currentSource ?? "mic"; // "mic" | "file"

function makeWaveshaper(amount=20){
Â  const n=2048;
Â  const curve=new Float32Array(n);
Â  const k=amount;
Â  for(let i=0;i<n;i++){
Â  Â  const x = (i*2/n)-1;
Â  Â  curve[i] = (1+k)*x/(1+k*Math.abs(x));
Â  }
Â  return curve;
}

/* ==========================================================
Â  Â 5 FX TEMPLATES (TouchMe sound "palette")
========================================================== */
const FX_TEMPLATES = [
Â  {
Â  Â  id:"digital", name:"Digital Touch (default)",
Â  Â  driveBase:10, driveRange:95,
Â  Â  preGainBase:0.85, preGainRange:1.25,
Â  Â  driveGainBase:0.95, driveGainRange:1.10,
Â  Â  filterType:"bandpass",
Â  Â  filterBase:180, filterRange:7200,
Â  Â  qBase:1.0, qRange:18.0,
Â  Â  ringBase:10, ringRange:360,
Â  Â  ringDepth:0.95,
Â  Â  widenLBase:0.0015, widenLRange:0.014,
Â  Â  widenRBase:0.0040, widenRRange:0.020,
Â  Â  wobble:0.0012, wobble2:0.0014
Â  },
Â  {
Â  Â  id:"piano_soft", name:"Soft Piano (warm, not sad)",
Â  Â  driveBase:4, driveRange:18,
Â  Â  preGainBase:0.95, preGainRange:0.55,
Â  Â  driveGainBase:0.95, driveGainRange:0.35,
Â  Â  filterType:"lowpass",
Â  Â  filterBase:650, filterRange:4200,
Â  Â  qBase:0.7, qRange:2.2,
Â  Â  ringBase:6, ringRange:55,
Â  Â  ringDepth:0.35,
Â  Â  widenLBase:0.0010, widenLRange:0.010,
Â  Â  widenRBase:0.0025, widenRRange:0.012,
Â  Â  wobble:0.0008, wobble2:0.0010
Â  },
Â  {
Â  Â  id:"piano_bright", name:"Bright Piano (sparkle)",
Â  Â  driveBase:6, driveRange:28,
Â  Â  preGainBase:0.92, preGainRange:0.75,
Â  Â  driveGainBase:0.95, driveGainRange:0.55,
Â  Â  filterType:"highpass",
Â  Â  filterBase:180, filterRange:1800,
Â  Â  qBase:0.9, qRange:2.8,
Â  Â  ringBase:12, ringRange:90,
Â  Â  ringDepth:0.45,
Â  Â  widenLBase:0.0012, widenLRange:0.012,
Â  Â  widenRBase:0.0040, widenRRange:0.014,
Â  Â  wobble:0.0010, wobble2:0.0012
Â  },
Â  {
Â  Â  id:"marimba", name:"Marimba / Pluck",
Â  Â  driveBase:8, driveRange:55,
Â  Â  preGainBase:0.88, preGainRange:0.95,
Â  Â  driveGainBase:0.95, driveGainRange:0.80,
Â  Â  filterType:"bandpass",
Â  Â  filterBase:600, filterRange:5200,
Â  Â  qBase:1.5, qRange:8.0,
Â  Â  ringBase:18, ringRange:180,
Â  Â  ringDepth:0.65,
Â  Â  widenLBase:0.0015, widenLRange:0.016,
Â  Â  widenRBase:0.0040, widenRRange:0.022,
Â  Â  wobble:0.0011, wobble2:0.0013
Â  },
Â  {
Â  Â  id:"pad_air", name:"Air Pad (wide + gentle)",
Â  Â  driveBase:3, driveRange:12,
Â  Â  preGainBase:0.98, preGainRange:0.45,
Â  Â  driveGainBase:0.92, driveGainRange:0.35,
Â  Â  filterType:"lowpass",
Â  Â  filterBase:900, filterRange:6500,
Â  Â  qBase:0.55, qRange:1.2,
Â  Â  ringBase:5, ringRange:35,
Â  Â  ringDepth:0.22,
Â  Â  widenLBase:0.0010, widenLRange:0.020,
Â  Â  widenRBase:0.0022, widenRRange:0.028,
Â  Â  wobble:0.0016, wobble2:0.0019
Â  }
];

function getTemplateId(){
Â  return (S.selFXTemplate ?? "digital");
}
function getTemplate(){
Â  return FX_TEMPLATES.find(t=>t.id===getTemplateId()) || FX_TEMPLATES[0];
}

function ensureAudio(){
Â  if(audioCtx) return;
Â  audioCtx = new (window.AudioContext||window.webkitAudioContext)();

Â  analyser = audioCtx.createAnalyser();
Â  analyser.fftSize = 1024;
Â  timeData = new Uint8Array(analyser.fftSize);

Â  masterGain = audioCtx.createGain();
Â  masterGain.gain.value = 0.9;

Â  preGain = audioCtx.createGain(); preGain.gain.value = 1.0;

Â  // EQ (ê³µìš©)
Â  eqLow = audioCtx.createBiquadFilter();
Â  eqLow.type = "lowshelf";
Â  eqLow.frequency.value = 200;
Â  eqLow.gain.value = 0;

Â  eqMid = audioCtx.createBiquadFilter();
Â  eqMid.type = "peaking";
Â  eqMid.frequency.value = 1000;
Â  eqMid.Q.value = 1.0;
Â  eqMid.gain.value = 0;

Â  eqHigh = audioCtx.createBiquadFilter();
Â  eqHigh.type = "highshelf";
Â  eqHigh.frequency.value = 4000;
Â  eqHigh.gain.value = 0;

Â  driveWS = audioCtx.createWaveShaper();
Â  driveWS.curve = makeWaveshaper(10);
Â  driveWS.oversample = '4x';
Â  driveGain = audioCtx.createGain(); driveGain.gain.value = 1.0;

Â  filter = audioCtx.createBiquadFilter();
Â  filter.type = 'bandpass';
Â  filter.frequency.value = 900;
Â  filter.Q.value = 2.0;

Â  ringOsc = audioCtx.createOscillator();
Â  ringOsc.type = 'sine';
Â  ringOsc.frequency.value = 35;

Â  ringGain = audioCtx.createGain();
Â  ringGain.gain.value = 0.0;

Â  ringMult = audioCtx.createGain();
Â  ringMult.gain.value = 1.0;
Â  ringOsc.connect(ringGain);
Â  ringGain.connect(ringMult.gain);

Â  splitter = audioCtx.createChannelSplitter(2);

Â  dL = audioCtx.createDelay(0.05);
Â  dR = audioCtx.createDelay(0.05);
Â  dL.delayTime.value = 0.004;
Â  dR.delayTime.value = 0.011;

Â  merger = audioCtx.createChannelMerger(2);

Â  comp = audioCtx.createDynamicsCompressor();
Â  comp.threshold.value = -22;
Â  comp.knee.value = 28;
Â  comp.ratio.value = 7;
Â  comp.attack.value = 0.003;
Â  comp.release.value = 0.14;

Â  // chain: input â†’ preGain â†’ EQ â†’ drive â†’ filter â†’ ring â†’ widen â†’ comp â†’ analyser â†’ master
Â  preGain.connect(eqLow);
Â  eqLow.connect(eqMid);
Â  eqMid.connect(eqHigh);

Â  eqHigh.connect(driveWS);
Â  driveWS.connect(driveGain);
Â  driveGain.connect(filter);
Â  filter.connect(ringMult);

Â  ringMult.connect(splitter);
Â  splitter.connect(dL, 0);
Â  splitter.connect(dR, 1);
Â  dL.connect(merger, 0, 0);
Â  dR.connect(merger, 0, 1);

Â  merger.connect(comp);
Â  comp.connect(analyser);
Â  analyser.connect(masterGain);
Â  masterGain.connect(audioCtx.destination);

Â  ringOsc.start();
Â  updateTopPill(1);
}

/* ==========================================================
Â  Â AUDIO PARAMS (kept in localStorage; popup edits these)
========================================================== */
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

function getMediaGain(){ return clamp(parseFloat(S.rngMediaGain ?? 1.00)||1, 0.2, 3.0); }
function getSens(){ return clamp(parseFloat(S.rngSens ?? 7.0)||7, 1, 12); }
function getGamma(){ return clamp(parseFloat(S.rngGamma ?? 0.72)||0.72, 0.45, 1.20); }
function getCap(){ return clamp(parseFloat(S.rngCap ?? 0.42)||0.42, 0.10, 0.70); }

function getEQLow(){ return clamp(parseFloat(S.rngEQLow ?? 0)||0, -20, 20); }
function getEQMid(){ return clamp(parseFloat(S.rngEQMid ?? 0)||0, -20, 20); }
function getEQHigh(){ return clamp(parseFloat(S.rngEQHigh ?? 0)||0, -20, 20); }

function applyEQ(){
Â  if(!audioCtx || !eqLow) return;
Â  eqLow.gain.setTargetAtTime(getEQLow(), audioCtx.currentTime, 0.02);
Â  eqMid.gain.setTargetAtTime(getEQMid(), audioCtx.currentTime, 0.02);
Â  eqHigh.gain.setTargetAtTime(getEQHigh(), audioCtx.currentTime, 0.02);
}

function updateAmp(){
Â  if(!analyser) return;

Â  analyser.getByteTimeDomainData(timeData);
Â  let sum=0;
Â  for(let i=0;i<timeData.length;i++){
Â  Â  const v=(timeData[i]-128)/128;
Â  Â  sum+=v*v;
Â  }
Â  const rms=Math.sqrt(sum/timeData.length);

Â  const rmsG = rms * getMediaGain();
Â  ampSmooth += (rmsG-ampSmooth)*0.12;

Â  const boosted = Math.pow(Math.max(0, ampSmooth * getSens()), getGamma());
Â  const scaled = Math.min(getCap(), boosted);

Â  amp = scaled;
Â  ampDelta = Math.abs(amp - prevAmp);
Â  prevAmp = amp;
}

/* ==========================================================
Â  Â OUTPUT ROUTING (optional)
========================================================== */
const selMic = document.createElement('select'); // (hidden; real UI in popup)
const selSpk = document.createElement('select');
let currentMicDeviceId = S.currentMicDeviceId ?? "default";
let outputSupported = false;

const monitorAudio = new Audio();
monitorAudio.autoplay = true;
monitorAudio.playsInline = true;
let monitorDest = null;

function setupOutputRouting(){
Â  if(!audioCtx) return;
Â  if(monitorDest) return;
Â  monitorDest = audioCtx.createMediaStreamDestination();
Â  masterGain.connect(monitorDest);
Â  monitorAudio.srcObject = monitorDest.stream;
}

async function listDevices(){
Â  let devices = [];
Â  try{ devices = await navigator.mediaDevices.enumerateDevices(); }catch(e){}

Â  const mics = devices.filter(d=>d.kind==="audioinput");
Â  const spks = devices.filter(d=>d.kind==="audiooutput");

Â  // ENTRY mic select
Â  const entrySelMic = document.getElementById('entrySelMic');
Â  entrySelMic.innerHTML = "";
Â  if(mics.length===0){
Â  Â  entrySelMic.disabled = true;
Â  Â  entrySelMic.innerHTML = `<option>ë§ˆì´í¬ ì¥ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</option>`;
Â  }else{
Â  Â  entrySelMic.disabled = false;
Â  Â  for(const d of mics){
Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  opt.value = d.deviceId;
Â  Â  Â  opt.textContent = d.label || `Mic (${d.deviceId.slice(0,6)}â€¦)`;
Â  Â  Â  if(d.deviceId === currentMicDeviceId) opt.selected = true;
Â  Â  Â  entrySelMic.appendChild(opt);
Â  Â  }
Â  }

Â  outputSupported = typeof monitorAudio.setSinkId === "function";
Â  if(outputSupported && S.currentSpkDeviceId){
Â  Â  try{
Â  Â  Â  setupOutputRouting();
Â  Â  Â  await monitorAudio.setSinkId(S.currentSpkDeviceId);
Â  Â  }catch(e){}
Â  }

Â  // push to popup
Â  sendToPopup({type:"devices", mics: mics.map(d=>({id:d.deviceId, label:(d.label||"Mic")})),
Â  Â  Â  Â  Â  Â  Â  spks: spks.map(d=>({id:d.deviceId, label:(d.label||"Speaker")})),
Â  Â  Â  Â  Â  Â  Â  outputSupported});
}

document.getElementById('entrySelMic').addEventListener('change', async (e)=>{
Â  currentMicDeviceId = e.target.value;
Â  S.currentMicDeviceId = currentMicDeviceId;
Â  saveSettings(S);
Â  if(currentSource==="mic" && micStream) await startMic(currentMicDeviceId, false);
});

/* ==========================================================
Â  Â INPUT SOURCE: MIC / FILE
========================================================== */
function disconnectInputs(){
Â  if(inputNode){ try{ inputNode.disconnect(); }catch(e){} inputNode = null; }
Â  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream = null; }
Â  if(fileNode){ try{ fileNode.disconnect(); }catch(e){} fileNode = null; }
}

async function startMic(deviceId="default", hideEntry=true){
Â  ensureAudio();
Â  await audioCtx.resume();
Â  setupOutputRouting();

Â  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream = null; }
Â  if(inputNode){ try{ inputNode.disconnect(); }catch(e){} inputNode = null; }
Â  if(fileNode){ try{ fileNode.disconnect(); }catch(e){} fileNode = null; }

Â  try{
Â  Â  micStream = await navigator.mediaDevices.getUserMedia({
Â  Â  Â  audio: {
Â  Â  Â  Â  deviceId: deviceId ? { exact: deviceId } : undefined,
Â  Â  Â  Â  echoCancellation:false,
Â  Â  Â  Â  noiseSuppression:false,
Â  Â  Â  Â  autoGainControl:false
Â  Â  Â  }
Â  Â  });

Â  Â  const src = audioCtx.createMediaStreamSource(micStream);
Â  Â  inputNode = src;
Â  Â  src.connect(preGain);

Â  Â  await listDevices();
Â  Â  updateTopPill(1);
Â  Â  startStatus("Mic ON. (Entryì—ì„œ ë°”ë¡œ ì…ì¥ ê°€ëŠ¥)");

Â  Â  if(hideEntry) hideEntryAndEnter();
Â  }catch(e){
Â  Â  console.error(e);
Â  Â  startStatus("Mic ON ì‹¤íŒ¨. ê¶Œí•œ/ì¥ì¹˜ ì„ íƒ í™•ì¸.");
Â  Â  alert("ë§ˆì´í¬ ê¶Œí•œ ë˜ëŠ” ì¥ì¹˜ ì„ íƒì— ì‹¤íŒ¨í–ˆì–´ìš”. í¬ë¡¬ ê¶Œí•œ í™•ì¸!");
Â  }
}

function stopMic(){
Â  if(micStream){
Â  Â  micStream.getTracks().forEach(t=>t.stop());
Â  Â  micStream = null;
Â  }
Â  if(inputNode){
Â  Â  try{ inputNode.disconnect(); }catch(e){}
Â  Â  inputNode = null;
Â  }
Â  updateTopPill(1);
}

function ensureFileAudioEl(){
Â  if(fileAudioEl) return;
Â  fileAudioEl = new Audio();
Â  fileAudioEl.crossOrigin = "anonymous";
Â  fileAudioEl.loop = true;
Â  fileAudioEl.preload = "auto";
Â  fileAudioEl.playsInline = true;
}

function connectFileToChain(){
Â  ensureAudio();
Â  ensureFileAudioEl();
Â  if(!fileAudioEl.src) return;

Â  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream = null; }
Â  if(inputNode){ try{ inputNode.disconnect(); }catch(e){} inputNode = null; }
Â  if(fileNode){ try{ fileNode.disconnect(); }catch(e){} fileNode = null; }

Â  try{
Â  Â  fileNode = audioCtx.createMediaElementSource(fileAudioEl);
Â  Â  fileNode.connect(preGain);
Â  }catch(e){
Â  Â  try{
Â  Â  Â  const oldSrc = fileAudioEl.src;
Â  Â  Â  fileAudioEl.pause();
Â  Â  Â  fileAudioEl.srcObject = null;
Â  Â  Â  fileAudioEl = null;
Â  Â  Â  ensureFileAudioEl();
Â  Â  Â  fileAudioEl.src = oldSrc;
Â  Â  Â  fileNode = audioCtx.createMediaElementSource(fileAudioEl);
Â  Â  Â  fileNode.connect(preGain);
Â  Â  }catch(err){
Â  Â  Â  console.error(err);
Â  Â  Â  alert("íŒŒì¼ ì†ŒìŠ¤ë¥¼ ì˜¤ë””ì˜¤ ì²´ì¸ì— ì—°ê²°í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆì–´ìš”.");
Â  Â  }
Â  }
Â  updateTopPill(1);
}

function startStatus(msg){
Â  const el = document.getElementById('startStatus');
Â  if(el) el.textContent = msg;
}

/* ==========================================================
Â  Â ENTRY / SOURCE UI
========================================================== */
const entrySelSrc = document.getElementById('entrySelSrc');
const entryMicBox = document.getElementById('entryMicBox');
const entryFileBox = document.getElementById('entryFileBox');

function applySourceUI(){
Â  currentSource = (S.currentSource ?? currentSource);
Â  entrySelSrc.value = currentSource;

Â  entryMicBox.style.display Â = (currentSource==="mic") ? "" : "none";
Â  entryFileBox.style.display = (currentSource==="file") ? "" : "none";

Â  updateTopPill(1);
Â  sendToPopup({type:"source", currentSource});
}
entrySelSrc.addEventListener('change', async ()=>{
Â  currentSource = entrySelSrc.value;
Â  S.currentSource = currentSource;
Â  saveSettings(S);
Â  applySourceUI();
Â  if(currentSource==="file"){
Â  Â  stopMic();
Â  }else{
Â  Â  if(fileAudioEl){ try{ fileAudioEl.pause(); }catch(e){} }
Â  }
});
applySourceUI();

/* ==========================================================
Â  Â FILE CONTROLS (ENTRY)
========================================================== */
const entryFileAudio = document.getElementById('entryFileAudio');
const entryFilePlay = document.getElementById('entryFilePlay');
const entryFilePause = document.getElementById('entryFilePause');
const entryFileStop = document.getElementById('entryFileStop');
const entryFileTxt = document.getElementById('entryFileTxt');

function setEntryFileBtns(enabled){
Â  entryFilePlay.disabled = !enabled;
Â  entryFilePause.disabled = !enabled;
Â  entryFileStop.disabled = !enabled;
}
setEntryFileBtns(false);

async function loadFileFromInput(file){
Â  if(!file) return;

Â  ensureAudio();
Â  await audioCtx.resume();
Â  setupOutputRouting();
Â  ensureFileAudioEl();

Â  const url = URL.createObjectURL(file);
Â  try{ fileAudioEl.pause(); }catch(e){}
Â  fileAudioEl.src = url;
Â  fileAudioEl.loop = true;

Â  entryFileTxt.textContent = `loaded: ${file.name} (${Math.round(file.size/1024)} KB)`;

Â  currentSource = "file";
Â  S.currentSource = "file";
Â  saveSettings(S);
Â  applySourceUI();

Â  connectFileToChain();
Â  setEntryFileBtns(true);
Â  updateTopPill(1);
Â  sendToPopup({type:"fileLoaded", name:file.name, size:file.size});
}

entryFileAudio.addEventListener('change', async ()=>{
Â  const f = entryFileAudio.files && entryFileAudio.files[0];
Â  if(!f) return;
Â  await loadFileFromInput(f);
});

function hideEntryAndEnter(){
Â  document.getElementById('hint').style.display='none';
}
function showEntry(msg=""){
Â  document.getElementById('hint').style.display='flex';
Â  if(msg) startStatus(msg);
}

document.getElementById('entryMicOn').addEventListener('click', async ()=>{
Â  if(currentSource!=="mic") return;
Â  await startMic(currentMicDeviceId, true);
});
document.getElementById('entryMicOff').addEventListener('click', ()=> stopMic());

entryFilePlay.addEventListener('click', async ()=>{
Â  if(!fileAudioEl || !fileAudioEl.src) return;
Â  ensureAudio(); await audioCtx.resume();
Â  connectFileToChain();
Â  try{ await fileAudioEl.play(); }catch(e){
Â  Â  alert("ì¬ìƒì´ ë§‰í˜”ì–´ìš”. í™”ë©´ì„ í•œë²ˆ í„°ì¹˜/í´ë¦­í•œ ë’¤ ë‹¤ì‹œ Play ëˆŒëŸ¬ì£¼ì„¸ìš”.");
Â  Â  return;
Â  }
Â  updateTopPill(1);
Â  hideEntryAndEnter();
});
entryFilePause.addEventListener('click', ()=>{
Â  if(!fileAudioEl) return;
Â  try{ fileAudioEl.pause(); }catch(e){}
Â  updateTopPill(1);
});
entryFileStop.addEventListener('click', ()=>{
Â  if(!fileAudioEl) return;
Â  try{ fileAudioEl.pause(); fileAudioEl.currentTime = 0; }catch(e){}
Â  updateTopPill(1);
});

/* ==========================================================
Â  Â ENTRY: Start Audio (unlock) + device list + MIDI init
========================================================== */
document.getElementById('btnStartAudio').addEventListener('click', async ()=>{
Â  ensureAudio();
Â  await audioCtx.resume();
Â  await listDevices();
Â  await initMIDI();
Â  startStatus("Audio unlocked. ì´ì œ Mic/File ì„ íƒ í›„ Enter ë²„íŠ¼ìœ¼ë¡œ ì…ì¥!");
Â  // enable entry mic buttons (if mic mode)
Â  document.getElementById('entryMicOn').disabled = !(currentSource==="mic");
Â  document.getElementById('entryMicOff').disabled = true;
});

addEventListener('pointerdown', async ()=>{
Â  if(audioCtx && audioCtx.state==='suspended'){
Â  Â  await audioCtx.resume();
Â  }
},{passive:true});

/* ==========================================================
Â  Â MIDI (TouchMe) (same logic; values controlled by popup too)
========================================================== */
let midiAccess = null;
let midiInput = null;

let touchRaw = 0;
let touch = 0;
let touchSmooth = 0;
let lastMidiAt = 0;

let midiName="MIDI: ?";
let midiLog = [];
let midiLearn = false;

function pushMidiLog(line){
Â  midiLog.push(line);
Â  if(midiLog.length>18) midiLog.shift();
Â  sendToPopup({type:"midiLog", midiName, lines:midiLog.slice()});
}

function getMIDIDead(){ return clamp(parseFloat(S.rngMIDIDead ?? 0.02)||0.02, 0, 0.25); }
function getMIDIGain(){ return clamp(parseFloat(S.rngMIDIGain ?? 1.60)||1.60, 0.3, 3.0); }
function getMIDICurve(){ return clamp(parseFloat(S.rngMIDICurve ?? 0.85)||0.85, 0.4, 2.8); }
function getMIDISmooth(){ return clamp(parseFloat(S.rngMIDISmooth ?? 0.22)||0.22, 0.02, 0.50); }

function shapeMIDI(x){
Â  const inv = ((S.selMIDIInvert ?? "0") === "1");
Â  if(inv) x = 1-x;

Â  const dead = getMIDIDead();
Â  if(x < dead) x = 0;
Â  else x = (x-dead) / (1-dead);

Â  x *= getMIDIGain();
Â  x = clamp(x, 0, 1);

Â  const curve = getMIDICurve();
Â  x = Math.pow(x, curve);
Â  return clamp(x, 0, 1);
}

function updateTouch(){
Â  const k = getMIDISmooth();
Â  touchSmooth += (touch - touchSmooth) * k;

Â  const now = performance.now();
Â  const idleMs = now - lastMidiAt;
Â  if(idleMs > 250 && !midiLearn){
Â  Â  touch *= 0.985;
Â  }
}

function midiParseRaw(data){
Â  const st = data[0] & 0xF0;
Â  const ch = data[0] & 0x0F;
Â  const d1 = data[1] ?? 0;
Â  const d2 = data[2] ?? 0;

Â  let type = "other";
Â  if(st===0xB0) type="cc";
Â  else if(st===0x90) type="noteon";
Â  else if(st===0x80) type="noteoff";
Â  return {st, ch, d1, d2, type};
}

function midiMsgToValue(data){
Â  const st = data[0] & 0xF0;
Â  const ch = data[0] & 0x0F;
Â  const d1 = data[1] ?? 0;
Â  const d2 = data[2] ?? 0;

Â  const wantCh = parseInt(S.selMIDICh ?? "-1",10);
Â  if(wantCh !== -1 && ch !== wantCh) return null;

Â  const mode = (S.selMIDIType ?? "cc");
Â  const num = clamp(parseInt(S.numMIDINum ?? 1,10)||1, 0, 127);

Â  if(mode==="cc"){
Â  Â  if(st !== 0xB0) return null;
Â  Â  if(d1 !== num) return null;
Â  Â  return { raw01: d2/127, ch, type:"cc", num:d1, val:d2 };
Â  }else{
Â  Â  if(st !== 0x90 && st !== 0x80) return null;
Â  Â  if(d1 !== num) return null;
Â  Â  const vel = (st===0x80) ? 0 : d2;
Â  Â  return { raw01: vel/127, ch, type:"note", num:d1, val:vel };
Â  }
}

async function initMIDI(){
Â  if(!navigator.requestMIDIAccess){
Â  Â  midiName="MIDI: not supported";
Â  Â  pushMidiLog("requestMIDIAccess ì—†ìŒ");
Â  Â  sendToPopup({type:"midiSupport", ok:false, msg:"âš ï¸ WebMIDI ë¯¸ì§€ì› (Sim Touchë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)"});
Â  Â  return;
Â  }
Â  try{
Â  Â  midiAccess = await navigator.requestMIDIAccess({sysex:false});
Â  Â  midiAccess.onstatechange = ()=> rebuildMIDIInputs();
Â  Â  rebuildMIDIInputs(true);
Â  Â  sendToPopup({type:"midiSupport", ok:true, msg:"âœ… WebMIDI OK. TouchMe ì—°ê²° í›„ LEARN ëˆ„ë¥´ê³  í•œ ë²ˆ í„°ì¹˜í•˜ì„¸ìš”."});
Â  Â  pushMidiLog("MIDI ready.");
Â  }catch(e){
Â  Â  console.error(e);
Â  Â  midiName="MIDI: blocked";
Â  Â  sendToPopup({type:"midiSupport", ok:false, msg:"âš ï¸ MIDI ì ‘ê·¼ ì°¨ë‹¨. Chrome/HTTPS/ê¶Œí•œ í™•ì¸."});
Â  Â  pushMidiLog("MIDI access failed");
Â  }
}

function rebuildMIDIInputs(autoselect=false){
Â  if(!midiAccess){
Â  Â  sendToPopup({type:"midiInputs", inputs:[]});
Â  Â  return;
Â  }
Â  const inputs = [...midiAccess.inputs.values()];
Â  sendToPopup({type:"midiInputs", inputs: inputs.map(i=>({id:i.id, name:i.name||"MIDI"}))});

Â  if(inputs.length===0){
Â  Â  midiName="MIDI: no inputs";
Â  Â  pushMidiLog("No MIDI devices. TouchMe USB/BT í™•ì¸.");
Â  Â  return;
Â  }

Â  const savedId = S.midiInputId ?? "";
Â  const hasSaved = inputs.some(i=>i.id===savedId);

Â  if(hasSaved){
Â  Â  attachMIDIInput(savedId);
Â  }else if(autoselect){
Â  Â  attachMIDIInput(inputs[0].id);
Â  }
}

function setLearn(on){
Â  midiLearn = on;
Â  if(on) pushMidiLog("LEARN: TouchMeë¥¼ í•œ ë²ˆ í„°ì¹˜í•˜ì„¸ìš” (CC/NOTE ìë™ ë§¤í•‘).");
Â  sendToPopup({type:"learn", on});
}

function attachMIDIInput(id){
Â  if(!midiAccess) return;
Â  const inp = [...midiAccess.inputs.values()].find(i=>i.id===id);
Â  if(!inp) return;

Â  if(midiInput) midiInput.onmidimessage = null;
Â  midiInput = inp;
Â  S.midiInputId = id;
Â  saveSettings(S);

Â  midiName = "MIDI: " + (midiInput.name || "input");
Â  pushMidiLog("Connected: " + midiName);

Â  midiInput.onmidimessage = (e)=>{
Â  Â  const data = e.data;
Â  Â  const r = midiParseRaw(data);
Â  Â  lastMidiAt = performance.now();

Â  Â  if(midiLearn){
Â  Â  Â  if(r.st===0xB0){
Â  Â  Â  Â  S.selMIDIType = "cc";
Â  Â  Â  Â  S.numMIDINum = r.d1;
Â  Â  Â  Â  S.selMIDICh = String(r.ch);
Â  Â  Â  Â  saveSettings(S);
Â  Â  Â  Â  pushMidiLog(`LEARN OK: CC #${r.d1} ch:${r.ch+1}`);
Â  Â  Â  Â  setLearn(false);
Â  Â  Â  Â  sendToPopup({type:"settingsSync", S});
Â  Â  Â  }else if(r.st===0x90 || r.st===0x80){
Â  Â  Â  Â  S.selMIDIType = "note";
Â  Â  Â  Â  S.numMIDINum = r.d1;
Â  Â  Â  Â  S.selMIDICh = String(r.ch);
Â  Â  Â  Â  saveSettings(S);
Â  Â  Â  Â  pushMidiLog(`LEARN OK: NOTE #${r.d1} ch:${r.ch+1}`);
Â  Â  Â  Â  setLearn(false);
Â  Â  Â  Â  sendToPopup({type:"settingsSync", S});
Â  Â  Â  }
Â  Â  }

Â  Â  const parsed = midiMsgToValue(data);
Â  Â  if(!parsed){
Â  Â  Â  if(Math.random() < 0.18) pushMidiLog(`raw=[${[...data].join(',')}] (not mapped)`);
Â  Â  Â  return;
Â  Â  }

Â  Â  touchRaw = parsed.raw01;
Â  Â  touch = shapeMIDI(touchRaw);

Â  Â  if(Math.random() < 0.22){
Â  Â  Â  pushMidiLog(`mapped ${parsed.type} #${parsed.num} ch:${parsed.ch+1} -> touch=${touch.toFixed(3)}`);
Â  Â  }

Â  Â  sendToPopup({type:"midiValue", raw01:touchRaw, touch, parsed});
Â  };
}

/* ==========================================================
Â  Â FX MAPPING (Touch) + TEMPLATE APPLY
========================================================== */
function applyFX(){
Â  if(!audioCtx) return;

Â  const sim = clamp(parseFloat(S.rngSimTouch ?? 0)||0, 0, 1);
Â  const t = Math.max(touchSmooth, sim);

Â  const T = getTemplate();

Â  const driveAmt = T.driveBase + t*T.driveRange;
Â  driveWS.curve = makeWaveshaper(driveAmt);

Â  preGain.gain.setTargetAtTime(T.preGainBase + t*T.preGainRange, audioCtx.currentTime, 0.03);
Â  driveGain.gain.setTargetAtTime(T.driveGainBase + t*T.driveGainRange, audioCtx.currentTime, 0.03);

Â  if(filter.type !== T.filterType) filter.type = T.filterType;
Â  const f = T.filterBase + Math.pow(t, 1.35) * T.filterRange;
Â  const q = T.qBase + t*T.qRange;
Â  filter.frequency.setTargetAtTime(f, audioCtx.currentTime, 0.03);
Â  filter.Q.setTargetAtTime(q, audioCtx.currentTime, 0.03);

Â  const ringHz = T.ringBase + t*T.ringRange;
Â  ringOsc.frequency.setTargetAtTime(ringHz, audioCtx.currentTime, 0.03);
Â  ringGain.gain.setTargetAtTime(t*T.ringDepth, audioCtx.currentTime, 0.03);

Â  const wob = (Math.sin(performance.now()*0.0017)*0.5+0.5);
Â  dL.delayTime.setTargetAtTime(T.widenLBase + t*T.widenLRange + wob*T.wobble, audioCtx.currentTime, 0.05);
Â  dR.delayTime.setTargetAtTime(T.widenRBase + t*T.widenRRange + (1-wob)*T.wobble2, audioCtx.currentTime, 0.05);

Â  sendToPopup({type:"fxText",
Â  Â  text:`template:${T.name} | drive:${driveAmt.toFixed(1)} | filter:${T.filterType} ${f.toFixed(0)}Hz Q:${q.toFixed(1)} | ring:${ringHz.toFixed(1)}Hz depth:${(t*T.ringDepth).toFixed(2)} | widen:${t.toFixed(2)}`
Â  });
}

/* ==========================================================
Â  Â VISUAL PARAMS (from S; popup edits these)
========================================================== */
function getIdleDrama(){ return clamp(parseFloat(S.rngIdleDrama ?? 0.55)||0.55, 0, 1); }
function getVisSens(){ return clamp(parseFloat(S.rngVisSens ?? 1.55)||1.55, 0.6, 2.6); }
function getLineMul(){ return clamp(parseFloat(S.rngLine ?? 0.75)||0.75, 0.2, 1.2); }
function getPerfLim(){ return clamp(parseFloat(S.rngPerf ?? 0.72)||0.72, 0.25, 1.0); }
function getFade(){ return clamp(parseFloat(S.rngFade ?? 0.03)||0.03, 0.02, 0.20); }
function getPointSize(){ return clamp(parseFloat(S.rngPointSize ?? 0.60)||0.60, 0.4, 1.2); }
function getGlow(){ return clamp(parseFloat(S.rngGlow ?? 0.45)||0.45, 0.10, 1.0); }

function getPointColor(){
Â  return ((S.selPointColor ?? "red") === "red") ? "#ff3b3b" : "#ffffff";
}

/* ==========================================================
Â  Â VISUAL FIELD
========================================================== */
let N = parseInt(S.selN ?? 220,10) || 220;
let pts = [];
let rot = 0;

const BASE_QUIET_TH = 0.0032;
const BASE_ACTIVE_TH = 0.0065;
const BASE_ONSET_TH Â = 0.0060;

let energy = 0;
let burstEnergy = 0;

function initPoints(){
Â  pts = [];
Â  for(let i=0;i<N;i++){
Â  Â  pts.push({
Â  Â  Â  x:(Math.random()*2-1)*(W*0.34),
Â  Â  Â  y:(Math.random()*2-1)*(H*0.34),
Â  Â  Â  z:(Math.random()*2-1)*340,
Â  Â  Â  vx:0,vy:0,vz:0
Â  Â  });
Â  }
}
initPoints();

function project(p){
Â  const s=Math.sin(rot), c=Math.cos(rot);
Â  const x = p.x*c - p.z*s;
Â  const z = p.x*s + p.z*c;
Â  const depth = 900;
Â  const k = depth/(depth+z);
Â  return { x:x*k + W/2, y:p.y*k + H/2, k, z };
}

function applyBounds(p, mode){
Â  if(mode==="wrap"){
Â  Â  const maxX=W*0.65, maxY=H*0.65, maxZ=560;
Â  Â  if(p.x> maxX) p.x=-maxX;
Â  Â  if(p.x<-maxX) p.x= maxX;
Â  Â  if(p.y> maxY) p.y=-maxY;
Â  Â  if(p.y<-maxY) p.y= maxY;
Â  Â  if(p.z> maxZ) p.z=-maxZ;
Â  Â  if(p.z<-maxZ) p.z= maxZ;
Â  Â  return;
Â  }

Â  const maxX=W*0.58, maxY=H*0.58, maxZ=560;

Â  if(mode==="bounce"){
Â  Â  if(p.x> maxX){ p.x=maxX; p.vx*=-0.7; }
Â  Â  if(p.x<-maxX){ p.x=-maxX; p.vx*=-0.7; }
Â  Â  if(p.y> maxY){ p.y=maxY; p.vy*=-0.7; }
Â  Â  if(p.y<-maxY){ p.y=-maxY; p.vy*=-0.7; }
Â  Â  if(p.z> maxZ){ p.z=maxZ; p.vz*=-0.7; }
Â  Â  if(p.z<-maxZ){ p.z=-maxZ; p.vz*=-0.7; }
Â  Â  return;
Â  }

Â  const pull = 0.0026;
Â  const edgeX = Math.max(0, Math.abs(p.x) - maxX);
Â  const edgeY = Math.max(0, Math.abs(p.y) - maxY);
Â  const edgeZ = Math.max(0, Math.abs(p.z) - maxZ);
Â  if(edgeX>0) p.vx += (-Math.sign(p.x)) * edgeX * pull;
Â  if(edgeY>0) p.vy += (-Math.sign(p.y)) * edgeY * pull;
Â  if(edgeZ>0) p.vz += (-Math.sign(p.z)) * edgeZ * pull;
}

/* ==========================================================
Â  Â UI / TOGGLES
========================================================== */
function updateTopPill(q=1){
Â  // popupì— í‘œì‹œí•  ìš©ë„
Â  const a = audioCtx ? audioCtx.state : 'off';
Â  const src = (currentSource==="mic")
Â  Â  ? (micStream ? "mic:on" : "mic:off")
Â  Â  : (fileAudioEl && fileAudioEl.src ? (fileAudioEl.paused ? "file:loaded" : "file:play") : "file:empty");
Â  const recStatus = isRecording ? "REC" : "";
Â  sendToPopup({type:"topPill", text:`audio:${a} | src:${src} | q:${q.toFixed(2)} ${recStatus}`});
}

function toggleFullscreen(){
Â  const el = document.documentElement;
Â  if(!document.fullscreenElement) el.requestFullscreen?.();
Â  else document.exitFullscreen?.();
}
document.getElementById('btnFS').addEventListener('click', toggleFullscreen);
document.getElementById('btnFSQuick').addEventListener('click', toggleFullscreen);

document.getElementById('btnMuteQuick').addEventListener('click', ()=>{
Â  if(!audioCtx) return;
Â  isMuted = !isMuted;
Â  masterGain.gain.setTargetAtTime(isMuted?0:0.9, audioCtx.currentTime, 0.02);
Â  document.getElementById('btnMuteQuick').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”ˆ';
});

/* ==========================================================
Â  Â SCREEN + AUDIO RECORDING
========================================================== */
let mediaRecorder;
let recordedChunks = [];
let isRecording = false;

function setupRecordingStream() {
Â  if(!audioCtx) {
Â  Â  alert("ë…¹í™”ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ë¨¼ì € 'Start Audio'ë¥¼ í´ë¦­í•´ì•¼ í•©ë‹ˆë‹¤.");
Â  Â  return null;
Â  }
Â  
Â  try {
Â  Â  const canvasStream = canvas.captureStream(60); // 60 FPS
Â  Â  const audioStream = monitorDest.stream; // ìµœì¢… ë§ˆìŠ¤í„° ì•„ì›ƒí’‹ ë…¸ë“œ

Â  Â  // ë‘ ìŠ¤íŠ¸ë¦¼ì„ í•©ì¹©ë‹ˆë‹¤.
Â  Â  const combinedStream = new MediaStream();
Â  Â  canvasStream.getVideoTracks().forEach(track => combinedStream.addTrack(track));
Â  Â  audioStream.getAudioTracks().forEach(track => combinedStream.addTrack(track));

Â  Â  return combinedStream;
Â  } catch (e) {
Â  Â  console.error("ë…¹í™” ìŠ¤íŠ¸ë¦¼ ì„¤ì • ì‹¤íŒ¨:", e);
Â  Â  alert("ë…¹í™” ìŠ¤íŠ¸ë¦¼ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìµœì‹  Chrome/Firefoxë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
Â  Â  return null;
Â  }
}

function startRecording() {
Â  if (isRecording) {
Â  Â  alert("ì´ë¯¸ ë…¹í™” ì¤‘ì…ë‹ˆë‹¤.");
Â  Â  return;
Â  }
Â  
Â  const stream = setupRecordingStream();
Â  if (!stream) return;

Â  recordedChunks = [];
Â  try {
Â  Â  mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8,opus' });
Â  } catch(e) {
Â  Â  try {
Â  Â  Â  // Fallback to a more generic type
Â  Â  Â  mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
Â  Â  } catch(e2) {
Â  Â  Â  console.error("MediaRecorder ì´ˆê¸°í™” ì‹¤íŒ¨:", e2);
Â  Â  Â  alert("ë…¹í™” ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
Â  Â  Â  return;
Â  Â  }
Â  }
Â  

Â  mediaRecorder.ondataavailable = (event) => {
Â  Â  if (event.data.size > 0) {
Â  Â  Â  recordedChunks.push(event.data);
Â  Â  }
Â  };

Â  mediaRecorder.onstop = () => {
Â  Â  const blob = new Blob(recordedChunks, { type: 'video/webm' });
Â  Â  const url = URL.createObjectURL(blob);
Â  Â  const a = document.createElement('a');
Â  Â  a.style.display = 'none';
Â  Â  a.href = url;
Â  Â  a.download = `limen-workshop-${new Date().toISOString().slice(0, 19).replace('T', '-')}.webm`;
Â  Â  document.body.appendChild(a);
Â  Â  a.click();
Â  Â  setTimeout(() => {
Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  }, 100);
Â  Â  isRecording = false;
Â  Â  document.getElementById('recordingIndicator').style.display = 'none';
Â  Â  sendToPopup({type:"recordingStatus", isRecording: false});
Â  Â  updateTopPill(1);
Â  Â  alert(`ë…¹í™” ì™„ë£Œ. íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤: ${a.download}`);
Â  };

Â  mediaRecorder.start();
Â  isRecording = true;
Â  document.getElementById('recordingIndicator').style.display = 'block';
Â  sendToPopup({type:"recordingStatus", isRecording: true});
Â  updateTopPill(1);
}

function stopRecording() {
Â  if (isRecording && mediaRecorder && mediaRecorder.state !== 'inactive') {
Â  Â  mediaRecorder.stop();
Â  } else {
Â  Â  alert("ë…¹í™” ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.");
Â  }
}
/* ==========================================================
Â  Â ENTRY REBOOT (Entryë¡œ ë³µê·€)
========================================================== */
function clearRuntime(){
Â  amp = 0; ampSmooth = 0; ampDelta = 0; prevAmp = 0;
Â  touchRaw = 0; touch = 0; touchSmooth = 0; lastMidiAt = 0;
Â  energy = 0; burstEnergy = 0; rot = 0;
Â  initPoints();

Â  document.getElementById('hudMidi').textContent = "midi: -";
Â  document.getElementById('hudTouch').textContent = "0.000";
Â  document.getElementById('hudAmp').textContent = "0.000";
Â  document.getElementById('hudTouchBar').style.width = "0%";
Â  document.getElementById('recordingIndicator').style.display = 'none';
Â  isRecording = false;

Â  ctx.setTransform(DPR,0,0,DPR,0,0);
Â  ctx.fillStyle="#000";
Â  ctx.fillRect(0,0,W,H);
}

async function entryReboot(reason="lag"){
Â  console.warn("ENTRY REBOOT:", reason);

Â  if (isRecording) {
Â  Â  stopRecording(); // Stop recording safely
Â  Â  // NOTE: The actual reboot happens after the mediaRecorder.onstop finishes and clears the state.
Â  Â  // For now, we continue the logic to clear audio before the async stop is guaranteed.
Â  }

Â  try{ stopMic(); }catch(e){}
Â  try{
Â  Â  if(fileAudioEl){
Â  Â  Â  try{ fileAudioEl.pause(); }catch(e){}
Â  Â  }
Â  }catch(e){}

Â  try{ disconnectInputs(); }catch(e){}
Â  fileNode = null;
Â  inputNode = null;

Â  try{
Â  Â  if(audioCtx){
Â  Â  Â  try{ await audioCtx.close(); }catch(e){}
Â  Â  }
Â  }catch(e){}
Â  audioCtx = null;
Â  analyser = null;
Â  timeData = null;
Â  masterGain = null;
Â  preGain = null;
Â  eqLow = eqMid = eqHigh = null;
Â  driveWS = driveGain = null;
Â  filter = null;
Â  ringOsc = null;
Â  ringGain = null;
Â  ringMult = null;
Â  splitter = null;
Â  dL = dR = null;
Â  merger = null;
Â  comp = null;
Â  monitorDest = null;

Â  clearRuntime();

Â  // Entry UI states
Â  document.getElementById('entrySelMic').disabled = true;
Â  document.getElementById('entrySelMic').innerHTML = `<option>Start Audio í›„ ëª©ë¡ ë¡œë“œ</option>`;
Â  document.getElementById('entryMicOn').disabled = true;
Â  document.getElementById('entryMicOff').disabled = true;

Â  showEntry(`ë ‰ ê°ì§€ â†’ Entryë¡œ ë³µê·€ (reason: ${reason})`);
Â  sendToPopup({type:"rebooted", reason});
}

document.getElementById("btnReboot").addEventListener("click", ()=> entryReboot("manual reset"));

/* ==========================================================
Â  Â AUTO REBOOT ON LAG / FREEZE
========================================================== */
function autoRebootEnabled(){ return ((S.selAutoReboot ?? "1") === "1"); }

let lastFrameT = performance.now();
let frameMsSmooth = 16.7;
let lagTimer = 0;

let lastAnimTick = performance.now();
setInterval(()=>{
Â  const now = performance.now();
Â  if(!autoRebootEnabled()) return;
Â  if(now - lastAnimTick > 1600){
Â  Â  entryReboot("freeze watchdog");
Â  Â  lastAnimTick = now;
Â  }
}, 400);

function checkLag(dt){
Â  if(!autoRebootEnabled()) return;
Â  if(dt > 45){
Â  Â  lagTimer += dt;
Â  Â  if(lagTimer > 2200){
Â  Â  Â  entryReboot("lag reboot");
Â  Â  Â  lagTimer = 0;
Â  Â  }
Â  }else{
Â  Â  lagTimer = Math.max(0, lagTimer - 50);
Â  }
}

/* ==========================================================
Â  Â MAIN LOOP (ì†ë„ ëŠë¦¬ê²Œ ì¡°ì •ë¨)
========================================================== */
let lastUiT = 0;

function loop(){
Â  const now = performance.now();
Â  lastAnimTick = now;

Â  const dt = now - lastFrameT;
Â  lastFrameT = now;
Â  frameMsSmooth += (dt - frameMsSmooth) * 0.08;

Â  checkLag(dt);

Â  let qAuto = 1 - Math.max(0, (frameMsSmooth - 16) / 45);
Â  qAuto = clamp(qAuto, 0.28, 1);
Â  const q = Math.min(qAuto, getPerfLim());

Â  ctx.fillStyle = `rgba(0,0,0,${getFade().toFixed(3)})`;
Â  ctx.fillRect(0,0,W,H);

Â  if(audioCtx){
Â  Â  applyEQ();
Â  Â  updateAmp();
Â  }else{
Â  Â  amp = 0; ampDelta = 0;
Â  }

Â  updateTouch();
Â  if(audioCtx) applyFX();

Â  // HUD + popup status
Â  if(now - lastUiT > 110){
Â  Â  lastUiT = now;

Â  Â  const sim = clamp(parseFloat(S.rngSimTouch ?? 0)||0, 0, 1);
Â  Â  const tv = Math.max(touchSmooth, sim);

Â  Â  document.getElementById('hudTouch').textContent = tv.toFixed(3);
Â  Â  document.getElementById('hudAmp').textContent = amp.toFixed(3);
Â  Â  document.getElementById('hudMidi').textContent = midiName;
Â  Â  document.getElementById('hudTouchBar').style.width = (tv*100).toFixed(1)+"%";

Â  Â  updateTopPill(q);

Â  Â  sendToPopup({
Â  Â  Â  type:"status",
Â  Â  Â  amp, dAmp:ampDelta, touch:tv, frame:frameMsSmooth, q,
Â  Â  Â  template:getTemplate().name
Â  Â  });
Â  }

Â  const visSens = getVisSens();
Â  const idleDrama = getIdleDrama();

Â  const QUIET_TH = BASE_QUIET_TH / visSens;
Â  const ACTIVE_TH = BASE_ACTIVE_TH / visSens;
Â  const ONSET_TH Â = BASE_ONSET_TH / visSens;

Â  const targetEnergy = (amp > ACTIVE_TH) ? 1 : (amp < QUIET_TH ? 0 : energy);
Â  energy += (targetEnergy - energy) * 0.05;

Â  const energyFloor = 0.04 + idleDrama * 0.20;
Â  energy = Math.max(energyFloor, energy);

Â  const onset = Math.max(0, (ampDelta - ONSET_TH));
Â  burstEnergy += (onset*8.0 - burstEnergy) * 0.12;
Â  burstEnergy *= 0.92;
Â  burstEnergy = Math.min(1.5, burstEnergy);

Â  const mode = (S.selMode ?? "pulse");
Â  const boundsMode = (S.selBounds ?? "soft");
Â  const quietLines = parseInt(S.selQuietLines ?? "1",10);

Â  const t = now*0.001;
Â  const breathe = 0.5 + 0.5*Math.sin(t*1.2);

Â  const sim = clamp(parseFloat(S.rngSimTouch ?? 0)||0, 0, 1);
Â  const touchV = Math.max(touchSmooth, sim);

Â  // âœ… ì „ì²´ ì†ë„ ëŠë¦¬ê²Œ: speedMul < 1
Â  const SPEED_MUL = 0.62;

Â  const baseSpeedQuiet = (0.10 + idleDrama*0.05) * SPEED_MUL;
Â  const baseChaosQuiet = 0.55 + idleDrama*1.10;

Â  const baseSpeedActive = (0.12 + Math.min(0.30, amp*2.6)) * visSens * SPEED_MUL;

Â  const baseChaosActive =
Â  Â  Math.min(30,
Â  Â  Â  (ampDelta*110) +
Â  Â  Â  (touchV*120) +
Â  Â  Â  burstEnergy*55
Â  Â  ) * visSens;

Â  let speed = baseSpeedQuiet*(1-energy) + baseSpeedActive*energy;
Â  let chaos = baseChaosQuiet*(1-energy) + baseChaosActive*energy;

Â  if(mode==="calm"){ speed *= 0.88; chaos *= 0.75; }
Â  if(mode==="burst"){ speed *= 1.05; chaos *= 1.18; }

Â  const lineMul = getLineMul();
Â  const linkDistQuiet = 26 + idleDrama*10;
Â  const linkDistActiveRaw = (64 + amp*240 + touchV*520 + burstEnergy*110) * lineMul * visSens;
Â  const linkDistActive = Math.min(180, linkDistActiveRaw);
Â  const linkDist = linkDistQuiet*(1-energy) + linkDistActive*energy;

Â  const centerPull = (0.008 + touchV*0.028) * (1.0 - Math.min(1, amp*1.2)) * (0.75 + idleDrama*0.6);
Â  const burst = (amp*0.017 + ampDelta*0.060 + touchV*0.020 + burstEnergy*0.020) * visSens;

Â  const freeze = energy * Math.max(0, 1 - (ampDelta*20));
Â  const rotSpeedBase = (0.0012 + energy*0.010 + burstEnergy*0.008 + touchV*0.010) * (1 - 0.7*freeze);
Â  const rotSpeed = rotSpeedBase * (0.65 + idleDrama*0.8) * SPEED_MUL;
Â  rot += rotSpeed;

Â  const scale = 1.0 + energy*(breathe-0.5)*0.25;

Â  for(const p of pts){
Â  Â  p.vx += (Math.random()-0.5)*chaos;
Â  Â  p.vy += (Math.random()-0.5)*chaos;
Â  Â  p.vz += (Math.random()-0.5)*chaos*0.55;

Â  Â  p.vx += (-p.x)*centerPull*(0.9 - energy*0.4);
Â  Â  p.vy += (-p.y)*centerPull*(0.9 - energy*0.4);
Â  Â  p.vz += (-p.z)*centerPull*(0.6 - energy*0.2);

Â  Â  p.vx += (p.x)*burst*energy;
Â  Â  p.vy += (p.y)*burst*energy;
Â  Â  p.vz += (p.z)*burst*energy*0.6;

Â  Â  p.vx *= 0.90 - energy*0.05;
Â  Â  p.vy *= 0.90 - energy*0.05;
Â  Â  p.vz *= 0.92 - energy*0.04;

Â  Â  p.x = (p.x + p.vx*speed) * scale + (1-scale)*p.x;
Â  Â  p.y = (p.y + p.vy*speed) * scale + (1-scale)*p.y;
Â  Â  p.z = (p.z + p.vz*speed) * (0.92 + 0.08*scale) + (1-(0.92 + 0.08*scale))*p.z;

Â  Â  applyBounds(p, boundsMode);
Â  }

Â  const pr = pts.map(project);

Â  if(energy > 0.05 || quietLines>0){
Â  Â  const cell = Math.max(22, Math.floor(linkDist));
Â  Â  const inv = 1 / cell;
Â  Â  const grid = new Map();

Â  Â  for(let i=0;i<N;i++){
Â  Â  Â  const a = pr[i];
Â  Â  Â  const cx = (a.x*inv)|0;
Â  Â  Â  const cy = (a.y*inv)|0;
Â  Â  Â  const key = (cx<<16) ^ (cy & 0xffff);
Â  Â  Â  let arr = grid.get(key);
Â  Â  Â  if(!arr){ arr=[]; grid.set(key, arr); }
Â  Â  Â  arr.push(i);
Â  Â  }

Â  Â  const baseMax = (1100 + energy*850 + burstEnergy*750 + touchV*700) * lineMul;
Â  Â  const maxLines = Math.floor(baseMax * q);

Â  Â  let linesDrawn = 0;
Â  Â  const stride = (q < 0.45) ? 2 : 1;

Â  Â  for(let i=0;i<N;i+=stride){
Â  Â  Â  if(linesDrawn >= maxLines) break;
Â  Â  Â  const a = pr[i];
Â  Â  Â  const cx = (a.x*inv)|0;
Â  Â  Â  const cy = (a.y*inv)|0;

Â  Â  Â  for(let oy=-1; oy<=1; oy++){
Â  Â  Â  Â  for(let ox=-1; ox<=1; ox++){
Â  Â  Â  Â  Â  if(linesDrawn >= maxLines) break;

Â  Â  Â  Â  Â  const k = ((cx+ox)<<16) ^ ((cy+oy) & 0xffff);
Â  Â  Â  Â  Â  const bucket = grid.get(k);
Â  Â  Â  Â  Â  if(!bucket) continue;

Â  Â  Â  Â  Â  for(let bi=0; bi<bucket.length; bi++){
Â  Â  Â  Â  Â  Â  const j = bucket[bi];
Â  Â  Â  Â  Â  Â  if(j<=i) continue;

Â  Â  Â  Â  Â  Â  const b = pr[j];
Â  Â  Â  Â  Â  Â  const dx=a.x-b.x, dy=a.y-b.y;
Â  Â  Â  Â  Â  Â  const d = Math.hypot(dx,dy);
Â  Â  Â  Â  Â  Â  if(d<linkDist){
Â  Â  Â  Â  Â  Â  Â  const alpha = 1 - d/linkDist;

Â  Â  Â  Â  Â  Â  Â  const quietGain = (quietLines===0) ? 0 : (quietLines===1 ? 0.12 : 0.24);
Â  Â  Â  Â  Â  Â  Â  const onGain = 0.34 + amp*1.5*visSens + burstEnergy*1.6*visSens + touchV*1.4;
Â  Â  Â  Â  Â  Â  Â  const punch = Math.min(1, alpha * (quietGain*(1-energy) + onGain*energy));

Â  Â  Â  Â  Â  Â  Â  ctx.globalAlpha = punch * getGlow();
Â  Â  Â  Â  Â  Â  Â  ctx.strokeStyle = "rgba(255,255,255,0.9)";
Â  Â  Â  Â  Â  Â  Â  ctx.lineWidth = 1;
Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(a.x,a.y);
Â  Â  Â  Â  Â  Â  Â  ctx.lineTo(b.x,b.y);
Â  Â  Â  Â  Â  Â  Â  ctx.stroke();

Â  Â  Â  Â  Â  Â  Â  linesDrawn++;
Â  Â  Â  Â  Â  Â  Â  if(linesDrawn >= maxLines) break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  }

Â  const glow = getGlow();
Â  const pSize = getPointSize();
Â  const pCol = getPointColor();

Â  for(let i=0;i<N;i++){
Â  Â  const p = pr[i];

Â  Â  const baseR = (0.6 + p.k*0.3) * pSize;
Â  Â  const rQuiet = Math.max(0.9, baseR * (1.05 + idleDrama*0.15));
Â  Â  const rActive = baseR * (1.15 + amp*2.2*visSens + touchV*1.6 + burstEnergy*0.9);
Â  Â  const r = rQuiet*(1-energy) + rActive*energy;

Â  Â  const aQuiet = 0.32 + idleDrama*0.12;
Â  Â  const aActive = Math.min(1, 0.40 + amp*0.95*visSens + touchV*0.65 + burstEnergy*0.60);
Â  Â  const a = aQuiet*(1-energy) + aActive*energy;

Â  Â  ctx.globalAlpha = a * glow;
Â  Â  ctx.fillStyle = pCol;
Â  Â  ctx.beginPath();
Â  Â  ctx.arc(p.x, p.y, r, 0, Math.PI*2);
Â  Â  ctx.fill();
Â  }
Â  ctx.globalAlpha = 1;

Â  requestAnimationFrame(loop);
}
loop();

/* ==========================================================
Â  Â POPUP CONTROL TOWER
Â  Â - âš™ï¸ ëˆ„ë¥´ë©´ íŒì—… ì°½ìœ¼ë¡œ ì„¤ì • UI í‘œì‹œ
Â  Â - íŒì—…ì€ localStorage + postMessage ë¡œ mainì„ ì»¨íŠ¸ë¡¤
========================================================== */
let controlWin = null;

function esc(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

function popupHTML(){
Â  const tmplOptions = FX_TEMPLATES.map(t=>`<option value="${esc(t.id)}">${esc(t.name)}</option>`).join("");

Â  return `<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>LIMEN â€“ Control Tower</title>
<style>
Â  html,body{margin:0;background:#0b0b0b;color:#ddd;font-family:system-ui,-apple-system,sans-serif;}
Â  .wrap{padding:12px;}
Â  .top{display:flex;gap:10px;align-items:center;position:sticky;top:0;background:rgba(11,11,11,.92);backdrop-filter:blur(10px);padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);z-index:5;}
Â  .title{font-weight:900;}
Â  .pill{margin-left:auto;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px;color:#bbb;padding:6px 8px;border:1px solid rgba(255,255,255,.12);border-radius:999px;background:rgba(255,255,255,.05);white-space:nowrap;}
Â  .tabs{display:flex;gap:6px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);}
Â  .tab{flex:1;padding:8px 10px;font-size:12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);cursor:pointer;text-align:center;user-select:none;}
Â  .tab.active{border-color:rgba(255,255,255,.34);background:rgba(255,255,255,.08);}
Â  .panel{display:none;padding:12px;}
Â  .panel.active{display:block;}
Â  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0;}
Â  .label{font-size:12px;color:#aaa;width:140px;}
Â  .grow{flex:1;min-width:220px;}
Â  button,select,input[type="range"],input[type="number"]{
Â  Â  background:#121212;color:#eee;border:1px solid rgba(255,255,255,.16);
Â  Â  border-radius:10px;padding:8px 10px;font-weight:650;outline:none;
Â  }
Â  input[type="range"]{padding:6px 10px;}
Â  button:hover,select:hover{border-color:rgba(255,255,255,.32)}
Â  .meter{height:10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);overflow:hidden}
Â  .meter i{display:block;height:100%;width:0%;background:rgba(255,255,255,.85)}
Â  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px;color:#bbb;white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.10);border-radius:10px;padding:8px;max-height:220px;overflow:auto}
Â  .small{font-size:11px;color:#9aa;line-height:1.45}
Â  .two{display:flex;gap:10px;flex-wrap:wrap}
Â  .box{flex:1;min-width:260px;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;background:rgba(255,255,255,.03)}
Â  .pillBtn{border-radius:999px;padding:6px 10px;font-size:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);cursor:pointer}
Â  .pillBtn.on{border-color:rgba(255,255,255,.34);background:rgba(255,255,255,.10)}
</style>
</head>
<body>
Â  <div class="top">
Â  Â  <div class="title">LIMEN â€“ Control Tower</div>
Â  Â  <div class="pill" id="topPill">audio:off | src:off | q:1.00</div>
Â  </div>

Â  <div class="tabs">
Â  Â  <div class="tab active" data-tab="visual">VISUAL</div>
Â  Â  <div class="tab" data-tab="audio">AUDIO</div>
Â  Â  <div class="tab" data-tab="midi">MIDI</div>
Â  Â  <div class="tab" data-tab="system">SYSTEM</div>
Â  </div>

Â  <div class="panel active" id="panel-visual">
Â  Â  <div class="row">
Â  Â  Â  <div class="label">Mode</div>
Â  Â  Â  <select id="selMode" class="grow">
Â  Â  Â  Â  <option value="calm">Calm (quiet 3D dots)</option>
Â  Â  Â  Â  <option value="pulse">Pulse (amp-driven)</option>
Â  Â  Â  Â  <option value="burst">Burst (delta-driven)</option>
Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Particles</div>
Â  Â  Â  <select id="selN" class="grow">
Â  Â  Â  Â  <option value="160">160</option>
Â  Â  Â  Â  <option value="220">220</option>
Â  Â  Â  Â  <option value="320">320</option>
Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Keep in screen</div>
Â  Â  Â  <select id="selBounds" class="grow">
Â  Â  Â  Â  <option value="soft">Soft boundary</option>
Â  Â  Â  Â  <option value="bounce">Bounce</option>
Â  Â  Â  Â  <option value="wrap">Wrap</option>
Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Quiet lines</div>
Â  Â  Â  <select id="selQuietLines" class="grow">
Â  Â  Â  Â  <option value="0">Off</option>
Â  Â  Â  Â  <option value="1">Very subtle</option>
Â  Â  Â  Â  <option value="2">On</option>
Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Point color</div>
Â  Â  Â  <select id="selPointColor" class="grow">
Â  Â  Â  Â  <option value="red">Red</option>
Â  Â  Â  Â  <option value="white">White</option>
Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Idle Drama</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngIdleDrama" type="range" min="0" max="1" step="0.01" value="0.55" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtIdleDrama">idle drama</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Visual Sens</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngVisSens" type="range" min="0.6" max="2.6" step="0.01" value="1.55" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtVisSens">visual sens</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Line density</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngLine" type="range" min="0.2" max="1.2" step="0.01" value="0.75" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtLine">line density</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Perf limit</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngPerf" type="range" min="0.25" max="1" step="0.01" value="0.72" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtPerf">perf limit</div>
Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">BG fade</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngFade" type="range" min="0.02" max="0.20" step="0.005" value="0.03" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtFade">fade</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Point size</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngPointSize" type="range" min="0.4" max="1.2" step="0.01" value="0.60" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtPointSize">point size</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Glow</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngGlow" type="range" min="0.10" max="1.0" step="0.01" value="0.45" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtGlow">glow</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="small">
Â  Â  Â  âœ… ì /ì„  ì†ë„ëŠ” ë©”ì¸ì—ì„œ ì „ì²´ì ìœ¼ë¡œ ëŠë¦¬ê²Œ ì ìš©ë¨<br/>
Â  Â  Â  âœ… ë ‰ ì˜¤ë©´ ìë™ Entry ë³µê·€(ë˜ëŠ” âŸ²)
Â  Â  </div>
Â  </div>

Â  <div class="panel" id="panel-audio">
Â  Â  <div class="row">
Â  Â  Â  <div class="label">Input level</div>
Â  Â  Â  <div class="grow"><div class="meter"><i id="meterIn"></i></div></div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Touch Template</div>
Â  Â  Â  <select id="selFXTemplate" class="grow">
Â  Â  Â  Â  ${tmplOptions}
Â  Â  Â  </select>
Â  Â  </div>
Â  Â  <div class="small" style="margin-top:-6px;">TouchMe(ë˜ëŠ” Sim Touch)ê°€ FXë¥¼ í”ë“œëŠ” ë°©ì‹ì˜ â€œìŒìƒ‰ í”„ë¦¬ì…‹â€</div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Media Gain</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngMediaGain" type="range" min="0.2" max="3.0" step="0.01" value="1.00" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtMediaGain">media gain</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Analysis Sens</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngSens" type="range" min="1" max="12" step="0.1" value="7.0" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtSens">analysis sens</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Gamma boost</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngGamma" type="range" min="0.45" max="1.20" step="0.01" value="0.72" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtGamma">gamma</div>
Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Amp cap</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngCap" type="range" min="0.10" max="0.70" step="0.01" value="0.42" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtCap">amp cap</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">EQ Low</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngEQLow" type="range" min="-20" max="20" step="0.5" value="0" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtEQLow">low</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="row">
Â  Â  Â  <div class="label">EQ Mid</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngEQMid" type="range" min="-20" max="20" step="0.5" value="0" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtEQMid">mid</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="row">
Â  Â  Â  <div class="label">EQ High</div>
Â  Â  Â  <div class="grow">
Â  Â  Â  Â  <input id="rngEQHigh" type="range" min="-20" max="20" step="0.5" value="0" style="width:100%;">
Â  Â  Â  Â  <div class="small" id="txtEQHigh">high</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Amp / Î”</div>
Â  Â  Â  <div class="mono grow" id="txtAmp">amp: -</div>
Â  Â  </div>
Â  Â  <div class="row">
Â  Â  Â  <div class="label">FX (Touch)</div>
Â  Â  Â  <div class="mono grow" id="txtFx">-</div>
Â  Â  </div>
Â  </div>

Â  <div class="panel" id="panel-midi">
Â  Â  <div class="row" style="justify-content:space-between;">
Â  Â  Â  <div class="small" id="txtMIDISupport" style="opacity:.95"></div>
Â  Â  Â  <div style="display:flex; gap:6px; flex-wrap:wrap;">
Â  Â  Â  Â  <button id="btnMIDIInit" class="pillBtn">Connect MIDI</button>
Â  Â  Â  Â  <button id="btnMIDILearn" class="pillBtn">LEARN</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="two">
Â  Â  Â  <div class="box">
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">MIDI Input</div>
Â  Â  Â  Â  Â  <select id="selMIDIIn" class="grow"><option value="">Loadingâ€¦</option></select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">Map Source</div>
Â  Â  Â  Â  Â  <select id="selMIDIType" class="grow">
Â  Â  Â  Â  Â  Â  <option value="cc">Control Change (CC)</option>
Â  Â  Â  Â  Â  Â  <option value="note">Note Velocity</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">CC / Note#</div>
Â  Â  Â  Â  Â  <input id="numMIDINum" class="grow" type="number" min="0" max="127" step="1" value="1" />
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">Channel</div>
Â  Â  Â  Â  Â  <select id="selMIDICh" class="grow">
Â  Â  Â  Â  Â  Â  <option value="-1">Any</option>
Â  Â  Â  Â  Â  Â  <option value="0">1</option><option value="1">2</option><option value="2">3</option><option value="3">4</option>
Â  Â  Â  Â  Â  Â  <option value="4">5</option><option value="5">6</option><option value="6">7</option><option value="7">8</option>
Â  Â  Â  Â  Â  Â  <option value="8">9</option><option value="9">10</option><option value="10">11</option><option value="11">12</option>
Â  Â  Â  Â  Â  Â  <option value="12">13</option><option value="13">14</option><option value="14">15</option><option value="15">16</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">Invert</div>
Â  Â  Â  Â  Â  <select id="selMIDIInvert" class="grow">
Â  Â  Â  Â  Â  Â  <option value="0">Normal</option>
Â  Â  Â  Â  Â  Â  <option value="1">Invert (1-x)</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">Deadzone</div>
Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  <input id="rngMIDIDead" type="range" min="0" max="0.25" step="0.005" value="0.02" style="width:100%;">
Â  Â  Â  Â  Â  Â  <div class="small" id="txtMIDIDead">deadzone</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">Gain</div>
Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  <input id="rngMIDIGain" type="range" min="0.3" max="3.0" step="0.01" value="1.60" style="width:100%;">
Â  Â  Â  Â  Â  Â  <div class="small" id="txtMIDIGain">gain</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">Curve</div>
Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  <input id="rngMIDICurve" type="range" min="0.4" max="2.8" step="0.01" value="0.85" style="width:100%;">
Â  Â  Â  Â  Â  Â  <div class="small" id="txtMIDICurve">curve</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">Smoothing</div>
Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  <input id="rngMIDISmooth" type="range" min="0.02" max="0.50" step="0.01" value="0.22" style="width:100%;">
Â  Â  Â  Â  Â  Â  <div class="small" id="txtMIDISmooth">smooth</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">Sim Touch</div>
Â  Â  Â  Â  Â  <div class="grow">
Â  Â  Â  Â  Â  Â  <input id="rngSimTouch" type="range" min="0" max="1" step="0.001" value="0" style="width:100%;">
Â  Â  Â  Â  Â  Â  <div class="small">ë¯¸ë””ê°€ ë§‰íŒ í™˜ê²½ì—ì„œ ì´ ìŠ¬ë¼ì´ë”ë¡œ FX/ë¹„ì£¼ì–¼ í…ŒìŠ¤íŠ¸</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="box">
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">Touch value</div>
Â  Â  Â  Â  Â  <div class="grow"><div class="meter"><i id="meterTouch"></i></div></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">Mapped</div>
Â  Â  Â  Â  Â  <div class="mono grow" id="txtMIDIRaw">raw: -</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="label">MIDI log</div>
Â  Â  Â  Â  Â  <div class="mono grow" id="txtMIDI">Waitingâ€¦</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="panel" id="panel-system">
Â  Â  <div class="row">
Â  Â  Â  <div class="label">Input source</div>
Â  Â  Â  <select id="selSrc" class="grow">
Â  Â  Â  Â  <option value="mic">Mic (Live input)</option>
Â  Â  Â  Â  <option value="file">File (MP3/WAV)</option>
Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Mic device</div>
Â  Â  Â  <select id="selMic" class="grow" disabled><option>Start Audio í›„ ëª©ë¡ ë¡œë“œ</option></select>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Speaker output</div>
Â  Â  Â  <select id="selSpk" class="grow" disabled><option>ì§€ì› í™•ì¸ ì¤‘â€¦</option></select>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Mic control</div>
Â  Â  Â  <button id="btnMicOn" class="grow">Mic ON</button>
Â  Â  Â  <button id="btnMicOff" class="grow">Mic OFF</button>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">File control</div>
Â  Â  Â  <button id="btnFilePlay" class="grow">Play</button>
Â  Â  Â  <button id="btnFilePause" class="grow">Pause</button>
Â  Â  Â  <button id="btnFileStop" class="grow">Stop</button>
Â  Â  </div>
Â  Â  
Â  Â  <div class="row">
Â  Â  Â  <div class="label"><b>Recording</b></div>
Â  Â  Â  <button id="btnStartRecording" class="grow">Start Recording</button>
Â  Â  Â  <button id="btnStopRecording" class="grow" disabled>Stop Recording</button>
Â  Â  </div>
Â  Â  <div class="small" style="margin-top:-6px;">ìº”ë²„ìŠ¤ ë¹„ì£¼ì–¼ + ì˜¤ë””ì˜¤ ì•„ì›ƒí’‹ì„ .webm íŒŒì¼ë¡œ ë…¹í™”</div>

Â  Â  <div class="row">
Â  Â  Â  <div class="label">Auto Reboot</div>
Â  Â  Â  <select id="selAutoReboot" class="grow">
Â  Â  Â  Â  <option value="1">ON (lag/freeze â†’ ENTRY)</option>
Â  Â  Â  Â  <option value="0">OFF</option>
Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div class="small" id="txtSupport"></div>
Â  Â  <div class="small">íŒ: í”„ë¡œì í„°ëŠ” ë©”ì¸ ë¸Œë¼ìš°ì €ë¥¼ í’€ìŠ¤í¬ë¦° ìœ ì§€í•˜ê³ , ì´ ì°½ìœ¼ë¡œë§Œ ì»¨íŠ¸ë¡¤í•˜ë©´ ë”± ì¢‹ìŒ</div>
Â  </div>

<script>
Â  const STORE_KEY = "${esc(STORE_KEY)}";
Â  function loadS(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||"{}"); }catch(e){ return {}; } }
Â  function saveS(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }
Â  let S = loadS();

Â  const tabs = [...document.querySelectorAll('.tab')];
Â  const panels = [...document.querySelectorAll('.panel')];
Â  function setTab(name){
Â  Â  tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
Â  Â  panels.forEach(p=>p.classList.toggle('active', p.id==="panel-"+name));
Â  Â  S.activeTab = name; saveS(S);
Â  }
Â  tabs.forEach(t=>t.addEventListener('click', ()=>setTab(t.dataset.tab)));
Â  setTab(S.activeTab || "visual");

Â  function bind(id, type){
Â  Â  const el = document.getElementById(id);
Â  Â  if(!el) return;
Â  Â  if(S[id] != null) el.value = S[id];
Â  Â  const evName = (type==="range" || type==="number") ? "input" : "change";
Â  Â  el.addEventListener(evName, ()=>{
Â  Â  Â  S = loadS();
Â  Â  Â  S[id] = (type==="range") ? parseFloat(el.value) : (type==="number") ? parseInt(el.value,10) : el.value;
Â  Â  Â  saveS(S);
Â  Â  Â  window.opener?.postMessage({type:"set", id, value:S[id]}, "*");
Â  Â  Â  refreshLabels();
Â  Â  });
Â  }

Â  // Visual binds
Â  ["selMode","selN","selBounds","selQuietLines","selPointColor"].forEach(id=>bind(id,"select"));
Â  ["rngIdleDrama","rngVisSens","rngLine","rngPerf","rngFade","rngPointSize","rngGlow"].forEach(id=>bind(id,"range"));

Â  // Audio binds
Â  bind("selFXTemplate","select");
Â  ["rngMediaGain","rngSens","rngGamma","rngCap","rngEQLow","rngEQMid","rngEQHigh"].forEach(id=>bind(id,"range"));

Â  // MIDI binds
Â  bind("selMIDIType","select");
Â  bind("numMIDINum","number");
Â  bind("selMIDICh","select");
Â  bind("selMIDIInvert","select");
Â  ["rngMIDIDead","rngMIDIGain","rngMIDICurve","rngMIDISmooth","rngSimTouch"].forEach(id=>bind(id,"range"));

Â  // System binds
Â  bind("selAutoReboot","select");
Â  bind("selSrc","select");

Â  // Buttons -> main actions
Â  document.getElementById("btnMIDIInit").addEventListener("click", ()=>window.opener?.postMessage({type:"action", name:"midiInit"}, "*"));
Â  document.getElementById("btnMIDILearn").addEventListener("click", ()=>window.opener?.postMessage({type:"action", name:"midiLearnToggle"}, "*"));

Â  document.getElementById("btnMicOn").addEventListener("click", ()=>window.opener?.postMessage({type:"action", name:"micOn"}, "*"));
Â  document.getElementById("btnMicOff").addEventListener("click", ()=>window.opener?.postMessage({type:"action", name:"micOff"}, "*"));

Â  document.getElementById("btnFilePlay").addEventListener("click", ()=>window.opener?.postMessage({type:"action", name:"filePlay"}, "*"));
Â  document.getElementById("btnFilePause").addEventListener("click", ()=>window.opener?.postMessage({type:"action", name:"filePause"}, "*"));
Â  document.getElementById("btnFileStop").addEventListener("click", ()=>window.opener?.postMessage({type:"action", name:"fileStop"}, "*"));
Â  
Â  document.getElementById("btnStartRecording").addEventListener("click", ()=>window.opener?.postMessage({type:"action", name:"startRecording"}, "*"));
Â  document.getElementById("btnStopRecording").addEventListener("click", ()=>window.opener?.postMessage({type:"action", name:"stopRecording"}, "*"));

Â  const topPill = document.getElementById("topPill");
Â  const meterIn = document.getElementById("meterIn");
Â  const meterTouch = document.getElementById("meterTouch");
Â  const txtAmp = document.getElementById("txtAmp");
Â  const txtFx = document.getElementById("txtFx");

Â  const txtMediaGain = document.getElementById("txtMediaGain");
Â  const txtSens = document.getElementById("txtSens");
Â  const txtGamma = document.getElementById("txtGamma");
Â  const txtCap = document.getElementById("txtCap");
Â  const txtEQLow = document.getElementById("txtEQLow");
Â  const txtEQMid = document.getElementById("txtEQMid");
Â  const txtEQHigh = document.getElementById("txtEQHigh");

Â  const txtIdleDrama = document.getElementById("txtIdleDrama");
Â  const txtVisSens = document.getElementById("txtVisSens");
Â  const txtLine = document.getElementById("txtLine");
Â  const txtPerf = document.getElementById("txtPerf");
Â  const txtFade = document.getElementById("txtFade");
Â  const txtPointSize = document.getElementById("txtPointSize");
Â  const txtGlow = document.getElementById("txtGlow");

Â  const txtMIDISupport = document.getElementById("txtMIDISupport");
Â  const txtMIDI = document.getElementById("txtMIDI");
Â  const txtMIDIRaw = document.getElementById("txtMIDIRaw");

Â  const txtMIDIDead = document.getElementById("txtMIDIDead");
Â  const txtMIDIGain = document.getElementById("txtMIDIGain");
Â  const txtMIDICurve = document.getElementById("txtMIDICurve");
Â  const txtMIDISmooth = document.getElementById("txtMIDISmooth");

Â  const btnStartRecording = document.getElementById("btnStartRecording");
Â  const btnStopRecording = document.getElementById("btnStopRecording");

Â  function refreshLabels(){
Â  Â  S = loadS();
Â  Â  txtMediaGain.textContent = "media gain: " + (parseFloat(S.rngMediaGain ?? 1).toFixed(2)) + "Ã—";
Â  Â  txtSens.textContent = "analysis sens: " + (parseFloat(S.rngSens ?? 7).toFixed(1)) + "Ã—";
Â  Â  txtGamma.textContent = "gamma: " + (parseFloat(S.rngGamma ?? 0.72).toFixed(2));
Â  Â  txtCap.textContent = "amp cap: " + (parseFloat(S.rngCap ?? 0.42).toFixed(2));

Â  Â  txtEQLow.textContent = "low: " + (parseFloat(S.rngEQLow ?? 0).toFixed(1)) + " dB (200Hz)";
Â  Â  txtEQMid.textContent = "mid: " + (parseFloat(S.rngEQMid ?? 0).toFixed(1)) + " dB (1kHz)";
Â  Â  txtEQHigh.textContent = "high: " + (parseFloat(S.rngEQHigh ?? 0).toFixed(1)) + " dB (4kHz)";

Â  Â  txtIdleDrama.textContent = "idle drama: " + (parseFloat(S.rngIdleDrama ?? 0.55).toFixed(2));
Â  Â  txtVisSens.textContent = "visual sens: " + (parseFloat(S.rngVisSens ?? 1.55).toFixed(2)) + "Ã—";
Â  Â  txtLine.textContent = "line density: " + (parseFloat(S.rngLine ?? 0.75).toFixed(2)) + "Ã—";
Â  Â  txtPerf.textContent = "perf limit: " + (parseFloat(S.rngPerf ?? 0.72).toFixed(2));
Â  Â  txtFade.textContent = "fade: " + (parseFloat(S.rngFade ?? 0.03).toFixed(3));
Â  Â  txtPointSize.textContent = "point size: " + (parseFloat(S.rngPointSize ?? 0.60).toFixed(2)) + "Ã—";
Â  Â  txtGlow.textContent = "glow: " + (parseFloat(S.rngGlow ?? 0.45).toFixed(2)) + "Ã—";

Â  Â  txtMIDIDead.textContent = "deadzone: " + (parseFloat(S.rngMIDIDead ?? 0.02).toFixed(3));
Â  Â  txtMIDIGain.textContent = "gain: " + (parseFloat(S.rngMIDIGain ?? 1.60).toFixed(2)) + "Ã—";
Â  Â  txtMIDICurve.textContent = "curve: " + (parseFloat(S.rngMIDICurve ?? 0.85).toFixed(2)) + " ( <1 = ë” ì˜ˆë¯¼ )";
Â  Â  txtMIDISmooth.textContent = "smooth: " + (parseFloat(S.rngMIDISmooth ?? 0.22).toFixed(2));
Â  }
Â  refreshLabels();

Â  window.addEventListener("message", (ev)=>{
Â  Â  const m = ev.data || {};
Â  Â  if(m.type==="topPill"){ topPill.textContent = m.text || topPill.textContent; }
Â  Â  if(m.type==="status"){
Â  Â  Â  const inPct = Math.max(0, Math.min(1, (m.amp||0)*6.0));
Â  Â  Â  meterIn.style.width = (inPct*100).toFixed(1)+"%";
Â  Â  Â  meterTouch.style.width = (Math.max(0, Math.min(1, m.touch||0))*100).toFixed(1)+"%";
Â  Â  Â  txtAmp.textContent = "amp: "+(m.amp||0).toFixed(4)+" | dAmp: "+(m.dAmp||0).toFixed(4)+" | frame:"+(m.frame||0).toFixed(1)+"ms | q:"+(m.q||0).toFixed(2);
Â  Â  }
Â  Â  if(m.type==="fxText"){ txtFx.textContent = m.text || "-"; }
Â  Â  if(m.type==="midiSupport"){ txtMIDISupport.textContent = m.msg || ""; }
Â  Â  if(m.type==="midiLog"){
Â  Â  Â  txtMIDI.textContent = (m.midiName||"MIDI") + "\\n" + (m.lines||[]).join("\\n");
Â  Â  }
Â  Â  if(m.type==="midiValue"){
Â  Â  Â  const p=m.parsed||{};
Â  Â  Â  txtMIDIRaw.textContent = "raw01:"+(m.raw01||0).toFixed(3)+" -> touch:"+(m.touch||0).toFixed(3)+" | "+(p.type||"").toUpperCase()+" #"+(p.num??"-")+" ch:"+((p.ch??0)+1)+" val:"+(p.val??"-");
Â  Â  }
Â  Â  if(m.type==="learn"){
Â  Â  Â  const b=document.getElementById("btnMIDILearn");
Â  Â  Â  b.classList.toggle("on", !!m.on);
Â  Â  Â  b.textContent = m.on ? "LEARN (ON)" : "LEARN";
Â  Â  }
Â  Â  if(m.type==="midiInputs"){
Â  Â  Â  const sel=document.getElementById("selMIDIIn");
Â  Â  Â  sel.innerHTML="";
Â  Â  Â  const arr=m.inputs||[];
Â  Â  Â  if(arr.length===0){ sel.innerHTML='<option value="">No MIDI inputs</option>'; return; }
Â  Â  Â  arr.forEach(x=>{
Â  Â  Â  Â  const opt=document.createElement("option");
Â  Â  Â  Â  opt.value=x.id; opt.textContent=x.name||"MIDI";
Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  });
Â  Â  Â  if(S.midiInputId){ sel.value=S.midiInputId; }
Â  Â  }
Â  Â  if(m.type==="devices"){
Â  Â  Â  const micSel=document.getElementById("selMic");
Â  Â  Â  micSel.innerHTML="";
Â  Â  Â  (m.mics||[]).forEach(x=>{
Â  Â  Â  Â  const opt=document.createElement("option");
Â  Â  Â  Â  opt.value=x.id; opt.textContent=x.label||"Mic";
Â  Â  Â  Â  micSel.appendChild(opt);
Â  Â  Â  });
Â  Â  Â  micSel.disabled = (m.mics||[]).length===0;
Â  Â  Â  if(S.currentMicDeviceId) micSel.value = S.currentMicDeviceId;

Â  Â  Â  const spkSel=document.getElementById("selSpk");
Â  Â  Â  spkSel.innerHTML="";
Â  Â  Â  if(!m.outputSupported){
Â  Â  Â  Â  spkSel.innerHTML='<option value="">outputSelect=NO</option>';
Â  Â  Â  Â  spkSel.disabled=true;
Â  Â  Â  }else{
Â  Â  Â  Â  (m.spks||[]).forEach(x=>{
Â  Â  Â  Â  Â  const opt=document.createElement("option");
Â  Â  Â  Â  Â  opt.value=x.id; opt.textContent=x.label||"Speaker";
Â  Â  Â  Â  Â  spkSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â  spkSel.disabled = false;
Â  Â  Â  Â  if(S.currentSpkDeviceId) spkSel.value = S.currentSpkDeviceId;
Â  Â  Â  }
Â  Â  Â  document.getElementById("txtSupport").textContent =
Â  Â  Â  Â  "ì§€ì› ìƒíƒœ: mic="+(m.mics||[]).length+" | spk="+(m.spks||[]).length+" | outputSelect="+(m.outputSupported?"YES":"NO");
Â  Â  }
Â  Â  if(m.type==="settingsSync"){
Â  Â  Â  // mainì—ì„œ ê°•ì œë¡œ ë°”ë€ ê°’(LEARN ë“±) ë°˜ì˜
Â  Â  Â  S = m.S || loadS();
Â  Â  Â  saveS(S);
Â  Â  Â  // ëª¨ë“  ì»¨íŠ¸ë¡¤ refresh
Â  Â  Â  for(const k in S){
Â  Â  Â  Â  const el=document.getElementById(k);
Â  Â  Â  Â  if(el) el.value = S[k];
Â  Â  Â  }
Â  Â  Â  refreshLabels();
Â  Â  }
Â  Â  if(m.type==="recordingStatus"){
Â  Â  Â  btnStartRecording.disabled = m.isRecording;
Â  Â  Â  btnStopRecording.disabled = !m.isRecording;
Â  Â  }
Â  });

Â  // MIDI input selection -> main attach
Â  document.getElementById("selMIDIIn").addEventListener("change", ()=>{
Â  Â  const id = document.getElementById("selMIDIIn").value;
Â  Â  S = loadS(); S.midiInputId = id; saveS(S);
Â  Â  window.opener?.postMessage({type:"action", name:"midiAttach", id}, "*");
Â  });

Â  // mic/spk selection -> main apply
Â  document.getElementById("selMic").addEventListener("change", ()=>{
Â  Â  const id = document.getElementById("selMic").value;
Â  Â  S = loadS(); S.currentMicDeviceId = id; saveS(S);
Â  Â  window.opener?.postMessage({type:"action", name:"micDevice", id}, "*");
Â  });
Â  document.getElementById("selSpk").addEventListener("change", ()=>{
Â  Â  const id = document.getElementById("selSpk").value;
Â  Â  S = loadS(); S.currentSpkDeviceId = id; saveS(S);
Â  Â  window.opener?.postMessage({type:"action", name:"spkDevice", id}, "*");
Â  });

Â  // keep focus on controls
Â  window.addEventListener("beforeunload", ()=>{
Â  Â  window.opener?.postMessage({type:"action", name:"popupClosed"}, "*");
Â  });
</script>
</body>
</html>`;
}

function openControlTower(){
Â  const w = Math.min(720, Math.max(520, (screen.availWidth||900)*0.38));
Â  const h = Math.min(860, Math.max(700, (screen.availHeight||900)*0.92));
Â  const left = (screen.availWidth||1200) - w - 20;
Â  const top = 20;

Â  if(controlWin && !controlWin.closed){
Â  Â  controlWin.focus();
Â  Â  return;
Â  }
Â  controlWin = window.open("", "LimenControlTower", `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`);
Â  if(!controlWin){
Â  Â  alert("íŒì—…ì´ ì°¨ë‹¨ëì–´ìš”. ë¸Œë¼ìš°ì €ì—ì„œ íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
Â  Â  return;
Â  }
Â  controlWin.document.open();
Â  controlWin.document.write(popupHTML());
Â  controlWin.document.close();

Â  // initial sync
Â  setTimeout(()=>{
Â  Â  sendToPopup({type:"settingsSync", S: loadSettings()});
Â  Â  listDevices();
Â  Â  rebuildMIDIInputs();
Â  Â  sendToPopup({type:"recordingStatus", isRecording});
Â  }, 250);
}

document.getElementById('btnGear').addEventListener('click', openControlTower);

/* popup messaging helpers */
function sendToPopup(msg){
Â  try{
Â  Â  if(controlWin && !controlWin.closed){
Â  Â  Â  controlWin.postMessage(msg, "*");
Â  Â  }
Â  }catch(e){}
}

/* Main receives changes/actions from popup */
window.addEventListener("message", async (ev)=>{
Â  const m = ev.data || {};
Â  if(m.type==="set"){
Â  Â  // update localStorage + local S
Â  Â  S[m.id] = m.value;
Â  Â  saveSettings(S);

Â  Â  // apply immediate effects
Â  Â  if(m.id==="selN"){
Â  Â  Â  N = parseInt(S.selN,10) || N;
Â  Â  Â  initPoints();
Â  Â  }
Â  Â  if(m.id==="selSrc"){
Â  Â  Â  currentSource = m.value;
Â  Â  Â  S.currentSource = currentSource;
Â  Â  Â  saveSettings(S);
Â  Â  Â  applySourceUI();
Â  Â  Â  if(currentSource==="file") stopMic();
Â  Â  }
Â  Â  if(m.id==="selFXTemplate"){
Â  Â  Â  // nothing else needed; applyFX reads it
Â  Â  }
Â  Â  if(m.id==="selAutoReboot"){
Â  Â  Â  // watchdog uses S
Â  Â  }
Â  Â  // keep popup informed
Â  Â  sendToPopup({type:"settingsSync", S});
Â  }

Â  if(m.type==="action"){
Â  Â  if(m.name==="midiInit") await initMIDI();
Â  Â  if(m.name==="midiLearnToggle") setLearn(!midiLearn);
Â  Â  if(m.name==="midiAttach" && m.id) attachMIDIInput(m.id);
Â  Â  
Â  Â  if(m.name==="startRecording") startRecording();
Â  Â  if(m.name==="stopRecording") stopRecording();

Â  Â  if(m.name==="micOn"){
Â  Â  Â  if(currentSource!=="mic") {
Â  Â  Â  Â  currentSource="mic"; S.currentSource="mic"; saveSettings(S); applySourceUI();
Â  Â  Â  }
Â  Â  Â  await startMic(currentMicDeviceId, false);
Â  Â  }
Â  Â  if(m.name==="micOff") stopMic();

Â  Â  if(m.name==="filePlay"){
Â  Â  Â  if(!fileAudioEl || !fileAudioEl.src){ alert("íŒŒì¼ì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ì–´ìš”."); return; }
Â  Â  Â  ensureAudio(); await audioCtx.resume();
Â  Â  Â  connectFileToChain();
Â  Â  Â  try{ await fileAudioEl.play(); }catch(e){ alert("ì¬ìƒì´ ë§‰í˜”ì–´ìš”. ë©”ì¸ í™”ë©´ì„ í•œë²ˆ í´ë¦­/í„°ì¹˜ í›„ ë‹¤ì‹œ Play."); }
Â  Â  }
Â  Â  if(m.name==="filePause"){ try{ fileAudioEl && fileAudioEl.pause(); }catch(e){} }
Â  Â  if(m.name==="fileStop"){ try{ if(fileAudioEl){ fileAudioEl.pause(); fileAudioEl.currentTime=0; } }catch(e){} }

Â  Â  if(m.name==="micDevice" && m.id){
Â  Â  Â  currentMicDeviceId = m.id;
Â  Â  Â  S.currentMicDeviceId = currentMicDeviceId;
Â  Â  Â  saveSettings(S);
Â  Â  Â  const entrySelMic = document.getElementById('entrySelMic');
Â  Â  Â  if(entrySelMic) entrySelMic.value = currentMicDeviceId;
Â  Â  Â  if(currentSource==="mic" && micStream) await startMic(currentMicDeviceId, false);
Â  Â  }

Â  Â  if(m.name==="spkDevice" && m.id){
Â  Â  Â  S.currentSpkDeviceId = m.id;
Â  Â  Â  saveSettings(S);
Â  Â  Â  if(outputSupported){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  ensureAudio();
Â  Â  Â  Â  Â  setupOutputRouting();
Â  Â  Â  Â  Â  await monitorAudio.setSinkId(m.id);
Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  console.warn(e);
Â  Â  Â  Â  Â  alert("ì´ í™˜ê²½ì—ì„œëŠ” ìŠ¤í”¼ì»¤ ì¶œë ¥ ì„ íƒì´ ì‹¤íŒ¨í–ˆì–´ìš”.");
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  }
});

/* ==========================================================
Â  Â Startup
========================================================== */
function startStatusInit(){
Â  startStatus("Start Audio â†’ Mic/File ì„ íƒ â†’ Enter");
}
startStatusInit();
updateTopPill(1);

window.addEventListener('pagehide', ()=>{
Â  try{ stopMic(); }catch(e){}
Â  try{ if(fileAudioEl) fileAudioEl.pause(); }catch(e){}
});
</script>
</body>
</html>
