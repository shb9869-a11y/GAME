<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport"
        content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,interactive-widget=resizes-content">
  <title>SLEEEEEEEP â€“ RED RABBIT LABYRINTH</title>

  <!-- í”½ì…€ ê²Œì„ í°íŠ¸ -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SLEEP">
  <meta name="theme-color" content="#000000">

  <style>
    :root{
      --appH: 100svh;
      --frame: clamp(12px, 3vmin, 24px);
      --ui-gap: 8px;

      --fs-body: clamp(10px, 1.6vmin, 14px);
      --fs-strong: clamp(11px, 1.8vmin, 16px);
      --fs-small: clamp(9px, 1.4vmin, 12px);
    }

    *{
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body{
      width: 100%;
      height: 100%;
      background: #000;
      color: #f5f5f5;
      font-family: "Press Start 2P", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    body{
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #game-root{
      position: relative;
      background: #000;
      border: 2px solid #444;
      border-radius: 8px;
      overflow: hidden;
      /* 16:9 ë¹„ìœ¨, ê°€ë¡œëª¨ë“œ ê¸°ì¤€ */
      width: min(100vw, 160vh);
      aspect-ratio: 16 / 9;
    }

    #game-canvas{
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      display: block;
      background: #000;
    }

    .ui-layer{
      pointer-events: none;
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: var(--frame);
    }

    #chapter-title{
      pointer-events: auto;
      align-self: flex-start;
      padding: 4px 8px;
      border: 1px solid #666;
      background: rgba(0,0,0,0.8);
      font-size: var(--fs-small);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    #dialog-box{
      pointer-events: auto;
      margin-top: auto;
      width: 100%;
      min-height: 80px;
      max-height: 34%;
      padding: 8px;
      background: rgba(0,0,0,0.85);
      border: 2px solid #777;
      font-size: var(--fs-body);
      line-height: 1.5;
      overflow-y: auto;
      word-break: keep-all;
    }

    #dialog-box::-webkit-scrollbar{
      width: 6px;
    }
    #dialog-box::-webkit-scrollbar-thumb{
      background: #555;
    }

    #controls{
      pointer-events: auto;
      position: absolute;
      left: var(--frame);
      bottom: var(--frame);
      right: var(--frame);
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: flex-end;
      justify-content: space-between;
    }

    /* ì¡°ì´ìŠ¤í‹± */
    #joystick{
      position: relative;
      width: 96px;
      height: 96px;
      touch-action: none;
    }

    #joystick-base{
      position: absolute;
      inset: 8px;
      border-radius: 50%;
      border: 2px solid #555;
      background: radial-gradient(circle at center, #222 0, #111 60%, #050505 100%);
      box-shadow: 0 0 6px rgba(0,0,0,0.8);
    }

    #joystick-stick{
      position: absolute;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid #888;
      background: radial-gradient(circle at center, #f5f5f5 0, #aaaaaa 40%, #555555 100%);
      left: calc(50% - 22px);
      top: calc(50% - 22px);
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
      transition: left 0.08s ease-out, top 0.08s ease-out;
    }

    .btn-circle{
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid #777;
      background: rgba(15,15,15,0.9);
      color: #f5f5f5;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px #111;
    }

    .btn-circle:active{
      transform: translateY(1px);
      background: rgba(40,40,40,0.9);
    }

    .btn-ghost{
      background: transparent;
      border: none;
      color: #999;
      font-size: var(--fs-small);
      margin-top: 4px;
    }

    .btn-ghost:active{
      color: #fff;
    }

    #note-overlay{
      pointer-events: auto;
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.92);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--frame);
    }

    #note-overlay.hidden{
      display: none;
    }

    .note-card{
      width: min(640px, 100%);
      max-height: 100%;
      border: 2px solid #888;
      background: #050505;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .note-title{
      font-size: var(--fs-strong);
      margin-bottom: 6px;
    }

    .note-body{
      font-size: var(--fs-body);
      line-height: 1.5;
      overflow-y: auto;
      padding-right: 4px;
      word-break: keep-all;
    }

    .note-body::-webkit-scrollbar{
      width: 6px;
    }
    .note-body::-webkit-scrollbar-thumb{
      background: #555;
    }

    .note-footer{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      font-size: var(--fs-small);
      color: #bbb;
    }

    .btn-small{
      pointer-events: auto;
      padding: 4px 10px;
      font-size: var(--fs-small);
      border-radius: 4px;
      border: 1px solid #999;
      background: #111;
      color: #f5f5f5;
    }

    .btn-small:active{
      background: #333;
    }

    #orientation-warning{
      position: fixed;
      inset: 0;
      background: #000;
      color: #f5f5f5;
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 16px;
      font-size: var(--fs-body);
    }

    #orientation-warning span{
      display: block;
      margin-top: 12px;
      font-size: var(--fs-small);
      color: #aaa;
    }

    #start-overlay{
      pointer-events: auto;
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center,#111 0,#000 60%,#000 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 18px;
    }

    #start-overlay.hidden{
      display: none;
    }

    .title-main{
      font-size: clamp(18px,3vmin,26px);
      letter-spacing: 2px;
      text-align: center;
      text-shadow: 0 0 8px rgba(255,255,255,0.6);
    }

    .title-sub{
      font-size: var(--fs-small);
      color: #ccc;
      text-align: center;
      max-width: 560px;
      line-height: 1.6;
    }

    .start-hint{
      font-size: var(--fs-small);
      color: #999;
      margin-top: 8px;
    }

    @media (max-width: 768px){
      #controls{
        transform: scale(0.9);
        transform-origin: bottom left;
      }
    }
  </style>
</head>
<body>
<div id="orientation-warning">
  ê°€ë¡œ ëª¨ë“œë¡œ ëŒë ¤ì£¼ì„¸ìš”.<br/>
  <span>ì´ ê²Œì„ì€ ê°€ë¡œ í™”ë©´(landscape)ì—ì„œë§Œ í”Œë ˆì´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
</div>

<div id="game-root">
  <canvas id="game-canvas" width="320" height="180"></canvas>

  <div class="ui-layer">
    <div id="chapter-title">SLEEP / HUB</div>

    <div id="start-overlay">
      <div class="title-main">RED RABBIT / FIVE ROADS</div>
      <div class="title-sub">
        ë¶‰ì€ í† ë¼ëŠ” ë‹¤ì„¯ ê°ˆë˜ì˜ ë¯¸ë¡œë¥¼ ì§€ë‚˜<br/>
        ì‚°ì¬Â·ë‚œë¯¼Â·í‘œë°±Â·ì“°ë ˆê¸°ì‚°Â·ë¹…ì´ìŠˆì˜ ì´ì•¼ê¸°ë¥¼ ë“£ìŠµë‹ˆë‹¤.<br/>
        ë§ˆì§€ë§‰ì—ëŠ”, ê¸°ì‚¬ì˜ ë°œì œë¬¸ì´ ìª½ì§€ë¡œ ë‚¨ìŠµë‹ˆë‹¤.
      </div>
      <div class="start-hint">í™”ë©´ì„ í„°ì¹˜í•˜ê±°ë‚˜ ì•„ë¬´ í‚¤ë‚˜ ëˆŒëŸ¬ ì‹œì‘</div>
    </div>

    <div id="dialog-box">
      ë¶‰ì€ í† ë¼ëŠ” ì•„ì§ ì ë“¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br/>
      ì¡°ì´ìŠ¤í‹±ìœ¼ë¡œ ì›€ì§ì´ê³ , A ë²„íŠ¼ìœ¼ë¡œ ìƒí˜¸ì‘ìš©í•˜ì„¸ìš”.
    </div>

    <div id="controls">
      <div id="joystick">
        <div id="joystick-base"></div>
        <div id="joystick-stick"></div>
      </div>
      <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
        <button id="btn-action" class="btn-circle">A</button>
        <button id="btn-note-list" class="btn-ghost">NOTES</button>
      </div>
    </div>
  </div>

  <!-- ìª½ì§€/ë°œì œë¬¸ -->
  <div id="note-overlay" class="hidden">
    <div class="note-card">
      <div class="note-title" id="note-title">NOTE</div>
      <div class="note-body" id="note-body"></div>
      <div class="note-footer">
        <span id="note-status"></span>
        <button id="btn-close-note" class="btn-small">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== ORIENTATION CHECK =====
  function checkOrientation(){
    const warn = document.getElementById('orientation-warning');
    if(window.innerWidth < window.innerHeight){
      warn.style.display = 'flex';
    }else{
      warn.style.display = 'none';
    }
  }
  window.addEventListener('resize', checkOrientation);
  checkOrientation();

  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');

  const TILE_SIZE = 16;
  const MAP_COLS = 20;
  const MAP_ROWS = 11;

  const chapterTitleEl = document.getElementById('chapter-title');
  const dialogBoxEl = document.getElementById('dialog-box');
  const startOverlayEl = document.getElementById('start-overlay');
  const noteOverlayEl = document.getElementById('note-overlay');
  const noteTitleEl = document.getElementById('note-title');
  const noteBodyEl = document.getElementById('note-body');
  const noteStatusEl = document.getElementById('note-status');

  const btnAction = document.getElementById('btn-action');
  const btnNoteList = document.getElementById('btn-note-list');
  const btnCloseNote = document.getElementById('btn-close-note');

  const joystick = {
    el: document.getElementById('joystick'),
    stick: document.getElementById('joystick-stick'),
    active: false,
    startX: 0,
    startY: 0,
    curX: 0,
    curY: 0,
    dirX: 0,
    dirY: 0,
    lastMoveTime: 0,
    moveInterval: 160
  };

  let gameStarted = false;
  let currentMapId = 'hub';

  const notesState = {
    cafeteria: false,
    cameroon: false,
    bleach: false,
    trash: false,
    bigissue: false
  };

  let player = {
    x: 9,
    y: 9,
    px: 9 * TILE_SIZE,
    py: 9 * TILE_SIZE,
    tx: 9 * TILE_SIZE,
    ty: 9 * TILE_SIZE,
    isMoving: false
  };

  const visitedHotspots = new Set();

  // ===== AUDIO =====
  let audioCtx = null;
  let masterGain = null;
  let bgmGain = null;
  let bgmFilter = null;
  let bgmStarted = false;

  function initAudio(){
    if(audioCtx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;
    audioCtx = new AC();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.65;
    masterGain.connect(audioCtx.destination);

    bgmGain = audioCtx.createGain();
    bgmGain.gain.value = 0.3;
    bgmFilter = audioCtx.createBiquadFilter();
    bgmFilter.type = "lowpass";
    bgmFilter.frequency.value = 800;
    bgmFilter.Q.value = 0.7;
    bgmGain.connect(bgmFilter);
    bgmFilter.connect(masterGain);
    startBGM();
  }

  function startBGM(){
    if(!audioCtx || bgmStarted) return;
    bgmStarted = true;
    const baseFreqs = [110, 220, 330];
    baseFreqs.forEach((f, i)=>{
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = f;
      osc.detune.value = i === 1 ? 12 : (i === 2 ? -8 : 0);

      const lfo = audioCtx.createOscillator();
      const lfoGain = audioCtx.createGain();
      lfo.type = "sine";
      lfo.frequency.value = 0.05 + 0.03*i;
      lfoGain.gain.value = 0.12;
      lfo.connect(lfoGain);
      lfoGain.connect(gain.gain);

      gain.gain.value = 0.18;
      osc.connect(gain);
      gain.connect(bgmGain);

      const now = audioCtx.currentTime;
      osc.start(now + i*0.3);
      lfo.start(now + i*0.3);
    });
  }

  function playStepSound(){
    if(!audioCtx) return;
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "triangle";
    osc.frequency.setValueAtTime(420, t);
    osc.frequency.exponentialRampToValueAtTime(220, t + 0.09);
    gain.gain.setValueAtTime(0.0, t);
    gain.gain.linearRampToValueAtTime(0.22, t + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
    osc.connect(gain);
    gain.connect(masterGain);
    osc.start(t);
    osc.stop(t + 0.18);
  }

  function playTextSound(){
    if(!audioCtx) return;
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "square";
    osc.frequency.setValueAtTime(880, t);
    osc.frequency.exponentialRampToValueAtTime(600, t + 0.05);
    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(0.15, t + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
    osc.connect(gain);
    gain.connect(masterGain);
    osc.start(t);
    osc.stop(t + 0.12);
  }

  function playNoteSound(){
    if(!audioCtx) return;
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.setValueAtTime(660, t);
    osc.frequency.exponentialRampToValueAtTime(1320, t + 0.25);
    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(0.25, t + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.35);
    osc.connect(gain);
    gain.connect(masterGain);
    osc.start(t);
    osc.stop(t + 0.4);
  }

  // ===== MAPS =====
  const maps = {
    hub: {
      id: 'hub',
      name: 'SLEEP / HUB',
      tiles: [
        "####################",
        "#..................#",
        "#..1.......2.......#",
        "#..................#",
        "#..3.......4.......#",
        "#..................#",
        "#........5.........#",
        "#..................#",
        "#..................#",
        "#.........@........#",
        "####################"
      ],
      start: {x: 9, y: 9},
      portals: {
        "3,2": "cafeteria",
        "11,2": "cameroon",
        "3,4": "bleach",
        "11,4": "trash",
        "9,6": "bigissue"
      },
      hotspots: [
        {
          x: 9, y: 8,
          id: "hub_intro",
          text: "ë‹¤ì„¯ ê°ˆë˜ì˜ ê¸¸ì´ ì•ì— ë†“ì—¬ ìˆìŠµë‹ˆë‹¤.\nì–´ëŠ ì„¸ê³„ì˜ ëª©ì†Œë¦¬ë¥¼ ë¨¼ì € ë“¤ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?"
        }
      ],
      goal: null
    },
    cafeteria: {
      id: 'cafeteria',
      name: 'ê¸‰ì‹ì‹¤ ì‚°ì¬ ë…¸ë™ì',
      tiles: [
        "####################",
        "#..G...............#",
        "#..####............#",
        "#......#...........#",
        "#......#...........#",
        "#......#.......#####",
        "#......#.......#..H#",
        "#..####.......#...#",
        "#.............#...#",
        "#.............#...#",
        "####################"
      ],
      start: {x: 2, y: 9},
      hotspots: [
        {
          x: 2, y: 1,
          id: "caf_1",
          text: "ì—´íŒì˜ ì—´ê¸°ëŠ” ì†ê¹Œì§€ ìµíˆë ¤ ë“¤ì—ˆìŠµë‹ˆë‹¤.\në°”ëŒì— ë¶ˆê½ƒì´ ííŠ¸ëŸ¬ì ¸ì„œëŠ” ì•ˆ ëœë‹¤ê³  í–ˆìŠµë‹ˆë‹¤."
        },
        {
          x: 4, y: 3,
          id: "caf_2",
          text: "ì½”ëì— ë¨¸ë¬´ëŠ” ì‹ìš©ìœ  ëƒ„ìƒˆë¥¼ ì§€ìš°ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤.\nê·¸ì¦ˆìŒ, ê·¸ëŠ” ë‹¤ì‹œ ë‹´ë°°ë¥¼ ë¬¼ì—ˆìŠµë‹ˆë‹¤."
        }
      ],
      goal: {x: 3, y: 1}
    },
    cameroon: {
      id: 'cameroon',
      name: 'ì¹´ë©”ë£¬ ë‚´ì „ ë‚œë¯¼',
      tiles: [
        "####################",
        "#.............#####",
        "#..######.....#..H#",
        "#..#..G.#.....#...#",
        "#..#....#.....#...#",
        "#..#....#.....#...#",
        "#..#....#######...#",
        "#..#..............#",
        "#..################",
        "#..................",
        "####################"
      ],
      start: {x: 2, y: 9},
      hotspots: [
        {
          x: 4, y: 3,
          id: "cam_1",
          text: "â€œì´ê³³ì´ ë‚˜ë¥¼ ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì–´ì©” ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní•˜ì§€ë§Œ ì €ëŠ” ì„ íƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤.â€"
        },
        {
          x: 13, y: 1,
          id: "cam_2",
          text: "ê²½ê³„ì„ ì€ ëˆˆì— ë³´ì´ì§€ ì•Šì•„ë„,\nì–¸ì œë‚˜ ëˆ„êµ°ê°€ë¥¼ ì˜ë¼ëƒ…ë‹ˆë‹¤."
        }
      ],
      goal: {x: 5, y: 3}
    },
    bleach: {
      id: 'bleach',
      name: 'ì¸ë„ í‘œë°± ë…¸ë™ì',
      tiles: [
        "####################",
        "#..G.........######",
        "#..#####.....#...H#",
        "#......#.....#....#",
        "#......#.....#....#",
        "#......#.....#....#",
        "#..######....#....#",
        "#.............#...#",
        "#.............#...#",
        "#.............#...#",
        "####################"
      ],
      start: {x: 2, y: 9},
      hotspots: [
        {
          x: 4, y: 1,
          id: "ble_1",
          text: "ì‹¬ë¼êµ¬ì§€ë€ ìƒë¥˜ì— íŠ¸ëŸ­ì´ ì„°ìŠµë‹ˆë‹¤.\nì¿ë¹› ì˜¤ì—¼ìˆ˜ê°€ í° ê±°í’ˆê³¼ ë’¤ì„ì—¬ ë–¨ì–´ì§‘ë‹ˆë‹¤."
        },
        {
          x: 8, y: 7,
          id: "ble_2",
          text: "ì—¬ë ¥ì´ ì—†ëŠ” ì‚¬ëŒë“¤ì€ ë²„í‹¸ ë¿ì´ë¼ê³  ë§í–ˆìŠµë‹ˆë‹¤.\në– ë‚˜ì§€ ì•Šì€ ì‚¬ëŒë“¤ë„ ê³§ ì•„í”Œ ê²ƒì´ë¼ê³  í–ˆìŠµë‹ˆë‹¤."
        }
      ],
      goal: {x: 3, y: 1}
    },
    trash: {
      id: 'trash',
      name: 'íƒœêµ­ ì“°ë ˆê¸°ì‚°',
      tiles: [
        "####################",
        "#..#######.....#..H#",
        "#..#.....#.....#...#",
        "#..#.G...#.....#...#",
        "#..#.....#####.#...#",
        "#..#.........#.#...#",
        "#..#######...#.#...#",
        "#..........###.#...#",
        "#..............#...#",
        "#..............#...#",
        "####################"
      ],
      start: {x: 2, y: 9},
      hotspots: [
        {
          x: 4, y: 3,
          id: "tr_1",
          text: "ë©€ë¦¬ì„œ ë³´ì•˜ì„ ë•Œ ì“°ë ˆê¸°ì‚°ì€ ì–¸ë• ê°™ì•˜ìŠµë‹ˆë‹¤.\nê°€ê¹Œì´ ë‹¤ê°€ê°ˆìˆ˜ë¡ ëƒ„ìƒˆì™€ ì†Œë¦¬ê°€ ìŒ“ì—¬ê°‘ë‹ˆë‹¤."
        },
        {
          x: 12, y: 8,
          id: "tr_2",
          text: "GPSë¥¼ ë„£ì€ ì‹ ë°œì€ ë„ì‹œë¥¼ ë– ë‚˜,\në°”ë‹¤ë¥¼ ê±´ë„ˆ, 3500km ë–¨ì–´ì§„ ì‹œì¥ì—ì„œ ë‹¤ì‹œ ì‹ í˜¸ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤."
        }
      ],
      goal: {x: 4, y: 3}
    },
    bigissue: {
      id: 'bigissue',
      name: 'ë¹…ì´ìŠˆ / ê±°ë¦¬ì˜ ì§‘',
      tiles: [
        "####################",
        "#..................#",
        "#..######......####",
        "#..#....#......#..H",
        "#..#.G..#......#..#",
        "#..#....#......#..#",
        "#..######......#..#",
        "#..............#..#",
        "#..............#..#",
        "#..............#..#",
        "####################"
      ],
      start: {x: 2, y: 9},
      hotspots: [
        {
          x: 4, y: 4,
          id: "bi_1",
          text: "ë§¤ì¼ ì•„ì¹¨ ì™¼ë°œ ì•ìª½ì— ë¶•ëŒ€ë¥¼ ê°ìŠµë‹ˆë‹¤.\në¶•ëŒ€ëŠ” ë°œê°€ë½ ëŒ€ì‹  ëª¸ì˜ ê· í˜•ì„ ì¡ì•„ì¤ë‹ˆë‹¤."
        },
        {
          x: 15, y: 3,
          id: "bi_2",
          text: "í™ˆë¦¬ìŠ¤ëŠ” ê±°ë¦¬ ë…¸ìˆ™ì¸ë§Œì´ ì•„ë‹™ë‹ˆë‹¤.\në¶ˆì•ˆì •í•œ ì§‘, ê¸°ì¤€ì— ë¯¸ì¹˜ì§€ ëª»í•˜ëŠ” ë°©ë„ í¬í•¨ë©ë‹ˆë‹¤."
        }
      ],
      goal: {x: 4, y: 4}
    }
  };

  // ===== TEXT HELPERS =====
  function setDialog(text){
    dialogBoxEl.textContent = '';
    const lines = text.split('\n');
    lines.forEach((line, idx) => {
      dialogBoxEl.appendChild(document.createTextNode(line));
      if(idx < lines.length - 1){
        dialogBoxEl.appendChild(document.createElement('br'));
      }
    });
    playTextSound();
  }

  function showNoteForMap(mapId){
    let title = "";
    let body = "";
    let key = null;

    if(mapId === 'cafeteria'){
      title = "NOTE 1 / ê¸‰ì‹ì‹¤ ì‚°ì¬ ë…¸ë™ì";
      body =
        "ì—´íŒì˜ ì—´ê¸°ëŠ” ì†ê¹Œì§€ ìµíˆë ¤ ë“¤ì—ˆìŠµë‹ˆë‹¤.\n" +
        "ì°½ë¬¸ì„ ì—´ë©´, ë°”ëŒì— ë¶ˆê½ƒì´ ííŠ¸ëŸ¬ì ¸ì„œëŠ” ì•ˆ ëœë‹¤ê³  í–ˆìŠµë‹ˆë‹¤.\n\n" +
        "ì½”ëì— ë¨¸ë¬´ëŠ” ì‹ìš©ìœ  ëƒ„ìƒˆë¥¼ ì§€ìš°ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤.\n" +
        "ê·¸ì¦ˆìŒ ê·¸ëŠ” ë‹¤ì‹œ ë‹´ë°°ë¥¼ ë¬¼ì—ˆê³ ,\n" +
        "ëª‡ ë…„ í›„ ì¡°ë¦¬ì‹¤ì„ ë– ë‚¬ìŠµë‹ˆë‹¤.\n\n" +
        "íì•” 4ê¸° ì§„ë‹¨. ê·¸ë¦¬ê³ , ì§€ë‚œí•´ 7ì›”ì˜ ë¶€ê³ .\n" +
        "ì¼í„°ì˜ ì—´ê¸°ëŠ” ëª¸ì— ë¨¼ì € ìŠ¤ë©°ë“¤ì—ˆìŠµë‹ˆë‹¤.";
      key = 'cafeteria';
    }else if(mapId === 'cameroon'){
      title = "NOTE 2 / ì¹´ë©”ë£¬ ë‚´ì „ ë‚œë¯¼";
      body =
        "â€œì´ê³³ì´ ë‚˜ë¥¼ ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì–´ì©” ìˆ˜ ì—†ì–´ìš”.\n" +
        "í•˜ì§€ë§Œ ì €ëŠ” ì„ íƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤.\n" +
        "ì´ê³³ì— ë¨¸ë¬´ëŠ” ê²ƒë°–ì—.â€\n\n" +
        "êµ­ê²½ê³¼ ë‚œë¯¼ ìº í”„, ì„œë¥˜ì™€ ë°”ì½”ë“œ,\n" +
        "ëˆˆì— ë³´ì´ì§€ ì•ŠëŠ” ì„ ë“¤ì´ ì‚¬ëŒì„ ì˜ë¼ëƒ…ë‹ˆë‹¤.\n\n" +
        "ë‹¹ì‹ ê³¼ ë‚˜ë¥¼ êµ¬ë¶„ì§“ëŠ” ê²½ê³„,\n" +
        "â€˜ë„ˆâ€™ê°€ â€˜ê·¸ê²ƒâ€™ì´ ë˜ëŠ” ìˆœê°„ì€ ì–´ë””ì—ì„œ ì‹œì‘ë ê¹Œìš”?";
      key = 'cameroon';
    }else if(mapId === 'bleach'){
      title = "NOTE 3 / ì¸ë„ í‘œë°± ë…¸ë™ì";
      body =
        "ì‹¬ë¼êµ¬ì§€ë€ ìƒë¥˜ì— ì„  íŠ¸ëŸ­ì—ì„œ,\n" +
        "ì¿ë¹› ì˜¤ì—¼ìˆ˜ê°€ í° ê±°í’ˆê³¼ ë’¤ì„ì—¬ ìŸì•„ì¡ŒìŠµë‹ˆë‹¤.\n" +
        "30ë¶„ ë’¤, ë˜‘ê°™ì€ ì¥ë©´ì´ ë°˜ë³µë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
        "í‘œë°± ê³µì¥ì˜ ë”ëŸ¬ìš´ ë¬¼ì€ ë°©ë¥˜ë˜ì–´\n" +
        "ë§ˆì„ê³¼ ê°•ìœ¼ë¡œ í˜ëŸ¬ë“¤ì–´ê°‘ë‹ˆë‹¤.\n\n" +
        "ë– ë‚  ì—¬ë ¥ì´ ì—†ëŠ” ì‚¬ëŒë“¤ì€ ë²„í‹¸ ë¿ì´ë¼ê³  ë§í•©ë‹ˆë‹¤.\n" +
        "ì—¬ê¸° ë¨¸ë¬´ëŠ” ì´ë“¤ ì—­ì‹œ ê³§ ì•„í”Œ ê²ƒì´ë¼ê³  ë§í•©ë‹ˆë‹¤.";
      key = 'bleach';
    }else if(mapId === 'trash'){
      title = "NOTE 4 / íƒœêµ­ ì“°ë ˆê¸°ì‚°";
      body =
        "ë©€ë¦¬ì„œ ë³´ì•˜ì„ ë•Œ, ì“°ë ˆê¸°ì‚°ì€ ì‘ì€ ì–¸ë• ê°™ì•˜ìŠµë‹ˆë‹¤.\n" +
        "ê°€ê¹Œì´ ë‹¤ê°€ê°ˆìˆ˜ë¡, ëƒ„ìƒˆì™€ ì†Œë¦¬ê°€ ê²¹ê²¹ì´ ìŒ“ì˜€ìŠµë‹ˆë‹¤.\n\n" +
        "GPSë¥¼ ë„£ì€ ì‹ ë°œì€ ë„ì‹œ ì™¸ê³½ìœ¼ë¡œ ë‚˜ê°”ë‹¤ê°€,\n" +
        "ì–‘ì£¼, ì¸ì²œ í•­êµ¬ë¥¼ ì§€ë‚˜,\n" +
        "4ì£¼ ë’¤, íƒœêµ­ ë¡±ëŒë¥´ì•„ ì‹œì¥ì—ì„œ ë‹¤ì‹œ ì‹ í˜¸ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.\n\n" +
        "í•œ ì‚¬ëŒì˜ ë°œìêµ­ì€,\n" +
        "ê±°ëŒ€í•œ ì“°ë ˆê¸°ì˜ ì—­ì‚¬ ì† í•œ ì¢Œí‘œê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.";
      key = 'trash';
    }else if(mapId === 'bigissue'){
      title = "NOTE 5 / ë¹…ì´ìŠˆ / ê±°ë¦¬ì˜ ì§‘";
      body =
        "ë§¤ì¼ ì•„ì¹¨, ì™¼ë°œ ì•ìª½ì— ë¶•ëŒ€ë¥¼ ê°ìŠµë‹ˆë‹¤.\n" +
        "2011ë…„ ì‚°ì¬ ì‚¬ê³ ë¡œ ì™¼ìª½ ë°œê°€ë½ ë‹¤ì„¯ ê°œë¥¼ ìƒì—ˆìŠµë‹ˆë‹¤.\n" +
        "ë¶•ëŒ€ëŠ” ë°œê°€ë½ ëŒ€ì‹  ëª¸ì˜ ê· í˜•ì„ ì¡ì•„ì£¼ì§€ë§Œ,\n" +
        "ì–¼ë§ˆ ëª» ê°€ ëª¨ì–‘ì´ ííŠ¸ëŸ¬ì§‘ë‹ˆë‹¤.\n\n" +
        "í™ˆë¦¬ìŠ¤ëŠ” ê±°ë¦¬ ë…¸ìˆ™ì¸ë§Œì„ ëœ»í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n" +
        "ë¶ˆì•ˆì •í•œ ì£¼ê±°, ê¸°ì¤€ì— ë¯¸ì¹˜ì§€ ëª»í•˜ëŠ” ì§‘,\n" +
        "ì¹˜ë£Œì‹œì„¤ê³¼ ì„ì‹œ ì‰¼í„°ì˜ ì¹¨ëŒ€ë“¤ê¹Œì§€ í¬í•¨ë©ë‹ˆë‹¤.\n\n" +
        "ìš°ë¦¬ëŠ” ì„œë¡œì—ê²Œ ê¸°ëŒ€ì–´ ì„œ ìˆìŠµë‹ˆë‹¤.\n" +
        "ëˆ„êµ°ê°€ì˜ ë¶•ëŒ€ ìœ„ì—ì„œ ê°„ì‹ íˆ ë²„í‹°ëŠ” ê· í˜•ì²˜ëŸ¼.";
      key = 'bigissue';
    }else if(mapId === 'all'){
      title = "FINAL NOTE / ë‹¤ì„¯ ê°ˆë˜ì˜ ì ";
      body =
        "ë¶‰ì€ í† ë¼ëŠ” ë‹¤ì„¯ ê°ˆë˜ì˜ ë¯¸ë¡œë¥¼ ëª¨ë‘ ì§€ë‚˜ì™”ìŠµë‹ˆë‹¤.\n\n" +
        "ê¸‰ì‹ì‹¤ì˜ ì—´ê¸°, êµ­ê²½ì˜ ê²½ê³„,\n" +
        "í‘œë°± ê³µì¥ì˜ ë¬¼, ì“°ë ˆê¸°ì‚° ìœ„ì˜ GPS,\n" +
        "ê±°ë¦¬ì˜ ì§‘ê³¼ ë¶•ëŒ€.\n\n" +
        "ì´ ì´ì•¼ê¸°ë“¤ì€ ì„œë¡œ ë‹¤ë¥¸ ê³³ì—ì„œ ì‹œì‘ë˜ì—ˆì§€ë§Œ,\n" +
        "í•˜ë‚˜ì˜ ì„¸ê³„ ì•ˆì—ì„œ ë™ì‹œì— ì ë“¤ì–´ ìˆìŠµë‹ˆë‹¤.\n\n" +
        "ë‹¹ì‹ ì€ ì´ì œ, ê¸°ì‚¬ì˜ ë°œì œë¬¸ì„ ë“¤ì—ˆê³ ,\n" +
        "ëˆ„êµ°ê°€ì˜ ì„¸ê³„ê°€ â€˜ê·¸ê²ƒâ€™ì´ ë˜ê¸° ì „ì˜ ìˆœê°„ì„\n" +
        "ì¡°ê¸ˆ ë” ì˜¤ë˜ ë°”ë¼ë³´ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.";
      key = null;
    }

    noteTitleEl.textContent = title;
    noteBodyEl.textContent = '';
    body.split('\n').forEach((line, idx) => {
      noteBodyEl.appendChild(document.createTextNode(line));
      if(idx < body.split('\n').length - 1){
        noteBodyEl.appendChild(document.createElement('br'));
      }
    });

    if(key){
      notesState[key] = true;
    }

    const collectedCount = Object.values(notesState).filter(Boolean).length;
    const total = Object.keys(notesState).length;
    noteStatusEl.textContent = `ìˆ˜ì§‘ëœ ìª½ì§€: ${collectedCount} / ${total}`;

    noteOverlayEl.classList.remove('hidden');
    playNoteSound();
  }

  function showNoteList(){
    let body = "";
    body += notesState.cafeteria ? "â–  NOTE 1 / ê¸‰ì‹ì‹¤ ì‚°ì¬ ë…¸ë™ì (íšë“)\n" : "â–¡ NOTE 1 / ê¸‰ì‹ì‹¤ ì‚°ì¬ ë…¸ë™ì\n";
    body += notesState.cameroon ? "â–  NOTE 2 / ì¹´ë©”ë£¬ ë‚´ì „ ë‚œë¯¼ (íšë“)\n" : "â–¡ NOTE 2 / ì¹´ë©”ë£¬ ë‚´ì „ ë‚œë¯¼\n";
    body += notesState.bleach ? "â–  NOTE 3 / ì¸ë„ í‘œë°± ë…¸ë™ì (íšë“)\n" : "â–¡ NOTE 3 / ì¸ë„ í‘œë°± ë…¸ë™ì\n";
    body += notesState.trash ? "â–  NOTE 4 / íƒœêµ­ ì“°ë ˆê¸°ì‚° (íšë“)\n" : "â–¡ NOTE 4 / íƒœêµ­ ì“°ë ˆê¸°ì‚°\n";
    body += notesState.bigissue ? "â–  NOTE 5 / ë¹…ì´ìŠˆ / ê±°ë¦¬ì˜ ì§‘ (íšë“)\n" : "â–¡ NOTE 5 / ë¹…ì´ìŠˆ / ê±°ë¦¬ì˜ ì§‘\n";

    noteTitleEl.textContent = "NOTES / ìª½ì§€ ëª©ë¡";
    noteBodyEl.textContent = '';
    body.split('\n').forEach((line, idx) => {
      noteBodyEl.appendChild(document.createTextNode(line));
      if(idx < body.split('\n').length - 1){
        noteBodyEl.appendChild(document.createElement('br'));
      }
    });
    const collectedCount = Object.values(notesState).filter(Boolean).length;
    const total = Object.keys(notesState).length;
    noteStatusEl.textContent = `ìˆ˜ì§‘ëœ ìª½ì§€: ${collectedCount} / ${total}`;
    noteOverlayEl.classList.remove('hidden');
    playNoteSound();
  }

  function getMap(){
    return maps[currentMapId];
  }

  function isWall(x, y){
    const map = getMap();
    if(x < 0 || x >= MAP_COLS || y < 0 || y >= MAP_ROWS) return true;
    const ch = map.tiles[y].charAt(x);
    if(ch === '#') return true;
    return false;
  }

  function getTileChar(x, y){
    const map = getMap();
    if(x < 0 || x >= MAP_COLS || y < 0 || y >= MAP_ROWS) return ' ';
    return map.tiles[y].charAt(x);
  }

  function warpToMap(mapId, startPos){
    currentMapId = mapId;
    chapterTitleEl.textContent = maps[mapId].name;
    const map = maps[mapId];
    const sp = startPos || map.start;
    player.x = sp.x;
    player.y = sp.y;
    player.px = player.x * TILE_SIZE;
    player.py = player.y * TILE_SIZE;
    player.tx = player.px;
    player.ty = player.py;
    player.isMoving = false;

    if(mapId === 'hub'){
      setDialog("ë‹¤ì„¯ ê°ˆë˜ì˜ ê¸¸.\ní† ë¼ëŠ” ì–´ëŠ ì„¸ê³„ë¶€í„° ë“¤ì–´ê°€ ë³¼ê¹Œìš”?");
    }else{
      if(mapId === 'cafeteria'){
        setDialog("ì—´íŒì˜ ì—´ê¸°ì™€ ì‹ìš©ìœ  ëƒ„ìƒˆê°€ ë‚¨ì€ ì¡°ë¦¬ì‹¤.\nì§€ì›Œì§„ ìë¦¬ë¥¼ ë”°ë¼ê°€ ë´…ë‹ˆë‹¤.");
      }else if(mapId === 'cameroon'){
        setDialog("ë³´ì´ì§€ ì•ŠëŠ” ì„ ë“¤ì´ ê²¹ì³ì§„ êµ­ê²½.\nì—´ë ¤ ìˆìœ¼ë©´ì„œ ë‹«íŒ ë¬¸ë“¤ì„ ì§€ë‚˜ê°‘ë‹ˆë‹¤.");
      }else if(mapId === 'bleach'){
        setDialog("í‘œë°± ê³µì¥ì˜ ë¬¼ì´ íë¥´ëŠ” ë§ˆì„.\ní°ìƒ‰ì´ ì•„ë‹ˆë¼, ì§€ì›Œì§ìœ¼ë¡œ ë¬¼ë“  ì„¸ê³„.");
      }else if(mapId === 'trash'){
        setDialog("ê²¹ê²¹ì´ ìŒ“ì¸ ì“°ë ˆê¸°ì‚°.\nëˆ„êµ°ê°€ì˜ ë°œìêµ­ì´ ì–´ë””ë¡œ ì˜®ê²¨ì¡ŒëŠ”ì§€ ë”°ë¼ê°€ ë´…ë‹ˆë‹¤.");
      }else if(mapId === 'bigissue'){
        setDialog("ê±°ë¦¬ì˜ ì§‘, í”ë“¤ë¦¬ëŠ” ê· í˜•.\nëˆ„êµ°ê°€ì˜ ë¶•ëŒ€ ìœ„ì—ì„œ ë²„í‹°ëŠ” ë°¤.");
      }
    }
  }

  function tryMove(dx, dy){
    if(!gameStarted) return;
    if(player.isMoving) return;
    if(dx === 0 && dy === 0) return;

    const nx = player.x + dx;
    const ny = player.y + dy;
    if(isWall(nx, ny)) return;

    player.x = nx;
    player.y = ny;
    player.tx = player.x * TILE_SIZE;
    player.ty = player.y * TILE_SIZE;
    player.isMoving = true;

    handleTileStepPending = true;
    playStepSound();
  }

  let handleTileStepPending = false;

  function handleTileStep(){
    const map = getMap();
    const key = player.x + "," + player.y;

    if(map.id === 'hub'){
      const portal = map.portals[key];
      if(portal){
        warpToMap(portal);
        return;
      }

      const collectedAll = Object.values(notesState).every(Boolean);
      if(collectedAll && player.x === 9 && player.y === 9){
        showNoteForMap('all');
      }

      map.hotspots.forEach(hs => {
        if(hs.x === player.x && hs.y === player.y){
          if(!visitedHotspots.has(hs.id)){
            visitedHotspots.add(hs.id);
          }
          setDialog(hs.text);
        }
      });

    }else{
      if(map.hotspots){
        map.hotspots.forEach(hs => {
          if(hs.x === player.x && hs.y === player.y){
            if(!visitedHotspots.has(hs.id)){
              visitedHotspots.add(hs.id);
            }
            setDialog(hs.text);
          }
        });
      }

      if(map.goal && map.goal.x === player.x && map.goal.y === player.y){
        showNoteForMap(map.id);
      }

      const ch = getTileChar(player.x, player.y);
      if(ch === 'H'){
        warpToMap('hub');
      }
    }
  }

  // ===== í”½ì…€ í† ë¼ ê·¸ë¦¬ê¸° =====
  // ctx: 2D context
  // x, y: í† ë¼ ê¸°ì¤€ ìœ„ì¹˜ (ì™¼ìª½ ìœ„ ëŠë‚Œ)
  // scale: í¬ê¸° ë°°ìœ¨ (ê¸°ë³¸ 1)
  function drawRedRabbit(ctx, x, y, scale = 1){
    ctx.fillStyle = '#ff3333';

    // ë¨¸ë¦¬
    ctx.fillRect(x + 2*scale, y + 1*scale, 4*scale, 3*scale);

    // ê·€ 2ê°œ
    ctx.fillRect(x + 1*scale, y - 1*scale, 1*scale, 3*scale);
    ctx.fillRect(x + 4*scale, y - 1*scale, 1*scale, 3*scale);

    // ëª¸í†µ
    ctx.fillRect(x + 2*scale, y + 4*scale, 4*scale, 3*scale);

    // ê¼¬ë¦¬
    ctx.fillRect(x + 6*scale, y + 4*scale, 2*scale, 2*scale);
  }

  // ===== RENDERING =====
  function draw(){
    ctx.fillStyle = "#000000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const map = getMap();

    let floor = "#111111";
    let floorDetail = "#151515";
    let wallDark = "#444444";
    let wallLight = "#666666";
    let accentGoal = "#ff4444";
    let accentGoalDark = "#550000";
    let accentHub = "#55ffff";
    let accentHubDark = "#002222";

    if(map.id === 'cafeteria'){
      floor = "#121010";
      floorDetail = "#2a1b1b";
      wallDark = "#4b3333";
      wallLight = "#8c5b46";
    }else if(map.id === 'cameroon'){
      floor = "#111119";
      floorDetail = "#202033";
      wallDark = "#373a4b";
      wallLight = "#7a7f99";
    }else if(map.id === 'bleach'){
      floor = "#161616";
      floorDetail = "#2a2a2a";
      wallDark = "#555555";
      wallLight = "#9f9f9f";
    }else if(map.id === 'trash'){
      floor = "#10130e";
      floorDetail = "#272f1a";
      wallDark = "#3e4a32";
      wallLight = "#7f8d5a";
    }else if(map.id === 'bigissue'){
      floor = "#101015";
      floorDetail = "#1f1f2b";
      wallDark = "#34344a";
      wallLight = "#777799";
    }

    for(let y=0; y<MAP_ROWS; y++){
      const row = map.tiles[y];
      for(let x=0; x<MAP_COLS; x++){
        const ch = row.charAt(x);
        const sx = x * TILE_SIZE;
        const sy = y * TILE_SIZE;

        ctx.fillStyle = floor;
        ctx.fillRect(sx, sy, TILE_SIZE, TILE_SIZE);

        if(ch === '#'){
          ctx.fillStyle = wallDark;
          ctx.fillRect(sx, sy, TILE_SIZE, TILE_SIZE);
          ctx.fillStyle = wallLight;
          ctx.fillRect(sx+2, sy+2, TILE_SIZE-4, TILE_SIZE-6);
        }else{
          ctx.fillStyle = floorDetail;
          ctx.fillRect(sx + (x%2===0?4:9), sy + (y%2===0?4:9), 1, 1);
        }

        if(map.id === 'hub'){
          if(ch === '1' || ch === '2' || ch === '3' || ch === '4' || ch === '5'){
            ctx.fillStyle = "#202020";
            ctx.fillRect(sx, sy, TILE_SIZE, TILE_SIZE);
            ctx.fillStyle = "#bbbbbb";
            ctx.fillRect(sx+3, sy+3, TILE_SIZE-6, TILE_SIZE-6);
            ctx.fillStyle = "#000000";
            ctx.font = "10px 'Press Start 2P'";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(ch, sx + TILE_SIZE/2, sy + TILE_SIZE/2 + 1);
          }
          if(ch === '@'){
            ctx.fillStyle = "#333333";
            ctx.fillRect(sx, sy, TILE_SIZE, TILE_SIZE);
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(sx+3, sy+3, TILE_SIZE-6, TILE_SIZE-6);
          }
        }

        if(ch === 'G'){
          ctx.fillStyle = accentGoalDark;
          ctx.fillRect(sx, sy, TILE_SIZE, TILE_SIZE);
          ctx.fillStyle = accentGoal;
          ctx.fillRect(sx+3, sy+3, TILE_SIZE-6, TILE_SIZE-6);
        }
        if(ch === 'H'){
          ctx.fillStyle = accentHubDark;
          ctx.fillRect(sx, sy, TILE_SIZE, TILE_SIZE);
          ctx.fillStyle = accentHub;
          ctx.fillRect(sx+3, sy+3, TILE_SIZE-6, TILE_SIZE-6);
        }
      }
    }

    if(player.isMoving){
      const speed = 0.28;
      const dx = player.tx - player.px;
      const dy = player.ty - player.py;
      player.px += dx * speed;
      player.py += dy * speed;

      if(Math.abs(dx) < 0.5 && Math.abs(dy) < 0.5){
        player.px = player.tx;
        player.py = player.ty;
        player.isMoving = false;
        if(handleTileStepPending){
          handleTileStepPending = false;
          handleTileStep();
        }
      }
    }

    // ğŸ”´ ì—¬ê¸°ì„œ ë„¤ê°€ ì¤€ í”½ì…€ í† ë¼ë¡œ ê·¸ë¦¬ê¸°
    drawRedRabbit(ctx, player.px, player.py, 2);

    requestAnimationFrame(draw);
  }

  requestAnimationFrame(draw);

  function startGameIfNeeded(){
    if(!gameStarted){
      gameStarted = true;
      startOverlayEl.classList.add('hidden');
      setDialog("ë¶‰ì€ í† ë¼ê°€ ëˆˆì„ ë–´ìŠµë‹ˆë‹¤.\në‹¤ì„¯ ê°ˆë˜ì˜ ê¸¸ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ ë³´ì„¸ìš”.");
    }
    initAudio();
  }

  window.addEventListener('keydown', (e)=>{
    startGameIfNeeded();
    if(noteOverlayEl && !noteOverlayEl.classList.contains('hidden')){
      if(e.key === 'Escape' || e.key === 'Enter' || e.key === ' '){
        noteOverlayEl.classList.add('hidden');
      }
      return;
    }
    if(e.key === 'ArrowUp' || e.key === 'w'){
      tryMove(0,-1);
    }else if(e.key === 'ArrowDown' || e.key === 's'){
      tryMove(0,1);
    }else if(e.key === 'ArrowLeft' || e.key === 'a'){
      tryMove(-1,0);
    }else if(e.key === 'ArrowRight' || e.key === 'd'){
      tryMove(1,0);
    }else if(e.key === ' ' || e.key === 'Enter' || e.key === 'z' || e.key === 'x'){
      handleAction();
    }
  });

  btnAction.addEventListener('click', ()=>{
    startGameIfNeeded();
    handleAction();
  });

  function handleAction(){
    const map = getMap();

    if(map.id === 'hub'){
      const all = Object.values(notesState).every(Boolean);
      if(player.x === 9 && player.y === 9){
        if(all){
          showNoteForMap('all');
        }else{
          setDialog("ì•„ì§ ì ë“¤ì§€ ì•Šì€ ì´ì•¼ê¸°ê°€ ìˆìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ê¸¸ë“¤ì„ ë” ê±¸ì–´ê°€ ë³´ì„¸ìš”.");
        }
      }else{
        setDialog("ì¡°ì´ìŠ¤í‹±ìœ¼ë¡œ ì›€ì§ì´ê³  A ë²„íŠ¼ìœ¼ë¡œ ìƒí˜¸ì‘ìš©í•©ë‹ˆë‹¤.\ní¬í„¸ ìœ„ì— ì„œë©´ ë‹¤ë¥¸ ì„¸ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      }
    }else{
      if(map.id === 'cafeteria'){
        setDialog("ë‹¹ì‹ ì´ ê±¸ì–´ê°€ëŠ” ê¸¸ ìœ„ì—ë„,\në³´ì´ì§€ ì•ŠëŠ” ì—´ê³¼ ê¸°ë¦„ì´ ë‚¨ì•„ ìˆì„ì§€ ëª¨ë¦…ë‹ˆë‹¤.");
      }else if(map.id === 'cameroon'){
        setDialog("ë°œë°‘ì˜ í”½ì…€ë“¤ë„ ë³´ì´ì§€ ì•ŠëŠ” ì„ ìœ¼ë¡œ ë‚˜ë‰©ë‹ˆë‹¤.\në‹¹ì‹ ì€ ì–´ëŠ ìª½ì— ì„œ ìˆìŠµë‹ˆê¹Œ?");
      }else if(map.id === 'bleach'){
        setDialog("í°ìƒ‰ì€ í•­ìƒ ê¹¨ë—í•¨ì„ ì˜ë¯¸í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\në¬´ì–¸ê°€ê°€ ì§€ì›Œì§„ ìë¦¬ì¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.");
      }else if(map.id === 'trash'){
        setDialog("ê²¹ê²¹ì´ ìŒ“ì¸ í”½ì…€ ë”ë¯¸ ì†ì—ì„œ,\në‹¹ì‹ ì€ ì–´ë–¤ í•˜ë‚˜ì˜ ì ì— ì‹œì„ ì´ ë©ˆì¶”ë‚˜ìš”?");
      }else if(map.id === 'bigissue'){
        setDialog("ìš°ë¦¬ëŠ” ì„œë¡œì—ê²Œ ì•½ê°„ì”© ê¸°ëŒ€ë©° ë²„íŒë‹ˆë‹¤.\nê· í˜•ì„ ìƒì§€ ì•Šê¸° ìœ„í•´.");
      }
    }
  }

  btnCloseNote.addEventListener('click', ()=>{
    noteOverlayEl.classList.add('hidden');
    if(currentMapId !== 'hub' && currentMapId !== 'all'){
      warpToMap('hub');
    }
  });

  btnNoteList.addEventListener('click', ()=>{
    if(!gameStarted) return;
    showNoteList();
  });

  startOverlayEl.addEventListener('click', ()=>{
    startGameIfNeeded();
  });

  const joystickRect = ()=> joystick.el.getBoundingClientRect();

  function joystickSetStick(dx, dy){
    const maxR = 32;
    const len = Math.sqrt(dx*dx + dy*dy);
    const r = Math.min(len, maxR);
    const nx = len ? dx / len : 0;
    const ny = len ? dy / len : 0;
    const cx = 48;
    const cy = 48;
    joystick.stick.style.left = (cx + nx * r - 22) + "px";
    joystick.stick.style.top = (cy + ny * r - 22) + "px";
  }

  function joystickReset(){
    joystick.active = false;
    joystick.dirX = 0;
    joystick.dirY = 0;
    joystickSetStick(0,0);
  }

  function joystickPointerDown(e){
    startGameIfNeeded();
    e.preventDefault();
    const rect = joystickRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    joystick.active = true;
    joystick.startX = x;
    joystick.startY = y;
    joystick.curX = x;
    joystick.curY = y;
    joystick.lastMoveTime = performance.now();
    joystickSetStick(0,0);
  }

  function joystickPointerMove(e){
    if(!joystick.active) return;
    e.preventDefault();
    const rect = joystickRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    joystick.curX = x;
    joystick.curY = y;

    const dx = x - joystick.startX;
    const dy = y - joystick.startY;

    joystickSetStick(dx, dy);

    const dist = Math.sqrt(dx*dx + dy*dy);
    const threshold = 12;
    if(dist < threshold){
      joystick.dirX = 0;
      joystick.dirY = 0;
      return;
    }

    if(Math.abs(dx) > Math.abs(dy)){
      joystick.dirX = dx > 0 ? 1 : -1;
      joystick.dirY = 0;
    }else{
      joystick.dirX = 0;
      joystick.dirY = dy > 0 ? 1 : -1;
    }

    const now = performance.now();
    if(now - joystick.lastMoveTime > joystick.moveInterval){
      joystick.lastMoveTime = now;
      tryMove(joystick.dirX, joystick.dirY);
    }
  }

  function joystickPointerUp(e){
    e.preventDefault();
    joystickReset();
  }

  joystick.el.addEventListener('mousedown', joystickPointerDown);
  joystick.el.addEventListener('mousemove', joystickPointerMove);
  window.addEventListener('mouseup', joystickPointerUp);

  joystick.el.addEventListener('touchstart', joystickPointerDown, {passive:false});
  joystick.el.addEventListener('touchmove', joystickPointerMove, {passive:false});
  window.addEventListener('touchend', joystickPointerUp, {passive:false});
  window.addEventListener('touchcancel', joystickPointerUp, {passive:false});

  function startGameIfNeededWrapper(){
    startGameIfNeeded();
  }

  warpToMap('hub');
</script>
</body>
</html>
