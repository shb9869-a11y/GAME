<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Isometric Yard Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ISO-YARD">
<meta name="theme-color" content="#000000">

<style>
  *{
    box-sizing:border-box;
    margin:0;
    padding:0;
  }
  :root{
    --camX: 0px;
    --camY: 0px;
  }

  body{
    background:#000;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    color:#fff;

    -webkit-user-select:none;
    user-select:none;
    -webkit-touch-callout:none;
    -webkit-tap-highlight-color:transparent;
  }

  .rotate-warning{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:#000;
    color:#fff;
    font-size:18px;
    text-align:center;
    padding:20px;
    z-index:1000;
  }

  .game-root{
    position:relative;
    width: 900px;
    height: 520px;
    background:#d0d2d6;
    overflow:hidden;
    border-radius:16px;
    box-shadow:0 0 40px rgba(0,0,0,0.8);

    -webkit-user-select:none;
    user-select:none;
    -webkit-touch-callout:none;
    -webkit-tap-highlight-color:transparent;
  }

  @media (orientation:portrait){
    .game-root{display:none;}
    .rotate-warning{display:flex;}
  }
  @media (orientation:landscape){
    .game-root{display:block;}
  }

  .world{
    position:absolute;
    left:50%;
    top:50%;
    width:800px;
    height:480px;
    transform:translate(calc(-50% + var(--camX)),
                        calc(-50% + var(--camY)));
    transition:transform .16s ease-out;
    pointer-events:none;
  }

  .scene-layer{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  /* ================== 이소메트릭 섬 바닥 ================== */

  .island{
    position:absolute;
    left:50%;
    top:55%;
    width:520px;
    height:320px;
    transform:translate(-50%,-50%) skewX(-25deg);
    background:#f7f7f7;
    border:4px solid #000;
    box-shadow:0 18px 0 #000;
    overflow:visible;
  }

  /* 섬 모서리에 튀어나온 플랫폼들 */
  .platform{
    position:absolute;
    width:120px;
    height:60px;
    background:#f7f7f7;
    border:4px solid #000;
    box-shadow:0 12px 0 #000;
  }
  .platform.p1{ left:-40px; bottom:30px; transform:skewX(25deg); }
  .platform.p2{ right:-60px; bottom:120px; transform:skewX(25deg); }
  .platform.p3{ left:140px; top:-40px; transform:skewX(25deg); }

  /* 잔디 느낌 패턴 */
  .grass-dot{
    position:absolute;
    width:3px;
    height:10px;
    border-radius:50px;
    background:#b5b5b5;
    opacity:0.7;
  }

  /* ================== 타워(건물) ================== */

  .tower{
    position:absolute;
    left:50%;
    bottom:70px;
    width:110px;
    height:260px;
    transform:translateX(-50%) skewX(25deg);
    background:#f0f0f0;
    border:4px solid #000;
    box-shadow:0 16px 0 #000;
  }

  .tower-top{
    position:absolute;
    left:50%;
    top:-38px;
    width:220px;
    height:80px;
    transform:translateX(-50%);
    background:#f0f0f0;
    border:4px solid #000;
    box-shadow:0 12px 0 #000;
  }

  .tower-window{
    position:absolute;
    width:32px;
    height:32px;
    background:#000;
    border:3px solid #000;
  }
  .tower-window.w1{ left:50%; top:40px; transform:translateX(-50%); }
  .tower-window.w2{ left:18px; top:100px; }
  .tower-window.w3{ right:18px; top:140px; }

  .tower-door{
    position:absolute;
    left:50%;
    bottom:0;
    width:44px;
    height:70px;
    transform:translate(-50%,0);
    background:#000;
    border:4px solid #000;
  }

  /* ================== 나무 / 바위 / 울타리 ================== */

  .tree{
    position:absolute;
    width:26px;
    height:60px;
  }
  .tree-trunk{
    position:absolute;
    left:50%;
    bottom:0;
    width:8px;
    height:22px;
    transform:translateX(-50%);
    background:#444;
    border-radius:4px;
    border:2px solid #000;
  }
  .tree-top{
    position:absolute;
    left:50%;
    bottom:18px;
    width:34px;
    height:34px;
    transform:translateX(-50%);
    background:#e0e0e0;
    border-radius:50%;
    border:3px solid #000;
  }

  .rock{
    position:absolute;
    width:40px;
    height:26px;
    background:#dedede;
    border-radius:18px;
    border:3px solid #000;
    box-shadow:0 4px 0 rgba(0,0,0,0.35);
  }

  .bush{
    position:absolute;
    width:60px;
    height:30px;
    background:#e0e0e0;
    border-radius:20px;
    border:3px solid #000;
    box-shadow:0 4px 0 rgba(0,0,0,0.35);
  }

  .fence{
    position:absolute;
    height:14px;
    background:#fefefe;
    border:3px solid #000;
  }

  /* ================== 플레이어 ================== */

  .player{
    position:absolute;
    width:26px;
    height:46px;
    transform-origin:center bottom;
  }
  .player .head{
    position:absolute;
    left:50%;
    bottom:30px;
    width:18px;
    height:18px;
    transform:translateX(-50%);
    border-radius:4px;
    border:3px solid #000;
    background:#ffd5a6;
  }
  .player .body{
    position:absolute;
    left:50%;
    bottom:8px;
    width:20px;
    height:22px;
    transform:translateX(-50%);
    border-radius:4px;
    border:3px solid #000;
    background:#ff8a3c;
  }
  .player .shadow{
    position:absolute;
    left:50%;
    bottom:0;
    width:36px;
    height:10px;
    transform:translateX(-50%);
    background:radial-gradient(ellipse at center,
            rgba(0,0,0,0.45) 0, transparent 70%);
  }

  /* ================== 조이스틱 ================== */

  .joystick{
    position:absolute;
    left:40px;
    bottom:40px;
    width:140px;
    height:140px;
    z-index:30;

    -webkit-user-select:none;
    user-select:none;
    -webkit-touch-callout:none;
    -webkit-tap-highlight-color:transparent;
  }
  .joystick-base{
    position:absolute;
    left:50%;
    top:50%;
    width:110px;
    height:110px;
    transform:translate(-50%,-50%);
    border-radius:50%;
    border:3px solid #fff;
    background:rgba(255,255,255,0.05);
    box-shadow:0 4px 0 #000;
  }
  .joystick-knob{
    position:absolute;
    left:50%;
    top:50%;
    width:50px;
    height:50px;
    transform:translate(-50%,-50%);
    border-radius:50%;
    background:#ffffff;
    border:3px solid #000;
    box-shadow:0 3px 0 #000;
  }

  .log{
    position:absolute;
    left:10px;
    top:10px;
    font-size:12px;
    color:#333;
    background:rgba(255,255,255,0.9);
    padding:4px 8px;
    border-radius:6px;
    border:2px solid #000;
    z-index:40;
  }
</style>
</head>
<body>

<div class="rotate-warning">
  이 게임은 <strong>가로 모드</strong>에서 사용해 주세요.<br><br>
  기기를 가로로 돌려 주세요.
</div>

<div class="game-root">
  <div class="world" id="world">
    <div class="scene-layer" id="sceneLayer"></div>

    <!-- 플레이어 -->
    <div class="scene-layer">
      <div class="player" id="player">
        <div class="head"></div>
        <div class="body"></div>
        <div class="shadow"></div>
      </div>
    </div>
  </div>

  <div class="joystick" id="joystick">
    <div class="joystick-base"></div>
    <div class="joystick-knob" id="joystickKnob"></div>
  </div>

  <div class="log" id="log">
    이소메트릭 마당입니다. 조이스틱으로 돌아다녀 보세요. (오브젝트는 아직 충돌 없이 장식만 합니다.)
  </div>
</div>

<script>
  const worldEl   = document.getElementById('world');
  const sceneEl   = document.getElementById('sceneLayer');
  const playerEl  = document.getElementById('player');

  /* ===== 장면 구성 ===== */
  function buildScene(){
    sceneEl.innerHTML = '';
    worldEl.className = 'world';

    const island = document.createElement('div');
    island.className = 'island';

    /* 섬 주변 플랫폼 */
    ['p1','p2','p3'].forEach(cls=>{
      const p = document.createElement('div');
      p.className = 'platform ' + cls;
      island.appendChild(p);
    });

    /* 잔디 도트 몇 개 */
    const grassSpots = [
      {x:20,y:60},{x:30,y:50},{x:40,y:55},{x:60,y:62},
      {x:70,y:50},{x:25,y:40},{x:55,y:42},{x:45,y:70}
    ];
    grassSpots.forEach(g=>{
      const dot = document.createElement('div');
      dot.className = 'grass-dot';
      dot.style.left = g.x + '%';
      dot.style.top  = g.y + '%';
      island.appendChild(dot);
    });

    /* 타워 */
    const tower = document.createElement('div');
    tower.className = 'tower';
    tower.innerHTML = `
      <div class="tower-top"></div>
      <div class="tower-window w1"></div>
      <div class="tower-window w2"></div>
      <div class="tower-window w3"></div>
      <div class="tower-door"></div>
    `;
    island.appendChild(tower);

    /* 나무들 (왼쪽/오른쪽) */
    const trees = [
      {x:18,y:62},{x:22,y:52},{x:26,y:42},
      {x:74,y:62},{x:78,y:52},{x:82,y:42},
      {x:15,y:30},{x:85,y:30}
    ];
    trees.forEach(t=>{
      const el = document.createElement('div');
      el.className = 'tree';
      el.style.left = t.x + '%';
      el.style.top  = t.y + '%';
      el.innerHTML = `<div class="tree-top"></div><div class="tree-trunk"></div>`;
      island.appendChild(el);
    });

    /* 바위들 */
    const rocks = [
      {x:10,y:70},{x:30,y:75},{x:72,y:75}
    ];
    rocks.forEach(r=>{
      const el = document.createElement('div');
      el.className = 'rock';
      el.style.left = r.x + '%';
      el.style.top  = r.y + '%';
      el.style.transform = 'translate(-50%,-50%)';
      island.appendChild(el);
    });

    /* 덤불 */
    const bushes = [
      {x:12,y:48},{x:88,y:48}
    ];
    bushes.forEach(b=>{
      const el = document.createElement('div');
      el.className = 'bush';
      el.style.left = b.x + '%';
      el.style.top  = b.y + '%';
      el.style.transform = 'translate(-50%,-50%)';
      island.appendChild(el);
    });

    /* 울타리 (하단, 좌, 우 일부) */
    const fenceBottom = document.createElement('div');
    fenceBottom.className = 'fence';
    fenceBottom.style.left = '8%';
    fenceBottom.style.bottom = '18px';
    fenceBottom.style.width = '84%';
    island.appendChild(fenceBottom);

    const fenceLeft = document.createElement('div');
    fenceLeft.className = 'fence';
    fenceLeft.style.width = '120px';
    fenceLeft.style.left = '-4%';
    fenceLeft.style.top = '40%';
    fenceLeft.style.transform = 'rotate(90deg)';
    island.appendChild(fenceLeft);

    const fenceRight = document.createElement('div');
    fenceRight.className = 'fence';
    fenceRight.style.width = '120px';
    fenceRight.style.right = '-4%';
    fenceRight.style.top = '38%';
    fenceRight.style.transform = 'rotate(90deg)';
    island.appendChild(fenceRight);

    sceneEl.appendChild(island);
  }

  /* ===== 월드 좌표 & 플레이어 이동 ===== */

  // x,y ∈ [-2,2] 정도의 평면을 섬 위에 맵핑
  let playerX = 0;
  let playerY = 0.6;  // 약간 아래에서 시작
  const limitX = 2.0;
  const limitY = 2.0;
  const speed  = 1.6;
  let joyVector = {x:0,y:0};

  function clampToIsland(){
    playerX = Math.max(-limitX, Math.min(limitX, playerX));
    playerY = Math.max(-limitY, Math.min(limitY, playerY));
  }

  function worldToScreen(x, y){
    // 이소메트릭 기울기 보정 (대략적인 값)
    const baseX = 400;
    const baseY = 280;
    const sx = baseX + x * 140;
    const sy = baseY + y * 70;
    return { x:sx, y:sy };
  }

  function updatePlayerVisual(){
    const pos = worldToScreen(playerX, playerY);
    playerEl.style.left = pos.x + 'px';
    playerEl.style.top  = (pos.y - 4) + 'px';

    const desiredX = 450;
    const desiredY = 260;
    const diffX = desiredX - pos.x;
    const diffY = desiredY - pos.y;
    const camX = diffX * 0.12;
    const camY = diffY * 0.12;
    document.documentElement.style.setProperty('--camX', camX + 'px');
    document.documentElement.style.setProperty('--camY', camY + 'px');
  }

  /* ===== 조이스틱 ===== */

  const joystick     = document.getElementById('joystick');
  const joystickKnob = document.getElementById('joystickKnob');
  let joyActive = false;
  let joyCenter = {x:0,y:0};
  const joyMaxRadius = 45;

  function setJoyVector(cx, cy){
    const dx = cx - joyCenter.x;
    const dy = cy - joyCenter.y;
    if(dx === 0 && dy === 0){
      joyVector.x = 0; joyVector.y = 0;
      joystickKnob.style.left = '50%';
      joystickKnob.style.top  = '50%';
      return;
    }
    const angle = Math.atan2(dy, dx);
    const dist  = Math.min(joyMaxRadius, Math.hypot(dx,dy));
    const nx = Math.cos(angle) * (dist/joyMaxRadius);
    const ny = Math.sin(angle) * (dist/joyMaxRadius);
    joyVector.x = nx;
    joyVector.y = ny;

    joystickKnob.style.left = 50 + (nx * 40) + '%';
    joystickKnob.style.top  = 50 + (ny * 40) + '%';
  }

  function resetJoystick(){
    joyVector.x = 0;
    joyVector.y = 0;
    joystickKnob.style.left = '50%';
    joystickKnob.style.top  = '50%';
  }

  joystick.addEventListener('pointerdown', e=>{
    e.preventDefault();
    joyActive = true;
    const rect = joystick.getBoundingClientRect();
    joyCenter.x = rect.left + rect.width/2;
    joyCenter.y = rect.top  + rect.height/2;
    setJoyVector(e.clientX, e.clientY);
  });

  window.addEventListener('pointermove', e=>{
    if(!joyActive) return;
    e.preventDefault();
    setJoyVector(e.clientX, e.clientY);
  });

  window.addEventListener('pointerup', ()=>{
    if(!joyActive) return;
    joyActive = false;
    resetJoystick();
  });

  window.addEventListener('pointercancel', ()=>{
    if(!joyActive) return;
    joyActive = false;
    resetJoystick();
  });

  // 키보드 테스트용 (원하면 삭제)
  window.addEventListener('keydown', e=>{
    if(e.key === 'ArrowUp')    joyVector.y = -1;
    if(e.key === 'ArrowDown')  joyVector.y =  1;
    if(e.key === 'ArrowLeft')  joyVector.x = -1;
    if(e.key === 'ArrowRight') joyVector.x =  1;
  });
  window.addEventListener('keyup', e=>{
    if(['ArrowUp','ArrowDown'].includes(e.key)) joyVector.y = 0;
    if(['ArrowLeft','ArrowRight'].includes(e.key)) joyVector.x = 0;
  });

  /* ===== 메인 루프 ===== */

  let lastTime = performance.now();
  function loop(now){
    const dt = Math.min(0.05, (now - lastTime) / 1000);
    lastTime = now;

    playerX += joyVector.x * speed * dt;
    playerY += joyVector.y * speed * dt;

    clampToIsland();
    updatePlayerVisual();

    requestAnimationFrame(loop);
  }

  buildScene();
  clampToIsland();
  updatePlayerVisual();
  requestAnimationFrame(loop);
</script>

</body>
</html>