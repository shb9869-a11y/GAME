<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,interactive-widget=resizes-content">
<title>SLEEEEEEEP – THE SECOND SLEEP</title>

<!-- 픽셀 게임 폰트 -->
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEP">
<meta name="theme-color" content="#000000">

<style>
:root{
  --appH: 100svh;
  --frame: clamp(16px, 4vmin, 40px);
  --ui-gap: 8px;

  --fs-body: clamp(12px, 2.2vmin, 16px);
  --fs-strong: clamp(14px, 2.8vmin, 20px);
  --fs-small: clamp(11px, 1.8vmin, 14px);

  --pad-btn-y: clamp(6px, 1.1vmin, 10px);
  --pad-btn-x: clamp(10px, 1.8vmin, 20px);

  --safe-t: env(safe-area-inset-top, 0px);
  --safe-b: env(safe-area-inset-bottom, 0px);
  --safe-l: env(safe-area-inset-left, 0px);
  --safe-r: env(safe-area-inset-right, 0px);

  --accent: #f5f5f5;
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  -webkit-user-select:none;
  user-select:none;
  -webkit-touch-callout:none;
  -webkit-tap-highlight-color: transparent;
}

html, body{
  width:100%;
  height:100%;
  overflow:hidden;
  touch-action:manipulation;
}

body{
  background:#000;
  color:var(--accent);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans KR",sans-serif;
}

input, textarea{
  -webkit-user-select:text;
  user-select:text;
}

/* 공통 버튼 */
.uiBtn{
  background:transparent;
  color:var(--accent);
  border:1px solid rgba(245,245,245,0.8);
  font-size:var(--fs-small);
  padding:var(--pad-btn-y) var(--pad-btn-x);
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  white-space:nowrap;
  cursor:pointer;
}
.uiBtn.flat{
  border:none;
  background:transparent;
}
.uiBtn[disabled]{
  opacity:0.4;
  pointer-events:none;
}

/* 프레임 박스 */
.frameBox{
  position:fixed;
  left:calc(var(--frame) + var(--safe-l));
  top:calc(var(--frame) + var(--safe-t));
  right:calc(var(--frame) + var(--safe-r));
  bottom:calc(var(--frame) + var(--safe-b));
  border:2px solid rgba(245,245,245,0.85);
  z-index:5;
  pointer-events:none;
}

/* 회전 안내 */
#rotateOverlay{
  position:fixed;
  inset:0;
  z-index:2000;
  display:none;
  align-items:center;
  justify-content:center;
  text-align:center;
  background:#000;
  color:var(--accent);
  padding:40px;
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
}

/* 시작 게이트 */
#startOverlay{
  position:fixed;
  inset:0;
  z-index:1500;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.9);
  color:var(--accent);
  text-align:center;
  padding:24px;
}
#startInner{
  max-width:72ch;
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  line-height:1.8;
}

/* 중앙 꿀렁이 (전체 배경) */
#blobCanvas{
  position:fixed;
  inset:0;
  z-index:0;
  width:100vw;
  height:100vh;
  display:block;
  image-rendering:pixelated;
}

/* 2장 타이틀 */
#titleOverlay{
  position:fixed;
  inset:0;
  z-index:30;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}
#titleLines{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}
.sleepLine{
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  letter-spacing:.16em;
  font-size:clamp(26px, 6.2vmin, 80px);
  text-transform:uppercase;
  white-space:nowrap;
  text-align:center;
  text-shadow:0 0 8px rgba(0,0,0,0.85);
}

/* 게임 카드 (인트로 카드 위치에 맞게, 팝업 느낌) */
#gameLayout{
  position:fixed;
  inset:0;
  z-index:20;
  padding:calc(var(--frame) + var(--safe-t))
           calc(var(--frame) + var(--safe-r))
           calc(var(--frame) + var(--safe-b) + 40px)
           calc(var(--frame) + var(--safe-l));
  display:flex;
  align-items:center;           /* 중앙 정렬 */
  justify-content:center;
  pointer-events:none;          /* 실제 입력은 캔버스, HUD, 대화창에서 */
  transform: translateY(-4vh);  /* 게임 화면을 전체적으로 살짝 위로 */
}
#gameCard{
  width:100%;
  max-width:1120px;
  height:auto;
  background:transparent;
  display:flex;
  flex-direction:column;        /* 위: 게임 화면, 아래: 멘트창 */
  align-items:center;
  justify-content:flex-start;
  gap:8px;
}
#gameScreenWrap{
  position:relative;
  width:100%;
  max-width:720px;
  aspect-ratio:16/9;
  background:#001307;
  border:1px solid rgba(245,245,245,0.4);
  box-shadow:0 0 0 2px rgba(0,0,0,0.85), 0 0 30px rgba(0,0,0,0.9);
  overflow:hidden;
  pointer-events:auto;
}
#gameCanvas{
  width:100%;
  height:100%;
  display:block;
  image-rendering:pixelated;
}

/* 닉네임 라벨 */
#nameTag{
  position:absolute;
  left:8px;
  top:8px;
  padding:4px 8px;
  background:rgba(0,0,0,0.6);
  border:1px solid rgba(245,245,245,0.7);
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  font-size:clamp(9px,1.6vmin,12px);
}

/* 대화창 – 게임 화면 바로 아래, 같은 가로 폭 */
#dialogBar{
  width:100%;
  max-width:720px;              /* gameScreenWrap과 동일 */
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  padding:10px 12px;
  background:rgba(0,0,0,0.9);
  border:1px solid rgba(245,245,245,0.6);
  box-shadow:0 0 18px rgba(0,0,0,0.9);
  position:relative;
  left:auto;
  bottom:auto;
  transform:none;
  pointer-events:auto;          /* NEXT 버튼 클릭 가능하게 */
}
#dialogTextWrap{
  flex:1;
}
#dialogText{
  font-family:"Courier New",ui-monospace,monospace;
  font-size:clamp(11px,2.0vmin,14px);
  line-height:1.7;
  white-space:pre-wrap;
}
#dialogHint{
  display:none; /* 예전 힌트 영역은 숨김 */
}
#dialogNext{
  flex:0 0 auto;
}

/* 안내 바 – 게임 창 밖, 검붉은 글자 */
#hintBar{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:calc(var(--frame) + var(--safe-b) + 4px);
  max-width:720px;
  width:calc(100vw - 2*(var(--frame) + var(--safe-l)));
  padding:6px 10px;
  font-family:"Courier New",ui-monospace,monospace;
  font-size:clamp(10px,1.9vmin,13px);
  text-align:center;
  color:#7b1f2a; /* 검붉은 색 */
  pointer-events:none;
}

/* HUD – 방향키 & 액션 버튼 (프레임 밖) */
#hudLeft{
  position:fixed;
  left:calc(var(--frame) + var(--safe-l));
  bottom:calc(var(--frame) + var(--safe-b));
  z-index:40;
}
#hudRight{
  position:fixed;
  right:calc(var(--frame) + var(--safe-r));
  bottom:calc(var(--frame) + var(--safe-b));
  z-index:40;
}

/* D-Pad */
.dpad{
  width:96px;
  height:96px;
  position:relative;
}
.dpad button{
  position:absolute;
  width:32px;
  height:32px;
  border-radius:6px;
  border:1px solid rgba(245,245,245,0.8);
  background:rgba(0,0,0,0.85);
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  font-size:10px;
  color:var(--accent);
  cursor:pointer;
}
.dpad button:active{
  background:#f5f5f5;
  color:#000;
}
.dpad-up{    left:32px; top:0; }
.dpad-down{  left:32px; bottom:0; }
.dpad-left{  left:0; top:32px; }
.dpad-right{ right:0; top:32px; }

/* 액션 버튼 */
#actionBtn{
  width:72px;
  height:72px;
  border-radius:50%;
  border:2px solid rgba(245,245,245,0.9);
  background:rgba(156,31,60,0.95);
  color:#fff;
  font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  font-size:11px;
  cursor:pointer;
  box-shadow:0 4px 0 rgba(0,0,0,0.9);
}
#actionBtn:active{
  transform:translateY(2px);
  box-shadow:0 2px 0 rgba(0,0,0,0.9);
}

/* 페이드 유틸 */
.fade-hidden{ opacity:0; transition:opacity 1800ms ease; }
.fade-show{ opacity:1; }

/* 스테이지 전환 페이드 */
#stageFade{
  position:fixed;
  inset:0;
  background:#000;
  z-index:50;
  opacity:0;
  pointer-events:none;
  transition:opacity 1200ms ease;
}

/* 가시성 제어 */
.hidden{ display:none !important; }

</style>
</head>
<body>

<canvas id="blobCanvas"></canvas>
<div class="frameBox" aria-hidden="true"></div>

<!-- 회전 안내 -->
<div id="rotateOverlay">
  <div>
    <b>Landscape mode required</b><br/>
    Please rotate your device to landscape to continue.
  </div>
</div>

<!-- 시작 게이트 -->
<div id="startOverlay">
  <div id="startInner">
    <p>WELCOME TO</p>
    <p style="margin-top:8px;">SLEEEEEEEEP – THE SECOND SLEEP</p>
    <p style="margin-top:18px;font-size:clamp(10px,2vmin,13px);">
      Tap START to continue.<br/>
      (카메라와 마이크는 사용하지 않지만, 전체 화면 및 사운드 사용을 위해 한 번 터치가 필요합니다.)
    </p>
    <button id="startBtn" class="uiBtn flat" style="margin-top:20px;">START</button>
  </div>
</div>

<!-- 2장 타이틀 -->
<div id="titleOverlay" class="fade-hidden">
  <div id="titleLines">
    <div id="titleLine1" class="sleepLine"></div>
    <div id="titleLine2" class="sleepLine"></div>
    <div id="titleLine3" class="sleepLine"></div>
  </div>
</div>

<!-- 게임 레이아웃 : 중앙 팝업 카드 -->
<div id="gameLayout" class="hidden">
  <div id="gameCard">
    <div id="gameScreenWrap">
      <canvas id="gameCanvas" width="320" height="180"></canvas>
      <div id="nameTag"></div>
    </div>

    <!-- 대화창: 게임 화면 바로 아래 -->
    <div id="dialogBar" class="hidden">
      <div id="dialogTextWrap">
        <div id="dialogText"></div>
        <div id="dialogHint"></div>
      </div>
      <button id="dialogNext" class="uiBtn">NEXT</button>
    </div>
  </div>
</div>

<!-- HUD -->
<div id="hudLeft" class="hidden">
  <div class="dpad">
    <button class="dpad-up"    data-dir="up">▲</button>
    <button class="dpad-down"  data-dir="down">▼</button>
    <button class="dpad-left"  data-dir="left">◀</button>
    <button class="dpad-right" data-dir="right">▶</button>
  </div>
</div>
<div id="hudRight" class="hidden">
  <button id="actionBtn">A</button>
</div>

<!-- 안내 바 -->
<div id="hintBar" class="hidden"></div>

<!-- 스테이지 전환 페이드 -->
<div id="stageFade" class="hidden"></div>

<script>
(() => {
  /* ===== 유틸 ===== */
  const qs = s => document.querySelector(s);
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  function setAppH(){
    document.documentElement.style.setProperty('--appH', window.innerHeight + 'px');
  }
  setAppH();
  addEventListener('resize', ()=>setTimeout(setAppH,50), {passive:true});

  /* ===== 회전 안내 ===== */
  const rotateOverlay = qs('#rotateOverlay');
  function isPortrait(){
    const vv = window.visualViewport;
    const w = vv?vv.width:innerWidth;
    const h = vv?vv.height:innerHeight;
    return h > w;
  }
  function updateRotateOverlay(){
    rotateOverlay.style.display = isPortrait() ? 'flex' : 'none';
  }
  ['load','resize','orientationchange','pageshow'].forEach(ev=>{
    addEventListener(ev, updateRotateOverlay, {passive:true});
  });
  updateRotateOverlay();

  /* ===== 전체 화면 & 오디오 ===== */
  let audioCtx = null;
  let audioPrimed = false;
  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }
  async function primeAudio(){
    ensureAudio();
    if(audioCtx.state === 'suspended'){
      try{ await audioCtx.resume(); }catch(e){}
    }
    audioPrimed = true;
  }
  async function ensureResumed(){
    ensureAudio();
    if(audioCtx.state === 'suspended'){
      try{ await audioCtx.resume(); }catch(e){}
    }
  }

  async function enterFullscreen(){
    const el = document.documentElement;
    try{
      if(!document.fullscreenElement){
        if(el.requestFullscreen) await el.requestFullscreen({navigationUI:'hide'});
        else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      }
    }catch(e){}
  }

  /* ===== 타자 소리 ===== */
  let typeBuffer = null;
  let lastTypeSoundTime = 0;

  function buildTypeBuffer(ctx){
    const duration   = 0.05;
    const sampleRate = ctx.sampleRate;
    const length     = Math.floor(sampleRate * duration);
    const buffer     = ctx.createBuffer(1, length, sampleRate);
    const data       = buffer.getChannelData(0);
    const freq       = 780;
    for(let i=0;i<length;i++){
      const t   = i / sampleRate;
      const env = Math.exp(-t * 11);
      const phase = 2*Math.PI*freq*t;
      data[i] = Math.sin(phase)*env*0.9;
    }
    return buffer;
  }

  function playTypeTick(){
    try{
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime || 0;
      if(now - lastTypeSoundTime < 0.05) return;
      lastTypeSoundTime = now;
      if(!typeBuffer) typeBuffer = buildTypeBuffer(ctx);
      const src = ctx.createBufferSource();
      src.buffer = typeBuffer;
      const g = ctx.createGain();
      g.gain.value = 0.35;
      src.connect(g).connect(ctx.destination);
      src.start();
    }catch(e){}
  }

  // append 모드 지원
  async function typeText(el, text, speed=40, append=false){
    if(!append) el.textContent = '';
    for(let i=0;i<text.length;i++){
      el.textContent += text[i];
      playTypeTick();
      await sleep(speed);
    }
  }

  /* ===== 간단한 팅~ (ding) 효과 ===== */
  async function playDing(){
    try{
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;
      const o1 = ctx.createOscillator();
      const o2 = ctx.createOscillator();
      const g  = ctx.createGain();
      o1.type='sine';
      o2.type='sine';
      o1.frequency.setValueAtTime(523.25, now);
      o2.frequency.setValueAtTime(784.0,  now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.5, now+0.03);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.6);
      o1.connect(g); o2.connect(g); g.connect(ctx.destination);
      o1.start(now); o2.start(now);
      o1.stop(now+0.65); o2.stop(now+0.65);
    }catch(e){}
  }

  /* ===== 게임풍 OST ===== */
  let musicRunning = false;

  function playNote(freq, dur=0.16, vol=0.38){
    try{
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type='square';
      o.frequency.setValueAtTime(freq, now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(vol, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
      o.connect(g).connect(ctx.destination);
      o.start(now);
      o.stop(now+dur+0.02);
    }catch(e){}
  }

  function startBrightMusic(){
    if(musicRunning) return;
    musicRunning = true;
    const base = 523.25; // C5
    const pattern = [
      0, 4, 7, 12,
      7, 4, 0, 7,
      2, 5, 9, 14,
      9, 5, 2, 7
    ];
    let idx = 0;
    const stepDur = 150; // ms

    function step(){
      if(!musicRunning) return;
      const semi = pattern[idx % pattern.length];
      const f = base * Math.pow(2, semi/12);
      playNote(f, 0.14, 0.4);
      idx++;
      setTimeout(step, stepDur);
    }
    step();
  }

  function startDarkMusic(){
    // 밝은 음악 정지 후 어두운 음악 시작
    musicRunning = false;
    setTimeout(()=>{
      if(musicRunning) return;
      musicRunning = true;
      const base = 440; // A4
      const pattern = [
        0, 3, 7, 10,
        3, 7, 0,  -2
      ];
      let idx = 0;
      const stepDur = 230;

      function step(){
        if(!musicRunning) return;
        const semi = pattern[idx % pattern.length];
        const f = base * Math.pow(2, semi/12);
        playNote(f, 0.2, 0.25);
        idx++;
        setTimeout(step, stepDur);
      }
      step();
    }, 400);
  }

  /* ===== 중앙 꿀렁이 (전체 배경, 더 크게) ===== */
  const blobCanvas = qs('#blobCanvas');
  const blobCtx = blobCanvas.getContext('2d');
  let blobAlpha = 0;
  let blobFadeIn = true;
  let blobStartTime = performance.now();

  function resizeBlob(){
    const dpr = window.devicePixelRatio || 1;
    blobCanvas.width = innerWidth * dpr;
    blobCanvas.height = innerHeight * dpr;
    blobCtx.setTransform(dpr,0,0,dpr,0,0);
  }
  resizeBlob();
  addEventListener('resize', ()=>setTimeout(resizeBlob,30), {passive:true});

  function drawBlob(){
    const w = innerWidth;
    const h = innerHeight;
    blobCtx.clearRect(0,0,w,h);
    if(blobAlpha <= 0) return;

    const t = (performance.now() - blobStartTime) * 0.001;
    const cx = w/2;
    const cy = h/2;
    const baseR = Math.min(w,h)*0.45; // 더 크게
    const N = 48;

    blobCtx.save();
    blobCtx.globalAlpha = blobAlpha;
    blobCtx.beginPath();
    for(let i=0;i<N;i++){
      const ang = (i/N)*Math.PI*2;
      const wob = 0.24*Math.sin(t*2 + i*0.7);
      const rr = baseR * (0.8 + wob);
      const x = cx + Math.cos(ang)*rr;
      const y = cy + Math.sin(ang)*rr*0.6;
      if(i===0) blobCtx.moveTo(x,y); else blobCtx.lineTo(x,y);
    }
    blobCtx.closePath();
    const grad = blobCtx.createRadialGradient(cx,cy,baseR*0.1, cx,cy,baseR*1.1);
    grad.addColorStop(0,'#000000');
    grad.addColorStop(1,'#101010');
    blobCtx.fillStyle = grad;
    blobCtx.strokeStyle = 'rgba(245,245,245,0.3)';
    blobCtx.lineWidth = 2.3;
    blobCtx.fill();
    blobCtx.stroke();
    blobCtx.restore();
  }

  function blobLoop(){
    requestAnimationFrame(blobLoop);
    const now = performance.now();
    if(blobFadeIn && blobAlpha < 1){
      const k = clamp((now - blobStartTime)/2000, 0, 1);
      blobAlpha = k;
    }
    drawBlob();
  }
  blobLoop();

  /* ===== 2장 타이틀 연출 (3줄 타이핑) ===== */
  const titleOverlay = qs('#titleOverlay');
  const titleLine1 = qs('#titleLine1');
  const titleLine2 = qs('#titleLine2');
  const titleLine3 = qs('#titleLine3');

  async function showTitleSequence(){
    titleOverlay.classList.remove('fade-show');
    titleOverlay.classList.add('fade-hidden');
    titleOverlay.style.display = 'flex';

    titleLine1.textContent = '';
    titleLine2.textContent = '';
    titleLine3.textContent = '';

    await sleep(50);

    titleOverlay.classList.remove('fade-hidden');
    titleOverlay.classList.add('fade-show');

    // 첫 줄
    await typeText(titleLine1, 'SLEEEEEEEEP', 55, false);
    await sleep(250);
    // 둘째 줄
    await typeText(titleLine2, 'SLEEEEEEEEP', 55, false);
    await sleep(250);
    // 셋째 줄
    await typeText(titleLine3, 'THE SECOND SLEEP', 55, false);

    await sleep(900);

    // 페이드 아웃
    titleOverlay.classList.remove('fade-show');
    titleOverlay.classList.add('fade-hidden');
    await sleep(1400);
    titleOverlay.style.display = 'none';

    // 타이틀 사라진 뒤 OST 시작 & 게임 UI 등장
    await ensureResumed();
    await playDing();
    startBrightMusic();
    startGameScene();
  }

  /* ===== 게임 영역 ===== */
  const gameLayout      = qs('#gameLayout');
  const gameCanvas      = qs('#gameCanvas');
  const gctx            = gameCanvas.getContext('2d');
  const nameTag         = qs('#nameTag');
  const dialogBar       = qs('#dialogBar');
  const dialogText      = qs('#dialogText');
  const dialogNextBtn   = qs('#dialogNext');
  const hudLeft         = qs('#hudLeft');
  const hudRight        = qs('#hudRight');
  const startOverlay    = qs('#startOverlay');
  const startBtn        = qs('#startBtn');
  const stageFade       = qs('#stageFade');
  const hintBar         = qs('#hintBar');

  // 닉네임 (SLEEP 본편에서 localStorage.sleepNick 사용했다고 가정)
  const nickRaw = (()=> {
    try{
      const v = localStorage.getItem('sleepNick');
      if(v && v.trim().length>0) return v.trim();
    }catch(e){}
    return '';
  })();

  // 기본 'YOU'는 라벨에 표시하지 않고, 대사에는 '토끼'로 대체
  const nick =
    nickRaw && nickRaw.toUpperCase() !== 'YOU'
      ? nickRaw
      : '';

  const nickForText = nick || '토끼';

  if(nick){
    nameTag.textContent = nick;
  }else{
    nameTag.style.display = 'none';
  }

  /* 픽셀 토끼 */
  function drawRedRabbit(ctx, x, y, scale=1){
    ctx.fillStyle = '#ff3333';
    // 머리
    ctx.fillRect(x + 2*scale, y + 1*scale, 4*scale, 3*scale);
    // 귀
    ctx.fillRect(x + 1*scale, y - 1*scale, 1*scale, 3*scale);
    ctx.fillRect(x + 4*scale, y - 1*scale, 1*scale, 3*scale);
    // 몸통
    ctx.fillRect(x + 2*scale, y + 4*scale, 4*scale, 3*scale);
    // 꼬리
    ctx.fillRect(x + 6*scale, y + 4*scale, 2*scale, 2*scale);
  }

  /* 게임 월드 */
  const W = gameCanvas.width;
  const H = gameCanvas.height;
  const groundY = 145;
  const sofaX = 210;
  const sofaWidth = 70;
  const sofaHeight = 26;

  let playerX = 40;
  let playerY = groundY - 16;
  let playerVX = 0;
  let playerVY = 0;
  const speed = 0.14;
  const maxVX = 1.4;

  let moveLeft=false, moveRight=false, moveUp=false, moveDown=false, actionPressed=false;
  let gameStarted = false;
  let introWalkStartTime = 0;

  // 상태: 타이틀, 인트로 걷기, 인트로 대화, 소파까지 자유, 소파에서 대화, 꿀렁이까지 자유, 꿀렁이 대화, 종료
  let gameState = 'title';

  /* 대화 시스템 */
  let currentLines = [];
  let currentIdx = 0;
  let typing = false;
  let fullLine = '';
  let onDialogDone = null;

  async function showDialog(lines, hint='', cb=null){
    currentLines = lines;
    currentIdx = 0;
    onDialogDone = cb;

    if(hint && hint.trim().length){
      hintBar.textContent = hint;
      hintBar.classList.remove('hidden');
    }else{
      hintBar.textContent = '';
      hintBar.classList.add('hidden');
    }

    dialogBar.classList.remove('hidden');
    await typeCurrentLine();
  }

  async function typeCurrentLine(){
    const line = currentLines[currentIdx] || '';
    fullLine = line;
    typing = true;
    await typeText(dialogText, line, 40, false);
    typing = false;
  }

  dialogNextBtn.addEventListener('click', async ()=>{
    await ensureResumed();
    if(typing){
      // 타이핑 중이면 즉시 완성
      typing = false;
      dialogText.textContent = fullLine;
      return;
    }
    currentIdx++;
    if(currentIdx >= currentLines.length){
      if(onDialogDone) onDialogDone();
      return;
    }
    await typeCurrentLine();
  });

  /* HUD 입력 */
  const dpad = hudLeft.querySelector('.dpad');
  if(dpad){
    dpad.addEventListener('pointerdown', (e)=>{
      const btn = e.target.closest('button[data-dir]');
      if(!btn) return;
      const dir = btn.dataset.dir;
      if(dir==='left')  moveLeft=true;
      if(dir==='right') moveRight=true;
      if(dir==='up')    moveUp=true;
      if(dir==='down')  moveDown=true;
      e.target.setPointerCapture(e.pointerId);
    });
    dpad.addEventListener('pointerup', (e)=>{
      const btn = e.target.closest('button[data-dir]');
      if(!btn) return;
      const dir = btn.dataset.dir;
      if(dir==='left')  moveLeft=false;
      if(dir==='right') moveRight=false;
      if(dir==='up')    moveUp=false;
      if(dir==='down')  moveDown=false;
    });
    dpad.addEventListener('pointercancel', ()=>{
      moveLeft=moveRight=moveUp=moveDown=false;
    });
  }

  const actionBtn = qs('#actionBtn');
  actionBtn.addEventListener('pointerdown', ()=>{
    actionPressed = true;
  });
  actionBtn.addEventListener('pointerup', ()=>{
    actionPressed = false;
  });
  actionBtn.addEventListener('pointercancel', ()=>{
    actionPressed = false;
  });

  /* 키보드(테스트용) */
  window.addEventListener('keydown', (e)=>{
    if(e.code === 'ArrowLeft')  moveLeft=true;
    if(e.code === 'ArrowRight') moveRight=true;
    if(e.code === 'ArrowUp')    moveUp=true;
    if(e.code === 'Space')      actionPressed=true;
  });
  window.addEventListener('keyup', (e)=>{
    if(e.code === 'ArrowLeft')  moveLeft=false;
    if(e.code === 'ArrowRight') moveRight=false;
    if(e.code === 'ArrowUp')    moveUp=false;
    if(e.code === 'Space')      actionPressed=false;
  });

  /* 게임 안에 들어가는 작은 꿀렁이 */
  function drawInnerBlob(ctx){
    const cx = W/2;
    const cy = 70;
    const baseR = 40;
    const N = 22;
    const t = performance.now()*0.001;

    ctx.beginPath();
    for(let i=0;i<N;i++){
      const ang = (i/N)*Math.PI*2;
      const wob = 0.25*Math.sin(t*2 + i*0.6);
      const r = baseR * (0.8 + wob);
      const x = cx + Math.cos(ang)*r;
      const y = cy + Math.sin(ang)*r*0.6;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.fillStyle = '#001307';
    ctx.strokeStyle = 'rgba(190,230,190,0.4)';
    ctx.lineWidth = 1.5;
    ctx.fill();
    ctx.stroke();
  }

  /* 게임 루프 */
  function update(){
    if(!gameStarted) return;

    // 인트로 걷기 (왼쪽에서 등장)
    if(gameState === 'introWalk'){
      const elapsed = (performance.now() - introWalkStartTime) / 1000;
      const startX = -24;
      const targetX = 56;
      const t = clamp(elapsed / 1.2, 0, 1);
      playerX = startX + (targetX - startX)*t;
      playerY = groundY - 16;
      if(t >= 1){
        gameState = 'introDialog';
        startIntroDialog();
      }
      return;
    }

    // 소파까지 / 꿀렁이까지 이동할 수 있는 구간
    if(gameState === 'freeToSofa' || gameState === 'freeToBlob'){
      let ax = 0;
      if(moveLeft)  ax -= speed;
      if(moveRight) ax += speed;
      playerVX += ax;
      playerVX *= 0.82;
      playerVX = clamp(playerVX, -maxVX, maxVX);

      playerX += playerVX;
      playerY = groundY - 16;

      // 화면 밖 제한
      if(playerX < 8){
        playerX = 8;
        playerVX = 0;
      }
      if(playerX > W-24){
        playerX = W-24;
        playerVX = 0;
      }

      // 소파에 앉기 (첫 번째 구간에서만)
      if(gameState === 'freeToSofa'){
        const nearSofa = (playerX > sofaX - 12);
        if(nearSofa && actionPressed){
          sitOnSofa();
        }
      }

      // 중앙 꿀렁이로 가기 (두 번째 구간에서)
      if(gameState === 'freeToBlob'){
        const centerX = W/2;
        const nearBlob = (Math.abs(playerX - centerX) < 20);
        if(nearBlob && actionPressed){
          startBlobDialog();
        }
      }
    }

    // 소파에 앉아 있는 동안은 위치 고정
    if(gameState === 'seatedDialog'){
      playerVX = 0;
      playerVY = 0;
    }
  }

  function draw(){
    const ctx = gctx;
    ctx.clearRect(0,0,W,H);

    // 배경 (초록 계열)
    ctx.fillStyle = '#05210f';
    ctx.fillRect(0,0,W,H);

    // 안쪽 꿀렁이 (게임 화면 안)
    drawInnerBlob(ctx);

    // 바닥 (녹색 톤)
    ctx.fillStyle = '#0b2f18';
    ctx.fillRect(0, groundY, W, H-groundY);
    ctx.strokeStyle = '#193d23';
    ctx.beginPath();
    ctx.moveTo(0,groundY);
    ctx.lineTo(W,groundY);
    ctx.stroke();

    // 왼쪽 단 (녹색 블럭)
    ctx.fillStyle = '#164524';
    ctx.fillRect(8, groundY-10, 32, 10);

    // 쇼파 (오른쪽, 노란색 유지)
    ctx.save();
    ctx.translate(sofaX, groundY - sofaHeight);
    ctx.fillStyle = '#e8c93b';
    ctx.fillRect(0, 8, sofaWidth, sofaHeight-8);   // 몸통
    ctx.fillRect(4, 0, sofaWidth-8, 10);           // 등받이
    ctx.fillStyle = '#c6a629';
    ctx.fillRect(6, 12, sofaWidth-12, sofaHeight-14); // 쿠션
    ctx.fillStyle = '#b09324';
    ctx.fillRect(4, sofaHeight-2, 8, 4);           // 다리
    ctx.fillRect(sofaWidth-12, sofaHeight-2, 8, 4);
    ctx.restore();

    // 플레이어 (토끼)
    const scale = 3;
    drawRedRabbit(ctx, playerX, playerY, scale);
  }

  function gameLoop(){
    requestAnimationFrame(gameLoop);
    update();
    draw();
  }
  gameLoop();

  /* ===== 상태 전환 ===== */
  function startGameScene(){
    gameLayout.classList.remove('hidden');
    hudLeft.classList.remove('hidden');
    hudRight.classList.remove('hidden');

    gameStarted = true;

    // 1초 후 왼쪽에서 토끼 등장
    setTimeout(()=>{
      gameState = 'introWalk';
      introWalkStartTime = performance.now();
    }, 1000);
  }

  async function startIntroDialog(){
    const lines = [
      "안녕?",
      `나는 ${nickForText}이야.`,
      "어때, 그래도 한 8분 걸어온 것 같은데, 어디 편한 곳에 앉아볼까?",
      "아아앗? 저기 소파가 있다! 저기에 앉아보자!!"
    ];
    const hint =
      "안내 : 캐릭터를 우측으로 이동시켜 버튼(A)을 눌러 쇼파에 앉으세요.\n" +
      "당신도 어디 좋은 자리를 잡아 앉아보세요.";
    showDialog(lines, hint, ()=>{
      gameState = 'freeToSofa';
    });
  }

  function sitOnSofa(){
    if(gameState !== 'freeToSofa') return;
    gameState = 'seatedDialog';

    // 쇼파 위 위치로 스냅
    playerX = sofaX + sofaWidth*0.4;
    playerY = groundY - sofaHeight - 2;
    playerVX = 0;
    playerVY = 0;

    const lines = [
      "앉았어?",
      "그래. 어때?",
      "짧은 시간의 여정은 조금 괜찮아?",
      "지금부터는 제 2장. 그러니까 THE SECOND SLEEP이야!",
      "THE FIRST SLEEP가 눈과 귀로 타자를 인식해나가는 순간이었다면, 지금은 어쩌면…",
      "머리로?",
      "그러니까 그냥 인식되어버렸던 그것들을 한 번 더 생각해보는 시간이지!",
      "너는 편하게 앉아있어. 이제 내가 한 번 움직여볼게."
    ];
    showDialog(lines, '', ()=>{
      // 토끼는 쇼파에서 일어나 바닥으로
      playerY = groundY - 16;
      // 조금 왼쪽으로 내려와서 중앙으로 갈 준비
      playerX = sofaX + sofaWidth*0.2;
      gameState = 'freeToBlob';
      const hint =
        "안내 : 캐릭터를 화면 중앙의 꿀렁이 가까이 이동시킨 뒤, A 버튼을 눌러주세요.\n" +
        "당신은 그대로 편하게 앉아, 방금 들었던 것들을 한 번 더 떠올려 보세요.";
      hintBar.textContent = hint;
      hintBar.classList.remove('hidden');
    });
  }

  function startBlobDialog(){
    if(gameState !== 'freeToBlob') return;
    gameState = 'blobDialog';

    // 중앙 쪽으로 스냅
    playerX = W/2 - 8;
    playerY = groundY - 16;

    const lines = [
      "우리는 지금부터 이 꿀렁꿀렁 거리는 물질 속으로 들어갈거야.",
      "이건 언제부터 존재했는지는 모르지만, 어느 순간부터 생겨난 응축된 응어리 같은 거거든.",
      "준비가 되면 버튼을 눌러줘.",
      "함께 그것의 속으로 들어가보자."
    ];
    hintBar.textContent = '';
    hintBar.classList.add('hidden');
    showDialog(lines, '', ()=>{
      endSecondStage();
    });
  }

  function endSecondStage(){
    gameState = 'finished';
    dialogNextBtn.disabled = true;

    // 페이드 인
    stageFade.classList.remove('hidden');
    requestAnimationFrame(()=>{
      stageFade.style.opacity = '1';
    });

    // 음악은 조금 어두운 느낌으로 변화
    startDarkMusic();

    // 다음 스테이지로 넘길 수 있는 훅
    setTimeout(()=>{
      if(typeof window.sleepSecondStageDone === 'function'){
        window.sleepSecondStageDone();
      } else {
        // 임시로 검은 화면만 남겨둔다
        gameLayout.classList.add('hidden');
        hudLeft.classList.add('hidden');
        hudRight.classList.add('hidden');
        dialogBar.classList.add('hidden');
        hintBar.classList.add('hidden');
      }
    }, 1300);
  }

  /* ===== 시작 오버레이 ===== */
  async function startAll(){
    await primeAudio();
    await enterFullscreen();
    startOverlay.style.display = 'none';
    blobStartTime = performance.now();
    blobFadeIn = true;
    blobAlpha = 0;

    await ensureResumed();
    await showTitleSequence();
  }

  ['click','touchstart','pointerdown'].forEach(ev=>{
    startBtn.addEventListener(ev, (e)=>{
      e.preventDefault();
      if(startOverlay.style.display === 'none') return;
      startAll();
    }, {passive:false});
  });

})();
</script>
</body>
</html>
