<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>SLEEEEP · Tall Grass Maze (App-like)</title>
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEEEP">
<meta name="mobile-web-app-capable" content="yes">
<style>
  :root{
    --fg:#ffffff;
    --safe-top:env(safe-area-inset-top,0px);
    --safe-bot:env(safe-area-inset-bottom,0px);
    --safe-left:env(safe-area-inset-left,0px);
    --safe-right:env(safe-area-inset-right,0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#000;color:var(--fg);
    font-family:ui-serif,Georgia,"Times New Roman",serif;}
  #stage{position:relative;width:100vw;height:100svh;overflow:hidden;
    padding:var(--safe-top) var(--safe-right) var(--safe-bot) var(--safe-left);}
  /* 게임 창: 전체를 채우지 않음(중앙 90% 이내) */
  #view{position:absolute;left:50%;top:50%;
    transform:translate(-50%,-50%);
    image-rendering:pixelated;image-rendering:crisp-edges;background:#000;}
  /* 텍스트 버튼(박스/테두리 없음) */
  .tbtn{
    position:absolute;top:10px;padding:0 6px;height:28px;display:grid;place-items:center;
    background:transparent;border:none;outline:none;border-radius:0;color:#fff;
    font:800 14px/1 ui-serif,Georgia,"Times New Roman",serif;letter-spacing:.02em;
    text-shadow:0 1px 0 #000a; cursor:pointer; user-select:none;
  }
  #btnMap{left:10px}
  #btnInv{right:10px}
  #btnDialog{right:10px; top:auto; bottom:10px} /* 하단 우측 */
  /* 투명 D-pad */
  .dpad{
    position:absolute;left:10px;bottom:10px;width:180px;height:180px;display:none;
    grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:8px;z-index:3;
  }
  .dpad .cell{display:grid;place-items:center;background:transparent}
  .key{
    width:100%;height:100%;background:transparent;color:#fff;border:none;border-radius:0;outline:none;
    font:800 18px/1 ui-serif,Georgia,"Times New Roman",serif;text-shadow:0 1px 0 #000a; cursor:pointer;
  }
  .key:active{transform:scale(.96)}
  @media (pointer:coarse){ .dpad{display:grid} }

  /* 모달(빈 창만) */
  .modal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:5;background:#0008}
  .sheet{min-width:520px;max-width:86vw;min-height:320px;max-height:72vh;overflow:auto;
    background:#101018;color:#fff;border-radius:0;padding:16px}
  .sheet h3{margin:0 0 12px;font:800 14px/1 ui-serif,Georgia,"Times New Roman",serif}
  .close{float:right;background:transparent;color:#fff;border:none;font-weight:800;cursor:pointer}
</style>
</head>
<body>
<div id="stage">
  <!-- 화면 전체를 채우지 않는 고정 해상도 캔버스 -->
  <canvas id="view" width="960" height="540" aria-label="게임 화면"></canvas>

  <!-- 텍스트 버튼 -->
  <button id="btnMap" class="tbtn">MAP</button>
  <button id="btnInv" class="tbtn">INVENTORY</button>
  <button id="btnDialog" class="tbtn">Dialogue</button>

  <!-- 투명 D-pad -->
  <div id="dpad" class="dpad" aria-hidden="false">
    <div class="cell"></div><div class="cell"><button class="key" data-dir="up">↑</button></div><div class="cell"></div>
    <div class="cell"><button class="key" data-dir="left">←</button></div><div class="cell"></div><div class="cell"><button class="key" data-dir="right">→</button></div>
    <div class="cell"></div><div class="cell"><button class="key" data-dir="down">↓</button></div><div class="cell"></div>
  </div>

  <!-- MAP / INVENTORY 빈 창 -->
  <div id="mapModal" class="modal"><div class="sheet">
    <button class="close" data-close>닫기</button><h3>MAP</h3>
    <div style="height:240px;background:#0e0e13"></div>
  </div></div>
  <div id="invModal" class="modal"><div class="sheet">
    <button class="close" data-close>닫기</button><h3>INVENTORY</h3>
    <div style="height:240px;background:#0e0e13"></div>
  </div></div>
</div>

<script>
/* ===== 캔버스 배치: 화면 90% 이내로 스케일 ===== */
const stage=document.getElementById('stage');
const cv=document.getElementById('view');
const g=cv.getContext('2d'); g.imageSmoothingEnabled=false;
function fit(){
  const vw=stage.clientWidth, vh=stage.clientHeight;
  const s=Math.min(vw*0.9/cv.width, vh*0.9/cv.height);
  const is = Math.max(1, Math.floor(s)); // 정수배 스케일
  cv.style.width=(cv.width*is)+'px';
  cv.style.height=(cv.height*is)+'px';
}
new ResizeObserver(fit).observe(stage); fit();

/* ===== 팔레트 ===== */
const C={
  path:'#1e1e1e',
  ground:'#000',
  tuftDark:'#0b140d',
  tuftMid :'#1f2e20',
  tuftHi  :'#3b553a',
  actor:'#f0e0bf', actorEdge:'#1a1a1a', actorHead:'#ffe8c9'
};

/* ===== 타일/미로 설정 ===== */
const W=cv.width, H=cv.height;
const TILE=20;                   // 48 × 27 타일
const COLS=(W/TILE)|0, ROWS=(H/TILE)|0;

const WALL=1, OPEN=0;
const grid = Array.from({length:ROWS},()=>Array(COLS).fill(WALL));

/* 랜덤 백트래킹 미로(셀 간격 2칸) */
function carveMaze(){
  const inb=(x,y)=>x>0&&y>0&&x<COLS-1&&y<ROWS-1;
  function neigh(x,y){
    return [[x+2,y],[x-2,y],[x,y+2],[x,y-2]].filter(([nx,ny])=>inb(nx,ny)&&grid[ny][nx]===WALL);
  }
  // 시작: 아래쪽 중앙 근처
  let sx=(COLS/2|0)|1, sy=(ROWS-3)|0; sx-=sx%2?0:1; sy-=sy%2?0:1;
  const stack=[[sx,sy]]; grid[sy][sx]=OPEN;
  while(stack.length){
    const [x,y]=stack[stack.length-1];
    const nb=neigh(x,y);
    if(nb.length===0){ stack.pop(); continue; }
    const [nx,ny]=nb[(Math.random()*nb.length)|0];
    grid[(y+ny)/2][(x+nx)/2]=OPEN; // 사이벽 열기
    grid[ny][nx]=OPEN;
    stack.push([nx,ny]);
  }
  // 출구 같은 넓은 공터 살짝
  for(let y=2;y<5;y++)for(let x=COLS-6;x<COLS-2;x++) grid[y][x]=OPEN;
}
carveMaze();

/* ===== 배경: 귀여운 풀 타일 + 길 ===== */
function prng(n){ n=(n<<13) ^ n; return (1.0 - ((n*(n*n*15731+789221)+1376312589)&0x7fffffff)/1073741824.0); }
function drawBackground(){
  g.fillStyle=C.ground; g.fillRect(0,0,W,H);
  for(let ty=0;ty<ROWS;ty++){
    for(let tx=0;tx<COLS;tx++){
      const x=tx*TILE, y=ty*TILE;
      if(grid[ty][tx]===OPEN){
        // 길
        g.fillStyle=C.path; g.fillRect(x,y,TILE,TILE);
        // 살짝 라인(입체감)
        g.fillStyle='rgba(255,255,255,.04)'; g.fillRect(x,y,TILE,2);
        g.fillStyle='rgba(0,0,0,.25)'; g.fillRect(x,y+TILE-2,TILE,2);
      }else{
        // 풀 타일(정적)
        const r=Math.abs(prng(tx*73856093 ^ ty*19349663));
        g.fillStyle = r<0.33 ? C.tuftDark : (r<0.66 ? C.tuftMid : C.tuftHi);
        const cx=x+TILE/2|0, cy=y+TILE/2|0;
        g.fillRect(cx-1, cy-4, 2, 5);      // 중앙 잎
        g.fillRect(cx-5, cy-1, 2, 3);      // 좌 잎
        g.fillRect(cx+3, cy-1, 2, 3);      // 우 잎
        if(r>0.7){ g.fillRect(cx-7, cy+4, 1,1); }
        if(r<0.25){ g.fillRect(cx+6, cy+3, 1,1); }
      }
    }
  }
}

/* ===== 플레이어: 길 위에서만 이동 ===== */
const player={x:(COLS/2|0)*TILE+TILE/2, y:(ROWS-2)*TILE+TILE/2, spd:2.6, size:.7};
function tileAt(x,y){ const tx=(x/TILE)|0, ty=(y/TILE)|0; if(tx<0||ty<0||tx>=COLS||ty>=ROWS) return WALL; return grid[ty][tx]; }

function moveOnPath(px,py,ax,ay,spd){
  let nx=px+ax*spd, ny=py+ay*spd;
  // 한 축씩 검사(길에서만 통과)
  if(tileAt(nx,py)===OPEN) px=nx;
  if(tileAt(px,ny)===OPEN) py=ny;
  return [px,py];
}

/* ===== 입력 ===== */
const keys=new Set();
addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(['arrowup','arrowdown','arrowleft','arrowright','w','a','s','d','e','enter'].includes(k)) e.preventDefault();
  keys.add(k);
  if(k==='e'||k==='enter') openDialog();
});
addEventListener('keyup',e=>keys.delete(e.key.toLowerCase()));

const dpad=document.getElementById('dpad'); const held=new Set(); const dstate={ax:0,ay:0};
function updHeld(){ let ax=0,ay=0; if(held.has('left')) ax-=1; if(held.has('right')) ax+=1; if(held.has('up')) ay-=1; if(held.has('down')) ay+=1; dstate.ax=ax; dstate.ay=ay; }
dpad.querySelectorAll('[data-dir]').forEach(btn=>{
  const dir=btn.dataset.dir;
  const down=e=>{e.preventDefault();held.add(dir);updHeld();};
  const up=e=>{e.preventDefault();held.delete(dir);updHeld();};
  btn.addEventListener('pointerdown',down,{passive:false});
  btn.addEventListener('pointerup',up,{passive:false});
  btn.addEventListener('pointercancel',up,{passive:false});
  btn.addEventListener('pointerleave',up,{passive:false});
  btn.addEventListener('touchstart',down,{passive:false});
  btn.addEventListener('touchend',up,{passive:false});
  btn.addEventListener('touchcancel',up,{passive:false});
});

/* ===== 모달(맵/인벤토리) ===== */
const mapModal=document.getElementById('mapModal');
const invModal=document.getElementById('invModal');
document.getElementById('btnMap').onclick=()=>mapModal.style.display='flex';
document.getElementById('btnInv').onclick=()=>invModal.style.display='flex';
[mapModal,invModal].forEach(m=>m.addEventListener('click',e=>{ if(e.target===m||e.target.dataset.close!=null) m.style.display='none';}));

/* ===== Dialogue (임시) ===== */
document.getElementById('btnDialog').onclick=()=>openDialog();
function openDialog(){ /* 나중에 실제 대화 연결 */ }

/* ===== 렌더링 ===== */
function drawPlayer(){
  const s=player.size;
  // 그림자
  g.fillStyle='rgba(0,0,0,.5)'; g.fillRect(player.x-10*s, player.y+10*s, 20*s, 4*s);
  // 몸/머리
  g.fillStyle=C.actor;     g.fillRect(player.x-10*s, player.y-16*s, 20*s, 12*s);
  g.fillStyle=C.actorHead; g.fillRect(player.x-8*s,  player.y-28*s, 16*s, 10*s);
  g.fillStyle=C.actorEdge; g.fillRect(player.x-10*s, player.y-4*s,  20*s, 2*s);
}

function update(){
  let ax=0,ay=0;
  if(keys.has('arrowleft')||keys.has('a')) ax-=1;
  if(keys.has('arrowright')||keys.has('d')) ax+=1;
  if(keys.has('arrowup')||keys.has('w')) ay-=1;
  if(keys.has('arrowdown')||keys.has('s')) ay+=1;
  ax+=dstate.ax; ay+=dstate.ay;
  const m=Math.hypot(ax,ay)||1; ax/=m; ay/=m;

  [player.x,player.y] = moveOnPath(player.x,player.y,ax,ay,player.spd);
}
function render(){
  drawBackground();
  drawPlayer();
}
function loop(){ update(); render(); requestAnimationFrame(loop); }
render(); requestAnimationFrame(loop);
</script>
</body>
</html>
